<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TodoMVC â€¢ Chelonia</title>
    <link rel="stylesheet" href="/assets/css/todomvc.css">
</head>
<body>
    <section class="todoapp">
        <header class="header">
            <h1>todos</h1>
            <input class="new-todo" placeholder="What needs to be done?" autofocus>
        </header>
        
        <section class="main" style="display: none;">
            <input id="toggle-all" class="toggle-all" type="checkbox">
            <label for="toggle-all">Mark all as complete</label>
            <ul class="todo-list"></ul>
        </section>
        
        <footer class="footer" style="display: none;">
            <span class="todo-count"></span>
            <ul class="filters">
                <li>
                    <a href="#/" class="selected">All</a>
                </li>
                <li>
                    <a href="#/active">Active</a>
                </li>
                <li>
                    <a href="#/completed">Completed</a>
                </li>
            </ul>
            <button class="clear-completed" style="display: none;">Clear completed</button>
        </footer>
    </section>
    
    <footer class="info">
        <p>Double-click to edit a todo</p>
        <p>Created with <a href="https://okturtles.org/">Chelonia</a></p>
        <p>Part of <a href="http://todomvc.com">TodoMVC</a></p>
    </footer>

    <!-- Login Modal -->
    <div id="login-modal" class="modal" style="display: block;">
        <div class="modal-content">
            <h2>Welcome to TodoMVC</h2>
            <p>Enter your username to start managing your todos:</p>
            <form id="login-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="email" id="email" placeholder="Email (optional)">
                <button type="submit">Start</button>
            </form>
        </div>
    </div>

    <!-- Template for todo items -->
    <template id="todo-template">
        <li>
            <div class="view">
                <input class="toggle" type="checkbox">
                <label></label>
                <button class="destroy" type="button" aria-label="Delete todo"></button>
            </div>
            <input class="edit">
        </li>
    </template>

    <!-- SBP and Chelonia CDN Imports -->
    <script type="module">
        console.log('ðŸš€ Loading SBP and Chelonia from CDN...')
        
        // Load SBP and Chelonia from CDN
        const sbpModule = await import('https://cdn.jsdelivr.net/npm/@sbp/sbp@2.4.1/+esm')
        window.sbp = sbpModule.default || sbpModule.sbp || sbpModule
        console.log('âœ… SBP loaded from CDN!')
        
        const cheloniaModule = await import('https://cdn.jsdelivr.net/npm/@chelonia/lib@1.2.2/+esm')
        window.chelonia = cheloniaModule
        console.log('âœ… Chelonia loaded from CDN!')
        console.log('âœ… Chelonia library loaded, using TodoMVC selectors for browser compatibility')
        
        // Register our simplified KV selectors for TodoMVC
        console.log('ðŸ”§ Registering TodoMVC-specific KV selectors...')
        const kvStore = new Map()
        const contracts = new Map()
        
        window.sbp('sbp/selectors/register', {
            // Simplified KV selectors for TodoMVC that work in browser
            'todomvc/kv/get': async (contractID, key) => {
                const kvKey = `todomvc:${contractID}:${key}`
                console.log(`ðŸ” KV GET: contractID=${contractID}, key=${key}, kvKey=${kvKey}`)
                const value = kvStore.get(kvKey) || localStorage.getItem(kvKey)
                const result = value ? JSON.parse(value) : null
                console.log(`ðŸ“– KV GET result:`, result ? `${Object.keys(result).length} items` : 'null')
                return result
            },
            
            'todomvc/kv/set': async (contractID, key, value) => {
                const kvKey = `todomvc:${contractID}:${key}`
                console.log(`ðŸ’¾ KV SET: contractID=${contractID}, key=${key}, kvKey=${kvKey}`)
                console.log(`ðŸ“ KV SET data:`, value ? `${Object.keys(value).length} todos` : 'empty')
                const serialized = JSON.stringify(value)
                kvStore.set(kvKey, serialized)
                localStorage.setItem(kvKey, serialized)
                console.log(`âœ… KV SET complete: stored ${serialized.length} chars`)
                return true
            },
            
            'todomvc/kv/delete': async (contractID, key) => {
                const kvKey = `todomvc:${contractID}:${key}`
                console.log(`ðŸ—‘ï¸ KV DELETE: contractID=${contractID}, key=${key}, kvKey=${kvKey}`)
                kvStore.delete(kvKey)
                localStorage.removeItem(kvKey)
                console.log(`âœ… KV DELETE complete`)
                return true
            },
            
            // Identity contract management for TodoMVC
            'todomvc/identity/create': async (username, email) => {
                // For demo purposes, identity creation just generates a contract-like object
                const id = `identity:${username}`
                console.log(`ðŸ‘¤ IDENTITY CREATE: username=${username}, email=${email || 'none'}`)
                const contract = { id, username, email: email || null, createdAt: Date.now() }
                contracts.set(id, contract)
                console.log(`âœ… IDENTITY CREATE complete: contractID=${id}`)
                return { id }
            }
        })
        
        // Signal readiness for KV selectors so app.js can safely proceed
        window.todomvcKVReady = true
        window.dispatchEvent(new Event('todomvc-kv-ready'))
        console.log('âœ… TodoMVC KV selectors registered with SBP!')
        
        // Initialize TodoMVC with simplified configuration
        window.todomvcConfig = {
            contracts: {
                'gi.contracts/identity': {
                    actions: {},
                    getters: {},
                    methods: {}
                }
            },
            skipSynchronization: true
        }
        
        console.log('ðŸŽ‰ TodoMVC ready with SBP and Chelonia APIs!')
    </script>
    <script src="/assets/js/app.js"></script>
</body>
</html>
