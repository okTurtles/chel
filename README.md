# Chel: Chelonia Command-line Interface

Modern CLI for Chelonia contract development, deployment, and management.

## All Available Commands

```
chel
chel help [command]
chel version
chel dev [--dp <port>] [--port <port>] [--debug]
chel build
chel pin <version> <manifest-file-path> [--only-changed | --overwrite]
chel test
chel keygen [--out=<key.json>]
chel manifest [-k|--key <pubkey1> [-k|--key <pubkey2> ...]] [--out=<manifest.json>] [-s|--slim <contract-slim.js>] [-v|--version <version>] <key.json> <contract-bundle.js>
chel deploy <url-or-dir-or-sqlitedb> <contract-manifest.json> [<manifest2.json> [<manifest3.json> ...]]
chel upload <url-or-dir-or-sqlitedb> <file1> [<file2> [<file3> ...]]
chel serve [options] <directory>
chel latestState <url> <contractID>
chel eventsAfter [--limit N] <url> <contractID> <hash>
chel eventsBefore [--limit N] <url> <contractID> <hash>
chel hash <file>
chel migrate --from <backend> --to <backend> --out <dir-or-sqlitedb>
```

Note: in many (if not all) instances, the `<url>` parameter can refer to a local folder path, in which case the command will operate without making a network connection, and will instead use the folder's contents to perform its operations.

### `chel pin` - Per-Contract Versioning System

ðŸŽ¯ Pin individual contracts to specific versions independently!

**Key Features:**
- âœ… **Per-contract versioning** using `chelonia.json` configuration
- âœ… **Individual contract pinning** by specifying manifest file path
- âœ… **New directory structure**: `contracts/<contract-name>/<version>/`
- âœ… **Manifest-based workflow** - requires existing manifest files
- âœ… **Ecosystem-agnostic** - no coupling to Node.js/npm

**Workflow:**
1. **Generate manifest first**: Use `chel manifest` to create `.manifest.json` files
2. **Pin from manifest**: Use `chel pin` with the manifest file path
3. **Contract files copied**: Only contract files (main/slim) are copied to new structure

**Usage Examples:**
```bash
chel pin <version> <manifest-file-path>

# Pin specific contract to a version using its manifest (from dist/contracts)
chel pin 2.0.5 dist/contracts/2.0.5/chatroom.2.0.5.manifest.json
chel pin 2.0.0 dist/contracts/2.0.0/group.2.0.0.manifest.json

# Switch versions efficiently with --only-changed
chel pin 2.0.6 dist/contracts/2.0.6/chatroom.2.0.6.manifest.json --only-changed

# Note: Contracts are pinned to the contracts/ output directory
```

**Configuration (`chelonia.json`):**
```json
{
  "contracts": {
    "chatroom": {
      "version": "2.0.6",
      "path": "contracts/gi.contracts_chatroom/2.0.6/chatroom.2.0.6.manifest.json"
    },
    "group": {
      "version": "2.0.0",
      "path": "contracts/gi.contracts_group/2.0.0/group.2.0.0.manifest.json"
    }
  }
}
```

**Directory Structure Created:**
```
contracts/
â”œâ”€â”€ gi.contracts_chatroom/
â”‚   â”œâ”€â”€ 2.0.5/
â”‚   â”‚   â”œâ”€â”€ chatroom.js
â”‚   â”‚   â””â”€â”€ chatroom-slim.js
â”‚   â””â”€â”€ 2.0.6/
â”‚       â”œâ”€â”€ chatroom.js
â”‚       â””â”€â”€ chatroom-slim.js
â””â”€â”€ gi.contracts_group/
    â””â”€â”€ 2.0.0/
        â”œâ”€â”€ group.js
        â””â”€â”€ group-slim.js
```

> **Note:** The pin command only copies contract files (main and slim) from existing manifest files. It does not copy or generate manifest files - those should be created separately using `chel manifest`.

> [!IMPORTANT]  
> **Contract Manifest Files:**
>
> The `*.manifest.json` files generated by `chel pin` contain placeholder hashes and signatures for development purposes. For production deployment, you must generate proper cryptographic signatures using the following workflow:

**Step 1: Generate cryptographic keys**
```bash
# Generate private and public key files in the root directory
chel keygen
```

This creates:
- `key.json` - Private key file (keep secure!)
- `key.pub.json` - Public key file

**Step 2: Generate production manifest with proper signatures**
```bash
chel manifest [-k|--key <pubkey1> [-k|--key <pubkey2> ...]] [--out=<manifest.json>] [-s|--slim <contract-slim.js>] [-v|--version <version>] <key.json> <contract-bundle.js>

chel manifest --slim contracts/gi.contracts_chatroom/2.0.10/chatroom-slim.js --version 2.0.10 --out contracts/gi.contracts_chatroom/2.0.10/chatroom.2.0.10.manifest.json key.json contracts/gi.contracts_chatroom/2.0.10/chatroom.js
```

This replaces the placeholder values with actual cryptographic hashes and signatures required for secure contract deployment.

**Command Options:**
- **`--only-changed`**: Efficiently switch versions or create new versions
- **`--overwrite`**: Force overwrite existing versions
- **Default**: Create new version by copying from source

### `chel serve` - Development Server with Contract Preloading

```
chel serve [options] <directory>

OPTIONS

--dp <port>        set dashboard port (default: 8888)
--port <port>      set application port (default: 8000)
--db-type <type>   one of: files, sqlite, mem (default: mem)
--db-location <loc>  for "files", a directory, for "sqlite", path to sqlite database
```

> [!IMPORTANT]  
> **Prerequisites:** Ensure your application directory contains a `contracts/` directory with the correct contract structure before running `chel serve`. The server automatically preloads all contract manifests found in `contracts/<contract-name>/<version>/` directories into the database on startup.

**Example Output:**
```bash
$ chel serve
ðŸš€ Starting Chelonia app server...
ðŸ“¦ Step 1: Preloading contracts...
ðŸ“‹ Found 4 contract manifest(s) to deploy
contracts/gi.contracts_chatroom/2.0.6/chatroom.js: /data/zLAeVmpcc88g...
contracts/gi.contracts_group/2.0.0/group.js: /data/zLAeVmpcc88g...
âœ… Successfully preloaded 4 contract(s) into database
ðŸš€ Step 2: Starting dashboard server...
ðŸ“Š Dashboard server running at: http://localhost:8888
ðŸš€ Step 3: Starting application server...
```

**Usage Examples:**
```bash
# Start with automatic contract preloading
chel serve

# Serve Group Income app from extracted directory
chel serve ./gi-v2.0.0

# Serve with custom ports and SQLite database
chel serve --dp 8888 --port 8000 --db-type sqlite --db-location ./app.db ./my-app
```

**What happens during startup:**
1. **Contract Discovery** - Scans `contracts/<name>/<version>/` directories
2. **Manifest Collection** - Finds all `.manifest.json` files
3. **Database Preloading** - Deploys all contracts with content-addressed storage
4. **Server Startup** - Starts dashboard and application servers
5. **Ready for Development** - All historical contracts available for message processing

### `chel dev` - Live Development Environment

ðŸ§ª **Live-testing environment with hot reload and contract interaction**

It provides a complete development server with automatic contract redeployment when files change.

**Usage:**
```bash
chel dev
chel dev --dp 8888
chel dev --port 8000
chel dev --debug
```

### `chel keygen`

```
{
  "version": "1.0.0",
  "cipher": "algo",
  "pubkey": "...",
  "privkey": "...",
  "encrypted": "algo"
}
```

If `"encrypted"` doesn't exist - it means the `"privkey"` was saved in the clear.

### `chel manifest`

Let's say you have the following files:

- `contract-bundle.js`
- `contract-slim.js`

Running `chel manifest --add-key alex.json --slim contract-slim.js deploy-key.json contract-bundle.js` will generate the following `contract-bundle.manifest.json`:

```
{
  "head": {
    "manifestVersion": "1.0.0"
  },
  "body": JSON.stringify({
    "version": "<contract version string, 'x'> by default",
    "contract": { "hash": "<hash of contract-bundle.js>", "file": "contract-bundle.js" },
    "contractSlim": { "hash": "<hash of contract-slim.js>", "file": "contract-slim.js" },
    "authors": [
      {"cipher": "algo", "key": "<pubkey from deploy-key.json>"},
      {"cipher": "algo", "key": "<pubkey from alex.json>"}
    ]
  }),
  "signature": {
    "key": "<which of the 'authors' keys was used to sign 'body'>",
    "signature": "<signature>"
  }
}
```

It will upload both versions of the contracts, and this JSON.

This format makes it as efficient as possible for using the contract system from both in-app and from the commandline.

The CLI tool will always use the self-contained contract bundle, whereas apps can load less code by loading the slim version of the contract. You just need to make sure that none of the external dependencies that you're referencing ever change if you do this, as otherwise you will get different state between the two versions of the contracts.

Note also that Chelonia is fundamentally language agnostic. We started out using Chelonia to build JS apps, but you can use this protocol with any programming language that supports source evaluation at runtime.

Some commands of this CLI tool (like `latestState`), only support JavaScript, but that is a limitation of resources on our side, and not a fundamental limitation of the protocol.

### `chel deploy`

Deploys manifest(s) generated with `chel manifest`.

Automatically uploads any corresponding contract files.

Outputs the hash(es) corresponding to the manifest(s).

Useful command:

```
cp -r path/to/contracts/* test/assets/ && ls ./test/assets/*-slim.js | sed -En 's/.*\/(.*)-slim.js/\1/p' | xargs -I {} ./src/main.ts manifest --out=test/assets/{}.manifest.json --slim test/assets/{}-slim.js key.json test/assets/{}.js && ls ./test/assets/*.manifest.json | xargs ./src/main.ts deploy http://127.0.0.1:8888
```

### sha256sum

Current release hashes will always be listed here.

```
8a267d23405085ac4b01e55fca235b68f07875d1f7898f711c07da5b1d384b80  dist/chel-v3.0.0-aarch64-apple-darwin.tar.gz
e46f8b42bb8c2c1f0c0263ffa7b28d0b4030f0892f68e65541fe4e4dd7b2f7e4  dist/chel-v3.0.0-aarch64-unknown-linux-gnu.tar.gz
497468d57887e2a922045d5f82200c99336fd807762f200621a8dc8a761032c1  dist/chel-v3.0.0-x86_64-apple-darwin.tar.gz
f8fc1dba11045519d172868c54433a983de04248a1bb61edf206eacee6ad65fa  dist/chel-v3.0.0-x86_64-pc-windows-msvc.tar.gz
301e5fd7fc483f40520090f810d0d463f092b50855e0259aa2dec8b15ee67029  dist/chel-v3.0.0-x86_64-unknown-linux-gnu.tar.gz
```

## History

See [HISTORY.md](HISTORY.md)

## License

[AGPL-3.0](LICENSE)
