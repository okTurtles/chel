import{a as D}from"./chunk-5CRMMCPK-cached.js";import"./chunk-GB4D3I4D-cached.js";import"./chunk-Q5WT7Z5S-cached.js";import{d as K,f as b,i as m,j as A,n as k,o as p}from"./chunk-5SBNFUND-cached.js";import"./chunk-GTDX6B7Q-cached.js";import"./chunk-OJPGIG5M-cached.js";import"./chunk-MMWHE4QG-cached.js";import{c as C}from"./chunk-WWKTCH3O-cached.js";import{a as P}from"./chunk-NAVF63QR-cached.js";import{a as I,c as z}from"./chunk-AZT5ZK4I-cached.js";import"./chunk-4XLIKA67-cached.js";import"./chunk-LIW6QCF4-cached.js";import"./chunk-WMVHT3GJ-cached.js";import{j as g}from"./chunk-SZPI64OI-cached.js";import{a as N}from"./chunk-FTWBMR5D-cached.js";import"./chunk-GA3LN23N-cached.js";import"./chunk-3VFZYJBQ-cached.js";import"./chunk-MEHASGB7-cached.js";import"./chunk-Z7X5SDSD-cached.js";import"./chunk-TEH4GFTX-cached.js";import"./chunk-QVCKPSEU-cached.js";import{a as f}from"./chunk-OMOH7TRL-cached.js";import{b as S,d as E}from"./chunk-WBBXU2FL-cached.js";import{e as _}from"./chunk-XMZXE55N-cached.js";z();var $=_(N());var T=_(P(),1);var ve=Number.parseInt("",10)||1/0,y=(e,i)=>e._vm?.authorizedKeys&&Object.values(e._vm.authorizedKeys).find(n=>n.name===i&&n._notAfterHeight==null)?.id;var O=(e,i,n,a,s)=>e._vm?.authorizedKeys&&Object.values(e._vm.authorizedKeys).filter(t=>t._notAfterHeight==null&&t.ringLevel<=(a??Number.POSITIVE_INFINITY)&&f("chelonia/haveSecretKey",t.id)&&(Array.isArray(i)?i.reduce((r,c)=>r&&(t.permissions==="*"||t.permissions.includes(c)),!0):i===t.permissions)&&n.reduce((r,c)=>r&&t.purpose.includes(c),!0)&&(Array.isArray(s)?s.reduce((r,c)=>r&&(t.allowedActions==="*"||!!t.allowedActions?.includes(c)),!0):s?s===t.allowedActions:!0)).sort((t,r)=>r.ringLevel-t.ringLevel)[0]?.id;async function x({contractID:e,quantity:i=1,creatorID:n,expires:a,invitee:s}){let t=await f("chelonia/contract/state",e);if(!t||!t._vm||!O(t,"*",["sig"])||t._volatile?.pendingKeyRequests?.length)throw new Error("Invalid or missing current group state");let r=y(t,"cek"),c=y(t,"csk");if(!r||!c)throw new Error("Contract is missing a CEK or CSK");let l=b(K),d=A(l),o=m(l,!1),h=k(t,r,m(l,!0));return await f("chelonia/out/keyAdd",{contractID:e,contractName:"gi.contracts/group",data:[{id:d,name:"#inviteKey-"+d,purpose:["sig"],ringLevel:Number.MAX_SAFE_INTEGER,permissions:[p.OP_KEY_REQUEST],meta:{quantity:i,expires:Date.now()+C*a,private:{content:h}},data:o}],signingKeyId:c}),{inviteKeyId:d,creatorID:n,invitee:s}}var L={name:"AddMembers",mixins:[$.validationMixin],components:{ProposalTemplate:D},data(){return{form:{invitees:[]},ephemeral:{currentStep:0,isValid:!1,invitesCount:1},config:{steps:["Member"]}}},computed:{...S(["currentGroupId","loggedIn"]),...E(["ourIdentityContractId","currentGroupState","currentWelcomeInvite","groupShouldPropose","groupSettings"]),shouldGenerateInvitesImmediately(){return this.currentWelcomeInvite.expires<Date.now()&&!this.groupShouldPropose}},methods:{inviteeUpdate(e,i){e.target.value.length>0&&!this.ephemeral.isValid&&(this.ephemeral.isValid=!0),e.target.value.length===0&&this.ephemeral.invitesCount===1&&this.ephemeral.isValid&&(this.ephemeral.isValid=!1)},removeInvitee(e){this.ephemeral.invitesCount-=1,this.form.invitees.splice(e,1)},addInviteeSlot(e){this.ephemeral.invitesCount+=1,I.nextTick(()=>{let i=this.$refs.fieldset.getElementsByTagName("label"),n=i[i.length-1];n&&n.focus()})},async generateInviteImmediately(){let e=this.currentGroupId;for(let i of this.form.invitees)try{let n=await x({contractID:e,invitee:i,creatorID:this.ourIdentityContractId,expires:this.groupSettings.inviteExpiryProposal});await f("gi.actions/group/invite",{contractID:e,data:n})}catch(n){console.error(`Invite to ${i} failed to be sent!`,n?.message);break}},async submit(e){if(this.shouldGenerateInvitesImmediately)await this.generateInviteImmediately(),this.$refs.modalTemplate.close();else{let i=!1,n=Date.now()+this.groupSettings.proposals[g].expires_ms;for(let a of this.form.invitees){let s=this.currentGroupId;try{await f("gi.actions/group/proposal",{contractID:s,data:{proposalType:g,proposalData:{memberName:a,reason:e.reason},votingRule:this.groupSettings.proposals[g].rule,expires_date_ms:n}})}catch(t){i=!0,console.error(`Invite to ${a} failed to be sent!`,t.message);break}}i||(this.ephemeral.currentStep+=1)}}}},M=function(){var e=this,i=e.$createElement,n=e._self._c||i;return n("proposal-template",{ref:"modalTemplate",attrs:{title:e.L("Add new members"),disabled:!e.ephemeral.isValid,maxSteps:e.config.steps.length,currentStep:e.ephemeral.currentStep,variant:e.shouldGenerateInvitesImmediately?"addMemberImmediate":"addMember"},on:{"update:currentStep":function(a){return e.$set(e.ephemeral,"currentStep",a)},"update:current-step":function(a){return e.$set(e.ephemeral,"currentStep",a)},submit:e.submit}},[e.ephemeral.currentStep===0?n("fieldset",{ref:"fieldset",staticClass:"c-fieldset",class:{"is-shifted":e.ephemeral.invitesCount>1}},[n("i18n",{staticClass:"label",attrs:{tag:"legend"}},[e._v("Full name")]),e._l(e.ephemeral.invitesCount,function(a,s){return n("div",{key:"member-"+s,staticClass:"field c-fields-item",attrs:{"data-test":"invitee"}},[n("i18n",{staticClass:"label sr-only"},[e._v("Invitee name")]),n("div",{staticClass:"inputgroup"},[n("input",{directives:[{name:"model",rawName:"v-model",value:e.form.invitees[s],expression:"form.invitees[index]"}],staticClass:"input",attrs:{type:"text","aria-label":e.L("Full name"),"aria-required":"aria-required"},domProps:{value:e.form.invitees[s]},on:{keyup:function(t){return e.inviteeUpdate(t,s)},input:function(t){t.target.composing||e.$set(e.form.invitees,s,t.target.value)}}}),n("button",{staticClass:"is-icon-small is-btn-shifted",attrs:{type:"button","data-test":"remove","aria-label":e.L("Remove invitee")},on:{click:function(t){return e.removeInvitee(s)}}},[n("i",{staticClass:"icon-times"})])])],1)}),n("button",{staticClass:"link has-icon",attrs:{type:"button","data-test":"addInviteeSlot"},on:{click:e.addInviteeSlot}},[n("i",{staticClass:"icon-plus"}),n("i18n",[e._v("Add more")])],1)],2):e._e()])},U=[],F=function(e){e&&e("data-v-c4728296_0",{source:".c-fields-item[data-v-c4728296]{margin-bottom:1rem}.c-feedback[data-v-c4728296]{text-align:center}.c-fieldset .is-btn-shifted[data-v-c4728296]{display:none}.c-fieldset.is-shifted .is-btn-shifted[data-v-c4728296]{display:block}",map:void 0,media:void 0})},j="data-v-c4728296",q=void 0,B=!1;function Y(e,i,n,a,s,t,r,c,l,d){let o=(typeof n=="function"?n.options:n)||{};o.__file=`style>
`,o.render||(o.render=e.render,o.staticRenderFns=e.staticRenderFns,o._compiled=!0,s&&(o.functional=!0)),o._scopeId=a;{let h;if(i&&(h=r?function(u){i.call(this,d(u,this.$root.$options.shadowRoot))}:function(u){i.call(this,c(u))}),h!==void 0)if(o.functional){let u=o.render;o.render=function(R,w){return h.call(w),u(R,w)}}else{let u=o.beforeCreate;o.beforeCreate=u?[].concat(u,h):[h]}}return o}function v(){let e=v.styles||(v.styles={}),i=typeof navigator<"u"&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());return function(a,s){if(document.querySelector('style[data-vue-ssr-id~="'+a+'"]'))return;let t=i?s.media||"default":a,r=e[t]||(e[t]={ids:[],parts:[],element:void 0});if(!r.ids.includes(a)){let c=s.source,l=r.ids.length;if(r.ids.push(a),s.map&&(c+=`
/*# sourceURL=`+s.map.sources[0]+" */",c+=`
/*# sourceMappingURL=data:application/json;base64,`+btoa(unescape(encodeURIComponent(JSON.stringify(s.map))))+" */"),i&&(r.element=r.element||document.querySelector("style[data-group="+t+"]")),!r.element){let d=document.head||document.getElementsByTagName("head")[0],o=r.element=document.createElement("style");o.type="text/css",s.media&&o.setAttribute("media",s.media),i&&(o.setAttribute("data-group",t),o.setAttribute("data-next-index","0")),d.appendChild(o)}if(i&&(l=parseInt(r.element.getAttribute("data-next-index")),r.element.setAttribute("data-next-index",l+1)),r.element.styleSheet)r.parts.push(c),r.element.styleSheet.cssText=r.parts.filter(Boolean).join(`
`);else{let d=document.createTextNode(c),o=r.element.childNodes;o[l]&&r.element.removeChild(o[l]),o.length?r.element.insertBefore(d,o[l]):r.element.appendChild(d)}}}}var G=Y({render:M,staticRenderFns:U},F,L,j,B,q,!1,v,void 0,void 0),Te=G;export{Te as default};
//# sourceMappingURL=AddMembers-KUKQCU2G-cached.js.map
