import{a as T}from"./chunk-ARAZFESJ-cached.js";import{a as I}from"./chunk-SXKMOEKE-cached.js";import{a as E}from"./chunk-XK3SURHI-cached.js";import"./chunk-WP4ONFFS-cached.js";import{a as R}from"./chunk-WMVHT3GJ-cached.js";import{e as v,i as b}from"./chunk-VUYUNB2W-cached.js";import{a as S}from"./chunk-GA3LN23N-cached.js";import"./chunk-3VFZYJBQ-cached.js";import"./chunk-MEHASGB7-cached.js";import"./chunk-Z7X5SDSD-cached.js";import{I as y}from"./chunk-TEH4GFTX-cached.js";import"./chunk-QVCKPSEU-cached.js";import{a as x}from"./chunk-OMOH7TRL-cached.js";import{d as w}from"./chunk-WBBXU2FL-cached.js";import"./chunk-XMZXE55N-cached.js";var U={name:"AvatarEditorCanvas",mixins:[T()],data(){return{ephemeral:{image:{src:"",loaded:!1,intrinsic:{width:null,height:null,aspectRatio:null},onCanvas:{x:null,y:null,width:null,height:null}},canvas:{style:{width:null,height:null},onCanvas:{width:null,height:null,origin:{translation:{x:0,y:0},rotation:0}},boundingRect:null},clipCircle:{x:null,y:null,diameter:0}}}},props:{zoom:{type:Number,required:!1,default:1},imageUrl:{type:String,required:!1}},watch:{zoom(){this.calculate(),this.draw()}},computed:{...w(["isDarkTheme","colors"]),canvasCommonAttrs(){return{width:this.ephemeral.canvas.onCanvas.width,height:this.ephemeral.canvas.onCanvas.height}},isWiderThanTaller(){let e=this.ephemeral.image;return e.loaded&&e.intrinsic.aspectRatio<=1},onCanvasColors(){return{clipCircleBg:this.isDarkTheme?"rgba(46, 48, 50, 0.5)":"rgba(245, 245, 245, 0.5)",canvasBg:this.colors.general_2}}},methods:{onImageLoad(){let e=this.ephemeral.image,{naturalWidth:n,naturalHeight:t}=this.$refs.img;e.loaded=!0,e.intrinsic.width=n,e.intrinsic.height=t,e.intrinsic.aspectRatio=t/n,this.$refs.helperCanvas.width=512,this.$refs.helperCanvas.height=512,this.$nextTick(()=>{this.calculate(),this.draw()})},onWindowResize(){let e=window.devicePixelRatio||1,n=window.getComputedStyle(this.$el),t=i=>parseFloat(n.getPropertyValue(i));this.ephemeral.canvas.style.width=`${t("width")}px`,this.ephemeral.canvas.style.height=`${t("height")}px`,this.ephemeral.canvas.onCanvas.width=t("width")*e,this.ephemeral.canvas.onCanvas.height=t("height")*e,this.ephemeral.image.loaded&&this.$nextTick(()=>{this.calculate(),this.draw()})},calculate(e=!1){let{image:n,clipCircle:t}=this.ephemeral,i=this.ephemeral.canvas.onCanvas,o={x:i.width/2,y:i.height/2};n.onCanvas.width=i.height*(1/n.intrinsic.aspectRatio),n.onCanvas.height=i.height,this.isWiderThanTaller?(t.diameter=i.height,t.x=o.x-t.diameter/2,t.y=0):(t.diameter=n.onCanvas.width,t.x=o.x-t.diameter/2,t.y=o.y-t.diameter/2),this.zoom>1&&(n.onCanvas.width*=this.zoom,n.onCanvas.height*=this.zoom),n.onCanvas.x=-1*(n.onCanvas.width/2),n.onCanvas.y=-1*(n.onCanvas.height/2),this.adjustOriginTranslation()},draw(){let e=this.$refs.canvas.getContext("2d"),n=this.ephemeral.image.onCanvas,t=this.ephemeral.canvas.onCanvas,i=this.ephemeral.clipCircle,o=i.diameter/2,r={x:t.width/2,y:t.height/2};e.clearRect(0,0,t.width,t.height),e.fillStyle=this.onCanvasColors.canvasBg,e.fillRect(0,0,t.width,t.height),e.save(),e.translate(r.x+t.origin.translation.x,r.y+t.origin.translation.y),e.drawImage(this.$refs.img,n.x,n.y,n.width,n.height),e.restore();let a=this.$refs.clip.getContext("2d");a.clearRect(0,0,t.width,t.height),a.fillStyle=this.onCanvasColors.clipCircleBg,a.fillRect(0,0,t.width,t.height),a.beginPath(),a.moveTo(r.x+o,r.y),a.arc(r.x,r.y,o,0,Math.PI*2,!0),a.save(),a.clip(),a.drawImage(this.$refs.canvas,i.x,i.y,i.diameter,i.diameter,i.x,i.y,i.diameter,i.diameter),a.restore()},extractEditedImage(){let{canvas:e,helperCanvas:n}=this.$refs,{clipCircle:t}=this.ephemeral;return n.getContext("2d").drawImage(e,t.x,t.y,t.diameter,t.diameter,0,0,n.width,n.height),E(n.toDataURL("image/jpeg"))},translate({x:e=0,y:n=0}){this.ephemeral.canvas.onCanvas.origin.translation.x+=e,this.ephemeral.canvas.onCanvas.origin.translation.y+=n,this.adjustOriginTranslation(),this.draw()},adjustOriginTranslation(){let{canvas:e,clipCircle:n}=this.ephemeral,t=this.ephemeral.image.onCanvas,i=e.onCanvas.origin.translation,o={x:e.onCanvas.width/2,y:e.onCanvas.height/2},r={x:o.x+i.x+t.x,y:o.y+i.y+t.y},a={x:r.x+t.width,y:r.y+t.height};r.x>n.x?i.x-=r.x-n.x:a.x<n.x+n.diameter&&(i.x+=n.x+n.diameter-a.x),r.y>n.y?i.y-=r.y-n.y:a.y<n.y+n.diameter&&(i.y+=n.y+n.diameter-a.y)}},created(){this.ephemeral.image.src=this.imageUrl||this.$route.query.imageUrl||""},mounted(){this.onWindowResize(),window.addEventListener("resize",this.onWindowResize)},beforeDestroy(){window.removeEventListener("resize",this.onWindowResize)}},L=function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("div",{staticClass:"c-editor-canvas",on:{wheel:function(i){return i.preventDefault(),e.$emit("pointer-wheel",i)}}},[e.ephemeral.image.loaded?[t("canvas",e._b({ref:"canvas",staticClass:"c-canvas bottom",style:e.ephemeral.canvas.style,attrs:{"data-test":"imageCanvas"}},"canvas",e.canvasCommonAttrs,!1)),t("canvas",e._b({ref:"clip",staticClass:"c-canvas top",style:e.ephemeral.canvas.style},"canvas",e.canvasCommonAttrs,!1))]:e._e(),t("div",{staticClass:"c-invisible-utils"},[t("img",{ref:"img",attrs:{"data-test":"imageHelperTag",src:e.ephemeral.image.src},on:{load:e.onImageLoad}}),t("canvas",{ref:"helperCanvas",staticClass:"c-canvas-img-extract"})])],2)},k=[],O=function(e){e&&e("data-v-584f7981_0",{source:".c-editor-canvas[data-v-584f7981]{position:relative;display:block;width:100%;height:15.625rem;overflow:hidden;cursor:move}.c-canvas[data-v-584f7981]{position:absolute;touch-action:none;top:0;left:0}.c-canvas.bottom[data-v-584f7981]{filter:brightness(.8) blur(4px)}.c-invisible-utils[data-v-584f7981]{position:absolute;width:1px;height:1px;top:-10rem;left:-10rem;pointer-events:none;overflow:hidden}.c-canvas-img-extract[data-v-584f7981]{position:absolute}",map:void 0,media:void 0})},j="data-v-584f7981",z=void 0,D=!1;function N(e,n,t,i,o,r,a,c,d,m){let s=(typeof t=="function"?t.options:t)||{};s.__file=`style>
`,s.render||(s.render=e.render,s.staticRenderFns=e.staticRenderFns,s._compiled=!0,o&&(s.functional=!0)),s._scopeId=i;{let h;if(n&&(h=a?function(l){n.call(this,m(l,this.$root.$options.shadowRoot))}:function(l){n.call(this,c(l))}),h!==void 0)if(s.functional){let l=s.render;s.render=function(f,u){return h.call(u),l(f,u)}}else{let l=s.beforeCreate;s.beforeCreate=l?[].concat(l,h):[h]}}return s}function _(){let e=_.styles||(_.styles={}),n=typeof navigator<"u"&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());return function(i,o){if(document.querySelector('style[data-vue-ssr-id~="'+i+'"]'))return;let r=n?o.media||"default":i,a=e[r]||(e[r]={ids:[],parts:[],element:void 0});if(!a.ids.includes(i)){let c=o.source,d=a.ids.length;if(a.ids.push(i),o.map&&(c+=`
/*# sourceURL=`+o.map.sources[0]+" */",c+=`
/*# sourceMappingURL=data:application/json;base64,`+btoa(unescape(encodeURIComponent(JSON.stringify(o.map))))+" */"),n&&(a.element=a.element||document.querySelector("style[data-group="+r+"]")),!a.element){let m=document.head||document.getElementsByTagName("head")[0],s=a.element=document.createElement("style");s.type="text/css",o.media&&s.setAttribute("media",o.media),n&&(s.setAttribute("data-group",r),s.setAttribute("data-next-index","0")),m.appendChild(s)}if(n&&(d=parseInt(a.element.getAttribute("data-next-index")),a.element.setAttribute("data-next-index",d+1)),a.element.styleSheet)a.parts.push(c),a.element.styleSheet.cssText=a.parts.filter(Boolean).join(`
`);else{let m=document.createTextNode(c),s=a.element.childNodes;s[d]&&a.element.removeChild(s[d]),s.length?a.element.insertBefore(m,s[d]):a.element.appendChild(m)}}}}var B=N({render:L,staticRenderFns:k},O,U,j,D,z,!1,_,void 0,void 0),$=B;var W=b([0,100],[1,5]),q={name:"AvatarEditor",components:{ModalTemplate:S,ButtonSubmit:R,SliderContinuous:I,EditorCanvas:$},data(){return{config:{sliderMin:0,sliderMax:100},form:{slider:0},ephemeral:{replaceImageUrl:"",canvasComponentKey:v(10)}}},computed:{zoom(){return W(this.form.slider)}},methods:{close(){this.$refs.modal.close()},onReplacePhotoClick(){this.$refs.replacePhotoInput.click()},submit(){let e=this.$refs.editorCanvas.extractEditedImage();x("okTurtles.events/emit",y,{blob:e,avatarType:this.$route.query.avatarType||""}),this.close()},onSliderInput(e){this.form.slider=parseFloat(e.target.value)},incrementSlider(e=1){this.form.slider=Math.min(100,this.form.slider+e),this.$refs.slider.updateSlider(this.form.slider)},decrementSlider(e=1){this.form.slider=Math.max(0,this.form.slider-e),this.$refs.slider.updateSlider(this.form.slider)},HandleWheelOnCanvas({deltaY:e}){e<0?this.incrementSlider(3):this.decrementSlider(3)},loadPhotoChange(e){e.length&&(this.ephemeral.replaceImageUrl&&URL.revokeObjectURL(this.ephemeral.replaceImageUrl),this.ephemeral.replaceImageUrl=URL.createObjectURL(e[0]),this.form.slider=0,this.ephemeral.canvasComponentKey=v(10))}}},V=function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("modal-template",{ref:"modal",staticClass:"is-centered",attrs:{"data-test":"AvatarEditorModal",a11yTitle:e.L("Edit avatar")}},[t("template",{slot:"title"},[t("i18n",[e._v("Edit avatar")])],1),t("input",{ref:"replacePhotoInput",staticClass:"sr-only",attrs:{type:"file",name:"load-photo",accept:"image/*","data-test-id":"replacePhotoInput"},on:{change:function(i){return e.loadPhotoChange(i.target.files)}}}),t("form",{staticClass:"c-form",on:{submit:function(i){i.preventDefault()}}},[t("editor-canvas",{key:e.ephemeral.canvasComponentKey,ref:"editorCanvas",staticClass:"c-canvas-container",attrs:{zoom:e.zoom,imageUrl:e.ephemeral.replaceImageUrl},on:{"pointer-wheel":e.HandleWheelOnCanvas,"pinch-in":function(i){return e.decrementSlider(4)},"pinch-out":function(i){return e.incrementSlider(4)}}}),t("div",{staticClass:"c-slider-container"},[t("button",{staticClass:"is-icon-small",on:{pointerdown:function(i){return e.decrementSlider()}}},[t("i",{staticClass:"icon-magnifying-minus"})]),t("slider-continuous",{key:e.ephemeral.canvasComponentKey+"-slider",ref:"slider",staticClass:"c-slider",attrs:{hideText:!0,uid:"avatar-zoom",min:e.config.sliderMin,max:e.config.sliderMax,value:e.form.slider},on:{input:e.onSliderInput}}),t("button",{staticClass:"is-icon-small",on:{pointerdown:function(i){return e.incrementSlider()}}},[t("i",{staticClass:"icon-magnifying-plus"})])],1),t("i18n",{staticClass:"has-text-1 hide-touch-device",attrs:{tag:"p"}},[e._v("Click and drag to reposition")]),t("i18n",{staticClass:"has-text-1 hide-hoverable-device",attrs:{tag:"p"}},[e._v("Pinch to zoom, drag to reposition")]),t("div",{staticClass:"buttons"},[t("i18n",{staticClass:"is-outlined",attrs:{tag:"button"},on:{click:e.onReplacePhotoClick}},[e._v("Replace photo")]),t("button-submit",{key:"save",attrs:{"data-test":"saveBtn"},on:{click:e.submit}},[t("i18n",[e._v("Save")])],1)],1)],1)],2)},X=[],G=function(e){e&&e("data-v-9e1a4db6_0",{source:".c-form[data-v-9e1a4db6]{max-width:25rem;width:100%;margin:0 auto}.c-canvas-container[data-v-9e1a4db6]{position:relative;opacity:.7;height:15.625rem;margin-bottom:.5rem}.c-slider-container[data-v-9e1a4db6]{position:relative;display:flex;flex-direction:row;align-items:center;justify-content:space-between;width:100%;gap:.5rem;margin-bottom:.5rem}.buttons[data-v-9e1a4db6]{margin-top:2rem}.c-slider[data-v-9e1a4db6]{flex-grow:1}.c-slider[data-v-9e1a4db6]  .marks{margin-top:-.5rem}",map:void 0,media:void 0})},H="data-v-9e1a4db6",Z=void 0,K=!1;function J(e,n,t,i,o,r,a,c,d,m){let s=(typeof t=="function"?t.options:t)||{};s.__file=`style>
`,s.render||(s.render=e.render,s.staticRenderFns=e.staticRenderFns,s._compiled=!0,o&&(s.functional=!0)),s._scopeId=i;{let h;if(n&&(h=a?function(l){n.call(this,m(l,this.$root.$options.shadowRoot))}:function(l){n.call(this,c(l))}),h!==void 0)if(s.functional){let l=s.render;s.render=function(f,u){return h.call(u),l(f,u)}}else{let l=s.beforeCreate;s.beforeCreate=l?[].concat(l,h):[h]}}return s}function C(){let e=C.styles||(C.styles={}),n=typeof navigator<"u"&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());return function(i,o){if(document.querySelector('style[data-vue-ssr-id~="'+i+'"]'))return;let r=n?o.media||"default":i,a=e[r]||(e[r]={ids:[],parts:[],element:void 0});if(!a.ids.includes(i)){let c=o.source,d=a.ids.length;if(a.ids.push(i),o.map&&(c+=`
/*# sourceURL=`+o.map.sources[0]+" */",c+=`
/*# sourceMappingURL=data:application/json;base64,`+btoa(unescape(encodeURIComponent(JSON.stringify(o.map))))+" */"),n&&(a.element=a.element||document.querySelector("style[data-group="+r+"]")),!a.element){let m=document.head||document.getElementsByTagName("head")[0],s=a.element=document.createElement("style");s.type="text/css",o.media&&s.setAttribute("media",o.media),n&&(s.setAttribute("data-group",r),s.setAttribute("data-next-index","0")),m.appendChild(s)}if(n&&(d=parseInt(a.element.getAttribute("data-next-index")),a.element.setAttribute("data-next-index",d+1)),a.element.styleSheet)a.parts.push(c),a.element.styleSheet.cssText=a.parts.filter(Boolean).join(`
`);else{let m=document.createTextNode(c),s=a.element.childNodes;s[d]&&a.element.removeChild(s[d]),s.length?a.element.insertBefore(m,s[d]):a.element.appendChild(m)}}}}var Q=J({render:V,staticRenderFns:X},G,q,H,K,Z,!1,C,void 0,void 0),ue=Q;export{ue as default};
//# sourceMappingURL=AvatarEditorModal-HMUJCFRM-cached.js.map
