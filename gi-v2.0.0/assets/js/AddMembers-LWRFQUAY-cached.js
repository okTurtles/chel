import{a as C}from"./chunk-NGBII4BC-cached.js";import"./chunk-GB4D3I4D-cached.js";import"./chunk-Q5WT7Z5S-cached.js";import{c as E,e as K,h as m,i as b,m as D,n as p}from"./chunk-MA76ZROG-cached.js";import"./chunk-YMRJBWFE-cached.js";import"./chunk-YN7ARXYA-cached.js";import"./chunk-MMWHE4QG-cached.js";import{c as A}from"./chunk-3V7YD6RE-cached.js";import{a as _,c as P}from"./chunk-AZT5ZK4I-cached.js";import"./chunk-QD6O46IB-cached.js";import"./chunk-LIW6QCF4-cached.js";import"./chunk-WMVHT3GJ-cached.js";import"./chunk-VUYUNB2W-cached.js";import{j as g}from"./chunk-SZPI64OI-cached.js";import{a as z}from"./chunk-FTWBMR5D-cached.js";import"./chunk-BZWIYGWR-cached.js";import"./chunk-SVSS5DEP-cached.js";import"./chunk-MEHASGB7-cached.js";import"./chunk-Z7X5SDSD-cached.js";import"./chunk-M3EDVPDK-cached.js";import"./chunk-33M5GGRR-cached.js";import{a as f}from"./chunk-OMOH7TRL-cached.js";import{b as I,d as S}from"./chunk-WBBXU2FL-cached.js";import{e as R}from"./chunk-XMZXE55N-cached.js";P();var x=R(z());var pe=Number.parseInt("",10)||1/0,y=(e,i)=>e._vm?.authorizedKeys&&Object.values(e._vm.authorizedKeys).find(r=>r.name===i&&r._notAfterHeight==null)?.id;var k=(e,i,r,a,s)=>e._vm?.authorizedKeys&&Object.values(e._vm.authorizedKeys).filter(t=>t._notAfterHeight==null&&t.ringLevel<=(a??Number.POSITIVE_INFINITY)&&f("chelonia/haveSecretKey",t.id)&&(Array.isArray(i)?i.reduce((n,c)=>n&&(t.permissions==="*"||t.permissions.includes(c)),!0):i===t.permissions)&&r.reduce((n,c)=>n&&t.purpose.includes(c),!0)&&(Array.isArray(s)?s.reduce((n,c)=>n&&(t.allowedActions==="*"||!!t.allowedActions?.includes(c)),!0):s?s===t.allowedActions:!0)).sort((t,n)=>n.ringLevel-t.ringLevel)[0]?.id;async function O({contractID:e,quantity:i=1,creatorID:r,expires:a,invitee:s}){let t=await f("chelonia/contract/state",e);if(!t||!t._vm||!k(t,"*",["sig"])||t._volatile?.pendingKeyRequests?.length)throw new Error("Invalid or missing current group state");let n=y(t,"cek"),c=y(t,"csk");if(!n||!c)throw new Error("Contract is missing a CEK or CSK");let l=K(E),d=b(l),o=m(l,!1),h=D(t,n,m(l,!0));return await f("chelonia/out/keyAdd",{contractID:e,contractName:"gi.contracts/group",data:[{id:d,name:"#inviteKey-"+d,purpose:["sig"],ringLevel:Number.MAX_SAFE_INTEGER,permissions:[p.OP_KEY_REQUEST],meta:{quantity:i,expires:Date.now()+A*a,private:{content:h}},data:o}],signingKeyId:c}),{inviteKeyId:d,creatorID:r,invitee:s}}var N={name:"AddMembers",mixins:[x.validationMixin],components:{ProposalTemplate:C},data(){return{form:{invitees:[]},ephemeral:{currentStep:0,isValid:!1,invitesCount:1},config:{steps:["Member"]}}},computed:{...I(["currentGroupId","loggedIn"]),...S(["ourIdentityContractId","currentGroupState","currentWelcomeInvite","groupShouldPropose","groupSettings"]),shouldGenerateInvitesImmediately(){return this.currentWelcomeInvite.expires<Date.now()&&!this.groupShouldPropose}},methods:{inviteeUpdate(e,i){e.target.value.length>0&&!this.ephemeral.isValid&&(this.ephemeral.isValid=!0),e.target.value.length===0&&this.ephemeral.invitesCount===1&&this.ephemeral.isValid&&(this.ephemeral.isValid=!1)},removeInvitee(e){this.ephemeral.invitesCount-=1,this.form.invitees.splice(e,1)},addInviteeSlot(e){this.ephemeral.invitesCount+=1,_.nextTick(()=>{let i=this.$refs.fieldset.getElementsByTagName("label"),r=i[i.length-1];r&&r.focus()})},async generateInviteImmediately(){let e=this.currentGroupId;for(let i of this.form.invitees)try{let r=await O({contractID:e,invitee:i,creatorID:this.ourIdentityContractId,expires:this.groupSettings.inviteExpiryProposal});await f("gi.actions/group/invite",{contractID:e,data:r})}catch(r){console.error(`Invite to ${i} failed to be sent!`,r?.message);break}},async submit(e){if(this.shouldGenerateInvitesImmediately)await this.generateInviteImmediately(),this.$refs.modalTemplate.close();else{let i=!1,r=Date.now()+this.groupSettings.proposals[g].expires_ms;for(let a of this.form.invitees){let s=this.currentGroupId;try{await f("gi.actions/group/proposal",{contractID:s,data:{proposalType:g,proposalData:{memberName:a,reason:e.reason},votingRule:this.groupSettings.proposals[g].rule,expires_date_ms:r}})}catch(t){i=!0,console.error(`Invite to ${a} failed to be sent!`,t.message);break}}i||(this.ephemeral.currentStep+=1)}}}},L=function(){var e=this,i=e.$createElement,r=e._self._c||i;return r("proposal-template",{ref:"modalTemplate",attrs:{title:e.L("Add new members"),disabled:!e.ephemeral.isValid,maxSteps:e.config.steps.length,currentStep:e.ephemeral.currentStep,variant:e.shouldGenerateInvitesImmediately?"addMemberImmediate":"addMember"},on:{"update:currentStep":function(a){return e.$set(e.ephemeral,"currentStep",a)},"update:current-step":function(a){return e.$set(e.ephemeral,"currentStep",a)},submit:e.submit}},[e.ephemeral.currentStep===0?r("fieldset",{ref:"fieldset",staticClass:"c-fieldset",class:{"is-shifted":e.ephemeral.invitesCount>1}},[r("i18n",{staticClass:"label",attrs:{tag:"legend"}},[e._v("Full name")]),e._l(e.ephemeral.invitesCount,function(a,s){return r("div",{key:"member-"+s,staticClass:"field c-fields-item",attrs:{"data-test":"invitee"}},[r("i18n",{staticClass:"label sr-only"},[e._v("Invitee name")]),r("div",{staticClass:"inputgroup"},[r("input",{directives:[{name:"model",rawName:"v-model",value:e.form.invitees[s],expression:"form.invitees[index]"}],staticClass:"input",attrs:{type:"text","aria-label":e.L("Full name"),"aria-required":"aria-required"},domProps:{value:e.form.invitees[s]},on:{keyup:function(t){return e.inviteeUpdate(t,s)},input:function(t){t.target.composing||e.$set(e.form.invitees,s,t.target.value)}}}),r("button",{staticClass:"is-icon-small is-btn-shifted",attrs:{type:"button","data-test":"remove","aria-label":e.L("Remove invitee")},on:{click:function(t){return e.removeInvitee(s)}}},[r("i",{staticClass:"icon-times"})])])],1)}),r("button",{staticClass:"link has-icon",attrs:{type:"button","data-test":"addInviteeSlot"},on:{click:e.addInviteeSlot}},[r("i",{staticClass:"icon-plus"}),r("i18n",[e._v("Add more")])],1)],2):e._e()])},T=[],M=function(e){e&&e("data-v-c4728296_0",{source:".c-fields-item[data-v-c4728296]{margin-bottom:1rem}.c-feedback[data-v-c4728296]{text-align:center}.c-fieldset .is-btn-shifted[data-v-c4728296]{display:none}.c-fieldset.is-shifted .is-btn-shifted[data-v-c4728296]{display:block}",map:void 0,media:void 0})},U="data-v-c4728296",j=void 0,F=!1;function q(e,i,r,a,s,t,n,c,l,d){let o=(typeof r=="function"?r.options:r)||{};o.__file=`style>
`,o.render||(o.render=e.render,o.staticRenderFns=e.staticRenderFns,o._compiled=!0,s&&(o.functional=!0)),o._scopeId=a;{let h;if(i&&(h=n?function(u){i.call(this,d(u,this.$root.$options.shadowRoot))}:function(u){i.call(this,c(u))}),h!==void 0)if(o.functional){let u=o.render;o.render=function($,w){return h.call(w),u($,w)}}else{let u=o.beforeCreate;o.beforeCreate=u?[].concat(u,h):[h]}}return o}function v(){let e=v.styles||(v.styles={}),i=typeof navigator<"u"&&/msie [6-9]\\b/.test(navigator.userAgent.toLowerCase());return function(a,s){if(document.querySelector('style[data-vue-ssr-id~="'+a+'"]'))return;let t=i?s.media||"default":a,n=e[t]||(e[t]={ids:[],parts:[],element:void 0});if(!n.ids.includes(a)){let c=s.source,l=n.ids.length;if(n.ids.push(a),s.map&&(c+=`
/*# sourceURL=`+s.map.sources[0]+" */",c+=`
/*# sourceMappingURL=data:application/json;base64,`+btoa(unescape(encodeURIComponent(JSON.stringify(s.map))))+" */"),i&&(n.element=n.element||document.querySelector("style[data-group="+t+"]")),!n.element){let d=document.head||document.getElementsByTagName("head")[0],o=n.element=document.createElement("style");o.type="text/css",s.media&&o.setAttribute("media",s.media),i&&(o.setAttribute("data-group",t),o.setAttribute("data-next-index","0")),d.appendChild(o)}if(i&&(l=parseInt(n.element.getAttribute("data-next-index")),n.element.setAttribute("data-next-index",l+1)),n.element.styleSheet)n.parts.push(c),n.element.styleSheet.cssText=n.parts.filter(Boolean).join(`
`);else{let d=document.createTextNode(c),o=n.element.childNodes;o[l]&&n.element.removeChild(o[l]),o.length?n.element.insertBefore(d,o[l]):n.element.appendChild(d)}}}}var B=q({render:L,staticRenderFns:T},M,N,U,F,j,!1,v,void 0,void 0),ze=B;export{ze as default};
//# sourceMappingURL=AddMembers-LWRFQUAY-cached.js.map
