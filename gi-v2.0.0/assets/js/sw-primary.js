var Cf=Object.create;var _s=Object.defineProperty;var Nf=Object.getOwnPropertyDescriptor;var Df=Object.getOwnPropertyNames;var Rf=Object.getPrototypeOf,kf=Object.prototype.hasOwnProperty;var vs=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof require<"u"?require:t)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var zr=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),Qa=(e,t)=>{for(var r in t)_s(e,r,{get:t[r],enumerable:!0})},Pf=(e,t,r,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Df(t))!kf.call(e,o)&&o!==r&&_s(e,o,{get:()=>t[o],enumerable:!(n=Nf(t,o))||n.enumerable});return e};var Io=(e,t,r)=>(r=e!=null?Cf(Rf(e)):{},Pf(t||!e||!e.__esModule?_s(r,"default",{value:e,enumerable:!0}):r,e));var zs=zr((Ug,vc)=>{var nd="Input must be an string, Buffer or Uint8Array";function od(e){let t;if(e instanceof Uint8Array)t=e;else if(typeof e=="string")t=new TextEncoder().encode(e);else throw new Error(nd);return t}function id(e){return Array.prototype.map.call(e,function(t){return(t<16?"0":"")+t.toString(16)}).join("")}function Di(e){return(4294967296+e).toString(16).substring(1)}function sd(e,t,r){let n=`
`+e+" = ";for(let o=0;o<t.length;o+=2){if(r===32)n+=Di(t[o]).toUpperCase(),n+=" ",n+=Di(t[o+1]).toUpperCase();else if(r===64)n+=Di(t[o+1]).toUpperCase(),n+=Di(t[o]).toUpperCase();else throw new Error("Invalid size "+r);o%6===4?n+=`
`+new Array(e.length+4).join(" "):o<t.length-2&&(n+=" ")}console.log(n)}function ad(e,t,r){let n=new Date().getTime(),o=new Uint8Array(t);for(let s=0;s<t;s++)o[s]=s%256;let i=new Date().getTime();console.log("Generated random input in "+(i-n)+"ms"),n=i;for(let s=0;s<r;s++){let a=e(o),u=new Date().getTime(),f=u-n;n=u,console.log("Hashed in "+f+"ms: "+a.substring(0,20)+"..."),console.log(Math.round(t/(1<<20)/(f/1e3)*100)/100+" MB PER SECOND")}}vc.exports={normalizeInput:od,toHex:id,debugPrint:sd,testSpeed:ad}});var Pc=zr((Lg,kc)=>{var ki=zs();function Ri(e,t,r){let n=e[t]+e[r],o=e[t+1]+e[r+1];n>=4294967296&&o++,e[t]=n,e[t+1]=o}function Tc(e,t,r,n){let o=e[t]+r;r<0&&(o+=4294967296);let i=e[t+1]+n;o>=4294967296&&i++,e[t]=o,e[t+1]=i}function Ac(e,t){return e[t]^e[t+1]<<8^e[t+2]<<16^e[t+3]<<24}function hn(e,t,r,n,o,i){let s=Ao[o],a=Ao[o+1],u=Ao[i],f=Ao[i+1];Ri(Te,e,t),Tc(Te,e,s,a);let d=Te[n]^Te[e],h=Te[n+1]^Te[e+1];Te[n]=h,Te[n+1]=d,Ri(Te,r,n),d=Te[t]^Te[r],h=Te[t+1]^Te[r+1],Te[t]=d>>>24^h<<8,Te[t+1]=h>>>24^d<<8,Ri(Te,e,t),Tc(Te,e,u,f),d=Te[n]^Te[e],h=Te[n+1]^Te[e+1],Te[n]=d>>>16^h<<16,Te[n+1]=h>>>16^d<<16,Ri(Te,r,n),d=Te[t]^Te[r],h=Te[t+1]^Te[r+1],Te[t]=h>>>31^d<<1,Te[t+1]=d>>>31^h<<1}var Oc=new Uint32Array([4089235720,1779033703,2227873595,3144134277,4271175723,1013904242,1595750129,2773480762,2917565137,1359893119,725511199,2600822924,4215389547,528734635,327033209,1541459225]),cd=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3],Bt=new Uint8Array(cd.map(function(e){return e*2})),Te=new Uint32Array(32),Ao=new Uint32Array(32);function Cc(e,t){let r=0;for(r=0;r<16;r++)Te[r]=e.h[r],Te[r+16]=Oc[r];for(Te[24]=Te[24]^e.t,Te[25]=Te[25]^e.t/4294967296,t&&(Te[28]=~Te[28],Te[29]=~Te[29]),r=0;r<32;r++)Ao[r]=Ac(e.b,4*r);for(r=0;r<12;r++)hn(0,8,16,24,Bt[r*16+0],Bt[r*16+1]),hn(2,10,18,26,Bt[r*16+2],Bt[r*16+3]),hn(4,12,20,28,Bt[r*16+4],Bt[r*16+5]),hn(6,14,22,30,Bt[r*16+6],Bt[r*16+7]),hn(0,10,20,30,Bt[r*16+8],Bt[r*16+9]),hn(2,12,22,24,Bt[r*16+10],Bt[r*16+11]),hn(4,14,16,26,Bt[r*16+12],Bt[r*16+13]),hn(6,8,18,28,Bt[r*16+14],Bt[r*16+15]);for(r=0;r<16;r++)e.h[r]=e.h[r]^Te[r]^Te[r+16]}var gn=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);function Nc(e,t,r,n){if(e===0||e>64)throw new Error("Illegal output length, expected 0 < length <= 64");if(t&&t.length>64)throw new Error("Illegal key, expected Uint8Array with 0 < length <= 64");if(r&&r.length!==16)throw new Error("Illegal salt, expected Uint8Array with length is 16");if(n&&n.length!==16)throw new Error("Illegal personal, expected Uint8Array with length is 16");let o={b:new Uint8Array(128),h:new Uint32Array(16),t:0,c:0,outlen:e};gn.fill(0),gn[0]=e,t&&(gn[1]=t.length),gn[2]=1,gn[3]=1,r&&gn.set(r,32),n&&gn.set(n,48);for(let i=0;i<16;i++)o.h[i]=Oc[i]^Ac(gn,i*4);return t&&(Ys(o,t),o.c=128),o}function Ys(e,t){for(let r=0;r<t.length;r++)e.c===128&&(e.t+=e.c,Cc(e,!1),e.c=0),e.b[e.c++]=t[r]}function Dc(e){for(e.t+=e.c;e.c<128;)e.b[e.c++]=0;Cc(e,!0);let t=new Uint8Array(e.outlen);for(let r=0;r<e.outlen;r++)t[r]=e.h[r>>2]>>8*(r&3);return t}function Rc(e,t,r,n,o){r=r||64,e=ki.normalizeInput(e),n&&(n=ki.normalizeInput(n)),o&&(o=ki.normalizeInput(o));let i=Nc(r,t,n,o);return Ys(i,e),Dc(i)}function ud(e,t,r,n,o){let i=Rc(e,t,r,n,o);return ki.toHex(i)}kc.exports={blake2b:Rc,blake2bHex:ud,blake2bInit:Nc,blake2bUpdate:Ys,blake2bFinal:Dc}});var Gc=zr((Fg,$c)=>{var Kc=zs();function ld(e,t){return e[t]^e[t+1]<<8^e[t+2]<<16^e[t+3]<<24}function yn(e,t,r,n,o,i){Be[e]=Be[e]+Be[t]+o,Be[n]=Pi(Be[n]^Be[e],16),Be[r]=Be[r]+Be[n],Be[t]=Pi(Be[t]^Be[r],12),Be[e]=Be[e]+Be[t]+i,Be[n]=Pi(Be[n]^Be[e],8),Be[r]=Be[r]+Be[n],Be[t]=Pi(Be[t]^Be[r],7)}function Pi(e,t){return e>>>t^e<<32-t}var Mc=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),$t=new Uint8Array([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0]),Be=new Uint32Array(16),Dt=new Uint32Array(16);function Uc(e,t){let r=0;for(r=0;r<8;r++)Be[r]=e.h[r],Be[r+8]=Mc[r];for(Be[12]^=e.t,Be[13]^=e.t/4294967296,t&&(Be[14]=~Be[14]),r=0;r<16;r++)Dt[r]=ld(e.b,4*r);for(r=0;r<10;r++)yn(0,4,8,12,Dt[$t[r*16+0]],Dt[$t[r*16+1]]),yn(1,5,9,13,Dt[$t[r*16+2]],Dt[$t[r*16+3]]),yn(2,6,10,14,Dt[$t[r*16+4]],Dt[$t[r*16+5]]),yn(3,7,11,15,Dt[$t[r*16+6]],Dt[$t[r*16+7]]),yn(0,5,10,15,Dt[$t[r*16+8]],Dt[$t[r*16+9]]),yn(1,6,11,12,Dt[$t[r*16+10]],Dt[$t[r*16+11]]),yn(2,7,8,13,Dt[$t[r*16+12]],Dt[$t[r*16+13]]),yn(3,4,9,14,Dt[$t[r*16+14]],Dt[$t[r*16+15]]);for(r=0;r<8;r++)e.h[r]^=Be[r]^Be[r+8]}function Lc(e,t){if(!(e>0&&e<=32))throw new Error("Incorrect output length, should be in [1, 32]");let r=t?t.length:0;if(t&&!(r>0&&r<=32))throw new Error("Incorrect key length, should be in [1, 32]");let n={h:new Uint32Array(Mc),b:new Uint8Array(64),c:0,t:0,outlen:e};return n.h[0]^=16842752^r<<8^e,r>0&&(Vs(n,t),n.c=64),n}function Vs(e,t){for(let r=0;r<t.length;r++)e.c===64&&(e.t+=e.c,Uc(e,!1),e.c=0),e.b[e.c++]=t[r]}function Fc(e){for(e.t+=e.c;e.c<64;)e.b[e.c++]=0;Uc(e,!0);let t=new Uint8Array(e.outlen);for(let r=0;r<e.outlen;r++)t[r]=e.h[r>>2]>>8*(r&3)&255;return t}function Bc(e,t,r){r=r||32,e=Kc.normalizeInput(e);let n=Lc(r,t);return Vs(n,e),Fc(n)}function fd(e,t,r){let n=Bc(e,t,r);return Kc.toHex(n)}$c.exports={blake2s:Bc,blake2sHex:fd,blake2sInit:Lc,blake2sUpdate:Vs,blake2sFinal:Fc}});var qs=zr((Bg,jc)=>{var Oo=Pc(),Co=Gc();jc.exports={blake2b:Oo.blake2b,blake2bHex:Oo.blake2bHex,blake2bInit:Oo.blake2bInit,blake2bUpdate:Oo.blake2bUpdate,blake2bFinal:Oo.blake2bFinal,blake2s:Co.blake2s,blake2sHex:Co.blake2sHex,blake2sInit:Co.blake2sInit,blake2sUpdate:Co.blake2sUpdate,blake2sFinal:Co.blake2sFinal}});var ou=zr(Mi=>{"use strict";Mi.byteLength=Vd;Mi.toByteArray=Wd;Mi.fromByteArray=Qd;var Ur=[],gr=[],Yd=typeof Uint8Array<"u"?Uint8Array:Array,Zs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(Rn=0,ru=Zs.length;Rn<ru;++Rn)Ur[Rn]=Zs[Rn],gr[Zs.charCodeAt(Rn)]=Rn;var Rn,ru;gr[45]=62;gr[95]=63;function nu(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");r===-1&&(r=t);var n=r===t?0:4-r%4;return[r,n]}function Vd(e){var t=nu(e),r=t[0],n=t[1];return(r+n)*3/4-n}function qd(e,t,r){return(t+r)*3/4-r}function Wd(e){var t,r=nu(e),n=r[0],o=r[1],i=new Yd(qd(e,n,o)),s=0,a=o>0?n-4:n,u;for(u=0;u<a;u+=4)t=gr[e.charCodeAt(u)]<<18|gr[e.charCodeAt(u+1)]<<12|gr[e.charCodeAt(u+2)]<<6|gr[e.charCodeAt(u+3)],i[s++]=t>>16&255,i[s++]=t>>8&255,i[s++]=t&255;return o===2&&(t=gr[e.charCodeAt(u)]<<2|gr[e.charCodeAt(u+1)]>>4,i[s++]=t&255),o===1&&(t=gr[e.charCodeAt(u)]<<10|gr[e.charCodeAt(u+1)]<<4|gr[e.charCodeAt(u+2)]>>2,i[s++]=t>>8&255,i[s++]=t&255),i}function Jd(e){return Ur[e>>18&63]+Ur[e>>12&63]+Ur[e>>6&63]+Ur[e&63]}function Xd(e,t,r){for(var n,o=[],i=t;i<r;i+=3)n=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(e[i+2]&255),o.push(Jd(n));return o.join("")}function Qd(e){for(var t,r=e.length,n=r%3,o=[],i=16383,s=0,a=r-n;s<a;s+=i)o.push(Xd(e,s,s+i>a?a:s+i));return n===1?(t=e[r-1],o.push(Ur[t>>2]+Ur[t<<4&63]+"==")):n===2&&(t=(e[r-2]<<8)+e[r-1],o.push(Ur[t>>10]+Ur[t>>4&63]+Ur[t<<2&63]+"=")),o.join("")}});var iu=zr(ea=>{ea.read=function(e,t,r,n,o){var i,s,a=o*8-n-1,u=(1<<a)-1,f=u>>1,d=-7,h=r?o-1:0,g=r?-1:1,E=e[t+h];for(h+=g,i=E&(1<<-d)-1,E>>=-d,d+=a;d>0;i=i*256+e[t+h],h+=g,d-=8);for(s=i&(1<<-d)-1,i>>=-d,d+=n;d>0;s=s*256+e[t+h],h+=g,d-=8);if(i===0)i=1-f;else{if(i===u)return s?NaN:(E?-1:1)*(1/0);s=s+Math.pow(2,n),i=i-f}return(E?-1:1)*s*Math.pow(2,i-n)};ea.write=function(e,t,r,n,o,i){var s,a,u,f=i*8-o-1,d=(1<<f)-1,h=d>>1,g=o===23?Math.pow(2,-24)-Math.pow(2,-77):0,E=n?0:i-1,w=n?1:-1,I=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=d):(s=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-s))<1&&(s--,u*=2),s+h>=1?t+=g/u:t+=g*Math.pow(2,1-h),t*u>=2&&(s++,u/=2),s+h>=d?(a=0,s=d):s+h>=1?(a=(t*u-1)*Math.pow(2,o),s=s+h):(a=t*Math.pow(2,h-1)*Math.pow(2,o),s=0));o>=8;e[r+E]=a&255,E+=w,a/=256,o-=8);for(s=s<<o|a,f+=o;f>0;e[r+E]=s&255,E+=w,s/=256,f-=8);e[r+E-w]|=I*128}});var Iu=zr(io=>{"use strict";var ta=ou(),no=iu(),su=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;io.Buffer=K;io.SlowBuffer=op;io.INSPECT_MAX_BYTES=50;var Ui=2147483647;io.kMaxLength=Ui;K.TYPED_ARRAY_SUPPORT=Zd();!K.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function Zd(){try{let e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),e.foo()===42}catch{return!1}}Object.defineProperty(K.prototype,"parent",{enumerable:!0,get:function(){if(K.isBuffer(this))return this.buffer}});Object.defineProperty(K.prototype,"offset",{enumerable:!0,get:function(){if(K.isBuffer(this))return this.byteOffset}});function Wr(e){if(e>Ui)throw new RangeError('The value "'+e+'" is invalid for option "size"');let t=new Uint8Array(e);return Object.setPrototypeOf(t,K.prototype),t}function K(e,t,r){if(typeof e=="number"){if(typeof t=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return ia(e)}return lu(e,t,r)}K.poolSize=8192;function lu(e,t,r){if(typeof e=="string")return tp(e,t);if(ArrayBuffer.isView(e))return rp(e);if(e==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(Lr(e,ArrayBuffer)||e&&Lr(e.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(Lr(e,SharedArrayBuffer)||e&&Lr(e.buffer,SharedArrayBuffer)))return na(e,t,r);if(typeof e=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let n=e.valueOf&&e.valueOf();if(n!=null&&n!==e)return K.from(n,t,r);let o=np(e);if(o)return o;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof e[Symbol.toPrimitive]=="function")return K.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}K.from=function(e,t,r){return lu(e,t,r)};Object.setPrototypeOf(K.prototype,Uint8Array.prototype);Object.setPrototypeOf(K,Uint8Array);function fu(e){if(typeof e!="number")throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function ep(e,t,r){return fu(e),e<=0?Wr(e):t!==void 0?typeof r=="string"?Wr(e).fill(t,r):Wr(e).fill(t):Wr(e)}K.alloc=function(e,t,r){return ep(e,t,r)};function ia(e){return fu(e),Wr(e<0?0:sa(e)|0)}K.allocUnsafe=function(e){return ia(e)};K.allocUnsafeSlow=function(e){return ia(e)};function tp(e,t){if((typeof t!="string"||t==="")&&(t="utf8"),!K.isEncoding(t))throw new TypeError("Unknown encoding: "+t);let r=du(e,t)|0,n=Wr(r),o=n.write(e,t);return o!==r&&(n=n.slice(0,o)),n}function ra(e){let t=e.length<0?0:sa(e.length)|0,r=Wr(t);for(let n=0;n<t;n+=1)r[n]=e[n]&255;return r}function rp(e){if(Lr(e,Uint8Array)){let t=new Uint8Array(e);return na(t.buffer,t.byteOffset,t.byteLength)}return ra(e)}function na(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');let n;return t===void 0&&r===void 0?n=new Uint8Array(e):r===void 0?n=new Uint8Array(e,t):n=new Uint8Array(e,t,r),Object.setPrototypeOf(n,K.prototype),n}function np(e){if(K.isBuffer(e)){let t=sa(e.length)|0,r=Wr(t);return r.length===0||e.copy(r,0,0,t),r}if(e.length!==void 0)return typeof e.length!="number"||ca(e.length)?Wr(0):ra(e);if(e.type==="Buffer"&&Array.isArray(e.data))return ra(e.data)}function sa(e){if(e>=Ui)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+Ui.toString(16)+" bytes");return e|0}function op(e){return+e!=e&&(e=0),K.alloc(+e)}K.isBuffer=function(t){return t!=null&&t._isBuffer===!0&&t!==K.prototype};K.compare=function(t,r){if(Lr(t,Uint8Array)&&(t=K.from(t,t.offset,t.byteLength)),Lr(r,Uint8Array)&&(r=K.from(r,r.offset,r.byteLength)),!K.isBuffer(t)||!K.isBuffer(r))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(t===r)return 0;let n=t.length,o=r.length;for(let i=0,s=Math.min(n,o);i<s;++i)if(t[i]!==r[i]){n=t[i],o=r[i];break}return n<o?-1:o<n?1:0};K.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};K.concat=function(t,r){if(!Array.isArray(t))throw new TypeError('"list" argument must be an Array of Buffers');if(t.length===0)return K.alloc(0);let n;if(r===void 0)for(r=0,n=0;n<t.length;++n)r+=t[n].length;let o=K.allocUnsafe(r),i=0;for(n=0;n<t.length;++n){let s=t[n];if(Lr(s,Uint8Array))i+s.length>o.length?(K.isBuffer(s)||(s=K.from(s)),s.copy(o,i)):Uint8Array.prototype.set.call(o,s,i);else if(K.isBuffer(s))s.copy(o,i);else throw new TypeError('"list" argument must be an Array of Buffers');i+=s.length}return o};function du(e,t){if(K.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||Lr(e,ArrayBuffer))return e.byteLength;if(typeof e!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);let r=e.length,n=arguments.length>2&&arguments[2]===!0;if(!n&&r===0)return 0;let o=!1;for(;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return oa(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return r*2;case"hex":return r>>>1;case"base64":return xu(e).length;default:if(o)return n?-1:oa(e).length;t=(""+t).toLowerCase(),o=!0}}K.byteLength=du;function ip(e,t,r){let n=!1;if((t===void 0||t<0)&&(t=0),t>this.length||((r===void 0||r>this.length)&&(r=this.length),r<=0)||(r>>>=0,t>>>=0,r<=t))return"";for(e||(e="utf8");;)switch(e){case"hex":return gp(this,t,r);case"utf8":case"utf-8":return hu(this,t,r);case"ascii":return pp(this,t,r);case"latin1":case"binary":return hp(this,t,r);case"base64":return fp(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return yp(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}K.prototype._isBuffer=!0;function kn(e,t,r){let n=e[t];e[t]=e[r],e[r]=n}K.prototype.swap16=function(){let t=this.length;if(t%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let r=0;r<t;r+=2)kn(this,r,r+1);return this};K.prototype.swap32=function(){let t=this.length;if(t%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let r=0;r<t;r+=4)kn(this,r,r+3),kn(this,r+1,r+2);return this};K.prototype.swap64=function(){let t=this.length;if(t%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let r=0;r<t;r+=8)kn(this,r,r+7),kn(this,r+1,r+6),kn(this,r+2,r+5),kn(this,r+3,r+4);return this};K.prototype.toString=function(){let t=this.length;return t===0?"":arguments.length===0?hu(this,0,t):ip.apply(this,arguments)};K.prototype.toLocaleString=K.prototype.toString;K.prototype.equals=function(t){if(!K.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t?!0:K.compare(this,t)===0};K.prototype.inspect=function(){let t="",r=io.INSPECT_MAX_BYTES;return t=this.toString("hex",0,r).replace(/(.{2})/g,"$1 ").trim(),this.length>r&&(t+=" ... "),"<Buffer "+t+">"};su&&(K.prototype[su]=K.prototype.inspect);K.prototype.compare=function(t,r,n,o,i){if(Lr(t,Uint8Array)&&(t=K.from(t,t.offset,t.byteLength)),!K.isBuffer(t))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof t);if(r===void 0&&(r=0),n===void 0&&(n=t?t.length:0),o===void 0&&(o=0),i===void 0&&(i=this.length),r<0||n>t.length||o<0||i>this.length)throw new RangeError("out of range index");if(o>=i&&r>=n)return 0;if(o>=i)return-1;if(r>=n)return 1;if(r>>>=0,n>>>=0,o>>>=0,i>>>=0,this===t)return 0;let s=i-o,a=n-r,u=Math.min(s,a),f=this.slice(o,i),d=t.slice(r,n);for(let h=0;h<u;++h)if(f[h]!==d[h]){s=f[h],a=d[h];break}return s<a?-1:a<s?1:0};function pu(e,t,r,n,o){if(e.length===0)return-1;if(typeof r=="string"?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),r=+r,ca(r)&&(r=o?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(o)return-1;r=e.length-1}else if(r<0)if(o)r=0;else return-1;if(typeof t=="string"&&(t=K.from(t,n)),K.isBuffer(t))return t.length===0?-1:au(e,t,r,n,o);if(typeof t=="number")return t=t&255,typeof Uint8Array.prototype.indexOf=="function"?o?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):au(e,[t],r,n,o);throw new TypeError("val must be string, number or Buffer")}function au(e,t,r,n,o){let i=1,s=e.length,a=t.length;if(n!==void 0&&(n=String(n).toLowerCase(),n==="ucs2"||n==="ucs-2"||n==="utf16le"||n==="utf-16le")){if(e.length<2||t.length<2)return-1;i=2,s/=2,a/=2,r/=2}function u(d,h){return i===1?d[h]:d.readUInt16BE(h*i)}let f;if(o){let d=-1;for(f=r;f<s;f++)if(u(e,f)===u(t,d===-1?0:f-d)){if(d===-1&&(d=f),f-d+1===a)return d*i}else d!==-1&&(f-=f-d),d=-1}else for(r+a>s&&(r=s-a),f=r;f>=0;f--){let d=!0;for(let h=0;h<a;h++)if(u(e,f+h)!==u(t,h)){d=!1;break}if(d)return f}return-1}K.prototype.includes=function(t,r,n){return this.indexOf(t,r,n)!==-1};K.prototype.indexOf=function(t,r,n){return pu(this,t,r,n,!0)};K.prototype.lastIndexOf=function(t,r,n){return pu(this,t,r,n,!1)};function sp(e,t,r,n){r=Number(r)||0;let o=e.length-r;n?(n=Number(n),n>o&&(n=o)):n=o;let i=t.length;n>i/2&&(n=i/2);let s;for(s=0;s<n;++s){let a=parseInt(t.substr(s*2,2),16);if(ca(a))return s;e[r+s]=a}return s}function ap(e,t,r,n){return Li(oa(t,e.length-r),e,r,n)}function cp(e,t,r,n){return Li(wp(t),e,r,n)}function up(e,t,r,n){return Li(xu(t),e,r,n)}function lp(e,t,r,n){return Li(xp(t,e.length-r),e,r,n)}K.prototype.write=function(t,r,n,o){if(r===void 0)o="utf8",n=this.length,r=0;else if(n===void 0&&typeof r=="string")o=r,n=this.length,r=0;else if(isFinite(r))r=r>>>0,isFinite(n)?(n=n>>>0,o===void 0&&(o="utf8")):(o=n,n=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let i=this.length-r;if((n===void 0||n>i)&&(n=i),t.length>0&&(n<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");o||(o="utf8");let s=!1;for(;;)switch(o){case"hex":return sp(this,t,r,n);case"utf8":case"utf-8":return ap(this,t,r,n);case"ascii":case"latin1":case"binary":return cp(this,t,r,n);case"base64":return up(this,t,r,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return lp(this,t,r,n);default:if(s)throw new TypeError("Unknown encoding: "+o);o=(""+o).toLowerCase(),s=!0}};K.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function fp(e,t,r){return t===0&&r===e.length?ta.fromByteArray(e):ta.fromByteArray(e.slice(t,r))}function hu(e,t,r){r=Math.min(e.length,r);let n=[],o=t;for(;o<r;){let i=e[o],s=null,a=i>239?4:i>223?3:i>191?2:1;if(o+a<=r){let u,f,d,h;switch(a){case 1:i<128&&(s=i);break;case 2:u=e[o+1],(u&192)===128&&(h=(i&31)<<6|u&63,h>127&&(s=h));break;case 3:u=e[o+1],f=e[o+2],(u&192)===128&&(f&192)===128&&(h=(i&15)<<12|(u&63)<<6|f&63,h>2047&&(h<55296||h>57343)&&(s=h));break;case 4:u=e[o+1],f=e[o+2],d=e[o+3],(u&192)===128&&(f&192)===128&&(d&192)===128&&(h=(i&15)<<18|(u&63)<<12|(f&63)<<6|d&63,h>65535&&h<1114112&&(s=h))}}s===null?(s=65533,a=1):s>65535&&(s-=65536,n.push(s>>>10&1023|55296),s=56320|s&1023),n.push(s),o+=a}return dp(n)}var cu=4096;function dp(e){let t=e.length;if(t<=cu)return String.fromCharCode.apply(String,e);let r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=cu));return r}function pp(e,t,r){let n="";r=Math.min(e.length,r);for(let o=t;o<r;++o)n+=String.fromCharCode(e[o]&127);return n}function hp(e,t,r){let n="";r=Math.min(e.length,r);for(let o=t;o<r;++o)n+=String.fromCharCode(e[o]);return n}function gp(e,t,r){let n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);let o="";for(let i=t;i<r;++i)o+=Ip[e[i]];return o}function yp(e,t,r){let n=e.slice(t,r),o="";for(let i=0;i<n.length-1;i+=2)o+=String.fromCharCode(n[i]+n[i+1]*256);return o}K.prototype.slice=function(t,r){let n=this.length;t=~~t,r=r===void 0?n:~~r,t<0?(t+=n,t<0&&(t=0)):t>n&&(t=n),r<0?(r+=n,r<0&&(r=0)):r>n&&(r=n),r<t&&(r=t);let o=this.subarray(t,r);return Object.setPrototypeOf(o,K.prototype),o};function vt(e,t,r){if(e%1!==0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}K.prototype.readUintLE=K.prototype.readUIntLE=function(t,r,n){t=t>>>0,r=r>>>0,n||vt(t,r,this.length);let o=this[t],i=1,s=0;for(;++s<r&&(i*=256);)o+=this[t+s]*i;return o};K.prototype.readUintBE=K.prototype.readUIntBE=function(t,r,n){t=t>>>0,r=r>>>0,n||vt(t,r,this.length);let o=this[t+--r],i=1;for(;r>0&&(i*=256);)o+=this[t+--r]*i;return o};K.prototype.readUint8=K.prototype.readUInt8=function(t,r){return t=t>>>0,r||vt(t,1,this.length),this[t]};K.prototype.readUint16LE=K.prototype.readUInt16LE=function(t,r){return t=t>>>0,r||vt(t,2,this.length),this[t]|this[t+1]<<8};K.prototype.readUint16BE=K.prototype.readUInt16BE=function(t,r){return t=t>>>0,r||vt(t,2,this.length),this[t]<<8|this[t+1]};K.prototype.readUint32LE=K.prototype.readUInt32LE=function(t,r){return t=t>>>0,r||vt(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+this[t+3]*16777216};K.prototype.readUint32BE=K.prototype.readUInt32BE=function(t,r){return t=t>>>0,r||vt(t,4,this.length),this[t]*16777216+(this[t+1]<<16|this[t+2]<<8|this[t+3])};K.prototype.readBigUInt64LE=mn(function(t){t=t>>>0,oo(t,"offset");let r=this[t],n=this[t+7];(r===void 0||n===void 0)&&ko(t,this.length-8);let o=r+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24,i=this[++t]+this[++t]*2**8+this[++t]*2**16+n*2**24;return BigInt(o)+(BigInt(i)<<BigInt(32))});K.prototype.readBigUInt64BE=mn(function(t){t=t>>>0,oo(t,"offset");let r=this[t],n=this[t+7];(r===void 0||n===void 0)&&ko(t,this.length-8);let o=r*2**24+this[++t]*2**16+this[++t]*2**8+this[++t],i=this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+n;return(BigInt(o)<<BigInt(32))+BigInt(i)});K.prototype.readIntLE=function(t,r,n){t=t>>>0,r=r>>>0,n||vt(t,r,this.length);let o=this[t],i=1,s=0;for(;++s<r&&(i*=256);)o+=this[t+s]*i;return i*=128,o>=i&&(o-=Math.pow(2,8*r)),o};K.prototype.readIntBE=function(t,r,n){t=t>>>0,r=r>>>0,n||vt(t,r,this.length);let o=r,i=1,s=this[t+--o];for(;o>0&&(i*=256);)s+=this[t+--o]*i;return i*=128,s>=i&&(s-=Math.pow(2,8*r)),s};K.prototype.readInt8=function(t,r){return t=t>>>0,r||vt(t,1,this.length),this[t]&128?(255-this[t]+1)*-1:this[t]};K.prototype.readInt16LE=function(t,r){t=t>>>0,r||vt(t,2,this.length);let n=this[t]|this[t+1]<<8;return n&32768?n|4294901760:n};K.prototype.readInt16BE=function(t,r){t=t>>>0,r||vt(t,2,this.length);let n=this[t+1]|this[t]<<8;return n&32768?n|4294901760:n};K.prototype.readInt32LE=function(t,r){return t=t>>>0,r||vt(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24};K.prototype.readInt32BE=function(t,r){return t=t>>>0,r||vt(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]};K.prototype.readBigInt64LE=mn(function(t){t=t>>>0,oo(t,"offset");let r=this[t],n=this[t+7];(r===void 0||n===void 0)&&ko(t,this.length-8);let o=this[t+4]+this[t+5]*2**8+this[t+6]*2**16+(n<<24);return(BigInt(o)<<BigInt(32))+BigInt(r+this[++t]*2**8+this[++t]*2**16+this[++t]*2**24)});K.prototype.readBigInt64BE=mn(function(t){t=t>>>0,oo(t,"offset");let r=this[t],n=this[t+7];(r===void 0||n===void 0)&&ko(t,this.length-8);let o=(r<<24)+this[++t]*2**16+this[++t]*2**8+this[++t];return(BigInt(o)<<BigInt(32))+BigInt(this[++t]*2**24+this[++t]*2**16+this[++t]*2**8+n)});K.prototype.readFloatLE=function(t,r){return t=t>>>0,r||vt(t,4,this.length),no.read(this,t,!0,23,4)};K.prototype.readFloatBE=function(t,r){return t=t>>>0,r||vt(t,4,this.length),no.read(this,t,!1,23,4)};K.prototype.readDoubleLE=function(t,r){return t=t>>>0,r||vt(t,8,this.length),no.read(this,t,!0,52,8)};K.prototype.readDoubleBE=function(t,r){return t=t>>>0,r||vt(t,8,this.length),no.read(this,t,!1,52,8)};function er(e,t,r,n,o,i){if(!K.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>o||t<i)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}K.prototype.writeUintLE=K.prototype.writeUIntLE=function(t,r,n,o){if(t=+t,r=r>>>0,n=n>>>0,!o){let a=Math.pow(2,8*n)-1;er(this,t,r,n,a,0)}let i=1,s=0;for(this[r]=t&255;++s<n&&(i*=256);)this[r+s]=t/i&255;return r+n};K.prototype.writeUintBE=K.prototype.writeUIntBE=function(t,r,n,o){if(t=+t,r=r>>>0,n=n>>>0,!o){let a=Math.pow(2,8*n)-1;er(this,t,r,n,a,0)}let i=n-1,s=1;for(this[r+i]=t&255;--i>=0&&(s*=256);)this[r+i]=t/s&255;return r+n};K.prototype.writeUint8=K.prototype.writeUInt8=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,1,255,0),this[r]=t&255,r+1};K.prototype.writeUint16LE=K.prototype.writeUInt16LE=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,2,65535,0),this[r]=t&255,this[r+1]=t>>>8,r+2};K.prototype.writeUint16BE=K.prototype.writeUInt16BE=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,2,65535,0),this[r]=t>>>8,this[r+1]=t&255,r+2};K.prototype.writeUint32LE=K.prototype.writeUInt32LE=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,4,4294967295,0),this[r+3]=t>>>24,this[r+2]=t>>>16,this[r+1]=t>>>8,this[r]=t&255,r+4};K.prototype.writeUint32BE=K.prototype.writeUInt32BE=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,4,4294967295,0),this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=t&255,r+4};function gu(e,t,r,n,o){wu(t,n,o,e,r,7);let i=Number(t&BigInt(4294967295));e[r++]=i,i=i>>8,e[r++]=i,i=i>>8,e[r++]=i,i=i>>8,e[r++]=i;let s=Number(t>>BigInt(32)&BigInt(4294967295));return e[r++]=s,s=s>>8,e[r++]=s,s=s>>8,e[r++]=s,s=s>>8,e[r++]=s,r}function yu(e,t,r,n,o){wu(t,n,o,e,r,7);let i=Number(t&BigInt(4294967295));e[r+7]=i,i=i>>8,e[r+6]=i,i=i>>8,e[r+5]=i,i=i>>8,e[r+4]=i;let s=Number(t>>BigInt(32)&BigInt(4294967295));return e[r+3]=s,s=s>>8,e[r+2]=s,s=s>>8,e[r+1]=s,s=s>>8,e[r]=s,r+8}K.prototype.writeBigUInt64LE=mn(function(t,r=0){return gu(this,t,r,BigInt(0),BigInt("0xffffffffffffffff"))});K.prototype.writeBigUInt64BE=mn(function(t,r=0){return yu(this,t,r,BigInt(0),BigInt("0xffffffffffffffff"))});K.prototype.writeIntLE=function(t,r,n,o){if(t=+t,r=r>>>0,!o){let u=Math.pow(2,8*n-1);er(this,t,r,n,u-1,-u)}let i=0,s=1,a=0;for(this[r]=t&255;++i<n&&(s*=256);)t<0&&a===0&&this[r+i-1]!==0&&(a=1),this[r+i]=(t/s>>0)-a&255;return r+n};K.prototype.writeIntBE=function(t,r,n,o){if(t=+t,r=r>>>0,!o){let u=Math.pow(2,8*n-1);er(this,t,r,n,u-1,-u)}let i=n-1,s=1,a=0;for(this[r+i]=t&255;--i>=0&&(s*=256);)t<0&&a===0&&this[r+i+1]!==0&&(a=1),this[r+i]=(t/s>>0)-a&255;return r+n};K.prototype.writeInt8=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,1,127,-128),t<0&&(t=255+t+1),this[r]=t&255,r+1};K.prototype.writeInt16LE=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,2,32767,-32768),this[r]=t&255,this[r+1]=t>>>8,r+2};K.prototype.writeInt16BE=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,2,32767,-32768),this[r]=t>>>8,this[r+1]=t&255,r+2};K.prototype.writeInt32LE=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,4,2147483647,-2147483648),this[r]=t&255,this[r+1]=t>>>8,this[r+2]=t>>>16,this[r+3]=t>>>24,r+4};K.prototype.writeInt32BE=function(t,r,n){return t=+t,r=r>>>0,n||er(this,t,r,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=t&255,r+4};K.prototype.writeBigInt64LE=mn(function(t,r=0){return gu(this,t,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});K.prototype.writeBigInt64BE=mn(function(t,r=0){return yu(this,t,r,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function mu(e,t,r,n,o,i){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function Eu(e,t,r,n,o){return t=+t,r=r>>>0,o||mu(e,t,r,4,34028234663852886e22,-34028234663852886e22),no.write(e,t,r,n,23,4),r+4}K.prototype.writeFloatLE=function(t,r,n){return Eu(this,t,r,!0,n)};K.prototype.writeFloatBE=function(t,r,n){return Eu(this,t,r,!1,n)};function bu(e,t,r,n,o){return t=+t,r=r>>>0,o||mu(e,t,r,8,17976931348623157e292,-17976931348623157e292),no.write(e,t,r,n,52,8),r+8}K.prototype.writeDoubleLE=function(t,r,n){return bu(this,t,r,!0,n)};K.prototype.writeDoubleBE=function(t,r,n){return bu(this,t,r,!1,n)};K.prototype.copy=function(t,r,n,o){if(!K.isBuffer(t))throw new TypeError("argument should be a Buffer");if(n||(n=0),!o&&o!==0&&(o=this.length),r>=t.length&&(r=t.length),r||(r=0),o>0&&o<n&&(o=n),o===n||t.length===0||this.length===0)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(o<0)throw new RangeError("sourceEnd out of bounds");o>this.length&&(o=this.length),t.length-r<o-n&&(o=t.length-r+n);let i=o-n;return this===t&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(r,n,o):Uint8Array.prototype.set.call(t,this.subarray(n,o),r),i};K.prototype.fill=function(t,r,n,o){if(typeof t=="string"){if(typeof r=="string"?(o=r,r=0,n=this.length):typeof n=="string"&&(o=n,n=this.length),o!==void 0&&typeof o!="string")throw new TypeError("encoding must be a string");if(typeof o=="string"&&!K.isEncoding(o))throw new TypeError("Unknown encoding: "+o);if(t.length===1){let s=t.charCodeAt(0);(o==="utf8"&&s<128||o==="latin1")&&(t=s)}}else typeof t=="number"?t=t&255:typeof t=="boolean"&&(t=Number(t));if(r<0||this.length<r||this.length<n)throw new RangeError("Out of range index");if(n<=r)return this;r=r>>>0,n=n===void 0?this.length:n>>>0,t||(t=0);let i;if(typeof t=="number")for(i=r;i<n;++i)this[i]=t;else{let s=K.isBuffer(t)?t:K.from(t,o),a=s.length;if(a===0)throw new TypeError('The value "'+t+'" is invalid for argument "value"');for(i=0;i<n-r;++i)this[i+r]=s[i%a]}return this};var ro={};function aa(e,t,r){ro[e]=class extends r{constructor(){super(),Object.defineProperty(this,"message",{value:t.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${e}]`,this.stack,delete this.name}get code(){return e}set code(o){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:o,writable:!0})}toString(){return`${this.name} [${e}]: ${this.message}`}}}aa("ERR_BUFFER_OUT_OF_BOUNDS",function(e){return e?`${e} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);aa("ERR_INVALID_ARG_TYPE",function(e,t){return`The "${e}" argument must be of type number. Received type ${typeof t}`},TypeError);aa("ERR_OUT_OF_RANGE",function(e,t,r){let n=`The value of "${e}" is out of range.`,o=r;return Number.isInteger(r)&&Math.abs(r)>2**32?o=uu(String(r)):typeof r=="bigint"&&(o=String(r),(r>BigInt(2)**BigInt(32)||r<-(BigInt(2)**BigInt(32)))&&(o=uu(o)),o+="n"),n+=` It must be ${t}. Received ${o}`,n},RangeError);function uu(e){let t="",r=e.length,n=e[0]==="-"?1:0;for(;r>=n+4;r-=3)t=`_${e.slice(r-3,r)}${t}`;return`${e.slice(0,r)}${t}`}function mp(e,t,r){oo(t,"offset"),(e[t]===void 0||e[t+r]===void 0)&&ko(t,e.length-(r+1))}function wu(e,t,r,n,o,i){if(e>r||e<t){let s=typeof t=="bigint"?"n":"",a;throw i>3?t===0||t===BigInt(0)?a=`>= 0${s} and < 2${s} ** ${(i+1)*8}${s}`:a=`>= -(2${s} ** ${(i+1)*8-1}${s}) and < 2 ** ${(i+1)*8-1}${s}`:a=`>= ${t}${s} and <= ${r}${s}`,new ro.ERR_OUT_OF_RANGE("value",a,e)}mp(n,o,i)}function oo(e,t){if(typeof e!="number")throw new ro.ERR_INVALID_ARG_TYPE(t,"number",e)}function ko(e,t,r){throw Math.floor(e)!==e?(oo(e,r),new ro.ERR_OUT_OF_RANGE(r||"offset","an integer",e)):t<0?new ro.ERR_BUFFER_OUT_OF_BOUNDS:new ro.ERR_OUT_OF_RANGE(r||"offset",`>= ${r?1:0} and <= ${t}`,e)}var Ep=/[^+/0-9A-Za-z-_]/g;function bp(e){if(e=e.split("=")[0],e=e.trim().replace(Ep,""),e.length<2)return"";for(;e.length%4!==0;)e=e+"=";return e}function oa(e,t){t=t||1/0;let r,n=e.length,o=null,i=[];for(let s=0;s<n;++s){if(r=e.charCodeAt(s),r>55295&&r<57344){if(!o){if(r>56319){(t-=3)>-1&&i.push(239,191,189);continue}else if(s+1===n){(t-=3)>-1&&i.push(239,191,189);continue}o=r;continue}if(r<56320){(t-=3)>-1&&i.push(239,191,189),o=r;continue}r=(o-55296<<10|r-56320)+65536}else o&&(t-=3)>-1&&i.push(239,191,189);if(o=null,r<128){if((t-=1)<0)break;i.push(r)}else if(r<2048){if((t-=2)<0)break;i.push(r>>6|192,r&63|128)}else if(r<65536){if((t-=3)<0)break;i.push(r>>12|224,r>>6&63|128,r&63|128)}else if(r<1114112){if((t-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,r&63|128)}else throw new Error("Invalid code point")}return i}function wp(e){let t=[];for(let r=0;r<e.length;++r)t.push(e.charCodeAt(r)&255);return t}function xp(e,t){let r,n,o,i=[];for(let s=0;s<e.length&&!((t-=2)<0);++s)r=e.charCodeAt(s),n=r>>8,o=r%256,i.push(o),i.push(n);return i}function xu(e){return ta.toByteArray(bp(e))}function Li(e,t,r,n){let o;for(o=0;o<n&&!(o+r>=t.length||o>=e.length);++o)t[o+r]=e[o];return o}function Lr(e,t){return e instanceof t||e!=null&&e.constructor!=null&&e.constructor.name!=null&&e.constructor.name===t.name}function ca(e){return e!==e}var Ip=function(){let e="0123456789abcdef",t=new Array(256);for(let r=0;r<16;++r){let n=r*16;for(let o=0;o<16;++o)t[n+o]=e[r]+e[o]}return t}();function mn(e){return typeof BigInt>"u"?Sp:e}function Sp(){throw new Error("BigInt not supported")}});var Qu=zr((T0,ya)=>{function Pp(e,t,r,n,o,i,s,a){"use strict";function u(B){var $=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298],V=1779033703,k=3144134277,le=1013904242,De=2773480762,ct=1359893119,qe=2600822924,We=528734635,yt=1541459225,jt=new Array(64);function nn(nr){for(var an=0,j=nr.length;j>=64;){var mt=V,xt=k,At=le,Pt=De,rt=ct,Kt=qe,Ht=We,or=yt,Je,Ge,It,Et,bt;for(Ge=0;Ge<16;Ge++)It=an+Ge*4,jt[Ge]=(nr[It]&255)<<24|(nr[It+1]&255)<<16|(nr[It+2]&255)<<8|nr[It+3]&255;for(Ge=16;Ge<64;Ge++)Je=jt[Ge-2],Et=(Je>>>17|Je<<15)^(Je>>>19|Je<<13)^Je>>>10,Je=jt[Ge-15],bt=(Je>>>7|Je<<25)^(Je>>>18|Je<<14)^Je>>>3,jt[Ge]=(Et+jt[Ge-7]|0)+(bt+jt[Ge-16]|0)|0;for(Ge=0;Ge<64;Ge++)Et=(((rt>>>6|rt<<26)^(rt>>>11|rt<<21)^(rt>>>25|rt<<7))+(rt&Kt^~rt&Ht)|0)+(or+($[Ge]+jt[Ge]|0)|0)|0,bt=((mt>>>2|mt<<30)^(mt>>>13|mt<<19)^(mt>>>22|mt<<10))+(mt&xt^mt&At^xt&At)|0,or=Ht,Ht=Kt,Kt=rt,rt=Pt+Et|0,Pt=At,At=xt,xt=mt,mt=Et+bt|0;V=V+mt|0,k=k+xt|0,le=le+At|0,De=De+Pt|0,ct=ct+rt|0,qe=qe+Kt|0,We=We+Ht|0,yt=yt+or|0,an+=64,j-=64}}nn(B);var on,sn=B.length%64,jr=B.length/536870912|0,Cr=B.length<<3,An=sn<56?56:120,ot=B.slice(B.length-sn,B.length);for(ot.push(128),on=sn+1;on<An;on++)ot.push(0);return ot.push(jr>>>24&255),ot.push(jr>>>16&255),ot.push(jr>>>8&255),ot.push(jr>>>0&255),ot.push(Cr>>>24&255),ot.push(Cr>>>16&255),ot.push(Cr>>>8&255),ot.push(Cr>>>0&255),nn(ot),[V>>>24&255,V>>>16&255,V>>>8&255,V>>>0&255,k>>>24&255,k>>>16&255,k>>>8&255,k>>>0&255,le>>>24&255,le>>>16&255,le>>>8&255,le>>>0&255,De>>>24&255,De>>>16&255,De>>>8&255,De>>>0&255,ct>>>24&255,ct>>>16&255,ct>>>8&255,ct>>>0&255,qe>>>24&255,qe>>>16&255,qe>>>8&255,qe>>>0&255,We>>>24&255,We>>>16&255,We>>>8&255,We>>>0&255,yt>>>24&255,yt>>>16&255,yt>>>8&255,yt>>>0&255]}function f(B,$,V){B.length>64&&(B=u(B.push?B:Array.prototype.slice.call(B,0)));var k,le=64+$.length+4,De=new Array(le),ct=new Array(64),qe=[];for(k=0;k<64;k++)De[k]=54;for(k=0;k<B.length;k++)De[k]^=B[k];for(k=0;k<$.length;k++)De[64+k]=$[k];for(k=le-4;k<le;k++)De[k]=0;for(k=0;k<64;k++)ct[k]=92;for(k=0;k<B.length;k++)ct[k]^=B[k];function We(){for(var yt=le-1;yt>=le-4;yt--){if(De[yt]++,De[yt]<=255)return;De[yt]=0}}for(;V>=32;)We(),qe=qe.concat(u(ct.concat(u(De)))),V-=32;return V>0&&(We(),qe=qe.concat(u(ct.concat(u(De))).slice(0,V))),qe}function d(B,$,V,k){var le=B[0]^$[V++],De=B[1]^$[V++],ct=B[2]^$[V++],qe=B[3]^$[V++],We=B[4]^$[V++],yt=B[5]^$[V++],jt=B[6]^$[V++],nn=B[7]^$[V++],on=B[8]^$[V++],sn=B[9]^$[V++],jr=B[10]^$[V++],Cr=B[11]^$[V++],An=B[12]^$[V++],ot=B[13]^$[V++],nr=B[14]^$[V++],an=B[15]^$[V++],j,mt,xt=le,At=De,Pt=ct,rt=qe,Kt=We,Ht=yt,or=jt,Je=nn,Ge=on,It=sn,Et=jr,bt=Cr,ir=An,fr=ot,sr=nr,ar=an;for(mt=0;mt<8;mt+=2)j=xt+ir,Kt^=j<<7|j>>>25,j=Kt+xt,Ge^=j<<9|j>>>23,j=Ge+Kt,ir^=j<<13|j>>>19,j=ir+Ge,xt^=j<<18|j>>>14,j=Ht+At,It^=j<<7|j>>>25,j=It+Ht,fr^=j<<9|j>>>23,j=fr+It,At^=j<<13|j>>>19,j=At+fr,Ht^=j<<18|j>>>14,j=Et+or,sr^=j<<7|j>>>25,j=sr+Et,Pt^=j<<9|j>>>23,j=Pt+sr,or^=j<<13|j>>>19,j=or+Pt,Et^=j<<18|j>>>14,j=ar+bt,rt^=j<<7|j>>>25,j=rt+ar,Je^=j<<9|j>>>23,j=Je+rt,bt^=j<<13|j>>>19,j=bt+Je,ar^=j<<18|j>>>14,j=xt+rt,At^=j<<7|j>>>25,j=At+xt,Pt^=j<<9|j>>>23,j=Pt+At,rt^=j<<13|j>>>19,j=rt+Pt,xt^=j<<18|j>>>14,j=Ht+Kt,or^=j<<7|j>>>25,j=or+Ht,Je^=j<<9|j>>>23,j=Je+or,Kt^=j<<13|j>>>19,j=Kt+Je,Ht^=j<<18|j>>>14,j=Et+It,bt^=j<<7|j>>>25,j=bt+Et,Ge^=j<<9|j>>>23,j=Ge+bt,It^=j<<13|j>>>19,j=It+Ge,Et^=j<<18|j>>>14,j=ar+sr,ir^=j<<7|j>>>25,j=ir+ar,fr^=j<<9|j>>>23,j=fr+ir,sr^=j<<13|j>>>19,j=sr+fr,ar^=j<<18|j>>>14;$[k++]=B[0]=xt+le|0,$[k++]=B[1]=At+De|0,$[k++]=B[2]=Pt+ct|0,$[k++]=B[3]=rt+qe|0,$[k++]=B[4]=Kt+We|0,$[k++]=B[5]=Ht+yt|0,$[k++]=B[6]=or+jt|0,$[k++]=B[7]=Je+nn|0,$[k++]=B[8]=Ge+on|0,$[k++]=B[9]=It+sn|0,$[k++]=B[10]=Et+jr|0,$[k++]=B[11]=bt+Cr|0,$[k++]=B[12]=ir+An|0,$[k++]=B[13]=fr+ot|0,$[k++]=B[14]=sr+nr|0,$[k++]=B[15]=ar+an|0}function h(B,$,V,k,le){for(;le--;)B[$++]=V[k++]}function g(B,$,V,k,le){for(;le--;)B[$++]^=V[k++]}function E(B,$,V,k,le){h(B,0,$,V+(2*le-1)*16,16);for(var De=0;De<2*le;De+=2)d(B,$,V+De*16,k+De*8),d(B,$,V+De*16+16,k+De*8+le*16)}function w(B,$,V){return B[$+(2*V-1)*16]}function I(B){for(var $=[],V=0;V<B.length;V++){var k=B.charCodeAt(V);if(k<128)$.push(k);else if(k<2048)$.push(192|k>>6),$.push(128|k&63);else if(k<55296)$.push(224|k>>12),$.push(128|k>>6&63),$.push(128|k&63);else{if(V>=B.length-1)throw new Error("invalid string");V++,k=(k&1023)<<10,k|=B.charCodeAt(V)&1023,k+=65536,$.push(240|k>>18),$.push(128|k>>12&63),$.push(128|k>>6&63),$.push(128|k&63)}}return $}function C(B){for(var $="0123456789abcdef".split(""),V=B.length,k=[],le=0;le<V;le++)k.push($[B[le]>>>4&15]),k.push($[B[le]>>>0&15]);return k.join("")}function G(B){for(var $="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),V=B.length,k=[],le=0,De,ct,qe,We;le<V;)De=le<V?B[le++]:0,ct=le<V?B[le++]:0,qe=le<V?B[le++]:0,We=(De<<16)+(ct<<8)+qe,k.push($[We>>>3*6&63]),k.push($[We>>>2*6&63]),k.push($[We>>>1*6&63]),k.push($[We>>>0*6&63]);return V%3>0&&(k[k.length-1]="=",V%3===1&&(k[k.length-2]="=")),k.join("")}var A=-1>>>0,R=1;if(typeof r=="object"){if(arguments.length>4)throw new Error("scrypt: incorrect number of arguments");var O=r;if(s=n,r=O.logN,typeof r>"u")if(typeof O.N<"u"){if(O.N<2||O.N>A)throw new Error("scrypt: N is out of range");if(O.N&O.N-1)throw new Error("scrypt: N is not a power of 2");r=Math.log(O.N)/Math.LN2}else throw new Error("scrypt: missing N parameter");R=O.p||1,n=O.r,o=O.dkLen||32,i=O.interruptStep||0,a=O.encoding}if(R<1)throw new Error("scrypt: invalid p");if(n<=0)throw new Error("scrypt: invalid r");if(r<1||r>31)throw new Error("scrypt: logN must be between 1 and 31");var F=1<<r>>>0,P,W,ce,Oe;if(n*R>=1<<30||n>A/128/R||n>A/256||F>A/128/n)throw new Error("scrypt: parameters are too large");typeof e=="string"&&(e=I(e)),typeof t=="string"&&(t=I(t)),typeof Int32Array<"u"?(P=new Int32Array(64*n),W=new Int32Array(32*F*n),Oe=new Int32Array(16)):(P=[],W=[],Oe=new Array(16)),ce=f(e,t,R*128*n);var xe=0,we=32*n;function he(B){for(var $=0;$<32*n;$++){var V=B+$*4;P[xe+$]=(ce[V+3]&255)<<24|(ce[V+2]&255)<<16|(ce[V+1]&255)<<8|(ce[V+0]&255)<<0}}function $e(B,$){for(var V=B;V<$;V+=2)h(W,V*(32*n),P,xe,32*n),E(Oe,P,xe,we,n),h(W,(V+1)*(32*n),P,we,32*n),E(Oe,P,we,xe,n)}function Pe(B,$){for(var V=B;V<$;V+=2){var k=w(P,xe,n)&F-1;g(P,xe,W,k*(32*n),32*n),E(Oe,P,xe,we,n),k=w(P,we,n)&F-1,g(P,we,W,k*(32*n),32*n),E(Oe,P,we,xe,n)}}function et(B){for(var $=0;$<32*n;$++){var V=P[xe+$];ce[B+$*4+0]=V>>>0&255,ce[B+$*4+1]=V>>>8&255,ce[B+$*4+2]=V>>>16&255,ce[B+$*4+3]=V>>>24&255}}var Xt=typeof setImmediate<"u"?setImmediate:setTimeout;function tt(B,$,V,k,le){(function De(){Xt(function(){k(B,B+V<$?B+V:$),B+=V,B<$?De():le()})})()}function Ve(B){var $=f(e,ce,o);return B==="base64"?G($):B==="hex"?C($):B==="binary"?new Uint8Array($):$}function Or(){for(var B=0;B<R;B++)he(B*128*n),$e(0,F),Pe(0,F),et(B*128*n);s(Ve(a))}function xo(B){he(B*128*n),tt(0,F,i*2,$e,function(){tt(0,F,i*2,Pe,function(){et(B*128*n),B+1<R?Xt(function(){xo(B+1)}):s(Ve(a))})})}typeof i=="function"&&(a=s,s=i,i=1e3),i<=0?Or():xo(0)}typeof ya<"u"&&(ya.exports=Pp)});var Zu=zr((A0,ts)=>{(function(e){"use strict";var t=function(p){var m,y=new Float64Array(16);if(p)for(m=0;m<p.length;m++)y[m]=p[m];return y},r=function(){throw new Error("no PRNG")},n=new Uint8Array(16),o=new Uint8Array(32);o[0]=9;var i=t(),s=t([1]),a=t([56129,1]),u=t([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),f=t([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),d=t([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),h=t([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),g=t([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function E(p,m,y,l){p[m]=y>>24&255,p[m+1]=y>>16&255,p[m+2]=y>>8&255,p[m+3]=y&255,p[m+4]=l>>24&255,p[m+5]=l>>16&255,p[m+6]=l>>8&255,p[m+7]=l&255}function w(p,m,y,l,b){var _,T=0;for(_=0;_<b;_++)T|=p[m+_]^y[l+_];return(1&T-1>>>8)-1}function I(p,m,y,l){return w(p,m,y,l,16)}function C(p,m,y,l){return w(p,m,y,l,32)}function G(p,m,y,l){for(var b=l[0]&255|(l[1]&255)<<8|(l[2]&255)<<16|(l[3]&255)<<24,_=y[0]&255|(y[1]&255)<<8|(y[2]&255)<<16|(y[3]&255)<<24,T=y[4]&255|(y[5]&255)<<8|(y[6]&255)<<16|(y[7]&255)<<24,U=y[8]&255|(y[9]&255)<<8|(y[10]&255)<<16|(y[11]&255)<<24,Y=y[12]&255|(y[13]&255)<<8|(y[14]&255)<<16|(y[15]&255)<<24,ae=l[4]&255|(l[5]&255)<<8|(l[6]&255)<<16|(l[7]&255)<<24,Q=m[0]&255|(m[1]&255)<<8|(m[2]&255)<<16|(m[3]&255)<<24,Ue=m[4]&255|(m[5]&255)<<8|(m[6]&255)<<16|(m[7]&255)<<24,te=m[8]&255|(m[9]&255)<<8|(m[10]&255)<<16|(m[11]&255)<<24,ge=m[12]&255|(m[13]&255)<<8|(m[14]&255)<<16|(m[15]&255)<<24,ye=l[8]&255|(l[9]&255)<<8|(l[10]&255)<<16|(l[11]&255)<<24,Se=y[16]&255|(y[17]&255)<<8|(y[18]&255)<<16|(y[19]&255)<<24,Ie=y[20]&255|(y[21]&255)<<8|(y[22]&255)<<16|(y[23]&255)<<24,me=y[24]&255|(y[25]&255)<<8|(y[26]&255)<<16|(y[27]&255)<<24,be=y[28]&255|(y[29]&255)<<8|(y[30]&255)<<16|(y[31]&255)<<24,Ee=l[12]&255|(l[13]&255)<<8|(l[14]&255)<<16|(l[15]&255)<<24,re=b,ue=_,Z=T,ne=U,ie=Y,X=ae,N=Q,D=Ue,H=te,M=ge,L=ye,z=Se,fe=Ie,_e=me,Ae=be,ve=Ee,x,Ne=0;Ne<20;Ne+=2)x=re+fe|0,ie^=x<<7|x>>>25,x=ie+re|0,H^=x<<9|x>>>23,x=H+ie|0,fe^=x<<13|x>>>19,x=fe+H|0,re^=x<<18|x>>>14,x=X+ue|0,M^=x<<7|x>>>25,x=M+X|0,_e^=x<<9|x>>>23,x=_e+M|0,ue^=x<<13|x>>>19,x=ue+_e|0,X^=x<<18|x>>>14,x=L+N|0,Ae^=x<<7|x>>>25,x=Ae+L|0,Z^=x<<9|x>>>23,x=Z+Ae|0,N^=x<<13|x>>>19,x=N+Z|0,L^=x<<18|x>>>14,x=ve+z|0,ne^=x<<7|x>>>25,x=ne+ve|0,D^=x<<9|x>>>23,x=D+ne|0,z^=x<<13|x>>>19,x=z+D|0,ve^=x<<18|x>>>14,x=re+ne|0,ue^=x<<7|x>>>25,x=ue+re|0,Z^=x<<9|x>>>23,x=Z+ue|0,ne^=x<<13|x>>>19,x=ne+Z|0,re^=x<<18|x>>>14,x=X+ie|0,N^=x<<7|x>>>25,x=N+X|0,D^=x<<9|x>>>23,x=D+N|0,ie^=x<<13|x>>>19,x=ie+D|0,X^=x<<18|x>>>14,x=L+M|0,z^=x<<7|x>>>25,x=z+L|0,H^=x<<9|x>>>23,x=H+z|0,M^=x<<13|x>>>19,x=M+H|0,L^=x<<18|x>>>14,x=ve+Ae|0,fe^=x<<7|x>>>25,x=fe+ve|0,_e^=x<<9|x>>>23,x=_e+fe|0,Ae^=x<<13|x>>>19,x=Ae+_e|0,ve^=x<<18|x>>>14;re=re+b|0,ue=ue+_|0,Z=Z+T|0,ne=ne+U|0,ie=ie+Y|0,X=X+ae|0,N=N+Q|0,D=D+Ue|0,H=H+te|0,M=M+ge|0,L=L+ye|0,z=z+Se|0,fe=fe+Ie|0,_e=_e+me|0,Ae=Ae+be|0,ve=ve+Ee|0,p[0]=re>>>0&255,p[1]=re>>>8&255,p[2]=re>>>16&255,p[3]=re>>>24&255,p[4]=ue>>>0&255,p[5]=ue>>>8&255,p[6]=ue>>>16&255,p[7]=ue>>>24&255,p[8]=Z>>>0&255,p[9]=Z>>>8&255,p[10]=Z>>>16&255,p[11]=Z>>>24&255,p[12]=ne>>>0&255,p[13]=ne>>>8&255,p[14]=ne>>>16&255,p[15]=ne>>>24&255,p[16]=ie>>>0&255,p[17]=ie>>>8&255,p[18]=ie>>>16&255,p[19]=ie>>>24&255,p[20]=X>>>0&255,p[21]=X>>>8&255,p[22]=X>>>16&255,p[23]=X>>>24&255,p[24]=N>>>0&255,p[25]=N>>>8&255,p[26]=N>>>16&255,p[27]=N>>>24&255,p[28]=D>>>0&255,p[29]=D>>>8&255,p[30]=D>>>16&255,p[31]=D>>>24&255,p[32]=H>>>0&255,p[33]=H>>>8&255,p[34]=H>>>16&255,p[35]=H>>>24&255,p[36]=M>>>0&255,p[37]=M>>>8&255,p[38]=M>>>16&255,p[39]=M>>>24&255,p[40]=L>>>0&255,p[41]=L>>>8&255,p[42]=L>>>16&255,p[43]=L>>>24&255,p[44]=z>>>0&255,p[45]=z>>>8&255,p[46]=z>>>16&255,p[47]=z>>>24&255,p[48]=fe>>>0&255,p[49]=fe>>>8&255,p[50]=fe>>>16&255,p[51]=fe>>>24&255,p[52]=_e>>>0&255,p[53]=_e>>>8&255,p[54]=_e>>>16&255,p[55]=_e>>>24&255,p[56]=Ae>>>0&255,p[57]=Ae>>>8&255,p[58]=Ae>>>16&255,p[59]=Ae>>>24&255,p[60]=ve>>>0&255,p[61]=ve>>>8&255,p[62]=ve>>>16&255,p[63]=ve>>>24&255}function A(p,m,y,l){for(var b=l[0]&255|(l[1]&255)<<8|(l[2]&255)<<16|(l[3]&255)<<24,_=y[0]&255|(y[1]&255)<<8|(y[2]&255)<<16|(y[3]&255)<<24,T=y[4]&255|(y[5]&255)<<8|(y[6]&255)<<16|(y[7]&255)<<24,U=y[8]&255|(y[9]&255)<<8|(y[10]&255)<<16|(y[11]&255)<<24,Y=y[12]&255|(y[13]&255)<<8|(y[14]&255)<<16|(y[15]&255)<<24,ae=l[4]&255|(l[5]&255)<<8|(l[6]&255)<<16|(l[7]&255)<<24,Q=m[0]&255|(m[1]&255)<<8|(m[2]&255)<<16|(m[3]&255)<<24,Ue=m[4]&255|(m[5]&255)<<8|(m[6]&255)<<16|(m[7]&255)<<24,te=m[8]&255|(m[9]&255)<<8|(m[10]&255)<<16|(m[11]&255)<<24,ge=m[12]&255|(m[13]&255)<<8|(m[14]&255)<<16|(m[15]&255)<<24,ye=l[8]&255|(l[9]&255)<<8|(l[10]&255)<<16|(l[11]&255)<<24,Se=y[16]&255|(y[17]&255)<<8|(y[18]&255)<<16|(y[19]&255)<<24,Ie=y[20]&255|(y[21]&255)<<8|(y[22]&255)<<16|(y[23]&255)<<24,me=y[24]&255|(y[25]&255)<<8|(y[26]&255)<<16|(y[27]&255)<<24,be=y[28]&255|(y[29]&255)<<8|(y[30]&255)<<16|(y[31]&255)<<24,Ee=l[12]&255|(l[13]&255)<<8|(l[14]&255)<<16|(l[15]&255)<<24,re=b,ue=_,Z=T,ne=U,ie=Y,X=ae,N=Q,D=Ue,H=te,M=ge,L=ye,z=Se,fe=Ie,_e=me,Ae=be,ve=Ee,x,Ne=0;Ne<20;Ne+=2)x=re+fe|0,ie^=x<<7|x>>>25,x=ie+re|0,H^=x<<9|x>>>23,x=H+ie|0,fe^=x<<13|x>>>19,x=fe+H|0,re^=x<<18|x>>>14,x=X+ue|0,M^=x<<7|x>>>25,x=M+X|0,_e^=x<<9|x>>>23,x=_e+M|0,ue^=x<<13|x>>>19,x=ue+_e|0,X^=x<<18|x>>>14,x=L+N|0,Ae^=x<<7|x>>>25,x=Ae+L|0,Z^=x<<9|x>>>23,x=Z+Ae|0,N^=x<<13|x>>>19,x=N+Z|0,L^=x<<18|x>>>14,x=ve+z|0,ne^=x<<7|x>>>25,x=ne+ve|0,D^=x<<9|x>>>23,x=D+ne|0,z^=x<<13|x>>>19,x=z+D|0,ve^=x<<18|x>>>14,x=re+ne|0,ue^=x<<7|x>>>25,x=ue+re|0,Z^=x<<9|x>>>23,x=Z+ue|0,ne^=x<<13|x>>>19,x=ne+Z|0,re^=x<<18|x>>>14,x=X+ie|0,N^=x<<7|x>>>25,x=N+X|0,D^=x<<9|x>>>23,x=D+N|0,ie^=x<<13|x>>>19,x=ie+D|0,X^=x<<18|x>>>14,x=L+M|0,z^=x<<7|x>>>25,x=z+L|0,H^=x<<9|x>>>23,x=H+z|0,M^=x<<13|x>>>19,x=M+H|0,L^=x<<18|x>>>14,x=ve+Ae|0,fe^=x<<7|x>>>25,x=fe+ve|0,_e^=x<<9|x>>>23,x=_e+fe|0,Ae^=x<<13|x>>>19,x=Ae+_e|0,ve^=x<<18|x>>>14;p[0]=re>>>0&255,p[1]=re>>>8&255,p[2]=re>>>16&255,p[3]=re>>>24&255,p[4]=X>>>0&255,p[5]=X>>>8&255,p[6]=X>>>16&255,p[7]=X>>>24&255,p[8]=L>>>0&255,p[9]=L>>>8&255,p[10]=L>>>16&255,p[11]=L>>>24&255,p[12]=ve>>>0&255,p[13]=ve>>>8&255,p[14]=ve>>>16&255,p[15]=ve>>>24&255,p[16]=N>>>0&255,p[17]=N>>>8&255,p[18]=N>>>16&255,p[19]=N>>>24&255,p[20]=D>>>0&255,p[21]=D>>>8&255,p[22]=D>>>16&255,p[23]=D>>>24&255,p[24]=H>>>0&255,p[25]=H>>>8&255,p[26]=H>>>16&255,p[27]=H>>>24&255,p[28]=M>>>0&255,p[29]=M>>>8&255,p[30]=M>>>16&255,p[31]=M>>>24&255}function R(p,m,y,l){G(p,m,y,l)}function O(p,m,y,l){A(p,m,y,l)}var F=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function P(p,m,y,l,b,_,T){var U=new Uint8Array(16),Y=new Uint8Array(64),ae,Q;for(Q=0;Q<16;Q++)U[Q]=0;for(Q=0;Q<8;Q++)U[Q]=_[Q];for(;b>=64;){for(R(Y,U,T,F),Q=0;Q<64;Q++)p[m+Q]=y[l+Q]^Y[Q];for(ae=1,Q=8;Q<16;Q++)ae=ae+(U[Q]&255)|0,U[Q]=ae&255,ae>>>=8;b-=64,m+=64,l+=64}if(b>0)for(R(Y,U,T,F),Q=0;Q<b;Q++)p[m+Q]=y[l+Q]^Y[Q];return 0}function W(p,m,y,l,b){var _=new Uint8Array(16),T=new Uint8Array(64),U,Y;for(Y=0;Y<16;Y++)_[Y]=0;for(Y=0;Y<8;Y++)_[Y]=l[Y];for(;y>=64;){for(R(T,_,b,F),Y=0;Y<64;Y++)p[m+Y]=T[Y];for(U=1,Y=8;Y<16;Y++)U=U+(_[Y]&255)|0,_[Y]=U&255,U>>>=8;y-=64,m+=64}if(y>0)for(R(T,_,b,F),Y=0;Y<y;Y++)p[m+Y]=T[Y];return 0}function ce(p,m,y,l,b){var _=new Uint8Array(32);O(_,l,b,F);for(var T=new Uint8Array(8),U=0;U<8;U++)T[U]=l[U+16];return W(p,m,y,T,_)}function Oe(p,m,y,l,b,_,T){var U=new Uint8Array(32);O(U,_,T,F);for(var Y=new Uint8Array(8),ae=0;ae<8;ae++)Y[ae]=_[ae+16];return P(p,m,y,l,b,Y,U)}var xe=function(p){this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0;var m,y,l,b,_,T,U,Y;m=p[0]&255|(p[1]&255)<<8,this.r[0]=m&8191,y=p[2]&255|(p[3]&255)<<8,this.r[1]=(m>>>13|y<<3)&8191,l=p[4]&255|(p[5]&255)<<8,this.r[2]=(y>>>10|l<<6)&7939,b=p[6]&255|(p[7]&255)<<8,this.r[3]=(l>>>7|b<<9)&8191,_=p[8]&255|(p[9]&255)<<8,this.r[4]=(b>>>4|_<<12)&255,this.r[5]=_>>>1&8190,T=p[10]&255|(p[11]&255)<<8,this.r[6]=(_>>>14|T<<2)&8191,U=p[12]&255|(p[13]&255)<<8,this.r[7]=(T>>>11|U<<5)&8065,Y=p[14]&255|(p[15]&255)<<8,this.r[8]=(U>>>8|Y<<8)&8191,this.r[9]=Y>>>5&127,this.pad[0]=p[16]&255|(p[17]&255)<<8,this.pad[1]=p[18]&255|(p[19]&255)<<8,this.pad[2]=p[20]&255|(p[21]&255)<<8,this.pad[3]=p[22]&255|(p[23]&255)<<8,this.pad[4]=p[24]&255|(p[25]&255)<<8,this.pad[5]=p[26]&255|(p[27]&255)<<8,this.pad[6]=p[28]&255|(p[29]&255)<<8,this.pad[7]=p[30]&255|(p[31]&255)<<8};xe.prototype.blocks=function(p,m,y){for(var l=this.fin?0:2048,b,_,T,U,Y,ae,Q,Ue,te,ge,ye,Se,Ie,me,be,Ee,re,ue,Z,ne=this.h[0],ie=this.h[1],X=this.h[2],N=this.h[3],D=this.h[4],H=this.h[5],M=this.h[6],L=this.h[7],z=this.h[8],fe=this.h[9],_e=this.r[0],Ae=this.r[1],ve=this.r[2],x=this.r[3],Ne=this.r[4],Le=this.r[5],Fe=this.r[6],Ce=this.r[7],Ke=this.r[8],Me=this.r[9];y>=16;)b=p[m+0]&255|(p[m+1]&255)<<8,ne+=b&8191,_=p[m+2]&255|(p[m+3]&255)<<8,ie+=(b>>>13|_<<3)&8191,T=p[m+4]&255|(p[m+5]&255)<<8,X+=(_>>>10|T<<6)&8191,U=p[m+6]&255|(p[m+7]&255)<<8,N+=(T>>>7|U<<9)&8191,Y=p[m+8]&255|(p[m+9]&255)<<8,D+=(U>>>4|Y<<12)&8191,H+=Y>>>1&8191,ae=p[m+10]&255|(p[m+11]&255)<<8,M+=(Y>>>14|ae<<2)&8191,Q=p[m+12]&255|(p[m+13]&255)<<8,L+=(ae>>>11|Q<<5)&8191,Ue=p[m+14]&255|(p[m+15]&255)<<8,z+=(Q>>>8|Ue<<8)&8191,fe+=Ue>>>5|l,te=0,ge=te,ge+=ne*_e,ge+=ie*(5*Me),ge+=X*(5*Ke),ge+=N*(5*Ce),ge+=D*(5*Fe),te=ge>>>13,ge&=8191,ge+=H*(5*Le),ge+=M*(5*Ne),ge+=L*(5*x),ge+=z*(5*ve),ge+=fe*(5*Ae),te+=ge>>>13,ge&=8191,ye=te,ye+=ne*Ae,ye+=ie*_e,ye+=X*(5*Me),ye+=N*(5*Ke),ye+=D*(5*Ce),te=ye>>>13,ye&=8191,ye+=H*(5*Fe),ye+=M*(5*Le),ye+=L*(5*Ne),ye+=z*(5*x),ye+=fe*(5*ve),te+=ye>>>13,ye&=8191,Se=te,Se+=ne*ve,Se+=ie*Ae,Se+=X*_e,Se+=N*(5*Me),Se+=D*(5*Ke),te=Se>>>13,Se&=8191,Se+=H*(5*Ce),Se+=M*(5*Fe),Se+=L*(5*Le),Se+=z*(5*Ne),Se+=fe*(5*x),te+=Se>>>13,Se&=8191,Ie=te,Ie+=ne*x,Ie+=ie*ve,Ie+=X*Ae,Ie+=N*_e,Ie+=D*(5*Me),te=Ie>>>13,Ie&=8191,Ie+=H*(5*Ke),Ie+=M*(5*Ce),Ie+=L*(5*Fe),Ie+=z*(5*Le),Ie+=fe*(5*Ne),te+=Ie>>>13,Ie&=8191,me=te,me+=ne*Ne,me+=ie*x,me+=X*ve,me+=N*Ae,me+=D*_e,te=me>>>13,me&=8191,me+=H*(5*Me),me+=M*(5*Ke),me+=L*(5*Ce),me+=z*(5*Fe),me+=fe*(5*Le),te+=me>>>13,me&=8191,be=te,be+=ne*Le,be+=ie*Ne,be+=X*x,be+=N*ve,be+=D*Ae,te=be>>>13,be&=8191,be+=H*_e,be+=M*(5*Me),be+=L*(5*Ke),be+=z*(5*Ce),be+=fe*(5*Fe),te+=be>>>13,be&=8191,Ee=te,Ee+=ne*Fe,Ee+=ie*Le,Ee+=X*Ne,Ee+=N*x,Ee+=D*ve,te=Ee>>>13,Ee&=8191,Ee+=H*Ae,Ee+=M*_e,Ee+=L*(5*Me),Ee+=z*(5*Ke),Ee+=fe*(5*Ce),te+=Ee>>>13,Ee&=8191,re=te,re+=ne*Ce,re+=ie*Fe,re+=X*Le,re+=N*Ne,re+=D*x,te=re>>>13,re&=8191,re+=H*ve,re+=M*Ae,re+=L*_e,re+=z*(5*Me),re+=fe*(5*Ke),te+=re>>>13,re&=8191,ue=te,ue+=ne*Ke,ue+=ie*Ce,ue+=X*Fe,ue+=N*Le,ue+=D*Ne,te=ue>>>13,ue&=8191,ue+=H*x,ue+=M*ve,ue+=L*Ae,ue+=z*_e,ue+=fe*(5*Me),te+=ue>>>13,ue&=8191,Z=te,Z+=ne*Me,Z+=ie*Ke,Z+=X*Ce,Z+=N*Fe,Z+=D*Le,te=Z>>>13,Z&=8191,Z+=H*Ne,Z+=M*x,Z+=L*ve,Z+=z*Ae,Z+=fe*_e,te+=Z>>>13,Z&=8191,te=(te<<2)+te|0,te=te+ge|0,ge=te&8191,te=te>>>13,ye+=te,ne=ge,ie=ye,X=Se,N=Ie,D=me,H=be,M=Ee,L=re,z=ue,fe=Z,m+=16,y-=16;this.h[0]=ne,this.h[1]=ie,this.h[2]=X,this.h[3]=N,this.h[4]=D,this.h[5]=H,this.h[6]=M,this.h[7]=L,this.h[8]=z,this.h[9]=fe},xe.prototype.finish=function(p,m){var y=new Uint16Array(10),l,b,_,T;if(this.leftover){for(T=this.leftover,this.buffer[T++]=1;T<16;T++)this.buffer[T]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(l=this.h[1]>>>13,this.h[1]&=8191,T=2;T<10;T++)this.h[T]+=l,l=this.h[T]>>>13,this.h[T]&=8191;for(this.h[0]+=l*5,l=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=l,l=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=l,y[0]=this.h[0]+5,l=y[0]>>>13,y[0]&=8191,T=1;T<10;T++)y[T]=this.h[T]+l,l=y[T]>>>13,y[T]&=8191;for(y[9]-=8192,b=(l^1)-1,T=0;T<10;T++)y[T]&=b;for(b=~b,T=0;T<10;T++)this.h[T]=this.h[T]&b|y[T];for(this.h[0]=(this.h[0]|this.h[1]<<13)&65535,this.h[1]=(this.h[1]>>>3|this.h[2]<<10)&65535,this.h[2]=(this.h[2]>>>6|this.h[3]<<7)&65535,this.h[3]=(this.h[3]>>>9|this.h[4]<<4)&65535,this.h[4]=(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14)&65535,this.h[5]=(this.h[6]>>>2|this.h[7]<<11)&65535,this.h[6]=(this.h[7]>>>5|this.h[8]<<8)&65535,this.h[7]=(this.h[8]>>>8|this.h[9]<<5)&65535,_=this.h[0]+this.pad[0],this.h[0]=_&65535,T=1;T<8;T++)_=(this.h[T]+this.pad[T]|0)+(_>>>16)|0,this.h[T]=_&65535;p[m+0]=this.h[0]>>>0&255,p[m+1]=this.h[0]>>>8&255,p[m+2]=this.h[1]>>>0&255,p[m+3]=this.h[1]>>>8&255,p[m+4]=this.h[2]>>>0&255,p[m+5]=this.h[2]>>>8&255,p[m+6]=this.h[3]>>>0&255,p[m+7]=this.h[3]>>>8&255,p[m+8]=this.h[4]>>>0&255,p[m+9]=this.h[4]>>>8&255,p[m+10]=this.h[5]>>>0&255,p[m+11]=this.h[5]>>>8&255,p[m+12]=this.h[6]>>>0&255,p[m+13]=this.h[6]>>>8&255,p[m+14]=this.h[7]>>>0&255,p[m+15]=this.h[7]>>>8&255},xe.prototype.update=function(p,m,y){var l,b;if(this.leftover){for(b=16-this.leftover,b>y&&(b=y),l=0;l<b;l++)this.buffer[this.leftover+l]=p[m+l];if(y-=b,m+=b,this.leftover+=b,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(y>=16&&(b=y-y%16,this.blocks(p,m,b),m+=b,y-=b),y){for(l=0;l<y;l++)this.buffer[this.leftover+l]=p[m+l];this.leftover+=y}};function we(p,m,y,l,b,_){var T=new xe(_);return T.update(y,l,b),T.finish(p,m),0}function he(p,m,y,l,b,_){var T=new Uint8Array(16);return we(T,0,y,l,b,_),I(p,m,T,0)}function $e(p,m,y,l,b){var _;if(y<32)return-1;for(Oe(p,0,m,0,y,l,b),we(p,16,p,32,y-32,p),_=0;_<16;_++)p[_]=0;return 0}function Pe(p,m,y,l,b){var _,T=new Uint8Array(32);if(y<32||(ce(T,0,32,l,b),he(m,16,m,32,y-32,T)!==0))return-1;for(Oe(p,0,m,0,y,l,b),_=0;_<32;_++)p[_]=0;return 0}function et(p,m){var y;for(y=0;y<16;y++)p[y]=m[y]|0}function Xt(p){var m,y,l=1;for(m=0;m<16;m++)y=p[m]+l+65535,l=Math.floor(y/65536),p[m]=y-l*65536;p[0]+=l-1+37*(l-1)}function tt(p,m,y){for(var l,b=~(y-1),_=0;_<16;_++)l=b&(p[_]^m[_]),p[_]^=l,m[_]^=l}function Ve(p,m){var y,l,b,_=t(),T=t();for(y=0;y<16;y++)T[y]=m[y];for(Xt(T),Xt(T),Xt(T),l=0;l<2;l++){for(_[0]=T[0]-65517,y=1;y<15;y++)_[y]=T[y]-65535-(_[y-1]>>16&1),_[y-1]&=65535;_[15]=T[15]-32767-(_[14]>>16&1),b=_[15]>>16&1,_[14]&=65535,tt(T,_,1-b)}for(y=0;y<16;y++)p[2*y]=T[y]&255,p[2*y+1]=T[y]>>8}function Or(p,m){var y=new Uint8Array(32),l=new Uint8Array(32);return Ve(y,p),Ve(l,m),C(y,0,l,0)}function xo(p){var m=new Uint8Array(32);return Ve(m,p),m[0]&1}function B(p,m){var y;for(y=0;y<16;y++)p[y]=m[2*y]+(m[2*y+1]<<8);p[15]&=32767}function $(p,m,y){for(var l=0;l<16;l++)p[l]=m[l]+y[l]}function V(p,m,y){for(var l=0;l<16;l++)p[l]=m[l]-y[l]}function k(p,m,y){var l,b,_=0,T=0,U=0,Y=0,ae=0,Q=0,Ue=0,te=0,ge=0,ye=0,Se=0,Ie=0,me=0,be=0,Ee=0,re=0,ue=0,Z=0,ne=0,ie=0,X=0,N=0,D=0,H=0,M=0,L=0,z=0,fe=0,_e=0,Ae=0,ve=0,x=y[0],Ne=y[1],Le=y[2],Fe=y[3],Ce=y[4],Ke=y[5],Me=y[6],ut=y[7],je=y[8],it=y[9],st=y[10],at=y[11],wt=y[12],Mt=y[13],Ut=y[14],Lt=y[15];l=m[0],_+=l*x,T+=l*Ne,U+=l*Le,Y+=l*Fe,ae+=l*Ce,Q+=l*Ke,Ue+=l*Me,te+=l*ut,ge+=l*je,ye+=l*it,Se+=l*st,Ie+=l*at,me+=l*wt,be+=l*Mt,Ee+=l*Ut,re+=l*Lt,l=m[1],T+=l*x,U+=l*Ne,Y+=l*Le,ae+=l*Fe,Q+=l*Ce,Ue+=l*Ke,te+=l*Me,ge+=l*ut,ye+=l*je,Se+=l*it,Ie+=l*st,me+=l*at,be+=l*wt,Ee+=l*Mt,re+=l*Ut,ue+=l*Lt,l=m[2],U+=l*x,Y+=l*Ne,ae+=l*Le,Q+=l*Fe,Ue+=l*Ce,te+=l*Ke,ge+=l*Me,ye+=l*ut,Se+=l*je,Ie+=l*it,me+=l*st,be+=l*at,Ee+=l*wt,re+=l*Mt,ue+=l*Ut,Z+=l*Lt,l=m[3],Y+=l*x,ae+=l*Ne,Q+=l*Le,Ue+=l*Fe,te+=l*Ce,ge+=l*Ke,ye+=l*Me,Se+=l*ut,Ie+=l*je,me+=l*it,be+=l*st,Ee+=l*at,re+=l*wt,ue+=l*Mt,Z+=l*Ut,ne+=l*Lt,l=m[4],ae+=l*x,Q+=l*Ne,Ue+=l*Le,te+=l*Fe,ge+=l*Ce,ye+=l*Ke,Se+=l*Me,Ie+=l*ut,me+=l*je,be+=l*it,Ee+=l*st,re+=l*at,ue+=l*wt,Z+=l*Mt,ne+=l*Ut,ie+=l*Lt,l=m[5],Q+=l*x,Ue+=l*Ne,te+=l*Le,ge+=l*Fe,ye+=l*Ce,Se+=l*Ke,Ie+=l*Me,me+=l*ut,be+=l*je,Ee+=l*it,re+=l*st,ue+=l*at,Z+=l*wt,ne+=l*Mt,ie+=l*Ut,X+=l*Lt,l=m[6],Ue+=l*x,te+=l*Ne,ge+=l*Le,ye+=l*Fe,Se+=l*Ce,Ie+=l*Ke,me+=l*Me,be+=l*ut,Ee+=l*je,re+=l*it,ue+=l*st,Z+=l*at,ne+=l*wt,ie+=l*Mt,X+=l*Ut,N+=l*Lt,l=m[7],te+=l*x,ge+=l*Ne,ye+=l*Le,Se+=l*Fe,Ie+=l*Ce,me+=l*Ke,be+=l*Me,Ee+=l*ut,re+=l*je,ue+=l*it,Z+=l*st,ne+=l*at,ie+=l*wt,X+=l*Mt,N+=l*Ut,D+=l*Lt,l=m[8],ge+=l*x,ye+=l*Ne,Se+=l*Le,Ie+=l*Fe,me+=l*Ce,be+=l*Ke,Ee+=l*Me,re+=l*ut,ue+=l*je,Z+=l*it,ne+=l*st,ie+=l*at,X+=l*wt,N+=l*Mt,D+=l*Ut,H+=l*Lt,l=m[9],ye+=l*x,Se+=l*Ne,Ie+=l*Le,me+=l*Fe,be+=l*Ce,Ee+=l*Ke,re+=l*Me,ue+=l*ut,Z+=l*je,ne+=l*it,ie+=l*st,X+=l*at,N+=l*wt,D+=l*Mt,H+=l*Ut,M+=l*Lt,l=m[10],Se+=l*x,Ie+=l*Ne,me+=l*Le,be+=l*Fe,Ee+=l*Ce,re+=l*Ke,ue+=l*Me,Z+=l*ut,ne+=l*je,ie+=l*it,X+=l*st,N+=l*at,D+=l*wt,H+=l*Mt,M+=l*Ut,L+=l*Lt,l=m[11],Ie+=l*x,me+=l*Ne,be+=l*Le,Ee+=l*Fe,re+=l*Ce,ue+=l*Ke,Z+=l*Me,ne+=l*ut,ie+=l*je,X+=l*it,N+=l*st,D+=l*at,H+=l*wt,M+=l*Mt,L+=l*Ut,z+=l*Lt,l=m[12],me+=l*x,be+=l*Ne,Ee+=l*Le,re+=l*Fe,ue+=l*Ce,Z+=l*Ke,ne+=l*Me,ie+=l*ut,X+=l*je,N+=l*it,D+=l*st,H+=l*at,M+=l*wt,L+=l*Mt,z+=l*Ut,fe+=l*Lt,l=m[13],be+=l*x,Ee+=l*Ne,re+=l*Le,ue+=l*Fe,Z+=l*Ce,ne+=l*Ke,ie+=l*Me,X+=l*ut,N+=l*je,D+=l*it,H+=l*st,M+=l*at,L+=l*wt,z+=l*Mt,fe+=l*Ut,_e+=l*Lt,l=m[14],Ee+=l*x,re+=l*Ne,ue+=l*Le,Z+=l*Fe,ne+=l*Ce,ie+=l*Ke,X+=l*Me,N+=l*ut,D+=l*je,H+=l*it,M+=l*st,L+=l*at,z+=l*wt,fe+=l*Mt,_e+=l*Ut,Ae+=l*Lt,l=m[15],re+=l*x,ue+=l*Ne,Z+=l*Le,ne+=l*Fe,ie+=l*Ce,X+=l*Ke,N+=l*Me,D+=l*ut,H+=l*je,M+=l*it,L+=l*st,z+=l*at,fe+=l*wt,_e+=l*Mt,Ae+=l*Ut,ve+=l*Lt,_+=38*ue,T+=38*Z,U+=38*ne,Y+=38*ie,ae+=38*X,Q+=38*N,Ue+=38*D,te+=38*H,ge+=38*M,ye+=38*L,Se+=38*z,Ie+=38*fe,me+=38*_e,be+=38*Ae,Ee+=38*ve,b=1,l=_+b+65535,b=Math.floor(l/65536),_=l-b*65536,l=T+b+65535,b=Math.floor(l/65536),T=l-b*65536,l=U+b+65535,b=Math.floor(l/65536),U=l-b*65536,l=Y+b+65535,b=Math.floor(l/65536),Y=l-b*65536,l=ae+b+65535,b=Math.floor(l/65536),ae=l-b*65536,l=Q+b+65535,b=Math.floor(l/65536),Q=l-b*65536,l=Ue+b+65535,b=Math.floor(l/65536),Ue=l-b*65536,l=te+b+65535,b=Math.floor(l/65536),te=l-b*65536,l=ge+b+65535,b=Math.floor(l/65536),ge=l-b*65536,l=ye+b+65535,b=Math.floor(l/65536),ye=l-b*65536,l=Se+b+65535,b=Math.floor(l/65536),Se=l-b*65536,l=Ie+b+65535,b=Math.floor(l/65536),Ie=l-b*65536,l=me+b+65535,b=Math.floor(l/65536),me=l-b*65536,l=be+b+65535,b=Math.floor(l/65536),be=l-b*65536,l=Ee+b+65535,b=Math.floor(l/65536),Ee=l-b*65536,l=re+b+65535,b=Math.floor(l/65536),re=l-b*65536,_+=b-1+37*(b-1),b=1,l=_+b+65535,b=Math.floor(l/65536),_=l-b*65536,l=T+b+65535,b=Math.floor(l/65536),T=l-b*65536,l=U+b+65535,b=Math.floor(l/65536),U=l-b*65536,l=Y+b+65535,b=Math.floor(l/65536),Y=l-b*65536,l=ae+b+65535,b=Math.floor(l/65536),ae=l-b*65536,l=Q+b+65535,b=Math.floor(l/65536),Q=l-b*65536,l=Ue+b+65535,b=Math.floor(l/65536),Ue=l-b*65536,l=te+b+65535,b=Math.floor(l/65536),te=l-b*65536,l=ge+b+65535,b=Math.floor(l/65536),ge=l-b*65536,l=ye+b+65535,b=Math.floor(l/65536),ye=l-b*65536,l=Se+b+65535,b=Math.floor(l/65536),Se=l-b*65536,l=Ie+b+65535,b=Math.floor(l/65536),Ie=l-b*65536,l=me+b+65535,b=Math.floor(l/65536),me=l-b*65536,l=be+b+65535,b=Math.floor(l/65536),be=l-b*65536,l=Ee+b+65535,b=Math.floor(l/65536),Ee=l-b*65536,l=re+b+65535,b=Math.floor(l/65536),re=l-b*65536,_+=b-1+37*(b-1),p[0]=_,p[1]=T,p[2]=U,p[3]=Y,p[4]=ae,p[5]=Q,p[6]=Ue,p[7]=te,p[8]=ge,p[9]=ye,p[10]=Se,p[11]=Ie,p[12]=me,p[13]=be,p[14]=Ee,p[15]=re}function le(p,m){k(p,m,m)}function De(p,m){var y=t(),l;for(l=0;l<16;l++)y[l]=m[l];for(l=253;l>=0;l--)le(y,y),l!==2&&l!==4&&k(y,y,m);for(l=0;l<16;l++)p[l]=y[l]}function ct(p,m){var y=t(),l;for(l=0;l<16;l++)y[l]=m[l];for(l=250;l>=0;l--)le(y,y),l!==1&&k(y,y,m);for(l=0;l<16;l++)p[l]=y[l]}function qe(p,m,y){var l=new Uint8Array(32),b=new Float64Array(80),_,T,U=t(),Y=t(),ae=t(),Q=t(),Ue=t(),te=t();for(T=0;T<31;T++)l[T]=m[T];for(l[31]=m[31]&127|64,l[0]&=248,B(b,y),T=0;T<16;T++)Y[T]=b[T],Q[T]=U[T]=ae[T]=0;for(U[0]=Q[0]=1,T=254;T>=0;--T)_=l[T>>>3]>>>(T&7)&1,tt(U,Y,_),tt(ae,Q,_),$(Ue,U,ae),V(U,U,ae),$(ae,Y,Q),V(Y,Y,Q),le(Q,Ue),le(te,U),k(U,ae,U),k(ae,Y,Ue),$(Ue,U,ae),V(U,U,ae),le(Y,U),V(ae,Q,te),k(U,ae,a),$(U,U,Q),k(ae,ae,U),k(U,Q,te),k(Q,Y,b),le(Y,Ue),tt(U,Y,_),tt(ae,Q,_);for(T=0;T<16;T++)b[T+16]=U[T],b[T+32]=ae[T],b[T+48]=Y[T],b[T+64]=Q[T];var ge=b.subarray(32),ye=b.subarray(16);return De(ge,ge),k(ye,ye,ge),Ve(p,ye),0}function We(p,m){return qe(p,m,o)}function yt(p,m){return r(m,32),We(p,m)}function jt(p,m,y){var l=new Uint8Array(32);return qe(l,y,m),O(p,n,l,F)}var nn=$e,on=Pe;function sn(p,m,y,l,b,_){var T=new Uint8Array(32);return jt(T,b,_),nn(p,m,y,l,T)}function jr(p,m,y,l,b,_){var T=new Uint8Array(32);return jt(T,b,_),on(p,m,y,l,T)}var Cr=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function An(p,m,y,l){for(var b=new Int32Array(16),_=new Int32Array(16),T,U,Y,ae,Q,Ue,te,ge,ye,Se,Ie,me,be,Ee,re,ue,Z,ne,ie,X,N,D,H,M,L,z,fe=p[0],_e=p[1],Ae=p[2],ve=p[3],x=p[4],Ne=p[5],Le=p[6],Fe=p[7],Ce=m[0],Ke=m[1],Me=m[2],ut=m[3],je=m[4],it=m[5],st=m[6],at=m[7],wt=0;l>=128;){for(ie=0;ie<16;ie++)X=8*ie+wt,b[ie]=y[X+0]<<24|y[X+1]<<16|y[X+2]<<8|y[X+3],_[ie]=y[X+4]<<24|y[X+5]<<16|y[X+6]<<8|y[X+7];for(ie=0;ie<80;ie++)if(T=fe,U=_e,Y=Ae,ae=ve,Q=x,Ue=Ne,te=Le,ge=Fe,ye=Ce,Se=Ke,Ie=Me,me=ut,be=je,Ee=it,re=st,ue=at,N=Fe,D=at,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=(x>>>14|je<<18)^(x>>>18|je<<14)^(je>>>9|x<<23),D=(je>>>14|x<<18)^(je>>>18|x<<14)^(x>>>9|je<<23),H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,N=x&Ne^~x&Le,D=je&it^~je&st,H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,N=Cr[ie*2],D=Cr[ie*2+1],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,N=b[ie%16],D=_[ie%16],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,Z=L&65535|z<<16,ne=H&65535|M<<16,N=Z,D=ne,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=(fe>>>28|Ce<<4)^(Ce>>>2|fe<<30)^(Ce>>>7|fe<<25),D=(Ce>>>28|fe<<4)^(fe>>>2|Ce<<30)^(fe>>>7|Ce<<25),H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,N=fe&_e^fe&Ae^_e&Ae,D=Ce&Ke^Ce&Me^Ke&Me,H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,ge=L&65535|z<<16,ue=H&65535|M<<16,N=ae,D=me,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=Z,D=ne,H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,ae=L&65535|z<<16,me=H&65535|M<<16,_e=T,Ae=U,ve=Y,x=ae,Ne=Q,Le=Ue,Fe=te,fe=ge,Ke=ye,Me=Se,ut=Ie,je=me,it=be,st=Ee,at=re,Ce=ue,ie%16===15)for(X=0;X<16;X++)N=b[X],D=_[X],H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=b[(X+9)%16],D=_[(X+9)%16],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,Z=b[(X+1)%16],ne=_[(X+1)%16],N=(Z>>>1|ne<<31)^(Z>>>8|ne<<24)^Z>>>7,D=(ne>>>1|Z<<31)^(ne>>>8|Z<<24)^(ne>>>7|Z<<25),H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,Z=b[(X+14)%16],ne=_[(X+14)%16],N=(Z>>>19|ne<<13)^(ne>>>29|Z<<3)^Z>>>6,D=(ne>>>19|Z<<13)^(Z>>>29|ne<<3)^(ne>>>6|Z<<26),H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,b[X]=L&65535|z<<16,_[X]=H&65535|M<<16;N=fe,D=Ce,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=p[0],D=m[0],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,p[0]=fe=L&65535|z<<16,m[0]=Ce=H&65535|M<<16,N=_e,D=Ke,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=p[1],D=m[1],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,p[1]=_e=L&65535|z<<16,m[1]=Ke=H&65535|M<<16,N=Ae,D=Me,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=p[2],D=m[2],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,p[2]=Ae=L&65535|z<<16,m[2]=Me=H&65535|M<<16,N=ve,D=ut,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=p[3],D=m[3],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,p[3]=ve=L&65535|z<<16,m[3]=ut=H&65535|M<<16,N=x,D=je,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=p[4],D=m[4],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,p[4]=x=L&65535|z<<16,m[4]=je=H&65535|M<<16,N=Ne,D=it,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=p[5],D=m[5],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,p[5]=Ne=L&65535|z<<16,m[5]=it=H&65535|M<<16,N=Le,D=st,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=p[6],D=m[6],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,p[6]=Le=L&65535|z<<16,m[6]=st=H&65535|M<<16,N=Fe,D=at,H=D&65535,M=D>>>16,L=N&65535,z=N>>>16,N=p[7],D=m[7],H+=D&65535,M+=D>>>16,L+=N&65535,z+=N>>>16,M+=H>>>16,L+=M>>>16,z+=L>>>16,p[7]=Fe=L&65535|z<<16,m[7]=at=H&65535|M<<16,wt+=128,l-=128}return l}function ot(p,m,y){var l=new Int32Array(8),b=new Int32Array(8),_=new Uint8Array(256),T,U=y;for(l[0]=1779033703,l[1]=3144134277,l[2]=1013904242,l[3]=2773480762,l[4]=1359893119,l[5]=2600822924,l[6]=528734635,l[7]=1541459225,b[0]=4089235720,b[1]=2227873595,b[2]=4271175723,b[3]=1595750129,b[4]=2917565137,b[5]=725511199,b[6]=4215389547,b[7]=327033209,An(l,b,m,y),y%=128,T=0;T<y;T++)_[T]=m[U-y+T];for(_[y]=128,y=256-128*(y<112?1:0),_[y-9]=0,E(_,y-8,U/536870912|0,U<<3),An(l,b,_,y),T=0;T<8;T++)E(p,8*T,l[T],b[T]);return 0}function nr(p,m){var y=t(),l=t(),b=t(),_=t(),T=t(),U=t(),Y=t(),ae=t(),Q=t();V(y,p[1],p[0]),V(Q,m[1],m[0]),k(y,y,Q),$(l,p[0],p[1]),$(Q,m[0],m[1]),k(l,l,Q),k(b,p[3],m[3]),k(b,b,f),k(_,p[2],m[2]),$(_,_,_),V(T,l,y),V(U,_,b),$(Y,_,b),$(ae,l,y),k(p[0],T,U),k(p[1],ae,Y),k(p[2],Y,U),k(p[3],T,ae)}function an(p,m,y){var l;for(l=0;l<4;l++)tt(p[l],m[l],y)}function j(p,m){var y=t(),l=t(),b=t();De(b,m[2]),k(y,m[0],b),k(l,m[1],b),Ve(p,l),p[31]^=xo(y)<<7}function mt(p,m,y){var l,b;for(et(p[0],i),et(p[1],s),et(p[2],s),et(p[3],i),b=255;b>=0;--b)l=y[b/8|0]>>(b&7)&1,an(p,m,l),nr(m,p),nr(p,p),an(p,m,l)}function xt(p,m){var y=[t(),t(),t(),t()];et(y[0],d),et(y[1],h),et(y[2],s),k(y[3],d,h),mt(p,y,m)}function At(p,m,y){var l=new Uint8Array(64),b=[t(),t(),t(),t()],_;for(y||r(m,32),ot(l,m,32),l[0]&=248,l[31]&=127,l[31]|=64,xt(b,l),j(p,b),_=0;_<32;_++)m[_+32]=p[_];return 0}var Pt=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function rt(p,m){var y,l,b,_;for(l=63;l>=32;--l){for(y=0,b=l-32,_=l-12;b<_;++b)m[b]+=y-16*m[l]*Pt[b-(l-32)],y=Math.floor((m[b]+128)/256),m[b]-=y*256;m[b]+=y,m[l]=0}for(y=0,b=0;b<32;b++)m[b]+=y-(m[31]>>4)*Pt[b],y=m[b]>>8,m[b]&=255;for(b=0;b<32;b++)m[b]-=y*Pt[b];for(l=0;l<32;l++)m[l+1]+=m[l]>>8,p[l]=m[l]&255}function Kt(p){var m=new Float64Array(64),y;for(y=0;y<64;y++)m[y]=p[y];for(y=0;y<64;y++)p[y]=0;rt(p,m)}function Ht(p,m,y,l){var b=new Uint8Array(64),_=new Uint8Array(64),T=new Uint8Array(64),U,Y,ae=new Float64Array(64),Q=[t(),t(),t(),t()];ot(b,l,32),b[0]&=248,b[31]&=127,b[31]|=64;var Ue=y+64;for(U=0;U<y;U++)p[64+U]=m[U];for(U=0;U<32;U++)p[32+U]=b[32+U];for(ot(T,p.subarray(32),y+32),Kt(T),xt(Q,T),j(p,Q),U=32;U<64;U++)p[U]=l[U];for(ot(_,p,y+64),Kt(_),U=0;U<64;U++)ae[U]=0;for(U=0;U<32;U++)ae[U]=T[U];for(U=0;U<32;U++)for(Y=0;Y<32;Y++)ae[U+Y]+=_[U]*b[Y];return rt(p.subarray(32),ae),Ue}function or(p,m){var y=t(),l=t(),b=t(),_=t(),T=t(),U=t(),Y=t();return et(p[2],s),B(p[1],m),le(b,p[1]),k(_,b,u),V(b,b,p[2]),$(_,p[2],_),le(T,_),le(U,T),k(Y,U,T),k(y,Y,b),k(y,y,_),ct(y,y),k(y,y,b),k(y,y,_),k(y,y,_),k(p[0],y,_),le(l,p[0]),k(l,l,_),Or(l,b)&&k(p[0],p[0],g),le(l,p[0]),k(l,l,_),Or(l,b)?-1:(xo(p[0])===m[31]>>7&&V(p[0],i,p[0]),k(p[3],p[0],p[1]),0)}function Je(p,m,y,l){var b,_=new Uint8Array(32),T=new Uint8Array(64),U=[t(),t(),t(),t()],Y=[t(),t(),t(),t()];if(y<64||or(Y,l))return-1;for(b=0;b<y;b++)p[b]=m[b];for(b=0;b<32;b++)p[b+32]=l[b];if(ot(T,p,y),Kt(T),mt(U,Y,T),xt(Y,m.subarray(32)),nr(U,Y),j(_,U),y-=64,C(m,0,_,0)){for(b=0;b<y;b++)p[b]=0;return-1}for(b=0;b<y;b++)p[b]=m[b+64];return y}var Ge=32,It=24,Et=32,bt=16,ir=32,fr=32,sr=32,ar=32,xs=32,Wa=It,Tf=Et,Af=bt,Hr=64,On=32,Bn=64,Is=32,Ss=64;e.lowlevel={crypto_core_hsalsa20:O,crypto_stream_xor:Oe,crypto_stream:ce,crypto_stream_salsa20_xor:P,crypto_stream_salsa20:W,crypto_onetimeauth:we,crypto_onetimeauth_verify:he,crypto_verify_16:I,crypto_verify_32:C,crypto_secretbox:$e,crypto_secretbox_open:Pe,crypto_scalarmult:qe,crypto_scalarmult_base:We,crypto_box_beforenm:jt,crypto_box_afternm:nn,crypto_box:sn,crypto_box_open:jr,crypto_box_keypair:yt,crypto_hash:ot,crypto_sign:Ht,crypto_sign_keypair:At,crypto_sign_open:Je,crypto_secretbox_KEYBYTES:Ge,crypto_secretbox_NONCEBYTES:It,crypto_secretbox_ZEROBYTES:Et,crypto_secretbox_BOXZEROBYTES:bt,crypto_scalarmult_BYTES:ir,crypto_scalarmult_SCALARBYTES:fr,crypto_box_PUBLICKEYBYTES:sr,crypto_box_SECRETKEYBYTES:ar,crypto_box_BEFORENMBYTES:xs,crypto_box_NONCEBYTES:Wa,crypto_box_ZEROBYTES:Tf,crypto_box_BOXZEROBYTES:Af,crypto_sign_BYTES:Hr,crypto_sign_PUBLICKEYBYTES:On,crypto_sign_SECRETKEYBYTES:Bn,crypto_sign_SEEDBYTES:Is,crypto_hash_BYTES:Ss,gf:t,D:u,L:Pt,pack25519:Ve,unpack25519:B,M:k,A:$,S:le,Z:V,pow2523:ct,add:nr,set25519:et,modL:rt,scalarmult:mt,scalarbase:xt};function Ja(p,m){if(p.length!==Ge)throw new Error("bad key size");if(m.length!==It)throw new Error("bad nonce size")}function Of(p,m){if(p.length!==sr)throw new Error("bad public key size");if(m.length!==ar)throw new Error("bad secret key size")}function cr(){for(var p=0;p<arguments.length;p++)if(!(arguments[p]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function Xa(p){for(var m=0;m<p.length;m++)p[m]=0}e.randomBytes=function(p){var m=new Uint8Array(p);return r(m,p),m},e.secretbox=function(p,m,y){cr(p,m,y),Ja(y,m);for(var l=new Uint8Array(Et+p.length),b=new Uint8Array(l.length),_=0;_<p.length;_++)l[_+Et]=p[_];return $e(b,l,l.length,m,y),b.subarray(bt)},e.secretbox.open=function(p,m,y){cr(p,m,y),Ja(y,m);for(var l=new Uint8Array(bt+p.length),b=new Uint8Array(l.length),_=0;_<p.length;_++)l[_+bt]=p[_];return l.length<32||Pe(b,l,l.length,m,y)!==0?null:b.subarray(Et)},e.secretbox.keyLength=Ge,e.secretbox.nonceLength=It,e.secretbox.overheadLength=bt,e.scalarMult=function(p,m){if(cr(p,m),p.length!==fr)throw new Error("bad n size");if(m.length!==ir)throw new Error("bad p size");var y=new Uint8Array(ir);return qe(y,p,m),y},e.scalarMult.base=function(p){if(cr(p),p.length!==fr)throw new Error("bad n size");var m=new Uint8Array(ir);return We(m,p),m},e.scalarMult.scalarLength=fr,e.scalarMult.groupElementLength=ir,e.box=function(p,m,y,l){var b=e.box.before(y,l);return e.secretbox(p,m,b)},e.box.before=function(p,m){cr(p,m),Of(p,m);var y=new Uint8Array(xs);return jt(y,p,m),y},e.box.after=e.secretbox,e.box.open=function(p,m,y,l){var b=e.box.before(y,l);return e.secretbox.open(p,m,b)},e.box.open.after=e.secretbox.open,e.box.keyPair=function(){var p=new Uint8Array(sr),m=new Uint8Array(ar);return yt(p,m),{publicKey:p,secretKey:m}},e.box.keyPair.fromSecretKey=function(p){if(cr(p),p.length!==ar)throw new Error("bad secret key size");var m=new Uint8Array(sr);return We(m,p),{publicKey:m,secretKey:new Uint8Array(p)}},e.box.publicKeyLength=sr,e.box.secretKeyLength=ar,e.box.sharedKeyLength=xs,e.box.nonceLength=Wa,e.box.overheadLength=e.secretbox.overheadLength,e.sign=function(p,m){if(cr(p,m),m.length!==Bn)throw new Error("bad secret key size");var y=new Uint8Array(Hr+p.length);return Ht(y,p,p.length,m),y},e.sign.open=function(p,m){if(cr(p,m),m.length!==On)throw new Error("bad public key size");var y=new Uint8Array(p.length),l=Je(y,p,p.length,m);if(l<0)return null;for(var b=new Uint8Array(l),_=0;_<b.length;_++)b[_]=y[_];return b},e.sign.detached=function(p,m){for(var y=e.sign(p,m),l=new Uint8Array(Hr),b=0;b<l.length;b++)l[b]=y[b];return l},e.sign.detached.verify=function(p,m,y){if(cr(p,m,y),m.length!==Hr)throw new Error("bad signature size");if(y.length!==On)throw new Error("bad public key size");var l=new Uint8Array(Hr+p.length),b=new Uint8Array(Hr+p.length),_;for(_=0;_<Hr;_++)l[_]=m[_];for(_=0;_<p.length;_++)l[_+Hr]=p[_];return Je(b,l,l.length,y)>=0},e.sign.keyPair=function(){var p=new Uint8Array(On),m=new Uint8Array(Bn);return At(p,m),{publicKey:p,secretKey:m}},e.sign.keyPair.fromSecretKey=function(p){if(cr(p),p.length!==Bn)throw new Error("bad secret key size");for(var m=new Uint8Array(On),y=0;y<m.length;y++)m[y]=p[32+y];return{publicKey:m,secretKey:new Uint8Array(p)}},e.sign.keyPair.fromSeed=function(p){if(cr(p),p.length!==Is)throw new Error("bad seed size");for(var m=new Uint8Array(On),y=new Uint8Array(Bn),l=0;l<32;l++)y[l]=p[l];return At(m,y,!0),{publicKey:m,secretKey:y}},e.sign.publicKeyLength=On,e.sign.secretKeyLength=Bn,e.sign.seedLength=Is,e.sign.signatureLength=Hr,e.hash=function(p){cr(p);var m=new Uint8Array(Ss);return ot(m,p,p.length),m},e.hash.hashLength=Ss,e.verify=function(p,m){return cr(p,m),p.length===0||m.length===0||p.length!==m.length?!1:w(p,0,m,0,p.length)===0},e.setPRNG=function(p){r=p},function(){var p=typeof self<"u"?self.crypto||self.msCrypto:null;if(p&&p.getRandomValues){var m=65536;e.setPRNG(function(y,l){var b,_=new Uint8Array(l);for(b=0;b<l;b+=m)p.getRandomValues(_.subarray(b,b+Math.min(l-b,m)));for(b=0;b<l;b++)y[b]=_[b];Xa(_)})}else typeof vs<"u"&&(p=vs("crypto"),p&&p.randomBytes&&e.setPRNG(function(y,l){var b,_=p.randomBytes(l);for(b=0;b<l;b++)y[b]=_[b];Xa(_)}))}()})(typeof ts<"u"&&ts.exports?ts.exports:self.nacl=self.nacl||{})});var cn=Symbol("tag"),$n=Symbol("serialize"),Gn=Symbol("deserialize"),dr=(e,t)=>(e.add(t),t),Qt=e=>{let t=new WeakSet,r=[],n=new Set,o=new Set;return{data:JSON.parse(JSON.stringify(e,(s,a)=>{if(a&&typeof a=="object"&&t.has(a))return a;if(a===void 0)return dr(t,["_","_"]);if(!a)return a;if(Array.isArray(a)&&a[0]==="_")return dr(t,["_","_",...a]);if(a instanceof Map)return dr(t,["_","Map",Array.from(a.entries())]);if(a instanceof Set)return dr(t,["_","Set",Array.from(a.values())]);if(a instanceof Blob||a instanceof File){let f=r.length;return r[r.length]=a,dr(t,["_","_ref",f])}if(a instanceof Error){let f=r.length;return r[r.length]=a,a.cause&&(a.cause=Qt(a.cause).data),dr(t,["_","_err",dr(t,["_","_ref",f]),a.name])}if(a instanceof MessagePort||a instanceof ReadableStream||a instanceof WritableStream||a instanceof ArrayBuffer){let f=r.length;return r[r.length]=a,n.add(a),dr(t,["_","_ref",f])}if(ArrayBuffer.isView(a)){let f=r.length;return r[r.length]=a,n.add(a.buffer),dr(t,["_","_ref",f])}if(typeof a=="function"){let f=new MessageChannel;return f.port1.onmessage=async d=>{try{try{let h=await a(...Nr(d.data[1])),{data:g,transferables:E}=Qt(h);d.data[0].postMessage([!0,g],E)}catch(h){let{data:g,transferables:E}=Qt(h);d.data[0].postMessage([!1,g],E)}}catch(h){console.error("Async error on onmessage handler",h)}},n.add(f.port2),o.add(f.port1),dr(t,["_","_fn",f.port2])}let u=Object.getPrototypeOf(a);return u?.constructor?.[cn]&&u.constructor[$n]?dr(t,["_","_custom",u.constructor[cn],u.constructor[$n](a)]):a}),(s,a)=>Array.isArray(a)&&a[0]==="_"&&a[1]==="_ref"?r[a[2]]:a),transferables:Array.from(n),revokables:Array.from(o)}},Ts=Object.create(null),Nr=e=>{let t=new WeakSet,r=[];return JSON.parse(JSON.stringify(e,(n,o)=>{if(o&&typeof o=="object"&&!t.has(o)&&!Array.isArray(o)&&Object.getPrototypeOf(o)!==Object.prototype){let i=r.length;return r[r.length]=o,dr(t,["_","_ref",i])}return o}),(n,o)=>{if(Array.isArray(o)&&o[0]==="_")switch(o[1]){case"_":return o.length>=3?o.slice(2):void 0;case"Map":return new Map(o[2]);case"Set":return new Set(o[2]);case"_custom":if(Ts[o[2]])return Ts[o[2]](o[3]);throw new Error("Invalid or unknown tag: "+o[2]);case"_ref":return r[o[2]];case"_err":return o[2].name!==o[3]&&(o[2].name=o[3]),o[2].cause&&(o[2].cause=Nr(o[2].cause)),o[2];case"_fn":{let i=o[2];return(...s)=>new Promise((a,u)=>{let f=new MessageChannel,{data:d,transferables:h}=Qt(s);f.port1.onmessage=g=>{g.data[0]?a(Nr(g.data[1])):u(Nr(g.data[1]))},i.postMessage([f.port2,d],[f.port2,...h])})}}return o})};Nr.register=e=>{typeof e=="function"&&typeof e[cn]=="string"&&typeof e[Gn]=="function"&&(Ts[e[cn]]=e[Gn].bind(e))};var jn="invite-initial-creator",Ot={ACTIVE:"active",PENDING:"pending",REMOVED:"removed"};var ui="proposal-result",pr="invite-member",St="remove-member",Er="group-setting-change",br="proposal-setting-change",Yt="generic",Za="proposal-archived";var ec=2;var tc=150;var So="open",Dr="passed",Hn="failed",rc="expiring",li="expired",fi="cancelled";var Kf={VIEW_PERMISSIONS:"view-permissions",ASSIGN_DELEGATOR:"assign-delegator",DELEGATE_PERMISSIONS:"delegate-permissions",REMOVE_MEMBER:"remove-member",REVOKE_INVITE:"revoke-invite",DELETE_CHANNEL:"delete-channel"},zt=Kf,sg={ADMIN:[zt.VIEW_PERMISSIONS,zt.ASSIGN_DELEGATOR,zt.DELEGATE_PERMISSIONS,zt.REMOVE_MEMBER,zt.REVOKE_INVITE,zt.DELETE_CHANNEL],MODERATOR_DELEGATOR:[zt.VIEW_PERMISSIONS,zt.DELEGATE_PERMISSIONS,zt.REMOVE_MEMBER,zt.REVOKE_INVITE,zt.DELETE_CHANNEL],MODERATOR:[zt.VIEW_PERMISSIONS,zt.REMOVE_MEMBER,zt.REVOKE_INVITE,zt.DELETE_CHANNEL]};var Ct="@",di="#",nc="message-receive-raw",pi="message-receive",oc="message-send",hi={DIRECT_MESSAGE:"direct-message",GROUP:"group"},hr={GROUP:"group",PRIVATE:"private",PUBLIC:"public"},Rr={POLL:"poll",TEXT:"text",INTERACTIVE:"interactive",NOTIFICATION:"notification"},As={ON_BOARDING:null,PROPOSAL:7};var kr={ALL_MESSAGES:"all-messages",DIRECT_MESSAGES:"direct-messages",NOTHING:"nothing"};var Ms={};Qa(Ms,{Errors:()=>Ks,GIErrorIgnoreAndBan:()=>pc,GIErrorMissingSigningKeyError:()=>Cn,GIErrorUIRuntimeError:()=>_t,L:()=>S,LError:()=>wr,LTags:()=>Vt});var un=Object.create(null),Yr=Object.create(null),sc=[],yi=Object.create(null),mi=Object.create(null),gi=Object.create(null),Mf=/^[^/]+/;function Os(e,...t){let r=_o(e),n=`${r}/*`,o=!!un[e],i=e;if(!o)if(un[n])i=n;else throw new Error(`SBP: selector not registered: ${e}`);for(let s of[mi[e],yi[r],sc])if(s){for(let a of s)if(a(r,e,t)===!1)return}return o||t.unshift(e),un[i].apply(Yr[r].state,t)}function _o(e){let t=Mf.exec(e);if(t===null)throw new Error(`SBP: selector missing domain: ${e}`);return t[0]}var ic={"sbp/selectors/register":e=>{let t=[];for(let r in e){let n=_o(r),o=n in Yr?Yr[n]:Yr[n]={state:Object.create(null),locked:!1};if(o.locked)(console.warn||console.log)(`[SBP WARN]: not registering selector on locked domain: '${r}'`);else if(un[r])(console.warn||console.log)(`[SBP WARN]: not registering already registered selector: '${r}'`);else if(typeof e[r]=="function"){gi[r]&&(console.warn||console.log)(`[SBP WARN]: registering unsafe selector: '${r}' (remember to lock after overwriting)`);let i=un[r]=e[r];t.push(r),r===`${n}/_init`&&i.call(o.state)}}return t},"sbp/selectors/unregister":e=>{var t;for(let r of e){if(!gi[r])throw new Error(`SBP: can't unregister locked selector: ${r}`);if(!((t=Yr[_o(r)])===null||t===void 0)&&t.locked)throw new Error(`SBP: can't unregister selector on a locked domain: '${r}'`);delete un[r]}},"sbp/selectors/overwrite":e=>(Os("sbp/selectors/unregister",Object.keys(e)),Os("sbp/selectors/register",e)),"sbp/selectors/unsafe":e=>{for(let t of e){if(un[t])throw new Error("unsafe must be called before registering selector");gi[t]=!0}},"sbp/selectors/lock":e=>{for(let t of e)delete gi[t]},"sbp/selectors/fn":e=>un[e],"sbp/filters/global/add":e=>{sc.push(e)},"sbp/filters/domain/add":(e,t)=>{yi[e]||(yi[e]=[]),yi[e].push(t)},"sbp/filters/selector/add":(e,t)=>{mi[e]||(mi[e]=[]),mi[e].push(t)},"sbp/domains/lock":e=>{if(e)for(let t of e){if(!Yr[t])throw new Error(`SBP: cannot lock non-existent domain: ${t}`);Yr[t].locked=!0}else for(let t in Yr)Yr[t].locked=!0}};ic["sbp/selectors/register"](ic);var c=Os;var Uf=/\{([0-9a-zA-Z_]+)\}/g;function Cs(e,...t){let r=t[0],n=typeof r=="object"&&r!==null?r:t;return e.replace(Uf,function(i,s,a){if(e[a-1]==="{"&&e[a+i.length]==="}")return s;let u=Object.prototype.hasOwnProperty.call(n,s)?n[s]:void 0;return u==null?"":String(u)})}var Ps="en-US",ac="en",Rs={},Ns=Ps,Ds=Ps.split("-")[0],ks=Rs,dg=c("sbp/selectors/register",{"translations/init":async function(t){let[r]=t.toLowerCase().split("-");if(t.toLowerCase()!==Ns.toLowerCase()&&r!==Ds){if(r===ac){Ns=Ps,Ds=ac,ks=Rs;return}try{ks=await c("backend/translations/get",t)||Rs,Ns=t,Ds=r}catch(n){console.error(n)}}}});function Vt(...e){let t={br_:"<br/>"};for(let r of e)t[`${r}_`]=`<${r}>`,t[`_${r}`]=`</${r}>`;return t}function S(e,t){return Cs(ks[e]||e,t).replace(/\s(?=[;:?!])/g,"\xA0")}function wr(e,t){let r="https://github.com/okTurtles/group-income/issues";return!t&&c("state/vuex/state").loggedIn&&(r=`${c("controller/router").options.base}?modal=UserSettingsModal&tab=application-logs&errorMsg=${encodeURIComponent(e.message)}`),{reportError:S('"{errorMsg}". You can {a_}report the error{_a}.',{errorMsg:e.message,a_:`<a class="link" target="_blank" href="${r}">`,_a:"</a>"})}}var Ks={};Qa(Ks,{GIErrorIgnoreAndBan:()=>pc,GIErrorMissingSigningKeyError:()=>Cn,GIErrorUIRuntimeError:()=>_t});var dt=(e,t=Error)=>class extends t{constructor(...r){super(...r),this.name=e,r[1]?.cause!==this.cause&&Object.defineProperty(this,"cause",{configurable:!0,writable:!0,value:r[1]?.cause}),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}},Ei=dt("ChelErrorWarning"),cc=dt("ChelErrorAlreadyProcessed"),Pr=dt("ChelErrorDBBadPreviousHEAD"),bi=dt("ChelErrorDBConnection"),wi=dt("ChelErrorUnexpected"),uc=dt("ChelErrorKeyAlreadyExists"),zn=dt("ChelErrorUnrecoverable"),xi=dt("ChelErrorForkedChain"),Yn=dt("ChelErrorDecryptionError"),lc=dt("ChelErrorDecryptionKeyNotFound",Yn),Kr=dt("ChelErrorSignatureError"),fc=dt("ChelErrorSignatureKeyUnauthorized",Kr),Ii=dt("ChelErrorSignatureKeyNotFound",Kr),dc=dt("ChelErrorFetchServerTimeFailed"),ln=dt("ChelErrorUnexpectedHttpResponseCode"),Vr=dt("ChelErrorResourceGone",ln);var pc=dt("GIErrorIgnoreAndBan"),_t=dt("GIErrorUIRuntimeError"),Cn=dt("GIErrorMissingSigningKeyError");var qn=6e4,Ls=60*qn,Ft=24*Ls,wg=30*Ft,xg=365*Ft,hc=(e,t)=>xr(Mr(e,t)),Us=(e,t)=>xr(Mr(e,-t));function Si(e,{knownSortedStamps:t,periodLength:r,guess:n}){if(!(Ff(e)||Object.prototype.toString.call(e)==="[object Date]"))throw new TypeError("must be ISO string or Date object");let o=typeof e=="string"?e:e.toISOString(),i,s,a;if(t.length){let u=t[t.length-1],f=t[0];if(o>=u)s=gc({recentDate:o,periodStart:u,periodLength:r}),a=hc(s,r),i=s>u?Us(s,r):t[t.length-2];else if(n&&o<f)s=gc({recentDate:o,periodStart:f,periodLength:r}),a=hc(s,r),i=Us(s,r);else for(let d=t.length-2;d>=0;d--)if(o>=t[d]){s=t[d],a=t[d+1],i=d>0?t[d-1]:n?Us(s,r):void 0;break}}return{previous:i,current:s,next:a}}function xr(e){return new Date(e).toISOString()}function Vn(e){return new Date(e)}function gc({recentDate:e,periodStart:t,periodLength:r}){let n=Vn(t),o=Mr(n,r),i=new Date(e),s;if(i<o){if(i>=n)return t;s=n;do s=Mr(s,-r);while(i<s)}else do s=o,o=Mr(o,r);while(i>=o);return xr(s)}function yc({date:e,periodStart:t,periodLength:r}){let n=new Date(e),o=Vn(t);return n>o&&n<Mr(o,r)}function Mr(e,t){let r=new Date(e);return r.setTime(r.getTime()+t),r}function _i(e,t){return Vn(e).getTime()-Vn(t).getTime()}function Lf(){let e="en-US-POSIX";return typeof navigator>"u"?e:navigator.languages??navigator.language??e}function vi(e,t={month:"short",day:"numeric"}){let r=new Date(e),n=Lf();return isNaN(r.valueOf())?"":r.toLocaleDateString(n,t)}function Ff(e){return typeof e=="string"&&/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z/.test(e)}var Bf=Symbol("@@empty"),Wn=e=>e===Bf,$f=e=>e===null,Gf=e=>typeof e>"u",jf=e=>typeof e=="boolean",Hf=e=>typeof e=="number",zf=e=>typeof e=="string",Yf=e=>!$f(e)&&typeof e=="object",To=e=>typeof e=="function";var vo=(e,t)=>To(e.type)?e.type(t):e.name||"?",Fs=class e extends Error{expectedType;valueType;value;typeScope;sourceFile;constructor(t,r,n,o,i="",s=""){let a=t||`invalid "${n}" value type; ${i||r} type expected`;super(a),this.expectedType=r,this.valueType=n,this.value=o,this.typeScope=s||"",this.sourceFile=this.getSourceFile(),this.message=`${a}
${this.getErrorInfo()}`,this.name=this.constructor.name,Error.captureStackTrace&&Error.captureStackTrace(this,e)}getSourceFile(){return(this.stack.match(/(\/[\w_\-.]+)+(\.\w+:\d+:\d+)/g)||[]).find(r=>r.indexOf("/flowTyper-js/dist/")===-1)||""}getErrorInfo(){return`
    file     ${this.sourceFile}
    scope    ${this.typeScope}
    expected ${this.expectedType.replace(/\n/g,"")}
    type     ${this.valueType}
    value    ${this.value}
`}},fn=(e,t,r,n,o,i)=>new Fs(n,o||vo(e),i||typeof t,JSON.stringify(t),e.name,r);var dn=e=>{function t(r,n=""){if(Wn(r)||r===e)return e;throw fn(t,r,n)}return t.type=()=>jf(e)?`${e?"true":"false"}`:`"${e}"`,t};var mc=function(e){if(Wn(e))return{};if(Yf(e)&&!Array.isArray(e))return Object.assign({},e);throw fn(mc,e)},Nn=(e,t="Object")=>{function r(n){let o=mc(n),i=Object.keys(e),s=Object.keys(o).find(f=>!i.includes(f));if(s)throw fn(r,n,t,`missing object property '${s}' in ${t} type`);let a=i.find(f=>e[f].name.includes("maybe")&&!o.hasOwnProperty(f));if(a)throw fn(r,o[a],`${t}.${a}`,`empty object property '${a}' for ${t} type`,`void | null | ${vo(e[a]).substr(1)}`,"-");let u=Wn(n)?(f,d)=>Object.assign(f,{[d]:e[d](n)}):(f,d)=>{let h=e[d];return h.name.includes("optional")&&!o.hasOwnProperty(d)?Object.assign(f,{}):Object.assign(f,{[d]:h(o[d],`${t}.${d}`)})};return i.reduce(u,{})}return r.type=()=>`{|
 ${Object.keys(e).map(o=>e[o].name.includes("optional")?`${o}?: ${vo(e[o],{noVoid:!0})}`:`${o}: ${vo(e[o])}`).join(`,
  `)} 
|}`,r};function Ec(e,t=""){if(!(Wn(e)||Gf(e)))throw fn(Ec,e,t)}Ec.type=()=>"void";var Ti=function e(t,r=""){if(Wn(t))return 0;if(Hf(t))return t;throw fn(e,t,r)};var bc=function e(t,r=""){if(Wn(t))return"";if(zf(t))return t;throw fn(e,t,r)};function Vf(...e){function t(r,n=""){for(let o of e)try{return o(r,n)}catch{}throw fn(t,r,n)}return t.type=()=>`(${e.map(r=>vo(r)).join(" | ")})`,t}var pn=Vf;var Bs,qr={MIN1:"1MIN",MIN5:"5MIN",MIN15:"15MIN",MIN30:"30MIN"},Zt={notifications:[],partition:Object.create(null)},qf={[qr.MIN1]:1*qn,[qr.MIN5]:5*qn,[qr.MIN15]:15*qn,[qr.MIN30]:30*qn},Wf=Nn({stateKey:e=>{if(e=bc(e),e.length===0)throw new TypeError("Empty notification data state key");return e},emitCondition:To,emit:To,shouldClearStateKey:To});async function wc(){let e=c("state/vuex/state"),t=c("state/vuex/getters"),r=e.periodicNotificationAlreadyFiredMap.alreadyFired,n=e.periodicNotificationAlreadyFiredMap.lastRun,o=(a,u)=>a.call(Zt.partition[u],{rootState:e,rootGetters:t});if(Zt.clearTimeout)return;let i=!1,s=()=>{i=!0};Zt.clearTimeout=s,await Promise.all(Object.entries(c("okTurtles.eventQueue/queuedInvocations")).map(([a,u])=>!!u.length&&c("okTurtles.eventQueue/queueEvent",a,()=>{}).catch(()=>{})));for(let a of Zt.notifications){if(i)break;let u=a.stateKey,f=n[u]||0,d=a.delay;if(Date.now()-f>=d){try{!r[u]&&o(a.emitCondition,u)&&(await o(a.emit,u),r[u]=!0),r[u]&&o(a.shouldClearStateKey,u)&&delete r[u]}catch(h){console.error("runNotificationListRecursive: Error calling notification",u,h)}n[u]=Date.now()}}Zt.clearTimeout===s&&(Zt.clearTimeout=(()=>{let a=setTimeout(()=>{delete Zt.clearTimeout,wc()},Bs);return()=>clearTimeout(a)})())}function Jf(){Zt.clearTimeout&&(Zt.clearTimeout(),delete Zt.clearTimeout),Zt.notifications.forEach(({stateKey:e})=>{Zt.partition[e]=Object.create(null)})}c("sbp/selectors/register",{"gi.periodicNotifications/init":function(){return wc().catch(e=>{console.error("[gi.periodicNotifications/init] Error",e)})},"gi.periodicNotifications/clearStatesAndStopTimers":function(){let e=c("state/vuex/state");e.periodicNotificationAlreadyFiredMap={alreadyFired:Object.create(null),lastRun:Object.create(null)},Jf()},"gi.periodicNotifications/importNotifications":function(e){let t=new Set;for(let{type:r,notificationData:n}of e){if(!r||!n)throw new Error("A required field in a periodic notification entry is missing.");let o=qf[r];if(!o)throw new RangeError("Invalid delay");if(Bs<=o||(Bs=o),Wf(n),t.has(n.stateKey))throw new Error("Duplicate periodic notification state key: "+n.stateKey);t.add(n.stateKey),Zt.partition[n.stateKey]=Object.create(null),Zt.notifications.push({...n,delay:o})}}});var Ai=60*Ft,Oi=180*Ft;var Ng=new Uint8Array(0);function xc(e,t){if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let r=0;r<e.byteLength;r++)if(e[r]!==t[r])return!1;return!0}function J(e){if(e instanceof Uint8Array&&e.constructor.name==="Uint8Array")return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")}function Xf(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var r=new Uint8Array(256),n=0;n<r.length;n++)r[n]=255;for(var o=0;o<e.length;o++){var i=e.charAt(o),s=i.charCodeAt(0);if(r[s]!==255)throw new TypeError(i+" is ambiguous");r[s]=o}var a=e.length,u=e.charAt(0),f=Math.log(a)/Math.log(256),d=Math.log(256)/Math.log(a);function h(w){if(w instanceof Uint8Array||(ArrayBuffer.isView(w)?w=new Uint8Array(w.buffer,w.byteOffset,w.byteLength):Array.isArray(w)&&(w=Uint8Array.from(w))),!(w instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(w.length===0)return"";for(var I=0,C=0,G=0,A=w.length;G!==A&&w[G]===0;)G++,I++;for(var R=(A-G)*d+1>>>0,O=new Uint8Array(R);G!==A;){for(var F=w[G],P=0,W=R-1;(F!==0||P<C)&&W!==-1;W--,P++)F+=256*O[W]>>>0,O[W]=F%a>>>0,F=F/a>>>0;if(F!==0)throw new Error("Non-zero carry");C=P,G++}for(var ce=R-C;ce!==R&&O[ce]===0;)ce++;for(var Oe=u.repeat(I);ce<R;++ce)Oe+=e.charAt(O[ce]);return Oe}function g(w){if(typeof w!="string")throw new TypeError("Expected String");if(w.length===0)return new Uint8Array;var I=0;if(w[I]!==" "){for(var C=0,G=0;w[I]===u;)C++,I++;for(var A=(w.length-I)*f+1>>>0,R=new Uint8Array(A);w[I];){var O=r[w.charCodeAt(I)];if(O===255)return;for(var F=0,P=A-1;(O!==0||F<G)&&P!==-1;P--,F++)O+=a*R[P]>>>0,R[P]=O%256>>>0,O=O/256>>>0;if(O!==0)throw new Error("Non-zero carry");G=F,I++}if(w[I]!==" "){for(var W=A-G;W!==A&&R[W]===0;)W++;for(var ce=new Uint8Array(C+(A-W)),Oe=C;W!==A;)ce[Oe++]=R[W++];return ce}}}function E(w){var I=g(w);if(I)return I;throw new Error(`Non-${t} character`)}return{encode:h,decodeUnsafe:g,decode:E}}var Qf=Xf,Zf=Qf,Sc=Zf;var $s=class{constructor(t,r,n){this.name=t,this.prefix=r,this.baseEncode=n}encode(t){if(t instanceof Uint8Array)return`${this.prefix}${this.baseEncode(t)}`;throw Error("Unknown type, must be binary type")}},Gs=class{constructor(t,r,n){if(this.name=t,this.prefix=r,r.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=r.codePointAt(0),this.baseDecode=n}decode(t){if(typeof t=="string"){if(t.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(t)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(t.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(t){return _c(this,t)}},js=class{constructor(t){this.decoders=t}or(t){return _c(this,t)}decode(t){let r=t[0],n=this.decoders[r];if(n!=null)return n.decode(t);throw RangeError(`Unable to decode multibase string ${JSON.stringify(t)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}};function _c(e,t){var r,n;return new js(Object.assign(Object.assign({},(r=e.decoders)!==null&&r!==void 0?r:{[e.prefix]:e}),(n=t.decoders)!==null&&n!==void 0?n:{[t.prefix]:t}))}var Ci=class{constructor(t,r,n,o){this.name=t,this.prefix=r,this.baseEncode=n,this.baseDecode=o,this.encoder=new $s(t,r,n),this.decoder=new Gs(t,r,o)}encode(t){return this.encoder.encode(t)}decode(t){return this.decoder.decode(t)}};function Hs({name:e,prefix:t,encode:r,decode:n}){return new Ci(e,t,r,n)}function Ni({name:e,prefix:t,alphabet:r}){let{encode:n,decode:o}=Sc(r,e);return Hs({prefix:t,name:e,encode:n,decode:i=>J(o(i))})}function ed(e,t,r,n){let o={};for(let d=0;d<t.length;++d)o[t[d]]=d;let i=e.length;for(;e[i-1]==="=";)--i;let s=new Uint8Array(i*r/8|0),a=0,u=0,f=0;for(let d=0;d<i;++d){let h=o[e[d]];if(h===void 0)throw new SyntaxError(`Non-${n} character`);u=u<<r|h,a+=r,a>=8&&(a-=8,s[f++]=255&u>>a)}if(a>=r||255&u<<8-a)throw new SyntaxError("Unexpected end of data");return s}function td(e,t,r){let n=t[t.length-1]==="=",o=(1<<r)-1,i="",s=0,a=0;for(let u=0;u<e.length;++u)for(a=a<<8|e[u],s+=8;s>r;)s-=r,i+=t[o&a>>s];if(s!==0&&(i+=t[o&a<<r-s]),n)for(;i.length*r&7;)i+="=";return i}function Ir({name:e,prefix:t,bitsPerChar:r,alphabet:n}){return Hs({prefix:t,name:e,encode(o){return td(o,n,r)},decode(o){return ed(o,n,r,e)}})}var Nt=Ni({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),rd=Ni({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Wc=Io(qs(),1);var dd=Yc,Hc=128,pd=127,hd=~pd,gd=Math.pow(2,31);function Yc(e,t,r){t=t||[],r=r||0;for(var n=r;e>=gd;)t[r++]=e&255|Hc,e/=128;for(;e&hd;)t[r++]=e&255|Hc,e>>>=7;return t[r]=e|0,Yc.bytes=r-n+1,t}var yd=Ws,md=128,zc=127;function Ws(e,n){var r=0,n=n||0,o=0,i=n,s,a=e.length;do{if(i>=a)throw Ws.bytes=0,new RangeError("Could not decode varint");s=e[i++],r+=o<28?(s&zc)<<o:(s&zc)*Math.pow(2,o),o+=7}while(s>=md);return Ws.bytes=i-n,r}var Ed=Math.pow(2,7),bd=Math.pow(2,14),wd=Math.pow(2,21),xd=Math.pow(2,28),Id=Math.pow(2,35),Sd=Math.pow(2,42),_d=Math.pow(2,49),vd=Math.pow(2,56),Td=Math.pow(2,63),Ad=function(e){return e<Ed?1:e<bd?2:e<wd?3:e<xd?4:e<Id?5:e<Sd?6:e<_d?7:e<vd?8:e<Td?9:10},Od={encode:dd,decode:yd,encodingLength:Ad},Cd=Od,No=Cd;function Do(e,t=0){return[No.decode(e,t),No.decode.bytes]}function Jn(e,t,r=0){return No.encode(e,t,r),t}function Xn(e){return No.encodingLength(e)}function Qn(e,t){let r=t.byteLength,n=Xn(e),o=n+Xn(r),i=new Uint8Array(o+r);return Jn(e,i,0),Jn(r,i,n),i.set(t,o),new Dn(e,r,t,i)}function Js(e){let t=J(e),[r,n]=Do(t),[o,i]=Do(t.subarray(n)),s=t.subarray(n+i);if(s.byteLength!==o)throw new Error("Incorrect length");return new Dn(r,o,s,t)}function Xs(e,t){if(e===t)return!0;{let r=t;return e.code===r.code&&e.size===r.size&&r.bytes instanceof Uint8Array&&xc(e.bytes,r.bytes)}}var Dn=class{constructor(t,r,n,o){this.code=t,this.size=r,this.digest=n,this.bytes=o}};function ee({name:e,code:t,encode:r}){return new Ki(e,t,r)}var Ki=class{constructor(t,r,n){this.name=t,this.code=r,this.encode=n}digest(t){if(t instanceof Uint8Array||t instanceof ReadableStream){let r=this.encode(t);return r instanceof Uint8Array?Qn(this.code,r):r.then(n=>Qn(this.code,n))}else throw Error("Unknown type, must be binary type")}};var{blake2b:oe}=Wc.default,Yg=ee({name:"blake2b-8",code:45569,encode:e=>J(oe(e,void 0,1))}),Vg=ee({name:"blake2b-16",code:45570,encode:e=>J(oe(e,void 0,2))}),qg=ee({name:"blake2b-24",code:45571,encode:e=>J(oe(e,void 0,3))}),Wg=ee({name:"blake2b-32",code:45572,encode:e=>J(oe(e,void 0,4))}),Jg=ee({name:"blake2b-40",code:45573,encode:e=>J(oe(e,void 0,5))}),Xg=ee({name:"blake2b-48",code:45574,encode:e=>J(oe(e,void 0,6))}),Qg=ee({name:"blake2b-56",code:45575,encode:e=>J(oe(e,void 0,7))}),Zg=ee({name:"blake2b-64",code:45576,encode:e=>J(oe(e,void 0,8))}),ey=ee({name:"blake2b-72",code:45577,encode:e=>J(oe(e,void 0,9))}),ty=ee({name:"blake2b-80",code:45578,encode:e=>J(oe(e,void 0,10))}),ry=ee({name:"blake2b-88",code:45579,encode:e=>J(oe(e,void 0,11))}),ny=ee({name:"blake2b-96",code:45580,encode:e=>J(oe(e,void 0,12))}),oy=ee({name:"blake2b-104",code:45581,encode:e=>J(oe(e,void 0,13))}),iy=ee({name:"blake2b-112",code:45582,encode:e=>J(oe(e,void 0,14))}),sy=ee({name:"blake2b-120",code:45583,encode:e=>J(oe(e,void 0,15))}),ay=ee({name:"blake2b-128",code:45584,encode:e=>J(oe(e,void 0,16))}),cy=ee({name:"blake2b-136",code:45585,encode:e=>J(oe(e,void 0,17))}),uy=ee({name:"blake2b-144",code:45586,encode:e=>J(oe(e,void 0,18))}),ly=ee({name:"blake2b-152",code:45587,encode:e=>J(oe(e,void 0,19))}),fy=ee({name:"blake2b-160",code:45588,encode:e=>J(oe(e,void 0,20))}),dy=ee({name:"blake2b-168",code:45589,encode:e=>J(oe(e,void 0,21))}),py=ee({name:"blake2b-176",code:45590,encode:e=>J(oe(e,void 0,22))}),hy=ee({name:"blake2b-184",code:45591,encode:e=>J(oe(e,void 0,23))}),gy=ee({name:"blake2b-192",code:45592,encode:e=>J(oe(e,void 0,24))}),yy=ee({name:"blake2b-200",code:45593,encode:e=>J(oe(e,void 0,25))}),my=ee({name:"blake2b-208",code:45594,encode:e=>J(oe(e,void 0,26))}),Ey=ee({name:"blake2b-216",code:45595,encode:e=>J(oe(e,void 0,27))}),by=ee({name:"blake2b-224",code:45596,encode:e=>J(oe(e,void 0,28))}),wy=ee({name:"blake2b-232",code:45597,encode:e=>J(oe(e,void 0,29))}),xy=ee({name:"blake2b-240",code:45598,encode:e=>J(oe(e,void 0,30))}),Iy=ee({name:"blake2b-248",code:45599,encode:e=>J(oe(e,void 0,31))}),Zn=ee({name:"blake2b-256",code:45600,encode:e=>J(oe(e,void 0,32))}),Sy=ee({name:"blake2b-264",code:45601,encode:e=>J(oe(e,void 0,33))}),_y=ee({name:"blake2b-272",code:45602,encode:e=>J(oe(e,void 0,34))}),vy=ee({name:"blake2b-280",code:45603,encode:e=>J(oe(e,void 0,35))}),Ty=ee({name:"blake2b-288",code:45604,encode:e=>J(oe(e,void 0,36))}),Ay=ee({name:"blake2b-296",code:45605,encode:e=>J(oe(e,void 0,37))}),Oy=ee({name:"blake2b-304",code:45606,encode:e=>J(oe(e,void 0,38))}),Cy=ee({name:"blake2b-312",code:45607,encode:e=>J(oe(e,void 0,39))}),Ny=ee({name:"blake2b-320",code:45608,encode:e=>J(oe(e,void 0,40))}),Dy=ee({name:"blake2b-328",code:45609,encode:e=>J(oe(e,void 0,41))}),Ry=ee({name:"blake2b-336",code:45610,encode:e=>J(oe(e,void 0,42))}),ky=ee({name:"blake2b-344",code:45611,encode:e=>J(oe(e,void 0,43))}),Py=ee({name:"blake2b-352",code:45612,encode:e=>J(oe(e,void 0,44))}),Ky=ee({name:"blake2b-360",code:45613,encode:e=>J(oe(e,void 0,45))}),My=ee({name:"blake2b-368",code:45614,encode:e=>J(oe(e,void 0,46))}),Uy=ee({name:"blake2b-376",code:45615,encode:e=>J(oe(e,void 0,47))}),Ly=ee({name:"blake2b-384",code:45616,encode:e=>J(oe(e,void 0,48))}),Fy=ee({name:"blake2b-392",code:45617,encode:e=>J(oe(e,void 0,49))}),By=ee({name:"blake2b-400",code:45618,encode:e=>J(oe(e,void 0,50))}),$y=ee({name:"blake2b-408",code:45619,encode:e=>J(oe(e,void 0,51))}),Gy=ee({name:"blake2b-416",code:45620,encode:e=>J(oe(e,void 0,52))}),jy=ee({name:"blake2b-424",code:45621,encode:e=>J(oe(e,void 0,53))}),Hy=ee({name:"blake2b-432",code:45622,encode:e=>J(oe(e,void 0,54))}),zy=ee({name:"blake2b-440",code:45623,encode:e=>J(oe(e,void 0,55))}),Yy=ee({name:"blake2b-448",code:45624,encode:e=>J(oe(e,void 0,56))}),Vy=ee({name:"blake2b-456",code:45625,encode:e=>J(oe(e,void 0,57))}),qy=ee({name:"blake2b-464",code:45626,encode:e=>J(oe(e,void 0,58))}),Wy=ee({name:"blake2b-472",code:45627,encode:e=>J(oe(e,void 0,59))}),Jy=ee({name:"blake2b-480",code:45628,encode:e=>J(oe(e,void 0,60))}),Xy=ee({name:"blake2b-488",code:45629,encode:e=>J(oe(e,void 0,61))}),Qy=ee({name:"blake2b-496",code:45630,encode:e=>J(oe(e,void 0,62))}),Zy=ee({name:"blake2b-504",code:45631,encode:e=>J(oe(e,void 0,63))}),em=ee({name:"blake2b-512",code:45632,encode:e=>J(oe(e,void 0,64))});var Jc=Io(qs(),1);var Nd=function(e,t,r,n){function o(i){return i instanceof r?i:new r(function(s){s(i)})}return new(r||(r=Promise))(function(i,s){function a(d){try{f(n.next(d))}catch(h){s(h)}}function u(d){try{f(n.throw(d))}catch(h){s(h)}}function f(d){d.done?i(d.value):o(d.value).then(a,u)}f((n=n.apply(e,t||[])).next())})},{blake2b:Dd,blake2bInit:Rd,blake2bUpdate:kd,blake2bFinal:Pd}=Jc.default,Xc=ee({name:"blake2b-256",code:45600,encode:e=>Nd(void 0,void 0,void 0,function*(){if(e instanceof ReadableStream){let t=Rd(32),r=e.getReader();for(;;){let n=yield r.read();if(n.done)break;kd(t,J(n.value))}return Pd(t)}else return J(Dd(e,void 0,32))})});var eo=Ir({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Kd=Ir({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Md=Ir({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ud=Ir({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Ld=Ir({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),im=Ir({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),sm=Ir({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Fd=Ir({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Bd=Ir({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});var Qc;function Zc(e,t){let{bytes:r,version:n}=e;switch(n){case 0:return Gd(r,Qs(e),t??Nt.encoder);default:return jd(r,Qs(e),t??eo.encoder)}}var eu=new WeakMap;function Qs(e){let t=eu.get(e);if(t==null){let r=new Map;return eu.set(e,r),r}return t}var to=class e{constructor(t,r,n,o){this[Qc]="CID",this.code=r,this.version=t,this.multihash=n,this.bytes=o,this["/"]=o}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{let{code:t,multihash:r}=this;if(t!==Ro)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(r.code!==Hd)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return e.createV0(r)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{let{code:t,digest:r}=this.multihash,n=Qn(t,r);return e.createV1(this.code,n)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(t){return e.equals(this,t)}static equals(t,r){let n=r;return n!=null&&t.code===n.code&&t.version===n.version&&Xs(t.multihash,n.multihash)}toString(t){return Zc(this,t)}toJSON(){return{"/":Zc(this)}}link(){return this}[(Qc=Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom"))](){return`CID(${this.toString()})`}static asCID(t){if(t==null)return null;let r=t;if(r instanceof e)return r;if(r["/"]!=null&&r["/"]===r.bytes||r.asCID===r){let{version:n,code:o,multihash:i,bytes:s}=r;return new e(n,o,i,s??tu(n,o,i.bytes))}else if(r[zd]===!0){let{version:n,multihash:o,code:i}=r,s=Js(o);return e.create(n,i,s)}else return null}static create(t,r,n){if(typeof r!="number")throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(t){case 0:{if(r!==Ro)throw new Error(`Version 0 CID must use dag-pb (code: ${Ro}) block encoding`);return new e(t,r,n,n.bytes)}case 1:{let o=tu(t,r,n.bytes);return new e(t,r,n,o)}default:throw new Error("Invalid version")}}static createV0(t){return e.create(0,Ro,t)}static createV1(t,r){return e.create(1,t,r)}static decode(t){let[r,n]=e.decodeFirst(t);if(n.length!==0)throw new Error("Incorrect length");return r}static decodeFirst(t){let r=e.inspectBytes(t),n=r.size-r.multihashSize,o=J(t.subarray(n,n+r.multihashSize));if(o.byteLength!==r.multihashSize)throw new Error("Incorrect length");let i=o.subarray(r.multihashSize-r.digestSize),s=new Dn(r.multihashCode,r.digestSize,i,o);return[r.version===0?e.createV0(s):e.createV1(r.codec,s),t.subarray(r.size)]}static inspectBytes(t){let r=0,n=()=>{let[h,g]=Do(t.subarray(r));return r+=g,h},o=n(),i=Ro;if(o===18?(o=0,r=0):i=n(),o!==0&&o!==1)throw new RangeError(`Invalid CID version ${o}`);let s=r,a=n(),u=n(),f=r+u,d=f-s;return{version:o,codec:i,multihashCode:a,digestSize:u,multihashSize:d,size:f}}static parse(t,r){let[n,o]=$d(t,r),i=e.decode(o);if(i.version===0&&t[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return Qs(i).set(n,t),i}};function $d(e,t){switch(e[0]){case"Q":{let r=t??Nt;return[Nt.prefix,r.decode(`${Nt.prefix}${e}`)]}case Nt.prefix:{let r=t??Nt;return[Nt.prefix,r.decode(e)]}case eo.prefix:{let r=t??eo;return[eo.prefix,r.decode(e)]}default:{if(t==null)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}}}function Gd(e,t,r){let{prefix:n}=r;if(n!==Nt.prefix)throw Error(`Cannot string encode V0 in ${r.name} encoding`);let o=t.get(n);if(o==null){let i=r.encode(e).slice(1);return t.set(n,i),i}else return o}function jd(e,t,r){let{prefix:n}=r,o=t.get(n);if(o==null){let i=r.encode(e);return t.set(n,i),i}else return o}var Ro=112,Hd=18;function tu(e,t,r){let n=Xn(e),o=n+Xn(t),i=new Uint8Array(o+r.byteLength);return Jn(e,i,0),Jn(t,i,n),i.set(r,o),i}var zd=Symbol.for("@ipld/js-cid/CID");var $i=Io(Iu());function Po(e,t){let r=Object.create(null);for(let n of t)q(e,n)&&(r[n]=e[n]);return r}function Xe(e,t){let r=Object.create(null);for(let n in e)t.includes(n)||(r[n]=e[n]);return r}function pt(e){return JSON.parse(JSON.stringify(e))}function Su(e){return e&&typeof e=="object"&&Object.prototype.toString.call(e)!=="[object RegExp]"&&Object.prototype.toString.call(e)!=="[object Date]"}function Gt(e,t){let r=e;for(let n in t){let o=Su(t[n])?pt(t[n]):void 0,i;if(o&&q(e,n)&&Su(i=r[n])){Gt(i,o);continue}Object.defineProperty(r,n,{configurable:!0,enumerable:!0,value:o||t[n],writable:!0})}return r}function Bi(e){return new Promise(t=>{setTimeout(t,e)})}function Pn(e,t){return Math.floor(Math.random()*(t-e+1)+e)}function _u(e){return Array.from(new Set(e))}function vu(...e){return _u(Array.prototype.concat.apply([],e))}function Tu(e,...t){return _u(e).filter(r=>t.every(n=>n.indexOf(r)>=0))}function ua(e,...t){let r=Array.prototype.concat.apply([],t);return e.filter(n=>r.indexOf(n)===-1)}function Fi(e){return!e||typeof e!="object"?e:Array.isArray(e)?e.map(t=>Fi(t)):Object.keys(e).sort().reduce((t,r)=>(t.push([r,Fi(e[r])]),t),[])}function so(e,t,r){let n,o,i,s,a;t==null&&(t=100);function u(){let d=performance.now()-s;d<t&&d>=0?n=setTimeout(u,t-d):(n=void 0,r||(a=e.apply(i,o),o=void 0,i=void 0))}let f=function(...d){o=d,i=this,s=performance.now();let h=r&&!n;return n||(n=setTimeout(u,t)),h&&(a=e.apply(i,o),o=void 0,i=void 0),a};return f.clear=function(){n&&(clearTimeout(n),n=void 0)},f.flush=function(){n&&(a=e.apply(i,o),o=void 0,i=void 0,clearTimeout(n),n=void 0)},f}function Au(e,t){let r=0;return(...n)=>{let o=new Date().getTime();if(o-r>t)return r=o,e(...n)}}var q=Function.prototype.call.bind(Object.prototype.hasOwnProperty);var qt={RAW:0,JSON:512,SHELTER_CONTRACT_MANIFEST:5316096,SHELTER_CONTRACT_TEXT:5316097,SHELTER_CONTRACT_DATA:5316098,SHELTER_FILE_MANIFEST:5316099,SHELTER_FILE_CHUNK:5316100},Ou=e=>{if(!e||e.length<52||e.length>64)throw new RangeError("CID length too short or too long");let t=to.parse(e,Nt);if(t.version!==1||t.multihash.code!==Zn.code||!Object.values(qt).includes(t.code))throw new Error("Invalid CID");return t};typeof globalThis=="object"&&!q(globalThis,"Buffer")&&(globalThis.Buffer=$i.Buffer);async function Cu(e,t=qt.RAW){let r=typeof e=="string"?new TextEncoder().encode(e):e,n=await Xc.digest(r);return to.create(1,t,n).toString(Nt)}function Fr(e,t=qt.RAW){let r=typeof e=="string"?new TextEncoder().encode(e):e,n=Zn.digest(r);return to.create(1,t,n).toString(Nt)}function Rt(e){let t=typeof e=="string"?new TextEncoder().encode(e):e,r=Zn.digest(t);return Nt.encode(r.bytes)}var _p=e=>$i.Buffer.from(e,"base64"),Nu=e=>_p(e).toString("utf8");var Du=async e=>{let t=new TextEncoder,r=t.encode(e.endpoint),n=t.encode(e.keys.p256dh),o=t.encode(e.keys.auth),i=new ArrayBuffer(8+(4+r.byteLength)+(2+n.byteLength)+(2+o.byteLength)),s=new Uint8Array(i),a=new DataView(i),u=0;a.setFloat64(u,e.expirationTime==null?NaN:e.expirationTime,!1),u+=8,a.setUint32(u,r.byteLength,!1),u+=4,s.set(r,u),u+=r.byteLength,a.setUint16(u,n.byteLength,!1),u+=2,s.set(n,u),u+=n.byteLength,a.setUint16(u,o.byteLength,!1),u+=2,s.set(o,u);let f=await crypto.subtle.digest("SHA-384",i),d=$i.Buffer.from(f.slice(0,16));return d[6]=128|d[6]&15,d[8]=128|d[8]&63,[d.slice(0,4),d.slice(4,6),d.slice(6,8),d.slice(8,10),d.slice(10,16)].map(h=>h.toString("hex")).join("-")};var vp=2*Ls;function Ko(e){return Date.now()-e.timestamp}function Ru(e){return Ko(e)>Tp(e)}function la(e){return Ko(e)<vp}function ku(e){return!la(e)}function Tp(e){return e.read?Ai:Oi}function Pu(e){return Rt(JSON.stringify(Fi(e)))}function En(e,t={}){return{proposalType:e.data.proposalType,proposalData:e.data.proposalData,expires_date_ms:e.data.expires_date_ms,createdDate:e.meta.createdDate,creatorID:e.creatorID,...t}}var fa=(e,t="")=>(t?c("state/vuex/getters").notificationsByGroup(t):c("state/vuex/getters").currentNotifications).some(n=>e(n)),Ap=[{type:qr.MIN15,notificationData:{stateKey:"nearDistributionEnd",emitCondition({rootState:e,rootGetters:t}){let r=t.ourGroups;return this.nearDistributionEnd=r.map(n=>{let o=t.groupSettingsForGroup(e[n]).distributionDate;if(!o)return null;let i=t.periodAfterPeriodForGroup(e[n],o),s=xr(new Date),a=_i(i,s);return t.ourGroupProfileForGroup(e[n])?.incomeDetailsType==="pledgeAmount"&&a>0&&a<Ft*7&&t.ourPaymentsForGroup(e[n])?.todo.length>0&&!fa(u=>u.type==="NEAR_DISTRIBUTION_END"&&u.data.period===o,n)?[n,o]:null}).filter(Boolean),this.nearDistributionEnd.length>0},emit(){this.nearDistributionEnd.forEach(([e,t])=>{c("gi.notifications/emit","NEAR_DISTRIBUTION_END",{groupID:e,period:t})})},shouldClearStateKey({rootGetters:e}){let t=e.ourGroups,r=e.notifications.filter(n=>n.type==="NEAR_DISTRIBUTION_END").reduce((n,o)=>(o.groupID&&(n[o.groupID]||(n[o.groupID]=[]),n[o.groupID].push(o.data.period)),n),Object.create(null));return t.every(n=>{let o=e.groupSettingsForGroup(n).distributionDate;return!!r[n]?.every(i=>i!==o)})}}},{type:qr.MIN5,notificationData:{stateKey:"nextDistributionPeriod",emitCondition({rootState:e,rootGetters:t}){let r=t.ourGroups;return this.nextDistributionPeriod=r.map(n=>{let o=t.ourGroupProfileForGroup(e[n]);if(!o?.incomeDetailsType)return null;let i=t.groupSettingsForGroup(e[n]).distributionDate;return i&&_i(xr(new Date),i)>0&&!fa(s=>s.type==="NEW_DISTRIBUTION_PERIOD"&&s.data.period===i,n)?[n,i,o.incomeDetailsType]:null}).filter(Boolean),this.nextDistributionPeriod.length>0},emit({rootGetters:e}){let t=e.ourIdentityContractId;this.nextDistributionPeriod.forEach(([r,n,o])=>{c("gi.notifications/emit","NEW_DISTRIBUTION_PERIOD",{groupID:r,period:n,creatorID:t,memberType:o==="pledgeAmount"?"pledger":"receiver"})})},shouldClearStateKey({rootState:e,rootGetters:t}){return t.ourGroups.every(n=>_i(xr(new Date),t.groupSettingsForGroup(e[n]).distributionDate)>0)}}},{type:qr.MIN5,notificationData:{stateKey:"expiringOrExpiredProposals",emitCondition({rootGetters:e}){return this.expiringOrExpiredProposalsByGroup=e.groupsByName.map(t=>{let{contractID:r}=t,n=[],o=[],i=[],s=e.groupProposals(r)||{};for(let a in s){let u=s[a];u.status===So&&(u.data.expires_date_ms<Date.now()?n.push(a):u.data.expires_date_ms<Date.now()+Ft&&(u.notifiedBeforeExpire||o.push(En(u,{proposalId:a})),!Object.keys(u.votes).includes(e.ourIdentityContractId)&&!fa(f=>f.type==="PROPOSAL_EXPIRING"&&f.data.proposalId===a,r)&&i.push({proposalId:a,creatorID:u.creatorID,proposalType:u.data.proposalType,proposalData:u.data.proposalData})))}return{contractID:r,expiringProposals:o,groupNotificationItems:i,expiredProposalIds:n}}).filter(t=>t.expiringProposals.length||t.groupNotificationItems.length||t.expiredProposalIds.length),this.expiringOrExpiredProposalsByGroup.length},async emit(){for(let{contractID:e,expiringProposals:t,groupNotificationItems:r,expiredProposalIds:n}of this.expiringOrExpiredProposalsByGroup)t.length&&await c("gi.actions/group/notifyExpiringProposals",{contractID:e,data:{proposals:t}}),r.length&&r.forEach(o=>{c("gi.notifications/emit","PROPOSAL_EXPIRING",{groupID:e,creatorID:o.creatorID,proposalId:o.proposalId,proposalType:o.proposalType,proposalData:o.proposalData,title:o.proposalType===Yt?o.proposalData.name:""})}),n.length&&c("gi.actions/group/markProposalsExpired",{contractID:e,data:{proposalIds:n}}).catch(o=>{console.error("Error calling markProposalsExpired from notifications mixin",o)})},shouldClearStateKey:()=>!0}},{type:qr.MIN5,notificationData:{stateKey:"lastLoggedIn",emitCondition({rootGetters:e}){return!!e.ourIdentityContractId},emit({rootState:e,rootGetters:t}){Promise.all(t.groupsByName.filter(({active:r})=>r).map(({contractID:r})=>c("gi.actions/group/kv/updateLastLoggedIn",{contractID:r,throttle:!0}))).catch(r=>{console.error("Error updating lastLoggedIn",r)})},shouldClearStateKey:()=>!0}}],Ku=Ap;var Bm=Au(e=>{let t=e==="granted"||e==="prompt"&&Notification.permission==="granted",{notificationEnabled:r}=c("state/vuex/state").settings;console.info(`Browser notifications have been: ${t?"enabled":"disabled"}, notificationEnabled=${r}`),(!t||r)&&c("service-worker/setup-push-subscription").catch(n=>{console.error("[handler] Error calling service-worker/setup-push-subscription",n)})},250);async function Kn({title:e,body:t,icon:r,path:n,groupID:o,sbpInvocation:i}){if(typeof Notification=="function"){if(typeof r=="object"&&r.manifestCid){let s=await c("gi.db/filesCache/load",r.manifestCid).catch(a=>{console.error("[Avatar.vue] Error loading file from cache",a)});s&&(r="data:;base64,"+encodeURIComponent(Buffer.from(s).toString("base64")))}if(typeof WorkerGlobalScope!="function")try{if(navigator.vendor==="Apple Computer, Inc.")throw new Error("Safari requires a service worker for the notification to be displayed");let s=new Notification(e,{body:t,icon:r});n&&(s.onclick=a=>{c("controller/router").push({path:n}).catch(console.warn)})}catch{return navigator.serviceWorker?.ready.then(a=>a.showNotification(e,{body:t,icon:r,data:{groupID:o,path:n,sbpInvocation:i}})).catch(console.warn)}else return self.clients.matchAll({type:"window"}).then(s=>{if(!s.some(a=>a.focused))return self.registration.showNotification(e,{body:t,icon:r,data:{groupID:o,path:n,sbpInvocation:i}}).catch(console.warn)})}}var Gi="login",Mu="login-error",Uu="login-complete",ao="logging-out",bn="logout",Jr="online",ji="offline",Hi="reconnecting",zi="reconnection-failed",Mo="kv-event",Yi="accepted-group",Lu="switch-group",Vi="joined-group",qi="left-group",Fu="error-group-non-existent-#general",co="joined-chatroom",Bu="left-chatroom",$u="deleted-chatroom";var Gu="error-joining-chatroom";var Xr="captured-logs",da="set-app-logs-filter";var Wi="chatroom-user-typing",Ji="chatroom-user-stop-typing",Uo="namespace-registration",Tt="kv-queue";var wn="chelonia-state-modified",Lo="notification-emitted",Xi="notification-removed",Qi="notification-status-loaded",Fo="new-chatroom-unread-position",Bo="new-last-logged-in",$o="new-unread-messages",Go="new-preferences",Zi="new-chatroom-notification-settings";var uo="serious-error";var ht={UNREAD_MESSAGES:"unreadMessages",LAST_LOGGED_IN:"lastLoggedIn",PREFERENCES:"preferences",NOTIFICATIONS:"notifications"},ju=2e3,Hu=30*6e4,pa={DISABLE_NOTIFICATIONS:"disableNotifications"};var jo=class{#e;#n=0;#o="";#r=!1;#t=0;constructor(t,r=""){this.#e=new Array(t).fill(r),this.#n=t,this.#o=r}add(t){let r=this.#n,n=this.#t;this.#e[n]=t,n===r-1&&(this.#r=!0),this.#t=(n+1)%r}addAll(t){for(let r of t)this.add(r)}clear(){this.#e.fill(this.#o),this.#r=!1,this.#t=0}toArray(){let t=this.#e,r=this.#t;return this.#r?[...t.slice(r),...t.slice(0,r)]:t.slice(0,r)}};var zu=["debug","error","info","log","warn"],ha=console,Op=(...e)=>{};async function Yu(e,{getItem:t,removeItem:r,setItem:n}){let o=new jo(e.maxEntries),i=Object.fromEntries(zu.map(d=>[d,(...h)=>{ha[d](...h),Cp(u,d,e.source,...h)}])),s=[],a=new Proxy({...i},{get(d,h,g){return Reflect.has(d,h)?Reflect.get(d,h,g):Reflect.get(ha,h,g)},has(d,h){return Reflect.has(ha,h)}}),u={get appLogsFilter(){return[...s]},console:a,entries:o,async clear(){await r("entries"),o.clear()},async save(){try{await n("entries",this.entries.toArray())}catch(d){a.error(d)}},setAppLogsFilter(d){s.splice(0,s.length,...d);for(let h of zu)a[h]=s.includes(h)?i[h]:Op}},f=await(async()=>{try{let d=await t("entries");return d?JSON.parse(d):[]}catch(d){return a.error("Failed to parse stored entries:",d),[]}})();return e.maxEntries<f.length&&f.splice(0,f.length-e.maxEntries),f.length&&u.entries.addAll(f),u}function Cp(e,t,r,...n){let o={timestamp:new Date().toISOString(),source:r,type:t,msg:n.map(i=>{try{let s=new WeakSet;return JSON.parse(JSON.stringify(i,(a,u)=>{if(u instanceof Error)return{name:u.name,message:u.message,stack:u.stack};if(typeof u=="object"&&u!==null){if(s.has(u))return"[Circular Reference]";s.add(u)}return u}))}catch(s){return`[captureLogs failed to stringify argument of type '${typeof i}'. Err: ${s.message}]`}})};e.entries.add(o),c("sbp/selectors/fn","okTurtles.events/emit")(Xr,o)}var xn=new Map,Jm=c("sbp/selectors/register",{"okTurtles.data/get":function(e){return xn.get(e)},"okTurtles.data/set":function(e,t){return xn.set(e,t),t},"okTurtles.data/delete":function(e){return xn.delete(e)},"okTurtles.data/add":function(e,t){let r=xn.get(e);r?r.push(t):xn.set(e,[t])},"okTurtles.data/remove":function(e,t){let r=xn.get(e);if(r){let n=r.length,o=r.filter(i=>i!==t);return xn.set(e,o),n-o.length}},"okTurtles.data/apply":function(e,t){return t(xn.get(e))}});var es=e=>`events/${e}/listeners`,e0=c("sbp/selectors/register",{"okTurtles.events/_init":function(){this.errorHandler=(e,t)=>{console.error(`[okTurtles.events] Error at handler for ${e}`,t)}},"okTurtles.events/on":function(e,t){return c("okTurtles.data/add",es(e),t),()=>c("okTurtles.events/off",e,t)},"okTurtles.events/once":function(e,t){let r=(...n)=>{t(...n),c("okTurtles.events/off",e,r)};return c("okTurtles.events/on",e,r)},"okTurtles.events/emit":function(e,...t){var r;for(let n of c("okTurtles.data/get",es(e))||[])try{n(...t)}catch(o){(r=this.errorHandler)===null||r===void 0||r.call(this,e,o)}},"okTurtles.events/off":function(e,t){t?c("okTurtles.data/remove",es(e),t):c("okTurtles.data/delete",es(e))},"okTurtles.events/setErrorHandler":function(e){this.errorHandler=e}});var Vu=e=>{};var qu={maxEntries:ju,source:"sw"},ga=self.console,Qr=null,Mn="",Np=e=>c("gi.db/logs/load",`giConsole/${Mn}/${e}`),Dp=e=>c("gi.db/logs/delete",`giConsole/${Mn}/${e}`),Wu=(e,t)=>c("gi.db/logs/save",`giConsole/${Mn}/${e}`,typeof t=="string"?t:JSON.stringify(t));async function Rp(e){Mn=e,Qr=await Yu(qu,{getItem:Np,removeItem:Dp,setItem:Wu}),await Wu("config",qu),Qr.setAppLogsFilter(new URLSearchParams(location.search).get("debug")?["error","warn","info","debug","log"]:["error","warn","info"]),c("okTurtles.events/on",da,Qr.setAppLogsFilter),self.console=Qr.console,ga.log("Starting to capture logs of type:",Qr.swLogsFilter)}async function kp({wipeOut:e}){e&&await Ju(),c("okTurtles.events/off",da),console.log("captureLogs paused"),self.console=ga}async function Ju(){await Qr?.clear()}c("okTurtles.events/on",Xr,so(()=>{Qr?.save().catch(e=>{console.error("Error saving logs during CAPTURED_LOGS event handler",e)})},1e3));Vu(ga);var d0=c("sbp/selectors/register",{"swLogs/get"(){return Qr?.entries.toArray()??[]},async"swLogs/save"(){await Qr?.save()},"swLogs/pauseCapture":kp,"swLogs/startCapture":Rp,async"swLogs/clearLogs"(e){let t=Mn;Mn=e;try{await Ju()}catch{}Mn=t}});var Xu=e=>Object.prototype.hasOwnProperty.call(e,"sbpInvocation"),g0=c("sbp/selectors/register",{"okTurtles.eventQueue/_init":function(){this.eventQueues=Object.create(null)},"okTurtles.eventQueue/isWaiting":function(e){var t;return!!(!((t=this.eventQueues[e])===null||t===void 0)&&t.length)},"okTurtles.eventQueue/queuedInvocations":function(e){var t,r;return e==null?Object.fromEntries(Object.entries(this.eventQueues).map(([n,o])=>[n,o.map(i=>Xu(i)?i.sbpInvocation:i.fn)])):(r=(t=this.eventQueues[e])===null||t===void 0?void 0:t.map(n=>Xu(n)?n.sbpInvocation:n.fn))!==null&&r!==void 0?r:[]},"okTurtles.eventQueue/queueEvent":async function(e,t){Object.prototype.hasOwnProperty.call(this.eventQueues,e)||(this.eventQueues[e]=[]);let r=this.eventQueues[e],n,o=new Promise(s=>{n=s}),i=typeof t=="function"?{fn:t,promise:o}:{sbpInvocation:t,promise:o};for(r.push(i);r.length>0;){let s=r[0];if(s===i)try{return typeof t=="function"?await t():await c(...t)}finally{n(),r.shift()}else await s.promise}}});var Kp=Io(Qu(),1),Re=Io(Zu(),1),Zr=e=>new TextEncoder().encode(e),Mp=e=>{let t=typeof e=="string"?Zr(e):e,r=Zn.digest(t);return Nt.encode(r.bytes)},In=e=>new Uint8Array(atob(e).split("").map(t=>t.charCodeAt(0)));var lt="edwards25519sha512batch",Wt="curve25519xsalsa20poly1305",Ho="xsalsa20poly1305",Up="externalkm32",Un=e=>{if(!(e instanceof Uint8Array))throw TypeError("Unsupported type");return btoa(Array.from(e).map(t=>String.fromCharCode(t)).join(""))},Qe=e=>{if(e===lt){let t=Re.default.sign.keyPair(),r={type:e,publicKey:t.publicKey};return Object.defineProperty(r,"secretKey",{value:t.secretKey}),r}else if(e===Wt){let t=Re.default.box.keyPair(),r={type:e,publicKey:t.publicKey};return Object.defineProperty(r,"secretKey",{value:t.secretKey}),r}else if(e===Ho){let t={type:e};return Object.defineProperty(t,"secretKey",{value:Re.default.randomBytes(Re.default.secretbox.keyLength)}),t}else if(e===Up){let t={type:e};return Object.defineProperty(t,"secretKey",{value:Re.default.randomBytes(32)}),t}throw new Error("Unsupported key type")},lo=()=>Un(Re.default.randomBytes(18));var se=(e,t)=>{if(e.type===lt||e.type===Wt){if(!t){if(!e.publicKey)throw new Error("Unsupported operation: no public key to export");return JSON.stringify([e.type,Un(e.publicKey),null],void 0,0)}if(!e.secretKey)throw new Error("Unsupported operation: no secret key to export");return JSON.stringify([e.type,null,Un(e.secretKey)],void 0,0)}else if(e.type===Ho){if(!t)throw new Error("Unsupported operation: no public key to export");if(!e.secretKey)throw new Error("Unsupported operation: no secret key to export");return JSON.stringify([e.type,null,Un(e.secretKey)],void 0,0)}throw new Error("Unsupported key type")},He=e=>{let t=JSON.parse(e);if(!t||t.length!==3)throw new Error("Invalid key object");if(t[0]===lt){if(t[2]){let r=Re.default.sign.keyPair.fromSecretKey(In(t[2])),n={type:t[0],publicKey:r.publicKey};return Object.defineProperty(n,"secretKey",{value:r.secretKey}),n}else if(t[1])return{type:t[0],publicKey:new Uint8Array(In(t[1]))};throw new Error("Missing secret or public key")}else if(t[0]===Wt){if(t[2]){let r=Re.default.box.keyPair.fromSecretKey(In(t[2])),n={type:t[0],publicKey:r.publicKey};return Object.defineProperty(n,"secretKey",{value:r.secretKey}),n}else if(t[1])return{type:t[0],publicKey:new Uint8Array(In(t[1]))};throw new Error("Missing secret or public key")}else if(t[0]===Ho){if(!t[2])throw new Error("Secret key missing");let r={type:t[0]};return Object.defineProperty(r,"secretKey",{value:new Uint8Array(In(t[2]))}),r}throw new Error("Unsupported key type")},el=e=>{let t=typeof e=="string"?He(e):e;return Qe(t.type)},de=e=>{let t=typeof e=="string"?He(e):e,r=se(t,!t.publicKey);return Mp(r)},rs=(e,t)=>{let r=typeof e=="string"?He(e):e;if(r.type!==lt)throw new Error("Unsupported algorithm");if(!r.secretKey)throw new Error("Secret key missing");let n=Zr(t),o=Re.default.sign.detached(n,r.secretKey);return Un(o)},fo=(e,t,r)=>{let n=typeof e=="string"?He(e):e;if(n.type!==lt)throw new Error("Unsupported algorithm");if(!n.publicKey)throw new Error("Public key missing");let o=In(r),i=Zr(t);if(!Re.default.sign.detached.verify(i,o,n.publicKey))throw new Error("Invalid signature")},zo=(e,t,r)=>{let n=typeof e=="string"?He(e):e;if(n.type===Ho){if(!n.secretKey)throw new Error("Secret key missing");let o=Re.default.randomBytes(Re.default.secretbox.nonceLength),i;if(r){i=new Uint8Array(o);let d=Re.default.hash(Zr(r)),h=Math.min(d.length,o.length);for(let g=0;g<h;g++)i[g]^=d[g]}else i=o;let s=Zr(t),a=Re.default.secretbox(s,i,n.secretKey),u=new Uint8Array(o.length+a.length);return u.set(o),u.set(a,o.length),Un(u)}else if(n.type===Wt){if(!n.publicKey)throw new Error("Public key missing");let o=Re.default.randomBytes(Re.default.box.nonceLength),i;if(r){i=new Uint8Array(o);let h=Re.default.hash(Zr(r)),g=Math.min(h.length,o.length);for(let E=0;E<g;E++)i[E]^=h[E]}else i=o;let s=Zr(t),a=Re.default.box.keyPair(),u=Re.default.box(s,i,n.publicKey,a.secretKey);crypto.getRandomValues(a.secretKey),a.secretKey.fill(0);let f=new Uint8Array(Re.default.box.publicKeyLength+o.length+u.length);return f.set(a.publicKey),f.set(o,Re.default.box.publicKeyLength),f.set(u,Re.default.box.publicKeyLength+o.length),Un(f)}throw new Error("Unsupported algorithm")},Yo=(e,t,r)=>{let n=typeof e=="string"?He(e):e;if(n.type===Ho){if(!n.secretKey)throw new Error("Secret key missing");let o=In(t),i=o.slice(0,Re.default.secretbox.nonceLength),s=o.slice(Re.default.secretbox.nonceLength,o.length);if(r){let u=Re.default.hash(Zr(r)),f=Math.min(u.length,i.length);for(let d=0;d<f;d++)i[d]^=u[d]}let a=Re.default.secretbox.open(s,i,n.secretKey);if(!a)throw new Error("Could not decrypt message");return Buffer.from(a).toString("utf-8")}else if(n.type===Wt){if(!n.secretKey)throw new Error("Secret key missing");let o=In(t),i=o.slice(0,Re.default.box.publicKeyLength),s=o.slice(Re.default.box.publicKeyLength,Re.default.box.publicKeyLength+Re.default.box.nonceLength),a=o.slice(Re.default.box.publicKeyLength+Re.default.box.nonceLength);if(r){let f=Re.default.hash(Zr(r)),d=Math.min(f.length,s.length);for(let h=0;h<d;h++)s[h]^=f[h]}let u=Re.default.box.open(a,s,i,n.secretKey);if(!u)throw new Error("Could not decrypt message");return Buffer.from(u).toString("utf-8")}throw new Error("Unsupported algorithm")};var ma=()=>c("chelonia/rootState"),Lp=Object.create(null,{_isSignedData:{value:!0}}),ns=e=>Object.setPrototypeOf(e,Lp),Sr=e=>!!e&&!!Object.getPrototypeOf(e)?._isSignedData,tl=function(e,t,r,n,o,i){let s=typeof e=="string"?ma()[e]:e;if(!i)throw new Kr("Signature additional data must be provided");let a=s?._vm?.authorizedKeys?.[t];if(!a?.purpose.includes("sig"))throw new Ii(`Signing key ID ${t} is missing or is missing signing purpose`);if(a._notAfterHeight!=null){let g=s._vm.authorizedKeys[t].name,E=Object.values(s._vm?.authorizedKeys).find(w=>w._notAfterHeight==null&&w.name===g&&w.purpose.includes("sig"))?.id;if(!E)throw new Ii(`Signing key ID ${t} has been revoked and no new key exists by the same name (${g})`);t=E}let u=o[t];if(!u)throw new Ii(`Missing signing key ${t}`);let f=typeof u=="string"?He(u):u,d=JSON.stringify(r,(g,E)=>E&&q(E,"serialize")&&typeof E.serialize=="function"?E.serialize.length===1?E.serialize(i):E.serialize():E),h=Rt(`${Rt(i)}${Rt(d)}`);return{...n,_signedData:[d,de(f),rs(f,h)]}},Fp=function(e,t,r,n){if(!e)throw new Kr("Missing contract state");if(!Sn(r))throw new Kr("Invalid message format");if(!Number.isSafeInteger(t)||t<0)throw new Kr(`Height ${t} is invalid or out of range`);let[o,i,s]=r._signedData,a=e._vm?.authorizedKeys?.[i];if(!a||t>a._notAfterHeight||t<a._notBeforeHeight||!a.purpose.includes("sig"))throw new fc(`Key ${i} is unauthorized or expired for the current contract`);let u=a.data,f=Rt(`${Rt(n)}${Rt(o)}`);try{fo(u,f,s);let d=JSON.parse(o);return[i,d]}catch(d){throw new Kr(d?.message||d)}},tr=(e,t,r,n)=>{if(!e||r===void 0||!t)throw new TypeError("Invalid invocation");n||(n=ma().secretKeys);let o=Object.create(null),i=tl.bind(null,e,t,r,o,n),s=a=>i(a||"");return ns({get signingKeyId(){return t},get serialize(){return s},get toString(){return a=>JSON.stringify(this.serialize(a))},get valueOf(){return()=>r},get recreate(){return a=>tr(e,t,a,n)},get get(){return a=>o[a]},get set(){return(a,u)=>{o[a]=u}}})},po=(e,t)=>{let r=de(e),n={_vm:{authorizedKeys:{[r]:{purpose:["sig"],data:se(e,!1),_notBeforeHeight:0,_notAfterHeight:void 0}}}},o=Object.create(null),i=tl.bind(null,n,r,t,o,{[r]:e}),s=a=>i(a||"");return ns({get signingKeyId(){return r},get serialize(){return s},get toString(){return a=>JSON.stringify(this.serialize(a))},get valueOf(){return()=>t},get recreate(){return a=>po(e,a)},get get(){return a=>o[a]},get set(){return(a,u)=>{o[a]=u}}})},_r=(e,t,r,n,o,i)=>{let s=()=>r,a,u=()=>(a||(a=Fp(t||ma()[e],n,r,o),i&&(a[1]=i(a[1]))),a[1]);return ns({get signingKeyId(){return a?a[0]:rl(r)},get serialize(){return s},get context(){return[e,r,n,o]},get toString(){return()=>JSON.stringify(this.serialize())},get valueOf(){return u},get toJSON(){return this.serialize},get get(){return f=>f!=="_signedData"?r[f]:void 0}})},rl=e=>{if(!Sn(e))throw new Kr("Invalid message format");return e._signedData[1]},Sn=e=>!(!e||typeof e!="object"||!q(e,"_signedData")||!Array.isArray(e._signedData)||e._signedData.length!==3||e._signedData.map(t=>typeof t).filter(t=>t!=="string").length!==0),os=e=>{if(!Sn(e))throw new Kr("Invalid message format");let t=()=>e,r,n=()=>(r||(r=[e._signedData[1],JSON.parse(e._signedData[0])]),r[1]);return ns({get signingKeyId(){return r?r[0]:rl(e)},get serialize(){return t},get toString(){return()=>JSON.stringify(this.serialize())},get valueOf(){return n},get toJSON(){return this.serialize},get get(){return o=>o!=="_signedData"?e[o]:void 0}})};var Ea=()=>c("chelonia/rootState"),Bp=Object.create(null,{_isEncryptedData:{value:!0}}),Vo=e=>Object.setPrototypeOf(e,Bp),Ln=e=>!!e&&!!Object.getPrototypeOf(e)?._isEncryptedData,nl=function(e,t,r,n){let o=typeof e=="string"?Ea()[e]:e,i=o?._vm?.authorizedKeys?.[t];if(!i?.purpose.includes("enc"))throw new Error(`Encryption key ID ${t} is missing or is missing encryption purpose`);if(i._notAfterHeight!=null){let u=o._vm.authorizedKeys[t].name,f=Object.values(o._vm?.authorizedKeys).find(d=>d._notAfterHeight==null&&d.name===u&&d.purpose.includes("enc"))?.id;if(!f)throw new Error(`Encryption key ID ${t} has been revoked and no new key exists by the same name (${u})`);t=f}let s=o._vm?.authorizedKeys?.[t].data;if(!s)throw new Error(`Missing encryption key ${t}`);let a=typeof s=="string"?He(s):s;return[de(a),zo(a,JSON.stringify(r,(u,f)=>f&&q(f,"serialize")&&typeof f.serialize=="function"?f.serialize.length===1?f.serialize(n):f.serialize():f),n)]},ba=function(e,t,r,n,o,i){if(!e)throw new Yn("Missing contract state");if(typeof r.valueOf=="function"&&(r=r.valueOf()),!wa(r))throw new Yn("Invalid message format");let[s,a]=r,u=n[s];if(!u)throw new lc(`Key ${s} not found`,{cause:s});let f=e._vm?.authorizedKeys?.[s];if(!f||t>f._notAfterHeight||t<f._notBeforeHeight||!f.purpose.includes("enc"))throw new wi(`Key ${s} is unauthorized or expired for the current contract`);let d=typeof u=="string"?He(u):u;try{let h=JSON.parse(Yo(d,a,o));return typeof i=="function"&&i(h,s),h}catch(h){throw new Yn(h?.message||h)}},ke=(e,t,r)=>{if(!e||r===void 0||!t)throw new TypeError("Invalid invocation");let n=nl.bind(null,e,t,r);return Vo({get encryptionKeyId(){return t},get serialize(){return o=>n(o||"")},get toString(){return o=>JSON.stringify(this.serialize(o))},get valueOf(){return()=>r}})},nt=(e,t)=>{if(t===void 0||!e)throw new TypeError("Invalid invocation");let r=de(e),n={_vm:{authorizedKeys:{[r]:{purpose:["enc"],data:se(e,!1),_notBeforeHeight:0,_notAfterHeight:void 0}}}},o=nl.bind(null,n,r,t);return Vo({get encryptionKeyId(){return r},get serialize(){return i=>o(i||"")},get toString(){return i=>JSON.stringify(this.serialize(i))},get valueOf(){return()=>t}})},Br=(e,t,r,n,o,i,s)=>{let a,u=()=>{if(a)return a;if(!t||!o){let f=Ea();t=t||f[e],o=o??f.secretKeys}return a=ba(t,n,r,o,i||"",s),Sn(a)&&(a=_r(e,t,a,n,i||"")),a};return Vo({get encryptionKeyId(){return qo(r)},get serialize(){return()=>r},get toString(){return()=>JSON.stringify(this.serialize())},get valueOf(){return u},get toJSON(){return this.serialize}})},ol=(e,t,r,n,o,i,s)=>{let a,u=()=>{if(a)return a;let f=Ea(),d=f[e];return a=ba(d,NaN,r,o??f.secretKeys,i||"",s),Sn(a)?_r(e,d,a,NaN,i||""):a};return Vo({get encryptionKeyId(){return qo(r)},get serialize(){return()=>r},get toString(){return()=>JSON.stringify(this.serialize())},get valueOf(){return u},get toJSON(){return this.serialize}})},il=(e,t,r)=>{if(t===void 0||!e)throw new TypeError("Invalid invocation");let n,o=de(e),i=()=>{if(n)return n;let s={_vm:{authorizedKeys:{[o]:{purpose:["enc"],data:se(e,!1),_notBeforeHeight:0,_notAfterHeight:void 0}}}};return n=ba(s,NaN,t,{[o]:e},r||""),n};return Vo({get encryptionKeyId(){return qo(t)},get serialize(){return()=>t},get toString(){return()=>JSON.stringify(this.serialize())},get valueOf(){return i},get toJSON(){return this.serialize}})},qo=e=>{if(!wa(e))throw new Yn("Invalid message format");return e[0]},wa=e=>!(!Array.isArray(e)||e.length!==2||e.map(t=>typeof t).filter(t=>t!=="string").length!==0),ho=e=>{if(e!=null)if(Ln(e))try{return{encryptionKeyId:e.encryptionKeyId,data:e.valueOf()}}catch(t){console.warn("unwrapMaybeEncryptedData: Unable to decrypt",t)}else return{encryptionKeyId:null,data:e}},vr=(e,t,r,n,o,i,s)=>wa(r)?Br(e,t,r,n,o,i,s):(s?.(r,""),r);var cl=(e,t,r,n,o,i)=>{let s=e.op,a=e.height,u=s===v.OP_ACTION_ENCRYPTED?Br(r,i,n,a,o,t,void 0):n;return[v.OP_KEY_ADD,v.OP_KEY_UPDATE].includes(s)?u.map(f=>vr(r,i,f,a,o,t,d=>{if(d.meta?.private?.content&&(d.meta.private.content=Br(r,i,d.meta.private.content,a,o,t,h=>{let g=de(h);if(g!==d.id)throw new Error(`Key ID mismatch. Expected to decrypt key ID ${d.id} but got ${g}`)})),d.meta?.keyRequest?.reference)try{d.meta.keyRequest.reference=vr(r,i,d.meta.keyRequest.reference,a,o,t)?.valueOf()}catch{delete d.meta.keyRequest.reference}if(d.meta?.keyRequest?.contractID)try{d.meta.keyRequest.contractID=vr(r,i,d.meta.keyRequest.contractID,a,o,t)?.valueOf()}catch{delete d.meta.keyRequest.contractID}})):(s===v.OP_CONTRACT&&(u.keys=u.keys?.map(f=>vr(r,i,f,a,o,t,d=>{if(!d.meta?.private?.content)return;let h=Br,g=r;d.meta.private.content=h(g,i,d.meta.private.content,a,o,t,E=>{let w=de(E);if(w!==d.id)throw new Error(`Key ID mismatch. Expected to decrypt key ID ${d.id} but got ${w}`)})}))),s===v.OP_KEY_SHARE?vr(r,i,u,a,o,t,f=>{f.keys?.forEach(d=>{if(!d.meta?.private?.content)return;let h=f.foreignContractID?ol:Br,g=f.foreignContractID||r;d.meta.private.content=h(g,i,d.meta.private.content,a,o,t,E=>{let w=de(E);if(w!==d.id)throw new Error(`Key ID mismatch. Expected to decrypt key ID ${d.id} but got ${w}`)})})}):s===v.OP_KEY_REQUEST?vr(r,i,u,a,o,t,f=>{f.replyWith=_r(f.contractID,void 0,f.replyWith,f.height,t)}):s===v.OP_ACTION_UNENCRYPTED&&Sn(u)?_r(r,i,u,a,t):s===v.OP_ACTION_ENCRYPTED?u:s===v.OP_KEY_DEL?u.map(f=>vr(r,i,f,a,o,t,void 0)):s===v.OP_KEY_REQUEST_SEEN?vr(r,i,n,a,o,t,void 0):s===v.OP_ATOMIC?u.map(([f,d])=>[f,cl({...e,op:f},t,r,d,o,i)]):u)},v=class e{_mapping;_head;_message;_signedMessageData;_direction;_decryptedValue;_innerSigningKeyId;static OP_CONTRACT="c";static OP_ACTION_ENCRYPTED="ae";static OP_ACTION_UNENCRYPTED="au";static OP_KEY_ADD="ka";static OP_KEY_DEL="kd";static OP_KEY_UPDATE="ku";static OP_PROTOCOL_UPGRADE="pu";static OP_PROP_SET="ps";static OP_PROP_DEL="pd";static OP_CONTRACT_AUTH="ca";static OP_CONTRACT_DEAUTH="cd";static OP_ATOMIC="a";static OP_KEY_SHARE="ks";static OP_KEY_REQUEST="kr";static OP_KEY_REQUEST_SEEN="krs";static createV1_0({contractID:t,previousHEAD:r=null,previousKeyOp:n=null,height:o=Number.MAX_SAFE_INTEGER,op:i,manifest:s}){let a={version:"1.0.0",previousHEAD:r,previousKeyOp:n,height:o,contractID:t,op:i[0],manifest:s};return new this(sl(a,i[1]))}static cloneWith(t,r,n){let o=Object.assign({},t,n);return new this(sl(o,r[1]))}static deserialize(t,r,n,o=ho){if(!t)throw new Error(`deserialize bad value: ${t}`);let{head:i,...s}=JSON.parse(t),a=JSON.parse(i),u=a.op===e.OP_CONTRACT?Fr(t,qt.SHELTER_CONTRACT_DATA):a.contractID;if(!n?._vm?.authorizedKeys&&a.op===e.OP_CONTRACT){let d=os(s),h=Object.fromEntries(d.valueOf()?.keys.map(g=>{let E=o(g);return E?[E.data.id,E.data]:null}).filter(Boolean));n={_vm:{type:a.type,authorizedKeys:h}}}let f=_r(u,n,s,a.height,i,d=>cl(a,i,u,d,r,n));return new this({direction:"incoming",mapping:{key:Fr(t,qt.SHELTER_CONTRACT_DATA),value:t},head:a,signedMessageData:f})}static deserializeHEAD(t){if(!t)throw new Error(`deserialize bad value: ${t}`);let r,n,o={get head(){return r===void 0&&(r=JSON.parse(JSON.parse(t).head)),r},get hash(){return n||(n=Fr(t,qt.SHELTER_CONTRACT_DATA)),n},get contractID(){return o.head?.contractID??o.hash},description(){return`<op_${this.head.op}|${this.hash} of ${this.contractID}>`},get isFirstMessage(){return!o.head?.contractID}};return o}constructor(t){this._direction=t.direction,this._mapping=t.mapping,this._head=t.head,this._signedMessageData=t.signedMessageData;let r=this.opType(),n=!0,o=(i,s)=>{switch(i){case e.OP_CONTRACT:if(!this.isFirstMessage()||!n)throw new Error("OP_CONTRACT: must be first message");break;case e.OP_ATOMIC:if(!n)throw new Error("OP_ATOMIC not allowed inside of OP_ATOMIC");if(!Array.isArray(s))throw new TypeError("OP_ATOMIC must be of an array type");n=!1,s.forEach(([a,u])=>o(a,u));break;case e.OP_KEY_ADD:case e.OP_KEY_DEL:case e.OP_KEY_UPDATE:if(!Array.isArray(s))throw new TypeError("OP_KEY_{ADD|DEL|UPDATE} must be of an array type");break;case e.OP_KEY_SHARE:case e.OP_KEY_REQUEST:case e.OP_KEY_REQUEST_SEEN:case e.OP_ACTION_ENCRYPTED:case e.OP_ACTION_UNENCRYPTED:break;default:throw new Error(`unsupported op: ${i}`)}};Object.defineProperty(this,"_message",{get:(i=>()=>{let s=this._signedMessageData.valueOf();return i||(o(r,s),i=!0),s})()})}decryptedValue(){if(this._decryptedValue)return this._decryptedValue;try{let t=this.message(),r=ho(t);return r?.data&&(Sr(r.data)?(this._innerSigningKeyId=r.data.signingKeyId,this._decryptedValue=r.data.valueOf()):this._decryptedValue=r.data),this._decryptedValue}catch{return}}innerSigningKeyId(){return this._decryptedValue||this.decryptedValue(),this._innerSigningKeyId}head(){return this._head}message(){return this._message}op(){return[this.head().op,this.message()]}rawOp(){return[this.head().op,this._signedMessageData]}opType(){return this.head().op}opValue(){return this.message()}signingKeyId(){return this._signedMessageData.signingKeyId}manifest(){return this.head().manifest}description(){let t=this.opType(),r=`<op_${t}`;if(t===e.OP_ACTION_UNENCRYPTED)try{let n=this.opValue().valueOf();typeof n.action=="string"&&(r+=`|${n.action}`)}catch(n){console.warn("Error on .description()",this.hash(),n)}return`${r}|${this.hash()} of ${this.contractID()}>`}isFirstMessage(){return!this.head().contractID}contractID(){return this.head().contractID||this.hash()}serialize(){return this._mapping.value}hash(){return this._mapping.key}previousKeyOp(){return this._head.previousKeyOp}height(){return this._head.height}id(){throw new Error("SPMessage.id() was called but it has been removed")}direction(){return this._direction}isKeyOp(){let t;return!!(al.includes(this.opType())||this.opType()===e.OP_ATOMIC&&Array.isArray(t=this.opValue())&&t.some(([r])=>al.includes(r)))}static get[cn](){return"SPMessage"}static[$n](t){return[t.serialize(),t.direction(),t.decryptedValue(),t.innerSigningKeyId()]}static[Gn]([t,r,n,o]){let i=e.deserialize(t);return i._direction=r,i._decryptedValue=n,i._innerSigningKeyId=o,i}};function sl(e,t){let r;return{direction:q(t,"recreate")?"outgoing":"incoming",get mapping(){if(!r){let n=JSON.stringify(e),o={...t.serialize(n),head:n},i=JSON.stringify(o);r={key:Fr(i,qt.SHELTER_CONTRACT_DATA),value:i}}return r},head:e,signedMessageData:t}}var al=[v.OP_CONTRACT,v.OP_KEY_ADD,v.OP_KEY_DEL,v.OP_KEY_UPDATE];var xa=new WeakMap,Ze=class{static[Gn](t){return new this(t)}static[$n](t){return xa.get(t)}static get[cn](){return"__chelonia_Secret"}constructor(t){xa.set(this,t)}valueOf(){return xa.get(this)}};var en={REVOKED:"revoked",VALID:"valid",USED:"used"};var _n="chelonia-reset",Wo="contract-is-syncing",Tr="contracts-modified";var rr="event-handled",ul="event-published",ll="event-publishing-error";var Jo="contract-registered";var fl="contract-is-pending-key-requests",is="contract-has-received-keys";var $p=Number.parseInt("",10)||1/0,ze=(e,t)=>e._vm?.authorizedKeys&&Object.values(e._vm.authorizedKeys).find(r=>r.name===t&&r._notAfterHeight==null)?.id,pl=(e,t)=>e._vm?.authorizedKeys&&Object.values(e._vm.authorizedKeys).filter(r=>r._notAfterHeight==null&&r.foreignKey?.includes(t)).map(r=>r.id),hl=(e,t)=>e._vm?.authorizedKeys&&Object.values(e._vm.authorizedKeys||{}).filter(r=>r.name===t&&r._notAfterHeight!=null).map(r=>r.id),gt=(e,t,r,n,o)=>e._vm?.authorizedKeys&&Object.values(e._vm.authorizedKeys).filter(i=>i._notAfterHeight==null&&i.ringLevel<=(n??Number.POSITIVE_INFINITY)&&c("chelonia/haveSecretKey",i.id)&&(Array.isArray(t)?t.reduce((s,a)=>s&&(i.permissions==="*"||i.permissions.includes(a)),!0):t===i.permissions)&&r.reduce((s,a)=>s&&i.purpose.includes(a),!0)&&(Array.isArray(o)?o.reduce((s,a)=>s&&(i.allowedActions==="*"||!!i.allowedActions?.includes(a)),!0):o?o===i.allowedActions:!0)).sort((i,s)=>s.ringLevel-i.ringLevel)[0]?.id,gl=(e,t)=>{let r;if(!(!t||!(r=e?._vm?.authorizedKeys?.[t]?.foreignKey)))try{return new URL(r).pathname}catch{}},go=(e,t,r,n)=>e._vm?.authorizedKeys&&Object.values(e._vm.authorizedKeys).filter(o=>o._notAfterHeight==null&&o.ringLevel<=(n??Number.POSITIVE_INFINITY)&&(Array.isArray(t)?t.reduce((i,s)=>i&&(o.permissions==="*"||o.permissions.includes(s)),!0):t===o.permissions)&&r.reduce((i,s)=>i&&o.purpose.includes(s),!0)).sort((o,i)=>i.ringLevel-o.ringLevel).map(o=>o.id),dl=(e,t,r,n,o)=>{let i=Sr(o)?o.valueOf():o;if(t.allowedActions!=="*"&&(!Array.isArray(t.allowedActions)||!t.allowedActions.includes(i.action)))return yr(e,`Signing key ${t.id} is not allowed for action ${i.action}`),!1;if(Sr(o)){let s=o,a=r._vm?.authorizedKeys?.[s.signingKeyId];if(!a&&e._direction==="outgoing")return!0;if(!a||!Array.isArray(a.purpose)||!a.purpose.includes("sig")||a.permissions!=="*"&&(!Array.isArray(a.permissions)||!a.permissions.includes(n+"#inner")))return yr(e,`Signing key ${s.signingKeyId} is missing permissions for operation ${n}`),!1;if(a.allowedActions!=="*"&&(!Array.isArray(a.allowedActions)||!a.allowedActions.includes(i.action+"#inner")))return yr(e,`Signing key ${a.id} is not allowed for action ${i.action}`),!1}return!0},Ia=(e,t,r,n,o,i)=>{let s=r._vm?.authorizedKeys?.[n];return!s||!Array.isArray(s.purpose)||!s.purpose.includes("sig")||s.permissions!=="*"&&(!Array.isArray(s.permissions)||!s.permissions.includes(o))?(yr(e,`Signing key ${n} is missing permissions for operation ${o}`),!1):!(o===v.OP_ACTION_UNENCRYPTED&&!dl(e,s,r,o,i)||!t.skipActionProcessing&&o===v.OP_ACTION_ENCRYPTED&&!dl(e,s,r,o,i.valueOf()))},Sa=function(e,t,r,n,o){let i=Array.isArray(t.permissions)?new Set(t.permissions):t.permissions,s=Array.isArray(t.allowedActions)?new Set(t.allowedActions):t.allowedActions;if(!r._vm?.authorizedKeys?.[t.id])throw new Error("Singing key for OP_KEY_ADD or OP_KEY_UPDATE must exist in _vm.authorizedKeys. contractID="+e+" signingKeyId="+t.id);let a=r._vm.authorizedKeys[t.id];n.forEach(u=>{let f=this.config.unwrapMaybeEncryptedData(u);if(!f)return;let d=f.data;if(!o&&t._private&&!f.encryptionKeyId)throw new Error("Signing key is private but it tried adding a public key");if(!Number.isSafeInteger(d.ringLevel)||d.ringLevel<a.ringLevel)throw new Error("Signing key has ringLevel "+a.ringLevel+" but attempted to add or update a key with ringLevel "+d.ringLevel);if(i!=="*"&&(!Array.isArray(d.permissions)||!d.permissions.reduce((h,g)=>h&&i.has(g),!0)))throw new Error("Unable to add or update a key with more permissions than the signing key. signingKey permissions: "+String(t?.permissions)+"; key add permissions: "+String(d.permissions));if(s!=="*"&&d.allowedActions&&(!s||!Array.isArray(d.allowedActions)||!d.allowedActions.reduce((h,g)=>h&&s.has(g),!0)))throw new Error("Unable to add or update a key with more allowed actions than the signing key. signingKey allowed actions: "+String(t?.allowedActions)+"; key add allowed actions: "+String(d.allowedActions))})},yl=function(e,t,r,n){if(!r._vm?.authorizedKeys?.[t.id])throw new Error("Singing key for OP_KEY_DEL must exist in _vm.authorizedKeys. contractID="+e+" signingKeyId="+t.id);let o=r._vm.authorizedKeys[t.id];n.forEach(i=>{let s=this.config.unwrapMaybeEncryptedData(i);if(!s)return;let a=s.data,u=r._vm.authorizedKeys[a];if(!u)throw new Error("Nonexisting key ID "+a);if(t._private)throw new Error("Signing key is private");if(!u._private!=!s.encryptionKeyId)throw new Error("_private attribute must be preserved");if(!Number.isSafeInteger(u.ringLevel)||u.ringLevel<o.ringLevel)throw new Error("Signing key has ringLevel "+o.ringLevel+" but attempted to remove a key with ringLevel "+u.ringLevel)})},ml=function(e,t,r,n){let o=Object.create(null),i=n.map(s=>{let a=this.config.unwrapMaybeEncryptedData(s);if(!a)return;let u=a.data,f=r._vm.authorizedKeys[u.oldKeyId];if(!f)throw new Ei("Missing old key ID "+u.oldKeyId);if(!f._private!=!a.encryptionKeyId)throw new Error("_private attribute must be preserved");if(u.name!==f.name)throw new Error("Name cannot be updated");if(!u.id!=!u.data)throw new Error("Both or none of the id and data attributes must be provided. Old key ID: "+u.oldKeyId);if(u.data&&f.meta?.private&&!u.meta?.private)throw new Error("Missing private key. Old key ID: "+u.oldKeyId);u.id&&u.id!==u.oldKeyId&&(o[u.id]=u.oldKeyId);let d=Xe(f,["_notAfterHeight","_notBeforeHeight"]);return u.permissions&&(d.permissions=u.permissions),u.allowedActions&&(d.allowedActions=u.allowedActions),u.purpose&&(d.purpose=u.purpose),u.meta&&(d.meta=u.meta),u.id&&(d.id=u.id),u.data&&(d.data=u.data),d}).filter(Boolean);return Sa.call(this,e,t,r,i,!0),[i,o]},ss=function(e,t,r,n,o,i,s){let a=[],u=[],f=(d,h)=>{let g=He(h),E=!!d.meta?.private?.transient;c("chelonia/storeSecretKeys",new Ze([{key:g,transient:!0}])),E||u.push({key:g,transient:E})};for(let d of r){let h=this.config.unwrapMaybeEncryptedData(d);if(!h)continue;let g=h.data,E;if(g.meta?.private&&g.meta.private.content&&g.id&&g.meta.private.content&&!c("chelonia/haveSecretKey",g.id,!g.meta.private.transient)){let w=this.config.unwrapMaybeEncryptedData(g.meta.private.content);if(w){if(w.encryptionKeyId==null)throw new Error("Expected encrypted data but got unencrypted data for key with ID: "+g.id);E=w.data,a.push([g.id,E]),f(g,E)}}if(g.name==="#sak"){if(h.encryptionKeyId)throw new Error("#sak may not be encrypted");if(g.permissions&&(!Array.isArray(g.permissions)||g.permissions.length!==0))throw new Error("#sak may not have permissions");if(!Array.isArray(g.purpose)||g.purpose.length!==1||g.purpose[0]!=="sak")throw new Error("#sak must have exactly one purpose: 'sak'");if(g.ringLevel!==0)throw new Error("#sak must have ringLevel 0")}if(g.name.startsWith("#inviteKey-")){n._vm.invites||(n._vm.invites=Object.create(null));let w=E||(q(this.transientSecretKeys,g.id)?se(this.transientSecretKeys[g.id],!0):void 0);n._vm.invites[g.id]={status:en.VALID,initialQuantity:g.meta.quantity,quantity:g.meta.quantity,expires:g.meta.expires,inviteSecret:w,responses:[]}}if(g.meta?.keyRequest?.contractID&&gt(n,[v.OP_KEY_ADD],["sig"])){let w=this.config.unwrapMaybeEncryptedData(g.meta.keyRequest.contractID);if(w&&s){let I=w.data,C=this.config.unwrapMaybeEncryptedData(g.meta.keyRequest.reference);s.push(()=>{c("chelonia/private/queueEvent",I,()=>{let G=c(this.config.stateSelector),A=G[o];if(c("chelonia/contract/hasKeyShareBeenRespondedBy",A,I,C))return;q(G,I)||this.config.reactiveSet(G,I,Object.create(null));let R=G[I];R._volatile||this.config.reactiveSet(R,"_volatile",Object.create(null)),R._volatile.pendingKeyRequests||this.config.reactiveSet(G[I]._volatile,"pendingKeyRequests",[]),!R._volatile.pendingKeyRequests.some(O=>O&&O.contractID===o&&O.hash===t)&&(R._volatile.pendingKeyRequests.push({contractID:o,name:g.name,hash:t,reference:C?.data}),this.setPostSyncOp(o,"pending-keys-for-"+I,["okTurtles.events/emit",fl,{contractID:I}]))}).catch(G=>{console.error("Error while setting or updating pendingKeyRequests",{contractID:o,keyRequestContractID:I,reference:C},G)})})}}}u.length&&s?.push(()=>{c("chelonia/storeSecretKeys",new Ze(u))}),s?.push(()=>Gp.call(this,o,n))},Gp=function(e,t){try{Object.values(t._vm.authorizedKeys).filter(r=>!!r.foreignKey&&ze(t,r.name)!=null).forEach(r=>{let n=String(r.foreignKey),o=new URL(n),i=o.pathname,s=o.searchParams.get("keyName");if(!i||!s){console.warn("Invalid foreign key: missing contract or key name",{contractID:e,keyId:r.id});return}let a=c(this.config.stateSelector);gt(t,[v.OP_KEY_DEL],["sig"],r.ringLevel)&&(Array.isArray(a?.[i]?._volatile?.watch)&&a[i]._volatile.watch.find(d=>d[0]===r.name&&d[1]===e)||(q(t._vm,"pendingWatch")||this.config.reactiveSet(t._vm,"pendingWatch",Object.create(null)),q(t._vm.pendingWatch,i)||this.config.reactiveSet(t._vm.pendingWatch,i,[]),t._vm.pendingWatch[i].find(([d])=>d===s)||t._vm.pendingWatch[i].push([s,r.id]),this.setPostSyncOp(e,`watchForeignKeys-${e}`,["chelonia/private/watchForeignKeys",e])))})}catch(r){console.warn("Error at subscribeToForeignKeyContracts: "+(r.message||r))}},El=(e,t,r)=>{let{HEAD:n,height:o,previousKeyOp:i}=r||{};if(!n)throw new Error("recreateEvent: Giving up because the contract has been removed");let s=e.head(),[a,u]=e.rawOp(),d=((g,E)=>{let w=E.valueOf(),I=(G,A)=>{let R;if(G===v.OP_KEY_ADD){if(!Array.isArray(A))throw new Error("Invalid message format");if(R=A.filter(O=>{let F=O.valueOf().id;return!q(t._vm.authorizedKeys,F)||t._vm.authorizedKeys[F]._notAfterHeight!=null}),R.length===0)console.info("Omitting empty OP_KEY_ADD",{head:s});else if(R.length===A.length)return A}else if(G===v.OP_KEY_DEL){if(!Array.isArray(A))throw new Error("Invalid message format");if(R=A.filter(O=>{let F=Object(O).valueOf();return q(t._vm.authorizedKeys,F)&&t._vm.authorizedKeys[F]._notAfterHeight==null}),R.length===0)console.info("Omitting empty OP_KEY_DEL",{head:s});else if(R.length===A.length)return A}else if(G===v.OP_KEY_UPDATE){if(!Array.isArray(A))throw new Error("Invalid message format");if(R=A.filter(O=>{let F=O.valueOf().oldKeyId;return O.valueOf().id==null||q(t._vm.authorizedKeys,F)&&t._vm.authorizedKeys[F]._notAfterHeight==null}),R.length===0)console.info("Omitting empty OP_KEY_UPDATE",{head:s});else if(R.length===A.length)return A}else if(G===v.OP_ATOMIC){if(!Array.isArray(A))throw new Error("Invalid message format");if(R=A.map(([O,F])=>[O,I(O,F)]).filter(([,O])=>!!O),R.length===0)console.info("Omitting empty OP_ATOMIC",{head:s});else return R.length===A.length&&R.reduce((O,F,P)=>O&&F===A[P],!0)?A:R}else return A},C=I(g,w);if(C===w)return E;if(C===void 0)return;if(typeof E.recreate!="function")throw new Error("Unable to recreate operation");return E.recreate(C)})(a,u);if(!d)return;let h=[a,d];return e=v.cloneWith(s,h,{previousKeyOp:i,previousHEAD:n,height:o+1}),e},$r=(e,t,r)=>{if(t)return t&&r._vm?.authorizedKeys?.[t]?.foreignKey?new URL(r._vm.authorizedKeys[t].foreignKey).pathname:e};function bl(e,t,r,n,{stream:o}={stream:!0}){if(!e)throw new Error("Missing contract ID");let i,s=async()=>{E=Math.min(r??$p,f),i=`${this.config.connectionURL}/eventsAfter/${e}/${t}${Number.isInteger(E)?`/${E}`:""}`;let A=await this.config.fetch(i,{signal:a});if(!A.ok){let R=`${A.status}: ${A.statusText}`;throw A.status===404||A.status===410?new Vr(R,{cause:A.status}):new ln(R,{cause:A.status})}if(!A.body)throw new Error("Missing body");if(h=parseInt(A.headers.get("shelter-headinfo-height"),10),!Number.isSafeInteger(h))throw new Error("Invalid latest height");return u++,A.body.getReader()};if(!Number.isSafeInteger(t)||t<0)throw new TypeError("Invalid since height value. Expected positive integer.");let a=this.abortController.signal,u=0,f=r??Number.POSITIVE_INFINITY,d,h,g="fetch",E,w,I="",C,G=new ReadableStream({async pull(A){try{for(;;)switch(g){case"fetch":{d=await s(),g="read-new-response",w=0;break}case"read-eos":case"read-new-response":case"read":{let{done:R,value:O}=await d.read();if(R)if(f===0||t>=h){A.close();return}else{if(g==="read-new-response"||I)throw new Error("Invalid response: done too early");g="fetch";break}if(!O)throw new Error("Invalid response: missing body");if(I=I+Buffer.from(O).toString().trim(),!I)break;if(g==="read-new-response"){if(I[0]!=="[")throw new Error("Invalid response: no array start delimiter");I=I.slice(1)}else if(g==="read-eos")throw new Error("Invalid data at the end of response");g="events";break}case"events":{let R=I.search(/(?<=\s*)[,\]]/);if(R<0){g="read";break}let O=!1;try{let F=I.slice(0,R).trim();if(F){if(w===E)throw new Error("Received too many events");if(C=JSON.parse(Nu(JSON.parse(F))).message,w===0){let P=v.deserializeHEAD(C).hash,W=v.deserializeHEAD(C).head.height;if(W!==t||n&&n!==P)throw W===t&&n&&n!==P?new xi(`Forked chain: hash(${P}) !== since(${n})`):new Error(`Unexpected data: hash(${P}) !== since(${n||""}) or height(${W}) !== since(${t})`)}(w++!==0||u!==0)&&(A.enqueue(C),O=!0,f--)}if(I[R]==="]"){if(C){let P=v.deserializeHEAD(C);t=P.head.height,n=P.hash,g="read-eos"}else g="eod";I=I.slice(R+1).trim()}else if(C)I=I.slice(R+1).trimStart();else throw new Error("Missing end delimiter");if(O)return}catch(F){throw console.error("[chelonia] Error during event parsing",F),F}break}case"eod":{if(f===0||t>=h)A.close();else throw new Error("Unexpected end of data");return}}}catch(R){throw console.error("[eventsAfter] Error",{lastUrl:i},R),d?.cancel("Error during pull").catch(O=>{console.error("Error canceling underlying event stream reader on error",R,O)}),R}}});return o?G:va(G)}function mr(e,t){t||(t=c(this.config.stateSelector)[e]);let r=ze(t,"#sak");if(!r)throw new Error(`Missing #sak in ${e}`);let n=this.transientSecretKeys[r];if(!n)throw new Error(`Missing secret #sak (${r}) in ${e}`);let o=typeof n=="string"?He(n):n,i=new Uint8Array(15);globalThis.crypto.getRandomValues(i);let s=`${e} ${c("chelonia/time")}.${Buffer.from(i).toString("base64")}`;return`shelter ${s}.${rs(o,s)}`}var Xo=e=>{Object.keys(e).forEach(t=>delete e[t])},wl=(e,t)=>{Object.keys(e).forEach(r=>t(e,r))},_a=function(e){let t=c(this.config.stateSelector);return(!q(t.contracts,e)||!t.contracts[e]||!q(t.contracts[e],"references"))&&!q(this.ephemeralReferenceCount,e)&&(!q(t,e)||!q(t[e],"_volatile")||!q(t[e]._volatile,"watch")||t[e]._volatile.watch.length===0||t[e]._volatile.watch.filter(([,r])=>this.subscriptionSet.has(r)).length===0)},va=async e=>{let t=e.getReader(),r=[];for(;;){let{done:n,value:o}=await t.read();if(n)break;r.push(o)}return r},yr=(e,...t)=>{e._direction==="outgoing"?console.warn(...t):console.error(...t)};var jp=e=>{let t=Boolean,r=new Promise(n=>{t=n});return c("okTurtles.eventQueue/queueEvent",e,()=>r),t},pe=(e,t,r,n,o,i)=>{let s=(a,u,f,d,h)=>g=>{let E=g??a,w=["chelonia/out/actionEncrypted",{...E,signingKeyId:u,innerSigningKeyId:f,encryptionKeyId:d,action:e.replace("gi.actions","gi.contracts"),originatingContractID:h}];return E.returnInvocation?w:c(...w)};return{[e]:async function(a){let u=a.contractID;if(!u)throw new Error("Missing contract ID");if(c("chelonia/rootState").contracts[u]===null)throw console.warn(`[${e}] Contract is marked as permamently deleted, aborting`,u),new Error("Contract permanently deleted: "+u);let d=jp("encrypted-action"),h=!1;try{await c("chelonia/contract/retain",u,{ephemeral:!0}).catch(O=>{throw h=!0,O});let g={[u]:await c("chelonia/latestContractState",u)},E=c("chelonia/rootState"),w=a.signingContractID||u;g[w]||(g[w]=await c("chelonia/latestContractState",w));let I=a.innerSigningContractID!==void 0?a.innerSigningContractID:u===E.loggedIn.identityContractID?null:E.loggedIn.identityContractID;I&&!g[I]&&(g[I]=await c("chelonia/latestContractState",I));let C=a.signingKeyId||ze(g[w],o??"csk"),G=a.innerSigningKeyId||a.innerSigningKeyId!==null&&I&&ze(g[I],i??"csk"),A=a.encryptionKeyId||ze(g[u],n??"cek");if(!C||!A||!await c("chelonia/haveSecretKey",C))throw console.warn(`Refusing to send action ${e} due to missing CSK or CEK`,{contractID:u,action:e,signingKeyName:o,encryptionKeyName:n,signingKeyId:C,encryptionKeyId:A,signingContractID:a.signingContractID,originatingContractID:a.originatingContractID}),new Cn(`No key found to send ${e} for contract ${u}`);if(I&&(!G||!await c("chelonia/haveSecretKey",G)))throw console.warn(`Refusing to send action ${e} due to missing inner signing key ID`,{contractID:u,action:e,signingKeyName:o,encryptionKeyName:n,signingKeyId:C,encryptionKeyId:A,signingContractID:a.signingContractID,originatingContractID:a.originatingContractID,innerSigningKeyId:G}),new Cn(`No key found to send ${e} for contract ${u}`);let R=s(a,C,G||null,A,a.originatingContractID);return r?await r(R,a,C,A,a.originatingContractID):await R()}catch(g){let E=typeof t=="string"?`${t} ${wr(g).reportError}`:t(a,g);throw new _t(E,{cause:g})}finally{d(),h||await c("chelonia/contract/release",u,{ephemeral:!0})}}}},Ta=(e,t,r,n,o,i)=>{let s=(a,u,f,d,h)=>g=>{let E=g??a,w=e.replace("gi.actions","gi.contracts");return c("chelonia/out/encryptedOrUnencryptedPubMessage",{contractID:E.contractID,contractName:w.split("/",2).join("/"),innerSigningKeyId:f,encryptionKeyId:d,signingKeyId:u,data:[w,E.data]})};return{[e]:async function(a){let u=a.contractID;if(!u)throw new Error("Missing contract ID");try{await c("chelonia/contract/retain",u,{ephemeral:!0});let f={[u]:await c("chelonia/latestContractState",u)},d=c("chelonia/rootState"),h=a.signingContractID||u;f[h]||(f[h]=await c("chelonia/latestContractState",h));let g=a.innerSigningContractID!==void 0?a.innerSigningContractID:u===d.loggedIn.identityContractID?null:d.loggedIn.identityContractID;g&&!f[g]&&(f[g]=await c("chelonia/latestContractState",g));let E=a.signingKeyId||ze(f[h],o??"csk"),w=a.innerSigningKeyId||a.innerSigningKeyId!==null&&g&&ze(f[g],i??"csk"),I=a.encryptionKeyId||ze(f[u],n??"cek");if(!E||!I||!await c("chelonia/haveSecretKey",E))throw console.warn(`Refusing to send action ${e} due to missing CSK or CEK`,{contractID:u,action:e,signingKeyName:o,encryptionKeyName:n,signingKeyId:E,encryptionKeyId:I,signingContractID:a.signingContractID,originatingContractID:a.originatingContractID}),new Cn(`No key found to send ${e} for contract ${u}`);if(g&&(!w||!await c("chelonia/haveSecretKey",w)))throw console.warn(`Refusing to send action ${e} due to missing inner signing key ID`,{contractID:u,action:e,signingKeyName:o,encryptionKeyName:n,signingKeyId:E,encryptionKeyId:I,signingContractID:a.signingContractID,originatingContractID:a.originatingContractID,innerSigningKeyId:w}),new Cn(`No key found to send ${e} for contract ${u}`);let C=s(a,E,w||null,I,a.originatingContractID);return r?await r(C,a,E,I,a.originatingContractID):await C()}catch(f){let d=typeof t=="string"?`${t} ${wr(f).reportError}`:t(a,f);throw new _t(d,{cause:f})}finally{await c("chelonia/contract/release",u,{ephemeral:!0})}}}};async function xl({contractID:e,quantity:t=1,creatorID:r,expires:n,invitee:o}){let i=await c("chelonia/contract/state",e);if(!i||!i._vm||!gt(i,"*",["sig"])||i._volatile?.pendingKeyRequests?.length)throw new Error("Invalid or missing current group state");let s=ze(i,"cek"),a=ze(i,"csk");if(!s||!a)throw new Error("Contract is missing a CEK or CSK");let u=Qe(lt),f=de(u),d=se(u,!1),h=ke(i,s,se(u,!0));return await c("chelonia/out/keyAdd",{contractID:e,contractName:"gi.contracts/group",data:[{id:f,name:"#inviteKey-"+f,purpose:["sig"],ringLevel:Number.MAX_SAFE_INTEGER,permissions:[v.OP_KEY_REQUEST],meta:{quantity:t,expires:Date.now()+Ft*n,private:{content:h}},data:d}],signingKeyId:a}),{inviteKeyId:f,creatorID:r,invitee:o}}function as(e){let t=Object.create(null);return e&&Object.entries(e).filter(([r,n])=>!!n).forEach(([r,{references:n,type:o}])=>{n&&(t[o]||(t[o]=[]),t[o].push(r))}),t}async function cs(e){let t=["gi.contracts/identity","gi.contracts/group","gi.contracts/chatroom"],r=o=>{let i=t.indexOf(o);return i===-1?t.length:i},n=[];try{let o=Object.entries(e).sort(([i],[s])=>r(i)-r(s));for(let[i,s]of o)for(let a of s){let{contracts:u}=c("chelonia/rootState");if(a in u)try{await c("chelonia/contract/sync",a)}catch(f){console.error(`syncContractsInOrder: failed to sync ${i}(${a}):`,f),f.name==="ChelErrorResourceGone"?(console.info("[syncContractsInOrder] Contract ID "+a+" has been deleted"),c("chelonia/contract/remove",a,{permanent:!0}).catch(d=>{console.error("[syncContractsInOrder] Error handling contract deletion",d)})):n.push(`${i}(\u2026${a.slice(-5)}) failed sync with '${f.message}'`)}else console.warn(`syncContractsInOrder: skipping ${i}(${a}) as it was removed while syncing previous contracts`)}if(n.length>0)throw new Error(n.join(", "))}catch(o){throw console.error("Error during contract sync (syncing all contractIDs)",o),o}}function Il(e){let t=[];if(e){let{paymentsFrom:r}=e;for(let n in r)for(let o in r[n])t=t.concat(r[n][o])}return t}function Sl(e,t){return{fromMemberID:t.data.fromMemberID,toMemberID:t.data.toMemberID,hash:e,amount:t.data.amount,isLate:!!t.data.isLate,when:t.data.completedDate}}function _l(e){let{creatorID:t,status:r}=e,{proposalType:n,proposalData:o}=e.data,i={mincomeAmount:S("mincome"),distributionDate:S("distribution date"),votingSystem:S("voting system"),votingRule:S("voting rules")},s={};n===br?o.ruleName!==o.current.ruleName?s.settingType="votingSystem":o.ruleThreshold!==o.current.ruleThreshold&&(s.settingType="votingRule"):n===Er?s.settingType=o.setting:n===Yt?s.title=o.name:n===pr?s.member=o.memberName:n===St&&(s.memberID=o.memberID);let{proposedValue:a}=o;return a&&(s.settingType==="distributionDate"?s.value=vi(a,{month:"long",year:"numeric",day:"numeric"}):s.value=a),s.settingType&&(s.setting=i[s.settingType]),{creatorID:t,status:r,type:n,options:s}}function us(e){return{me:e?`${Ct}${e}`:"",all:`${Ct}all`}}function Hp(e,t=!1){return`${di}${t?":chatID:":""}${e}`}function zp(e){return e.includes(":chatID:")?e.split(":chatID:")[1]:""}function vl(e,t={escaped:!0,forChat:!0}){let{getChatroomNameById:r,usernameFromID:n,userDisplayNameFromID:o}=c("state/vuex/getters"),{reverseNamespaceLookups:i}=c("state/vuex/state"),s=[...Object.keys(i).map(h=>us(h).me).filter(h=>!!h),Hp("[^\\s]+",!0)],{escaped:a,forChat:u}=t,f=a?new RegExp(`(?<=\\s|^)(${s.join("|")})(?=[^\\w\\d]|$)`):new RegExp(`(${s.join("|")})`),d=h=>{if(h.startsWith(Ct)){let g=h.slice(1),E=u?Ct:"",w=u?n(g):o(g);return E+w}else if(h.startsWith(di)){let g=zp(h);return(u?di:"")+r(g)}return h};return e.split(f).map(h=>f.test(h)?d(h):h).join("")}async function Yp({contractID:e,messageHash:t,height:r,text:n,isDMOrMention:o,messageType:i,memberID:s,chatRoomName:a}){let u=await c("state/vuex/getters"),f=await c("state/vuex/state"),d=f.loggedIn?.identityContractID;if(!d)return;let h=f[d].chatRooms[e],g=o||[Rr.INTERACTIVE,Rr.POLL].includes(i);await c("chelonia/contract/retain",e,{ephemeral:!0});try{g&&c("gi.actions/identity/kv/addChatRoomUnreadMessage",{contractID:e,messageHash:t,createdHeight:r}).catch(W=>{console.error("[messageReceivePostEffect] Error calling addChatRoomUnreadMessage",W)});let E=`# ${a}`,w;if(h){let W=f[e].members,ce=Object.keys(W),Oe=ce.length===1&&ce[0]===d,xe=ce.filter(he=>he!==d).sort((he,$e)=>{let Pe=new Date(W[he].joinedDate).getTime(),et=new Date(W[$e].joinedDate).getTime();return Pe-et}),we=Oe?d:xe[xe.length-1];E=Oe?u.userDisplayNameFromID(d):xe.map(he=>u.userDisplayNameFromID(he)).join(", "),w=u.ourContactProfilesById[we]?.picture}else w=u.ourContactProfilesById[s]?.picture;let I=`/group-chat/${e}`,C=f[e]?.attributes?.privacyLevel===hr.PRIVATE,G=u.chatNotificationSettings[e]||(C?u.chatNotificationSettings.privateDefault:u.chatNotificationSettings.publicDefault),{messageNotification:A,messageSound:R}=G;if(c("chelonia/contract/isSyncing",e,{firstSync:!0}))return;let F=A===kr.ALL_MESSAGES||A===kr.DIRECT_MESSAGES&&o,P=R===kr.ALL_MESSAGES||R===kr.DIRECT_MESSAGES&&o;F&&Kn({title:E,body:i===Rr.TEXT?vl(n):S("New message"),icon:w,path:I}),P&&c("okTurtles.events/emit",pi,{contractID:e,messageHash:t,messageType:i})}finally{await c("chelonia/contract/release",e,{ephemeral:!0})}}var Tl=Yp;c("okTurtles.events/on",nc,({contractID:e,data:t,innerSigningContractID:r,newMessage:n})=>{let o=c("chelonia/contract/state",e),i=c("chelonia/rootState"),s=c("state/vuex/getters"),a=us(i.loggedIn?.identityContractID),u=n||t,f=(!!n||t.type===Rr.TEXT)&&u.text&&(u.text.includes(a.me)||u.text.includes(a.all));if(!n){let d=!!s.chatRoomUnreadMessages(e).find(h=>h.messageHash===t.hash);if(d&&!f&&c("gi.actions/identity/kv/removeChatRoomUnreadMessage",{contractID:e,messageHash:t.hash}).catch(h=>{console.error("[MESSAGE_RECEIVE_RAW handler] Error calling removeChatRoomUnreadMessage",h)}),d)return}Tl({contractID:e,messageHash:u.hash,height:u.height,text:u.text,isDMOrMention:f||o.attributes?.type===hi.DIRECT_MESSAGE,messageType:n?t.type:Rr.TEXT,memberID:r,chatRoomName:o.attributes?.name}).catch(d=>{console.error("[action/chatroom.js] Error on messageReceivePostEffect",d)})});var Vp=c("sbp/selectors/register",{"gi.actions/chatroom/create":async function(e,t){let n=c("state/vuex/state").loggedIn.identityContractID;await c("chelonia/contract/retain",n,{ephemeral:!0});try{let o=e.options?.csk,i=e.options?.cek;if(!i){let E=Qe(Wt),w=de(E),I=se(E,!1),C=nt(E,se(E,!0));i={id:w,foreignKey:void 0,meta:{private:{content:C,shareable:!0}},data:I,_rawKey:E}}let s=i._rawKey?i._rawKey:He(i.data);if(!o){let E=Qe(lt),w=de(E),I=se(E,!1),C=nt(s,se(E,!0));o={id:w,foreignKey:void 0,meta:{private:{content:C,shareable:!0}},data:I,_rawKey:E}}if(await c("chelonia/storeSecretKeys",new Ze([i._rawKey,o._rawKey].map(E=>({key:E,transient:!0})))),!await c("chelonia/contract/currentKeyIdByName",n,"csk"))throw new Error("User CSK id not found");let u=Qe(lt),f=de(u),d=se(u,!1),h=nt(s,se(u,!0)),g=await c("chelonia/out/registerContract",{...Xe(e,["options"]),publishOptions:{billableContractID:t,...e.publishOptions},signingKeyId:o.id,actionSigningKeyId:o.id,actionEncryptionKeyId:i.id,keys:[{id:o.id,name:"csk",purpose:["sig"],ringLevel:0,permissions:"*",allowedActions:"*",foreignKey:o.foreignKey,meta:o.meta,data:o.data},{id:i.id,name:"cek",purpose:["enc"],ringLevel:0,permissions:[v.OP_ACTION_ENCRYPTED],allowedActions:"*",foreignKey:i.foreignKey,meta:i.meta,data:i.data},...e.options?.groupKeys?[{id:e.options.groupKeys[0].id,name:"group-csk",purpose:["sig"],ringLevel:2,permissions:[v.OP_ATOMIC,v.OP_KEY_DEL,v.OP_ACTION_ENCRYPTED],allowedActions:["gi.contracts/chatroom/leave"],foreignKey:e.options.groupKeys[0].foreignKey,meta:e.options.groupKeys[0].meta,data:e.options.groupKeys[0].data},{id:e.options.groupKeys[1].id,name:"group-cek",purpose:["enc"],ringLevel:2,permissions:[v.OP_ATOMIC,v.OP_KEY_ADD,v.OP_KEY_DEL,v.OP_ACTION_ENCRYPTED],allowedActions:["gi.contracts/chatroom/join","gi.contracts/chatroom/leave"],foreignKey:e.options.groupKeys[1].foreignKey,meta:e.options.groupKeys[1].meta,data:e.options.groupKeys[1].data}]:[],{id:f,name:"#sak",purpose:["sak"],ringLevel:0,permissions:[],allowedActions:[],meta:{private:{content:h}},data:d}],data:{...e.data,attributes:{...e.data?.attributes,creatorID:n}},contractName:"gi.contracts/chatroom"});return await c("chelonia/storeSecretKeys",new Ze([i._rawKey,o._rawKey].map(E=>({key:E})))),g}catch(o){throw console.error("gi.actions/chatroom/register failed!",o),new _t(S("Failed to create chat channel."))}finally{await c("chelonia/contract/release",n,{ephemeral:!0})}},"gi.actions/chatroom/shareNewKeys":async(e,t)=>{let r=c("chelonia/contract/state",e),n=await c("chelonia/contract/currentKeyIdByName",r,"cek"),o=r.attributes.groupContractID?r.attributes.groupContractID:e;return Promise.all(Object.keys(r.members).map(async i=>{let s=await c("chelonia/contract/currentKeyIdByName",i,"cek");if(!s){console.warn(`Unable to share rotated keys for ${o} with ${i}: Missing CEK`);return}return["chelonia/out/keyShare",{data:ke(e,n,{contractID:e,foreignContractID:i,keys:Object.values(t).map(([,a,u])=>({id:u,meta:{private:{content:ke(i,s,se(a,!0))}}}))})}]})).then(i=>[i.filter(Boolean)])},"gi.actions/chatroom/_ondeleted":async(e,t)=>{let r=c("state/vuex/getters"),n=r.currentIdentityState;if(n.chatRooms?.[e]){let o=r.ourIdentityContractId;await c("gi.actions/identity/deleteDirectMessage",{contractID:o,data:{contractID:e}}).catch(i=>{console.warn(`[handleDeletedContract] ${i.name} thrown by gi.actions/identity/deleteDirectMessage ${o} for ${e}:`,i)})}else{let o=Object.entries(n.groups||{}).filter(([i,s])=>!s.hasLeft).map(([i])=>i);for(let i of o){let s=c("chelonia/contract/state",i);if(s?.chatRooms?.[e]){s.chatRooms[e].deletedDate||await c("gi.actions/group/deleteChatRoom",{contractID:i,data:{chatRoomID:e}}).catch(a=>{console.warn(`[handleDeletedContract] ${a.name} thrown by gi.actions/group/deleteChatRoom ${i} for ${e}:`,a)});break}}}},...Ta("gi.actions/chatroom/user-typing-event",S("Failed to send typing notification")),...Ta("gi.actions/chatroom/user-stop-typing-event",S("Failed to send stopped typing notification")),...pe("gi.actions/chatroom/addMessage",S("Failed to add message.")),...pe("gi.actions/chatroom/editMessage",S("Failed to edit message.")),...pe("gi.actions/chatroom/deleteMessage",S("Failed to delete message.")),...pe("gi.actions/chatroom/deleteAttachment",S("Failed to delete attachment of message.")),...pe("gi.actions/chatroom/makeEmotion",S("Failed to make emotion.")),...pe("gi.actions/chatroom/pinMessage",S("Failed to pin message.")),...pe("gi.actions/chatroom/unpinMessage",S("Failed to unpin message.")),...pe("gi.actions/chatroom/join",S("Failed to join chat channel."),async(e,t,r)=>{let n=c("state/vuex/state"),o=n.loggedIn.identityContractID,i=(Array.isArray(t.data.memberID)?t.data.memberID:[t.data.memberID]).map(s=>s??o);await c("chelonia/contract/retain",i,{ephemeral:!0});try{await c("chelonia/contract/wait",t.contractID),i.forEach(u=>{if(!u||!q(n.contracts,u)||!q(n,u))throw new Error(`Unable to send gi.actions/chatroom/join on ${t.contractID} because user ID contract ${u} is missing`)});let s=t.encryptionKeyId||await c("chelonia/contract/currentKeyIdByName",t.contractID,"cek"),a=await Promise.all(i.map(async u=>[u,await c("chelonia/contract/currentKeyIdByName",u,"csk")]));return await c("chelonia/out/atomic",{...t,contractName:"gi.contracts/chatroom",data:[["chelonia/out/keyAdd",{data:a.map(([u,f])=>ke(t.contractID,s,{foreignKey:`shelter:${encodeURIComponent(u)}?keyName=${encodeURIComponent("csk")}`,id:f,data:n[u]._vm.authorizedKeys[f].data,permissions:[v.OP_ACTION_ENCRYPTED+"#inner"],allowedActions:"*",purpose:["sig"],ringLevel:Number.MAX_SAFE_INTEGER,name:`${u}/${f}`}))}],...i.map(u=>e({...t,data:u===o?{}:{memberID:u},returnInvocation:!0}))],signingKeyId:r})}finally{await c("chelonia/contract/release",i,{ephemeral:!0})}}),...pe("gi.actions/chatroom/rename",S("Failed to rename chat channel.")),...pe("gi.actions/chatroom/changeDescription",S("Failed to change chat channel description.")),...pe("gi.actions/chatroom/leave",S("Failed to leave chat channel."),async(e,t,r)=>{let n=t.data.memberID,o=n&&await c("chelonia/contract/foreignKeysByContractID",t.contractID,n);return o?.length?await c("chelonia/out/atomic",{...t,contractName:"gi.contracts/chatroom",data:[e({...t,returnInvocation:!0}),["chelonia/out/keyDel",{data:o}]],signingKeyId:r}):await e(t)}),...pe("gi.actions/chatroom/delete",S("Failed to delete chat channel.")),...pe("gi.actions/chatroom/voteOnPoll",S("Failed to vote on a poll.")),...pe("gi.actions/chatroom/changeVoteOnPoll",S("Failed to change vote on a poll.")),...pe("gi.actions/chatroom/closePoll",S("Failed to close a poll."))});var ur=":against",Cl=":indifferent",Aa=":undecided",kt=":for",tn="percentage",vn="disagreement",qp="multi-choice",Al=e=>Object.keys(e.profiles).filter(t=>e.profiles[t].status===Ot.ACTIVE).length,Nl={[tn]:function(e,t,r){r=Object.values(r);let n=Al(e);t===St&&(n-=1);let o=e.settings.proposals[t].ruleSettings[tn].threshold,i=Ol(tn,o,n),s=r.filter(E=>E===Cl).length,a=r.filter(E=>E===kt).length,u=r.filter(E=>E===ur).length,d=a+u+s,h=n-d,g=Math.ceil(i*(n-s));return console.debug(`votingRule ${tn} for ${t}:`,{neededToPass:g,totalFor:a,totalAgainst:u,totalIndifferent:s,threshold:i,absent:h,turnout:d,population:n}),a>=g?kt:a+h<g?ur:Aa},[vn]:function(e,t,r){r=Object.values(r);let n=Al(e),o=t===St?2:1,i=Math.max(e.settings.proposals[t].ruleSettings[vn].threshold,o),s=Ol(vn,i,n),a=r.filter(h=>h===kt).length,u=r.filter(h=>h===ur).length,f=r.length,d=n-f;return console.debug(`votingRule ${vn} for ${t}:`,{totalFor:a,totalAgainst:u,threshold:s,turnout:f,population:n,absent:d}),u>=s?ur:u+d<s?kt:Aa},[qp]:function(e,t,r){throw new Error("unimplemented!")}},Oa=Nl,Dl=pn(...Object.keys(Nl).map(e=>dn(e))),ZE=pn(...[ur,Cl,Aa,kt].map(e=>dn(e))),Ol=(e,t,r)=>{let n=Math.max(3,r);return{[vn]:()=>Math.min(n-1,t),[tn]:()=>{let o=2/n;return Math.max(o,t)}}[e]()};function yo({state:e,proposalHash:t,proposal:r,contractID:n,meta:o,height:i}){delete e.proposals[t],c("gi.contracts/group/pushSideEffect",n,["gi.contracts/group/makeNotificationWhenProposalClosed",e,n,o,i,t,r]),c("gi.contracts/group/pushSideEffect",n,["gi.contracts/group/archiveProposal",n,t,r])}var sb=Nn({rule:Dl,expires_ms:Ti,ruleSettings:Nn({[tn]:Nn({threshold:Ti}),[vn]:Nn({threshold:Ti})})});function Rl(e,t,r){let n=e.proposals[t],o=Object.assign({},n.votes),i=Oa[n.data.votingRule](e,n.data.proposalType,o);o[String(Math.random())]=r;let s=Oa[n.data.votingRule](e,n.data.proposalType,o);return console.debug(`oneVoteToCloseWith currentResult(${i}) newResult(${s})`),s===r}function kl(e,t){return Rl(e,t,kt)}function Pl(e,t){return Rl(e,t,ur)}function Qo(e,{meta:t,data:r,contractID:n,height:o}){let{proposalHash:i}=r,s=e.proposals[i];s.status=Hn,c("okTurtles.events/emit",ui,e,ur,r),yo({state:e,proposalHash:i,proposal:s,contractID:n,meta:t,height:o})}var Zo={rule:tn,expires_ms:14*Ft,ruleSettings:{[tn]:{threshold:.66},[vn]:{threshold:1}}},Kl={[pr]:{defaults:Zo,[kt]:async function(e,t){let{data:r,contractID:n,meta:o,height:i}=t,{proposalHash:s}=r,a=e.proposals[s];a.payload=r.passPayload,a.status=Dr;let u={...t,data:r.passPayload};await c("gi.contracts/group/invite/process",u,e),c("okTurtles.events/emit",ui,e,kt,r),yo({state:e,proposalHash:s,proposal:a,contractID:n,meta:o,height:i})},[ur]:Qo},[St]:{defaults:Zo,[kt]:async function(e,t){let{data:r,contractID:n,meta:o,height:i}=t,{proposalHash:s,passPayload:a}=r,u=e.proposals[s];u.status=Dr,u.payload=a;let f=u.data.proposalData,d={...t,data:f,proposalHash:s};await c("gi.contracts/group/removeMember/process",d,e),c("gi.contracts/group/pushSideEffect",n,["gi.contracts/group/removeMember/sideEffect",d]),yo({state:e,proposalHash:s,proposal:u,contractID:n,meta:o,height:i})},[ur]:Qo},[Er]:{defaults:Zo,[kt]:async function(e,t){let{data:r,contractID:n,meta:o,height:i}=t,{proposalHash:s}=r,a=e.proposals[s];a.status=Dr;let{setting:u,proposedValue:f}=a.data.proposalData,d={...t,data:{[u]:f},proposalHash:s};await c("gi.contracts/group/updateSettings/process",d,e),c("gi.contracts/group/pushSideEffect",n,["gi.contracts/group/updateSettings/sideEffect",d]),yo({state:e,proposalHash:s,proposal:a,contractID:n,meta:o,height:i})},[ur]:Qo},[br]:{defaults:Zo,[kt]:async function(e,t){let{data:r,contractID:n,meta:o,height:i}=t,{proposalHash:s}=r,a=e.proposals[s];a.status=Dr;let u={...t,data:a.data.proposalData,proposalHash:s};await c("gi.contracts/group/updateAllVotingRules/process",u,e),yo({state:e,proposalHash:s,proposal:a,contractID:n,meta:o,height:i})},[ur]:Qo},[Yt]:{defaults:Zo,[kt]:function(e,{data:t,contractID:r,meta:n,height:o}){let{proposalHash:i}=t,s=e.proposals[i];s.status=Dr,c("okTurtles.events/emit",ui,e,kt,t),yo({state:e,proposalHash:i,proposal:s,contractID:r,meta:n,height:o})},[ur]:Qo}},mo=Kl,ab=pn(...Object.keys(Kl).map(e=>dn(e)));function Ml(e){return fetch(e).then(t=>t.blob())}var ls=async(e,t)=>{let r=e;console.debug("will upload a picture of type:",r.type);let{download:n}=await c("chelonia/fileUpload",e,{type:r.type,cipher:"aes256gcm"},t);return n};c("okTurtles.events/on",qi,({identityContractID:e,groupContractID:t})=>{let r=c("chelonia/rootState");if(!r.notifications||r.loggedIn?.identityContractID!==e)return;let n=r.notifications.items.filter(o=>o.groupID===t).map(o=>o.hash);c("gi.notifications/remove",n)});var ei="gi.actions/group/join/failed",Ca;c("okTurtles.events/on",_n,()=>{c("okTurtles.data/delete",ei)});var Wp=c("sbp/selectors/register",{"gi.actions/group/create":async function({data:{name:e,picture:t,sharedValues:r,mincomeAmount:n,mincomeCurrency:o,ruleName:i,ruleThreshold:s,distributionDate:a},publishOptions:u}){let f=`${self.location.origin}/assets/images/group-avatar-default.png`,h=c("chelonia/rootState").loggedIn.identityContractID;if(t)try{f=await ls(t,{billableContractID:h})}catch(he){throw console.error("actions/group.js failed to upload the group picture",he),new _t(S("Failed to upload the group picture. {codeError}",{codeError:he.message}))}let g=Qe(lt),E=Qe(Wt),w=Qe(lt),I=Qe(lt),C=de(g),G=de(E),A=de(w),R=de(I),O=se(g,!1),F=se(E,!1),P=se(w,!1),W=se(I,!1),ce=nt(E,se(g,!0)),Oe=nt(E,se(E,!0)),xe=nt(E,se(w,!0)),we=nt(E,se(I,!0));try{let he={rule:i,ruleSettings:{[i]:{threshold:+s}}};if(a||(a=xr(Mr(new Date,3*Ft))),await c("chelonia/storeSecretKeys",new Ze([E,g].map(tt=>({key:tt,transient:!0})))),!await c("chelonia/contract/currentKeyIdByName",h,"csk"))throw new Error("User CSK id not found");if(!await c("chelonia/contract/currentKeyIdByName",h,"cek"))throw new Error("User CEK id not found");let et=await c("chelonia/out/registerContract",{contractName:"gi.contracts/group",publishOptions:{billableContractID:h,...u},signingKeyId:C,actionSigningKeyId:C,actionEncryptionKeyId:G,keys:[{id:C,name:"csk",purpose:["sig"],ringLevel:1,permissions:"*",allowedActions:"*",meta:{private:{content:ce,shareable:!0}},data:O},{id:G,name:"cek",purpose:["enc"],ringLevel:1,permissions:"*",allowedActions:"*",meta:{private:{content:Oe,shareable:!0}},data:F},{id:A,name:"#inviteKey-"+A,purpose:["sig"],ringLevel:Number.MAX_SAFE_INTEGER,permissions:[v.OP_KEY_REQUEST],meta:{quantity:tc,...As.ON_BOARDING&&{expires:await c("chelonia/time")+Ft*As.ON_BOARDING},private:{content:xe}},data:P},{id:R,name:"#sak",purpose:["sak"],ringLevel:0,permissions:[],allowedActions:[],meta:{private:{content:we}},data:W}],data:{invites:{[A]:{creatorID:jn,inviteKeyId:A}},settings:{groupName:e,groupPicture:f,sharedValues:r,mincomeAmount:+n,mincomeCurrency:o,distributionDate:a,minimizeDistribution:!0,proposals:{[Er]:Gt(Gt({},mo[Er].defaults),he),[pr]:Gt(Gt({},mo[pr].defaults),he),[St]:Gt(Gt({},mo[St].defaults),he),[br]:Gt(Gt({},mo[br].defaults),he),[Yt]:Gt(Gt({},mo[Yt].defaults),he)}},groupOwnerID:h}}),Xt=et.contractID();await c("chelonia/storeSecretKeys",new Ze([E,g,w].map(tt=>({key:tt})))),await c("chelonia/contract/retain",Xt,{ephemeral:!0}),await Promise.race([(async()=>{for(let tt=0;tt<10;tt++){if(await c("okTurtles.eventQueue/queueEvent","encrypted-action",()=>{}),await c("chelonia/contract/wait",Xt),c("chelonia/rootState")[Xt]?.generalChatRoomId)return;await new Promise(Or=>setTimeout(Or,50))}throw new Error("#General still not found")})(),new Promise((tt,Ve)=>{setTimeout(()=>Ve(new Error("Waiting for chatroom creation is taking too long")),5e3)})]).catch(tt=>{console.error("Error waiting for new group contract to be ready",tt)});try{await c("gi.actions/identity/joinGroup",{contractID:h,data:{groupContractID:Xt,inviteSecret:se(g,!0),creatorID:!0}})}finally{await c("chelonia/contract/release",Xt,{ephemeral:!0})}return et.contractID()}catch(he){throw console.error("gi.actions/group/create failed!",he),new _t(S("Failed to create the group: {reportError}",wr(he)))}},"gi.actions/group/join":function(e){return c("okTurtles.eventQueue/queueEvent",`JOIN_GROUP-${e.contractID}`,async()=>{console.debug("[gi.actions/group/join] Scheduled call starting",e.contractID,e);let{loggedIn:t}=c("chelonia/rootState");if(!t)throw new Error("[gi.actions/group/join] Not logged in");let{identityContractID:r}=t;await c("chelonia/contract/wait",[e.originatingContractID,e.contractID]);let n=[...new Set([e.contractID,e.originatingContractID])];await c("chelonia/contract/retain",n,{ephemeral:!0});try{let o=c("chelonia/rootState");if(!o.contracts[e.contractID]){console.warn("[gi.actions/group/join] The group contract was removed after sync. If this happened during logging in, this likely means that we left the group on a different session.",{contractID:e.contractID});return}if(o.contracts[e.contractID].type!=="gi.contracts/group")throw Error(`Contract ${e.contractID} is not a group`);let i=await c("chelonia/contract/hasKeyShareBeenRespondedBy",r,e.contractID,e.reference),s=o[e.contractID],a=await c("chelonia/contract/receivedKeysToPerformOperation",r,s,"*"),u=!i&&!a&&!!e.originatingContractID,f=await c("chelonia/contract/waitingForKeyShareTo",s,r,e.reference);if(u||f){let d=({contractID:w,sharedWithContractID:I,signingKeyName:C})=>{w!==e.contractID||I!==r||f&&!f.includes(C)||(E(),g(),c("gi.actions/group/join",e).catch(G=>{console.error("[gi.actions/group/join] Error during join (inside CONTRACT_HAS_RECEIVED_KEYS event handler)",G)}))},g=c("okTurtles.events/once",bn,()=>{E()}),E=c("okTurtles.events/on",is,d)}if(u)await c("chelonia/out/keyRequest",{...Xe(e,["options"]),innerEncryptionKeyId:await c("chelonia/contract/currentKeyIdByName",e.contractID,"cek"),permissions:[v.OP_ACTION_ENCRYPTED],allowedActions:["gi.contracts/identity/joinDirectMessage"],reference:e.reference,encryptKeyRequestMetadata:!0,hooks:{prepublish:e.hooks?.prepublish,postpublish:null}}).catch(d=>{throw console.error(`[gi.actions/group/join] Error while sending key request for ${e.contractID}:`,d?.message||d,d),d});else if(a&&!f){if(s.profiles?.[r]?.status!==Ot.ACTIVE){let d=await c("chelonia/contract/currentKeyIdByName",e.contractID,"cek"),h=await c("chelonia/contract/currentKeyIdByName",r,"pek"),g=await c("chelonia/contract/currentKeyIdByName",e.contractID,"csk"),E=await c("chelonia/contract/currentKeyIdByName",r,"csk"),w=o[r]._vm.authorizedKeys[E].data;try{let I=await c("chelonia/contract/foreignKeysByContractID",e.contractID,r);await c("chelonia/out/atomic",{...Xe(e,["options","action","hooks","encryptionKeyId","signingKeyId"]),data:[h&&await c("gi.actions/out/shareVolatileKeys",{contractID:e.contractID,contractName:"gi.contracts/group",subjectContractID:r,keyIds:[h],returnInvocation:!0}),!I?.includes(E)&&["chelonia/out/keyAdd",{contractID:e.contractID,contractName:"gi.contracts/group",data:[ke(e.contractID,d,{foreignKey:`shelter:${encodeURIComponent(r)}?keyName=${encodeURIComponent("csk")}`,id:E,data:w,permissions:[v.OP_ACTION_ENCRYPTED+"#inner"],allowedActions:"*",purpose:["sig"],ringLevel:Number.MAX_SAFE_INTEGER,name:`${r}/${E}`})],signingKeyId:g}],await c("gi.actions/group/inviteAccept",{...Xe(e,["options","action","hooks","encryptionKeyId","signingKeyId"]),data:{reference:o[r].groups[e.contractID].hash},returnInvocation:!0})].filter(Boolean),signingKeyId:g,hooks:{prepublish:e.hooks?.prepublish,postpublish:null}})}catch(I){throw console.error(`[gi.actions/group/join] Error while accepting invite ${e.contractID}:`,I),I}}await c("chelonia/contract/wait",e.contractID),c("okTurtles.events/emit",Vi,{identityContractID:r,groupContractID:e.contractID})}else!a&&!f||(f?console.info("Requested to join group but already waiting for OP_KEY_SHARE. contractID="+e.contractID):console.error("Requested to join group but the state appears invalid. This should be unreachable. contractID="+e.contractID,{sendKeyRequest:u,hasSecretKeys:a,pendingKeyShares:f}))}catch(o){throw console.error("gi.actions/group/join failed!",o),o}finally{await c("chelonia/contract/release",n,{ephemeral:!0})}}).then(()=>{c("okTurtles.data/get",ei)?.delete(e.contractID)}).catch(t=>{let r=c("okTurtles.data/get",ei);r||(r=new Map,c("okTurtles.data/set",ei,r)),r.set(e.contractID,e);let n=()=>{Ca===void 0&&(Ca=setTimeout(()=>{Ca=void 0,r.size!==0&&c("gi.actions/group/reattemptFailedJoins").catch(o=>{console.error("Error running reattemptFailedJoins",o),n()})},6e4))};throw n(),t})},"gi.actions/group/joinWithInviteSecret":async function(e,t){let r=c("state/vuex/state").loggedIn.identityContractID;await c("chelonia/contract/wait",[e,r]);try{await c("chelonia/contract/retain",e,{ephemeral:!0}),await c("gi.actions/identity/joinGroup",{contractID:r,contractName:"gi.contracts/identity",data:{groupContractID:e,inviteSecret:t}})}finally{await c("chelonia/contract/release",e,{ephemeral:!0})}},"gi.actions/group/reattemptFailedJoins":async function(){let e=c("state/vuex/getters").ourGroups,t=c("okTurtles.data/get",ei);if(t)return await Promise.allSettled([...t.entries()].map(([r,n])=>{if(!e.includes(r)){t.delete(r);return}return c("gi.actions/group/join",n).catch(o=>{throw console.error("Error on group join re-attempt",n,o),o})})).then(r=>{if(r.some(n=>n.status==="rejected"))throw new Error("Error on group join re-attempt")})},"gi.actions/group/shareNewKeys":async(e,t)=>{let r=c("chelonia/rootState"),n=r[e],o=await c("chelonia/contract/currentKeyIdByName",n,"cek");return Promise.all(Object.entries(n.profiles).filter(([i,s])=>s.status===Ot.ACTIVE).map(async([i])=>{let s=await c("chelonia/contract/currentKeyIdByName",r[i],"cek");if(!s){console.warn(`Unable to share rotated keys for ${e} with ${i}: Missing CEK`);return}return["chelonia/out/keyShare",{data:ke(e,o,{contractID:e,foreignContractID:i,keys:Object.values(t).map(([,a,u])=>({id:u,meta:{private:{content:ke(i,s,se(a,!0))}}}))})}]})).then(i=>[i.filter(Boolean)])},...pe("gi.actions/group/addChatRoom",S("Failed to add chat channel"),async function(e,t){let r=c("chelonia/rootState"),n=r[t.contractID],o=r.loggedIn.identityContractID;for(let h in n.chatRooms)if(t.data.attributes.name.toUpperCase().normalize()===n.chatRooms[h].name.toUpperCase().normalize())throw new _t(S("Duplicate channel name"));let i=await c("chelonia/contract/currentKeyIdByName",n,"csk"),s={id:i,foreignKey:`shelter:${encodeURIComponent(t.contractID)}?keyName=${encodeURIComponent("csk")}`,data:n._vm.authorizedKeys[i].data},a=await c("chelonia/contract/currentKeyIdByName",n,"cek"),u={id:a,foreignKey:`shelter:${encodeURIComponent(t.contractID)}?keyName=${encodeURIComponent("cek")}`,data:n._vm.authorizedKeys[a].data},f=![hr.GROUP,hr.PUBLIC].includes(t.data.attributes.privacyLevel),d=await c("gi.actions/chatroom/create",{data:{...t.data,attributes:{adminIDs:[n.groupOwnerID],...t.data?.attributes}},options:{...t.options,...f?{groupKeys:[s,u]}:{csk:s,cek:u}},hooks:{prepublish:t.hooks?.prepublish,postpublish:null}},t.contractID);return f&&await c("gi.actions/out/shareVolatileKeys",{contractID:o,contractName:"gi.contracts/identity",subjectContractID:d.contractID(),keyIds:"*"}),await e({...Xe(t,["options","action","data","hooks"]),data:{...t.data,chatRoomID:d.contractID()},hooks:{prepublish:null,postpublish:t.hooks?.postpublish}}),d}),...pe("gi.actions/group/joinChatRoom",S("Failed to join chat channel."),async function(e,t){let r=c("chelonia/rootState"),{identityContractID:n}=r.loggedIn,o=t.data.memberID||n,i=t.data.chatRoomID,s=t.contractID;o!==n&&r[i].attributes.privacyLevel===hr.PRIVATE&&await c("gi.actions/out/shareVolatileKeys",{contractID:o,contractName:"gi.contracts/identity",subjectContractID:i,keyIds:"*"});let a=u=>{u===i&&r[i]?.members?.[n]&&(c("okTurtles.events/emit",co,{identityContractID:n,groupContractID:s,chatRoomID:i}),c("okTurtles.events/off",rr,a))};return c("okTurtles.events/on",rr,a),e({...Xe(t,["options","action"])})}),"gi.actions/group/addAndJoinChatRoom":async function(e){await c("chelonia/contract/retain",e.contractID,{ephemeral:!0});try{let r=(await c("gi.actions/group/addChatRoom",{...Xe(e,["options","hooks"]),hooks:{prepublish:e.hooks?.prepublish,postpublish:null}})).contractID();return await c("chelonia/contract/sync",e.contractID),await c("gi.actions/group/joinChatRoom",{...Xe(e,["options","data","hooks"]),data:{chatRoomID:r},hooks:{postpublish:e.hooks?.postpublish}}),r}finally{c("chelonia/contract/release",e.contractID,{ephemeral:!0}).catch(t=>console.error("[gi.actions/group/addAndJoinChatRoom] Error releasing group chatroom",t))}},...pe("gi.actions/group/renameChatRoom",S("Failed to rename chat channel."),async function(e,t){return await c("gi.actions/chatroom/rename",{...Xe(t,["options","contractID","data","hooks"]),contractID:t.data.chatRoomID,data:{name:t.data.name},hooks:{prepublish:t.hooks?.prepublish,postpublish:null}}),await e({...Xe(t,["options","action","hooks"]),hooks:{prepublish:null,postpublish:t.hooks?.postpublish}})}),"gi.actions/group/removeOurselves":e=>c("gi.actions/group/removeMember",{...Xe(e,["options","action"]),data:{}}),...pe("gi.actions/group/removeMember",(e,t)=>e.data.memberID?S("Failed to remove {memberID}: {reportError}",{memberID:e.data.memberID,...wr(t)}):S("Failed to leave group. {codeError}",{codeError:t.message}),async function(e,t,r){await e({...Xe(t,["options","action"])})}),...pe("gi.actions/group/changeChatRoomDescription",S("Failed to update description of chat channel."),async function(e,t){return await c("gi.actions/chatroom/changeDescription",{...Xe(t,["options","contractID","data","hooks"]),contractID:t.data.chatRoomID,data:{description:t.data.description},hooks:{prepublish:t.hooks?.prepublish,postpublish:null}}),e({...Xe(t,["options","action","hooks"]),hooks:{prepublish:null,postpublish:t.hooks?.postpublish}})}),"gi.actions/group/autobanUser":async function(e,t,r,n=1){try{if(n===1){setTimeout(()=>{c("gi.actions/group/autobanUser",e,t,r,n+1).catch(u=>{console.error("[gi.actions/group/autobanUser] Error from setTimeout callback (1st attempt)",u)})},Pn(0,5e3));return}let o=r&&r.innerSigningContractID,i=e.contractID(),s=c("chelonia/rootState"),a=s[i];if(o&&s.contracts[i]?.type==="gi.contracts/group"&&a?.profiles?.[o]?.status===Ot.ACTIVE){let f=c("state/vuex/getters").usernameFromID(o);console.warn(`autoBanSenderOfMessage: autobanning ${o} (username ${f}) from ${i}`);let[d,h]=Object.entries(a.proposals).find(([g,E])=>E.status===So&&E.data.proposalType===St&&E.data.proposalData.memberID===o)??["",void 0];if(h)h.votes[s.loggedIn.identityContractID]||await c("gi.actions/group/proposalVote",{contractID:i,data:{proposalHash:d,vote:kt,passPayload:{secret:""}},publishOptions:{maxAttempts:3}});else try{h=await c("gi.actions/group/proposal",{contractID:i,data:{proposalType:St,proposalData:{memberID:o,reason:S("Automated ban because they're sending malformed messages resulting in: {error}",{error:t.message}),automated:!0},votingRule:a.settings.proposals[St].rule,expires_date_ms:Date.now()+a.settings.proposals[St].expires_ms},publishOptions:{maxAttempts:1}})}catch(g){if(n>3)console.error(`autoBanSenderOfMessage: max attempts reached. Error ${g.message} attempting to ban ${o}`,e,g);else{let E=Pn(0,1500);console.warn(`autoBanSenderOfMessage: ${g.message} attempting to ban ${o}, retrying in ${E} ms...`,g),setTimeout(()=>{c("gi.actions/group/autobanUser",e,t,r,n+1).catch(w=>{console.error("[gi.actions/group/autobanUser] Error from setTimeout callback (> 3rd attempt)",w)})},E)}}}}catch(o){console.error(`${o.name} during autoBanSenderOfMessage!`,e,o)}},"gi.actions/group/notifyProposalStateInGeneralChatRoom":async function({groupID:e,proposal:t}){let{generalChatRoomId:r}=await c("chelonia/contract/state",e);return c("gi.actions/chatroom/addMessage",{contractID:r,data:{type:Rr.INTERACTIVE,proposal:t}})},...pe("gi.actions/group/notifyExpiringProposals",S("Failed to notify expiring proposals."),async function(e,t){let{proposals:r}=t.data;await e({...Xe(t,["options","data","action","hooks"]),data:{proposalIds:r.map(n=>n.proposalId)},hooks:{prepublish:t.hooks?.prepublish,postpublish:null}});for(let n=0;n<r.length;n++)await c("gi.actions/group/notifyProposalStateInGeneralChatRoom",{groupID:t.contractID,proposal:{...r[n],status:rc}})}),...pe("gi.actions/group/leaveChatRoom",S("Failed to leave chat channel."),async(e,t)=>{let r=await c("chelonia/contract/state",t.contractID),n=t.data.memberID||c("state/vuex/state").loggedIn.identityContractID,o=r.chatRooms[t.data.chatRoomID].members[n].joinedHeight;await e({...t,data:{...t.data,joinedHeight:o}})}),...pe("gi.actions/group/deleteChatRoom",S("Failed to delete chat channel.")),...pe("gi.actions/group/invite",S("Failed to create invite.")),...pe("gi.actions/group/inviteAccept",S("Failed to accept invite."),async function(e,t){let r=await e(t);return c("okTurtles.events/emit",Yi,{contractID:t.contractID}),r}),...pe("gi.actions/group/inviteRevoke",S("Failed to revoke invite."),async function(e,t,r){return await c("chelonia/out/keyDel",{contractID:t.contractID,contractName:"gi.contracts/group",data:[t.data.inviteKeyId],signingKeyId:r}),e(t)}),...pe("gi.actions/group/payment",S("Failed to create payment.")),...pe("gi.actions/group/paymentUpdate",S("Failed to update payment.")),...pe("gi.actions/group/sendPaymentThankYou",S("Failed to send a payment thank you note.")),...pe("gi.actions/group/groupProfileUpdate",S("Failed to update group profile.")),...pe("gi.actions/group/proposal",S("Failed to create proposal."),(e,t)=>{let{contractID:r}=t;return e({...t,hooks:{onprocessed:async n=>{try{let o=n.hash(),s=(await c("chelonia/contract/state",r)).proposals[o],a=En(s,{proposalId:o,status:So});await c("gi.actions/group/notifyProposalStateInGeneralChatRoom",{groupID:r,proposal:a})}catch(o){throw console.error(`[gi.actions/group/proposal] Error while notifying proposal creation in general chatroom ${r}:`,o),o}}}})}),...pe("gi.actions/group/proposalVote",S("Failed to vote on proposal."),async(e,t)=>{let{contractID:r,data:n}=t,o=await c("chelonia/contract/state",r),i=n.proposalHash,s=o.proposals[i],a=s.data.proposalType,u=kl(o,i),f=Pl(o,i),d=n.vote===kt,h=!d,g=d?{}:void 0,E;u&&d?(a===pr&&(g=await xl({contractID:r,invitee:s.data.proposalData.memberName,creatorID:s.creatorID,expires:o.settings.inviteExpiryProposal})),E=En(s,{proposalId:i,status:Dr})):f&&h&&(E=En(s,{proposalId:i,status:Hn}));let w=await e({...t,data:{...n,passPayload:g}});return E&&await c("gi.actions/group/notifyProposalStateInGeneralChatRoom",{groupID:r,proposal:E}),w}),...pe("gi.actions/group/proposalCancel",S("Failed to cancel proposal."),async function(e,t){let{contractID:r,data:n}=t,i=(await c("chelonia/contract/state",r)).proposals[n.proposalHash],s=En(i,{proposalId:n.proposalHash,status:fi}),a=await e(t);return await c("gi.actions/group/notifyProposalStateInGeneralChatRoom",{groupID:r,proposal:s}),a}),...pe("gi.actions/group/markProposalsExpired",S("Failed to mark proposals expired."),async function(e,t){let{contractID:r,data:n}=t,o=await c("chelonia/contract/state",r);for(let s of n.proposalIds){let a=o.proposals[s],u=En(a,{proposalId:s,status:li});await c("gi.actions/group/notifyProposalStateInGeneralChatRoom",{groupID:r,proposal:u})}return await e(t)}),"gi.actions/group/_ondeleted":async(e,t)=>{let r=c("state/vuex/getters"),n=r.ourIdentityContractId,o=r.currentIdentityState;o.groups?.[e]&&!o.groups[e].hasLeft&&await c("gi.actions/identity/leaveGroup",{contractID:n,data:{groupContractID:e,reference:t.profiles?.[n]?.reference}}).catch(i=>{console.warn(`[handleDeletedContract] ${i.name} thrown by gi.actions/identity/leaveGroup ${n} for ${e}:`,i)})},...pe("gi.actions/group/updateSettings",S("Failed to update group settings.")),...pe("gi.actions/group/updateAllVotingRules",(e,t)=>S("Failed to update voting rules. {codeError}",{codeError:t.message})),...pe("gi.actions/group/updateDistributionDate",S("Failed to update group distribution date.")),...pe("gi.actions/group/updateGroupInviteExpiry",S("Failed to update group invite expiry.")),...""});c("okTurtles.events/on",Jr,()=>{c("state/vuex/state").loggedIn?.identityContractID&&c("gi.actions/group/kv/load").catch(e=>{console.error("Error from 'gi.actions/group/kv/load' after reestablished connection:",e)})});var Jp=c("sbp/selectors/register",{"gi.actions/group/kv/load":async()=>{console.info("loading data from group key-value store...");let e=await c("chelonia/rootState"),t=e.loggedIn?.identityContractID;if(!t)throw new Error("Unable to fetch group data without an active session");await Promise.all(Object.entries(e[t].groups||{}).map(([r,n])=>{if(!n.hasLeft)return c("chelonia/queueInvocation",r,["gi.actions/group/kv/loadLastLoggedIn",{contractID:r}])})),console.info("group key-value store data loaded!")},"gi.actions/group/kv/fetchLastLoggedIn":async({contractID:e})=>{let t=await c("chelonia/kv/get",e,ht.LAST_LOGGED_IN);return t?t.data:Object.create(null)},"gi.actions/group/kv/loadLastLoggedIn":({contractID:e})=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{let t=await c("gi.actions/group/kv/fetchLastLoggedIn",{contractID:e});c("okTurtles.events/emit",Bo,[e,t])}).catch(t=>{console.error("[gi.actions/group/kv/loadLastLoggedIn] Error loading last logged in",t)}),"gi.actions/group/kv/updateLastLoggedIn":({contractID:e,throttle:t})=>{let r=c("state/vuex/state").loggedIn?.identityContractID;if(!r)throw new Error("Unable to update lastLoggedIn without an active session");let n=c("chelonia/time");if(t){let s=c("state/vuex/state").lastLoggedIn?.[e]?.[r];if(s){let a=new Date(s).getTime();if(n-a<Hu)return}}let o=new Date(n).toISOString();return c("okTurtles.eventQueue/queueEvent",Tt,async()=>{let i=({etag:a,currentData:u={}}={})=>[{...u,[r]:o},a],s=i()[0];await c("chelonia/kv/set",e,ht.LAST_LOGGED_IN,s,{encryptionKeyId:await c("chelonia/contract/currentKeyIdByName",e,"cek"),signingKeyId:await c("chelonia/contract/currentKeyIdByName",e,"csk"),onconflict:i})})}});var Ul=[],ti={async ready(){await Promise.all(Ul.map(e=>e()))},createInstance({name:e,storeName:t}){let r=(()=>{let n;return()=>(n||(n=new Promise((o,i)=>{if(e.includes("-")||t.includes("-")){i(new Error("Unsupported characters in name: -"));return}let s=a=>{let u=self.indexedDB.open(e+"--"+t,a);u.onupgradeneeded=f=>{f.target.result.createObjectStore(t)},u.onsuccess=f=>{let d=f.target.result;if(!d.objectStoreNames.contains(t))return s(d.version+1);o(d)},u.onerror=f=>{i(f)},u.onblocked=f=>{i(new Error("DB is blocked"))}};s()})),n)})();return Ul.push(r),{async clear(){let s=(await r()).transaction([t],"readwrite").objectStore(t).clear();return new Promise((a,u)=>{s.onsuccess=()=>{a()},s.onerror=f=>{u(f)}})},async getItem(n){let a=(await r()).transaction([t],"readonly").objectStore(t).get(n);return new Promise((u,f)=>{a.onsuccess=d=>{u(d.target.result)},a.onerror=d=>{f(d)}})},async removeItem(n){let a=(await r()).transaction([t],"readwrite").objectStore(t).delete(n);return new Promise((u,f)=>{a.onsuccess=()=>{u()},a.onerror=d=>{f(d.target.error)}})},async setItem(n,o){let u=(await r()).transaction([t],"readwrite").objectStore(t).put(o,n);return new Promise((f,d)=>{u.onsuccess=()=>{f()},u.onerror=h=>{d(h.target.error)}})}}}},Xp=async e=>{let t=Qe(Wt),r=de(t),n=se(t,!0),o=se(t,!1),i=lo(),s=await e(r,i),a=zo(s,n,r);return{encryptionParams:{stateEncryptionKeyId:r,salt:i,encryptedStateEncryptionKey:a},stateEncryptionKeyP:o}},Gr=ti.createInstance({name:"Group Income",storeName:"Settings"}),ps=class extends Error{},Eo="@settings/currentUser",Tn="CHELONIA_STATE";c("sbp/selectors/register",{"gi.db/ready":function(){return ti.ready()},"gi.db/settings/save":function(e,t){return Gr.setItem("u"+e,t)},"gi.db/settings/load":function(e){return Gr.getItem("u"+e)},"gi.db/settings/delete":function(e){return Gr.removeItem("u"+e)},"gi.db/settings/saveEncrypted":async function(e,t,r){let{stateEncryptionKeyId:n,salt:o,encryptedStateEncryptionKey:i}=r,s=await Gr.getItem("k"+n);if(!s)throw new Error(`Unable to retrieve the key corresponding to key ID ${n}`);let a=zo(s,JSON.stringify(t),e);return Gr.setItem("e"+e,`${btoa(n)}.${btoa(o)}.${btoa(i)}.${btoa(a)}`).finally(()=>{c("gi.db/settings/delete",e).catch(u=>{console.error("[gi.db/settings/saveEncrypted] Error deleting unencrypted data for key",e,u)})})},"gi.db/settings/loadEncrypted":function(e,t){return Gr.getItem("e"+e).then(async r=>{if(!r||typeof r!="string")throw new ps(`Unable to retrive state for ${e||""}`);let[n,o,i,s]=r.split(".").map(h=>atob(h)),a=await t(n,o),u=Yo(a,i,n),f=de(u);if(f!==n)throw new Error(`Invalid state key ID: expected ${n} but got ${f}`);let d=JSON.parse(Yo(u,s,e||""));return await Gr.setItem("k"+n,u),{encryptionParams:{stateEncryptionKeyId:n,salt:o,encryptedStateEncryptionKey:i},value:d}}).catch(async r=>{if(!t)throw r;r instanceof ps||console.warn("Error while retrieving local state",r);let{encryptionParams:n,stateEncryptionKeyP:o}=await Xp(t);return await Gr.setItem("k"+n.stateEncryptionKeyId,o),{encryptionParams:n,value:null}})},"gi.db/settings/deleteStateEncryptionKey":function({stateEncryptionKeyId:e}){return Gr.removeItem("k"+e)},"gi.db/settings/deleteEncrypted":function(e){return Gr.removeItem("e"+e)}});var Ar=ti.createInstance({name:"Group Income",storeName:"Files Cache"}),Ll=100;c("sbp/selectors/register",{"gi.db/filesCache/save":async function(e,t){if(e.startsWith("__"))throw new Error("Invalid key");let r=await Ar.getItem("keys")??[];return c("okTurtles.eventQueue/queueEvent","gi.db/files",()=>Ar.setItem(e,t).then(async n=>{console.log("successfully saved:",e);let o=r.indexOf(e);if(o!==-1&&r.splice(o,1),r.push(e),r.length>Ll){let i=r.splice(0,r.length-Ll);await Promise.all(i.map(s=>Ar.removeItem(s)))}await Ar.setItem("keys",r)}).catch(n=>{console.error("error saving:",e,n)}))},"gi.db/filesCache/load":async function(e){if(e.startsWith("__"))throw new Error("Invalid key");let t=await Ar.getItem(e);return t&&c("okTurtles.eventQueue/queueEvent","gi.db/files",async()=>{let r=await Ar.getItem("keys")??[],n=r.indexOf(e);n!==-1&&(r.splice(n,1),r.push(e),await Ar.setItem("keys",r))}).catch(r=>{console.error("[gi.db/filesCache/load] Error updating keys")}),t},"gi.db/filesCache/delete":async function(e){if(e.startsWith("__"))throw new Error("Invalid key");await Ar.removeItem(e),c("okTurtles.eventQueue/queueEvent","gi.db/files",async()=>{let t=await Ar.getItem("keys")??[],r=t.indexOf(e);r!==-1&&(t.splice(r,1),await Ar.setItem("keys",t))}).catch(t=>{console.error("[gi.db/filesCache/delete] Error updating keys")})},"gi.db/filesCache/clear":async function(){await Ar.clear()}});var fs=ti.createInstance({name:"Group Income",storeName:"Archive"});c("sbp/selectors/register",{"gi.db/archive/save":function(e,t){return fs.setItem(e,t)},"gi.db/archive/load":function(e){return fs.getItem(e)},"gi.db/archive/delete":function(e){return fs.removeItem(e)},"gi.db/archive/clear":function(){return fs.clear()}});var ds=ti.createInstance({name:"Group Income",storeName:"Logs"});c("sbp/selectors/register",{"gi.db/logs/save":function(e,t){return ds.setItem(e,t)},"gi.db/logs/load":function(e){return ds.getItem(e)},"gi.db/logs/delete":function(e){return ds.removeItem(e)},"gi.db/logs/clear":function(){return ds.clear()}});function rn(e){return function(t){if(!t.ok){let r=`${t.status}: ${t.statusText}`;throw t.status===404||t.status===410?new Vr(r,{cause:t.status}):new ln(r)}return t[e]()}}var Bl=(e,t,r)=>{if(!r)return[];try{let n=JSON.parse(r),o=il(t,n,`meta.private.oldKeys;${e}`);return JSON.parse(o.valueOf())}catch(n){console.error("[decryptOldIekList] Error during decryption",n)}},Fl=async(e,t,r)=>{try{let n=await fetch(`${c("okTurtles.data/get","API_URL")}/file/${t}`).then(rn("json")),o=(()=>{let s=os(n),a=JSON.parse(s.get("head"));if(a.contractID!==e)throw new Error("Unexpected contract ID.");if(![v.OP_ATOMIC,v.OP_KEY_UPDATE].includes(a.op))throw new Error("Unsupported opcode: "+a.op);return(a.op===v.OP_KEY_UPDATE?[[v.OP_KEY_UPDATE,s.valueOf()]]:s.valueOf()).filter(([f])=>f===v.OP_KEY_UPDATE).flatMap(([,f])=>f).find(f=>f.name==="iek"&&f.meta?.private?.oldKeys)?.meta.private.oldKeys})();o||console.error("[processOldIekList] Error finding old IEKs, logging in will probably fail due to missing keys");let i=Bl(e,r,o);if(!i)console.error("[processOldIekList] Error decrypting old IEKs, logging in will probably fail due to missing keys");else{let s=i.map(a=>({key:He(a),transient:!0}));await c("chelonia/storeSecretKeys",new Ze(s))}}catch(n){console.error("[processOldIekList] Error fetching or processing old keys:",n)}},Qp=(e,t,r,n)=>{let o=Bl(e,r,n);if(!o)throw new Error("Error decrypting old IEK list");let i=new Set(o),s=se(r,!0);return i.add(s),nt(t,JSON.stringify(Array.from(i))).toString(`meta.private.oldKeys;${e}`)};c("okTurtles.events/on",rr,(e,t)=>{let r=c("state/vuex/state").loggedIn?.identityContractID;e!==r||![v.OP_ATOMIC,v.OP_KEY_UPDATE].includes(t.opType())||c("chelonia/contract/currentKeyIdByName",r,"csk",!0)||(console.warn("Likely password change for identity contract. Logging us out.",r),c("gi.actions/identity/logout").catch(o=>{console.error("Error while automatically logging out",o)}))});var Zp=c("sbp/selectors/register",{"gi.actions/identity/create":async function({IPK:e,IEK:t,publishOptions:r,username:n,email:o,picture:i,token:s}){let a=`${self.location.origin}/assets/images/user-avatar-default.png`;e=e.valueOf(),t=t.valueOf();let u=typeof e=="string"?He(e):e,f=typeof t=="string"?He(t):t,d="deletionToken"+lo(),h=Rt(d),g=Qe(lt),E=Qe(Wt),w=Qe(Wt),I=Qe(lt),C=de(u),G=de(f),A=de(g),R=de(E),O=de(w),F=de(I),P=se(u,!1),W=se(f,!1),ce=se(g,!1),Oe=se(E,!1),xe=se(w,!1),we=se(I,!1),he=nt(f,se(g,!0)),$e=nt(f,se(E,!0)),Pe=nt(E,se(w,!0)),et=nt(f,se(I,!0)),Xt=nt(f,d);await c("chelonia/storeSecretKeys",new Ze([u,f,E,g,w,I].map(Ve=>({key:Ve,transient:!0}))));let tt;try{await c("chelonia/out/registerContract",{contractName:"gi.contracts/identity",publishOptions:{...r,headers:{...r?.headers,"shelter-deletion-token-digest":h,"shelter-namespace-registration":n,"shelter-salt-registration-token":s.valueOf()}},signingKeyId:C,actionSigningKeyId:A,actionEncryptionKeyId:O,keys:[{id:C,name:"ipk",purpose:["sig"],ringLevel:0,permissions:"*",allowedActions:"*",meta:{private:{transient:!0}},data:P},{id:G,name:"iek",purpose:["enc"],ringLevel:0,permissions:["gi.contracts/identity/keymeta"],meta:{private:{transient:!0}},data:W},{id:A,name:"csk",purpose:["sig"],ringLevel:1,permissions:[v.OP_KEY_ADD,v.OP_KEY_DEL,v.OP_ACTION_UNENCRYPTED,v.OP_ACTION_ENCRYPTED,v.OP_ATOMIC,v.OP_CONTRACT_AUTH,v.OP_CONTRACT_DEAUTH,v.OP_KEY_SHARE,v.OP_KEY_UPDATE,v.OP_ACTION_ENCRYPTED+"#inner"],allowedActions:"*",meta:{private:{content:he}},data:ce},{id:R,name:"cek",purpose:["enc"],ringLevel:1,permissions:[v.OP_ACTION_ENCRYPTED,v.OP_KEY_ADD,v.OP_KEY_DEL,v.OP_KEY_REQUEST,v.OP_KEY_REQUEST_SEEN,v.OP_KEY_SHARE,v.OP_KEY_UPDATE],allowedActions:"*",meta:{private:{content:$e}},data:Oe},{id:O,name:"pek",purpose:["enc"],ringLevel:2,permissions:[v.OP_ACTION_ENCRYPTED],allowedActions:["gi.actions/identity/setAttributes"],meta:{private:{content:Pe}},data:xe},{id:F,name:"#sak",purpose:["sak"],ringLevel:0,permissions:[],allowedActions:[],meta:{private:{content:et}},data:we}],hooks:{postpublishContract:async Ve=>{await c("chelonia/contract/retain",Ve.contractID(),{ephemeral:!0});try{if(tt=Ve.contractID(),i)try{a=await ls(i,{billableContractID:tt})}catch(Or){throw console.error("actions/identity.js picture upload error:",Or),new _t(S("Failed to upload the profile picture. {codeError}",{codeError:Or.message}),{cause:Or})}}finally{await c("chelonia/contract/release",Ve.contractID(),{ephemeral:!0})}}},data:{attributes:{username:n,email:o,get picture(){return a},encryptedDeletionToken:Xt.serialize("encryptedDeletionToken")}}}),await c("chelonia/storeSecretKeys",new Ze([E,g,w,I].map(Ve=>({key:Ve})))),c("chelonia/clearTransientSecretKeys",[G,C])}catch(Ve){throw console.error("gi.actions/identity/create failed!",Ve),new _t(S("Failed to create user identity: {reportError}",wr(Ve)),{cause:Ve})}finally{await c("chelonia/clearTransientSecretKeys",[G,C])}return tt},"gi.actions/identity/login":function({identityContractID:e,encryptionParams:t,cheloniaState:r,state:n,transientSecretKeys:o,oldKeysAnchorCid:i}){return c("okTurtles.eventQueue/queueEvent","ACTIONS-LOGIN",async()=>{console.debug("[gi.actions/identity/login] Scheduled call starting",e),o=o.valueOf().map(s=>({key:He(s),transient:!0})),typeof WorkerGlobalScope=="function"&&await c("swLogs/startCapture",e),await c("chelonia/reset",{...r,loggedIn:{identityContractID:e}}),await c("chelonia/storeSecretKeys",new Ze(o)),i&&await Fl(e,i,o[0].key);try{r?.contracts[e]?.references?await c("chelonia/contract/sync",e):await c("chelonia/contract/retain",e)}catch(s){throw console.error("[gi.actions/identity] Error during login contract sync",s),new _t(S("Error during login contract sync"),{cause:s})}try{await c("gi.db/settings/save",Eo,e),c("okTurtles.events/emit",Gi,{identityContractID:e,encryptionParams:t,state:n});let s=as(r?.contracts);await cs(s);try{let a=c("chelonia/rootState"),u=Object.keys(a[e].groups);await c("chelonia/contract/wait",Array.from(new Set([...u,...Object.values(s).flat()]))),await Promise.allSettled(u.map(async f=>q(a.contracts,f)&&q(a[e].groups,f)&&a[f]?.profiles?.[e]?.status!==Ot.ACTIVE&&c("gi.actions/group/join",{originatingContractID:e,originatingContractName:"gi.contracts/identity",contractID:f,contractName:"gi.contracts/group",reference:a[e].groups[f].hash,signingKeyId:a[e].groups[f].inviteSecretId,innerSigningKeyId:await c("chelonia/contract/currentKeyIdByName",e,"csk"),encryptionKeyId:await c("chelonia/contract/currentKeyIdByName",e,"cek")}).catch(d=>{console.error(`Error during gi.actions/group/join for ${f} at login`,d);let h=S("Join group error during login: {msg}",{msg:d?.message||"unknown error"});throw new _t(h)}))),Object.entries(a[e].groups).filter(([,{hasLeft:f}])=>!f).forEach(([f])=>{a[f]?.profiles?.[e]?.status===Ot.ACTIVE&&c("gi.actions/group/kv/updateLastLoggedIn",{contractID:f,throttle:!1}).catch(d=>console.error("Error sending updateLastLoggedIn",d))})}catch(a){throw console.error("[gi.actions/identity/login] Error re-joining groups after login",a),a}return e}catch(s){c("chelonia/clearTransientSecretKeys",o.map(({key:u})=>de(u))),console.error("gi.actions/identity/login failed!",s);let a=S("Failed to log in: {reportError}",wr(s));throw await c("gi.actions/identity/_private/logout").catch(u=>{console.error("[gi.actions/identity/login] Error calling logout (after failure to login)",u)}),new _t(a,{cause:s})}})},"gi.actions/identity/_private/logout":async function(){let e;c("okTurtles.events/emit",ao);try{console.info("logging out, waiting for any events to finish..."),await c("okTurtles.eventQueue/queueEvent","encrypted-action",()=>{}),e=await c("chelonia/reset",async()=>{await c("okTurtles.eventQueue/queueEvent","encrypted-action",()=>{}),await c("okTurtles.eventQueue/queueEvent",Tt,()=>{});let t=await c("okTurtles.eventQueue/queueEvent",Tn,async()=>{let r=pt(c("chelonia/rootState"));return await c("gi.db/settings/delete",Tn),r});return await c("gi.db/settings/save",Eo,null),t}).then(t=>(console.info("successfully logged out"),t))}catch(t){console.error(`${t.name} during logout: ${t.message}`,t)}return c("gi.db/filesCache/clear").catch(t=>{console.error("Error clearing file cache",t)}),typeof WorkerGlobalScope=="function"&&c("swLogs/pauseCapture",{wipeOut:!0}).catch(t=>{console.error("Error clearing file cache",t)}),c("okTurtles.events/emit",bn),e},"gi.actions/identity/addJoinDirectMessageKey":async(e,t,r)=>{let n=await c("chelonia/contract/currentKeyIdByName",t,r),o=await c("chelonia/contract/currentKeyIdByName",e,"cek"),i=c("chelonia/contract/state",t);if(!(await c("chelonia/contract/foreignKeysByContractID",e,t))?.includes(n))return await c("chelonia/out/keyAdd",{contractID:e,contractName:"gi.contracts/identity",data:[ke(e,o,{foreignKey:`shelter:${encodeURIComponent(t)}?keyName=${encodeURIComponent(r)}`,id:n,data:i._vm.authorizedKeys[n].data,permissions:[v.OP_ACTION_ENCRYPTED+"#inner"],allowedActions:["gi.contracts/identity/joinDirectMessage#inner"],purpose:["sig"],ringLevel:Number.MAX_SAFE_INTEGER,name:`${t}/${n}`})],signingKeyId:c("chelonia/contract/suitableSigningKey",e,[v.OP_KEY_ADD],["sig"])})},"gi.actions/identity/shareNewPEK":async(e,t)=>{let r=c("chelonia/rootState"),n=r[e];if(await Promise.all(Object.keys(n.groups||{}).filter(o=>!n.groups[o].hasLeft&&!!r.contracts[o]).map(async o=>{let i=await c("chelonia/contract/currentKeyIdByName",o,"cek"),s=await c("chelonia/contract/currentKeyIdByName",o,"csk");if(!i||!s){console.warn(`Unable to share rotated keys for ${e} with ${o}: Missing CEK or CSK`);return}return c("chelonia/out/keyShare",{contractID:o,contractName:r.contracts[o].type,data:ke(o,i,{contractID:o,keys:Object.values(t).map(([,a,u])=>({id:u,meta:{private:{content:ke(o,i,se(a,!0))}}}))}),signingKeyId:s,hooks:{preSendCheck:(a,u)=>u?.profiles?.[e]?.status===Ot.ACTIVE}}).catch(a=>{if(a.name!=="ChelErrorSignatureKeyNotFound")throw a})})),!!t.pek)return[void 0,[await c("gi.actions/identity/setAttributes",{contractID:e,data:n.attributes,encryptionKey:t.pek[1],encryptionKeyId:t.pek[2],returnInvocation:!0})]]},...pe("gi.actions/identity/setAttributes",S("Failed to set profile attributes."),void 0,"pek"),...pe("gi.actions/identity/updateSettings",S("Failed to update profile settings.")),...pe("gi.actions/identity/createDirectMessage",S("Failed to create a new direct message channel."),async function(e,t){let r=c("state/vuex/getters"),n=t.data.memberIDs.filter(u=>u!==r.ourIdentityContractId).map(u=>r.ourContactProfilesById[u].contractID),o=t.data.currentGroupId,i=r.ourIdentityContractId,s=await c("gi.actions/chatroom/create",{data:{attributes:{name:"",description:"",privacyLevel:hr.PRIVATE,type:hi.DIRECT_MESSAGE}},hooks:{prepublish:t.hooks?.prepublish,postpublish:null}},i);await c("gi.actions/out/shareVolatileKeys",{contractID:i,contractName:"gi.contracts/identity",subjectContractID:s.contractID(),keyIds:"*"}),await c("gi.actions/chatroom/join",{...Xe(t,["options","contractID","data","hooks"]),contractID:s.contractID(),data:{memberID:[i,...n]}});let a=u=>{u===s.contractID()&&c("chelonia/contract/state",s.contractID())?.members?.[i]&&(c("okTurtles.events/emit",co,{identityContractID:i,groupContractID:o,chatRoomID:s.contractID()}),c("okTurtles.events/off",rr,a))};c("okTurtles.events/on",rr,a),await e({...Xe(t,["options","data","action","hooks"]),data:{contractID:s.contractID()},hooks:{onprocessed:t.hooks?.onprocessed}});for(let u=0;u<n.length;u++){let f=u<n.length-1?void 0:{prepublish:null,postpublish:t.hooks?.postpublish};await c("gi.actions/out/shareVolatileKeys",{contractID:n[u],contractName:"gi.contracts/identity",subjectContractID:s.contractID(),keyIds:"*"}),await c("gi.actions/identity/joinDirectMessage",{...Xe(t,["options","contractID","data","hooks"]),contractID:n[u],data:{contractID:s.contractID()},signingKeyId:await c("chelonia/contract/suitableSigningKey",n[u],[v.OP_ACTION_ENCRYPTED],["sig"],void 0,["gi.contracts/identity/joinDirectMessage"]),innerSigningContractID:o,hooks:f})}return s.contractID()}),...pe("gi.actions/identity/joinDirectMessage",S("Failed to join a direct message.")),...pe("gi.actions/identity/joinGroup",S("Failed to join a group.")),...pe("gi.actions/identity/leaveGroup",S("Failed to leave a group.")),...pe("gi.actions/identity/setDirectMessageVisibility",S("Failed to set direct message visibility.")),"gi.actions/identity/uploadFiles":async({attachments:e,billableContractID:t})=>{let{identityContractID:r}=c("state/vuex/state").loggedIn;try{let n=await Promise.all(e.map(async i=>{let{url:s,compressedBlob:a}=i,u=a||await Ml(s),f=await c("chelonia/fileUpload",u,{type:i.mimeType,cipher:"aes256gcm"},{billableContractID:t}),{delete:d,download:h}=f;return{attributes:Xe(i,["url","compressedBlob","needsImageCompression"]),downloadData:h,deleteData:{token:d}}})),o=n.map(({downloadData:i,deleteData:s})=>({manifestCid:i.manifestCid,token:s.token}));return await c("gi.actions/identity/saveFileDeleteToken",{contractID:r,data:{billableContractID:t,tokensByManifestCid:o}}),n.map(({attributes:i,downloadData:s})=>({...i,downloadData:s}))}catch(n){let o=S("Failed to upload files: {reportError}",wr(n));throw new _t(o)}},"gi.actions/identity/removeFiles":async({manifestCids:e,option:t})=>{let{identityContractID:r}=c("state/vuex/state").loggedIn,{shouldDeleteFile:n,shouldDeleteToken:o,throwIfMissingToken:i}=t,s,a,u=await c("chelonia/contract/state",r);if(n){let f=Object.fromEntries(e.map(d=>{if(!i&&o&&!u.fileDeleteTokens[d])return console.info("[gi.actions/identity/removeFiles] Skipping file as token is missing",d),[d,null];let h=o?{token:u.fileDeleteTokens[d].token}:{billableContractID:r};return[d,h]}));a=i?e:e.filter(d=>!!f[d]),s=await c("chelonia/fileDelete",a,f)}else a=e;if(o&&await c("gi.actions/identity/removeFileDeleteToken",{contractID:r,data:{manifestCids:s?a.filter((f,d)=>s[d].status==="fulfilled"):a}}),s?.some(f=>f.status==="rejected"))throw console.error("[gi.actions/identity/removeFiles] Some CIDs could not be deleted",s?.map((f,d)=>f.status==="rejected"&&a[d]).filter(Boolean)),new Error("Some CIDs could not be deleted")},"gi.actions/identity/logout":(...e)=>c("okTurtles.eventQueue/queueEvent","ACTIONS-LOGIN",["gi.actions/identity/_private/logout",...e]),"gi.actions/identity/changePassword":async({identityContractID:e,username:t,oldIPK:r,oldIEK:n,newIPK:o,newIEK:i,updateToken:s,hooks:a})=>{r=r.valueOf(),n=n.valueOf(),o=o.valueOf(),i=i.valueOf(),s=s.valueOf();let u=Qe(lt),f=Qe(Wt),d=Qe(lt),h=de(r),g=de(n),E=de(o),w=de(i),I=de(u),C=de(f),G=de(d),A=se(o,!1),R=se(i,!1),O=se(u,!1),F=se(f,!1),P=se(d,!1),W=nt(i,se(u,!0)),ce=nt(i,se(f,!0)),Oe=nt(i,se(d,!0)),xe=c("chelonia/contract/state",e);await c("chelonia/storeSecretKeys",new Ze([r,n,o,i,f,u,d].map(he=>({key:he,transient:!0}))));let we=Qp(e,i,n,xe._vm.authorizedKeys[g]?.meta?.private?.oldKeys);await c("chelonia/out/keyUpdate",{contractID:e,contractName:"gi.contracts/identity",data:[{id:E,name:"ipk",oldKeyId:h,meta:{private:{transient:!0}},data:A},{id:w,name:"iek",oldKeyId:g,meta:{private:{transient:!0,oldKeys:we}},data:R},{id:I,name:"csk",oldKeyId:ze(xe,"csk"),meta:{private:{content:W}},data:O},{id:C,name:"cek",oldKeyId:ze(xe,"cek"),meta:{private:{content:ce}},data:F},{id:G,name:"#sak",oldKeyId:ze(xe,"#sak"),meta:{private:{content:Oe}},data:P}],signingKeyId:h,publishOptions:{headers:{"shelter-salt-update-token":s}},hooks:a}),await c("chelonia/storeSecretKeys",new Ze([f,u,d].map(he=>({key:he})))),c("chelonia/clearTransientSecretKeys",[g,h,w,E])},"gi.actions/identity/delete":async({contractID:e,transientSecretKeys:t,oldKeysAnchorCid:r})=>{let n=c("chelonia/contract/state",e);if(!n?.attributes?.encryptedDeletionToken)throw new Error("Missing encrypted deletion token");let o=t.valueOf().map(f=>[de(f),He(f)]),i=n.attributes.encryptedDeletionToken;if(r){let f=o[0][1];await Fl(e,r,f)}let s=Br(e,n,i,NaN,Object.fromEntries(o),"encryptedDeletionToken"),{ourDirectMessages:a,ourGroups:u}=c("state/vuex/getters");await Promise.all([...Object.keys(a).map(f=>c("gi.actions/chatroom/leave",{contractID:f,data:{}}).catch(d=>{console.warn("Error while leaving DM before deleting identity contract",f,d)})),...u.map(f=>c("gi.actions/group/removeOurselves",{contractID:f}).catch(d=>{console.warn("Error while leaving group before deleting identity contract",f,d)}))]),await c("chelonia/out/deleteContract",e,{[e]:{token:new Ze(s.valueOf())}})},"gi.actions/identity/_ondeleted":async(e,t)=>{let r=c("state/vuex/getters").ourIdentityContractId;e===r&&await c("gi.actions/identity/logout")},...pe("gi.actions/identity/deleteDirectMessage",S("Failed to delete direct message.")),...pe("gi.actions/identity/saveFileDeleteToken",S("Failed to save delete tokens for the attachments.")),...pe("gi.actions/identity/removeFileDeleteToken",S("Failed to remove delete tokens for the attachments.")),...pe("gi.actions/identity/setGroupAttributes",S("Failed to set group attributes."))});var $l=(e={})=>({...e,read:!1});c("okTurtles.events/on",Jr,()=>{c("state/vuex/state").loggedIn?.identityContractID&&c("gi.actions/identity/kv/load").catch(e=>{console.error("Error from 'gi.actions/identity/kv/load' after reestablished connection:",e)})});var eh=c("sbp/selectors/register",{"gi.actions/identity/kv/load":async()=>{console.info("loading data from identity key-value store..."),await c("gi.actions/identity/kv/loadChatRoomUnreadMessages"),await c("gi.actions/identity/kv/loadPreferences"),await c("gi.actions/identity/kv/loadNotificationStatus"),console.info("identity key-value store data loaded!")},"gi.actions/identity/kv/fetchChatRoomUnreadMessages":async()=>{let e=c("state/vuex/state").loggedIn?.identityContractID;if(!e)throw new Error("Unable to fetch chatroom unreadMessages without an active session");return(await c("chelonia/kv/get",e,ht.UNREAD_MESSAGES))?.data||{}},"gi.actions/identity/kv/saveChatRoomUnreadMessages":({data:e,onconflict:t})=>{let r=c("state/vuex/state").loggedIn?.identityContractID;if(!r)throw new Error("Unable to update chatroom unreadMessages without an active session");return c("chelonia/kv/queuedSet",{contractID:r,key:ht.UNREAD_MESSAGES,data:e,onconflict:t})},"gi.actions/identity/kv/loadChatRoomUnreadMessages":()=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{let e=await c("gi.actions/identity/kv/fetchChatRoomUnreadMessages");c("okTurtles.events/emit",$o,e)}),"gi.actions/identity/kv/initChatRoomUnreadMessages":({contractID:e,messageHash:t,createdHeight:r})=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{let n=({currentData:i={},etag:s}={})=>i[e]?null:[{...i,[e]:{readUntil:{messageHash:t,createdHeight:r},unreadMessages:[]}},s],o=n()?.[0];await c("gi.actions/identity/kv/saveChatRoomUnreadMessages",{data:o,onconflict:n})}),"gi.actions/identity/kv/setChatRoomReadUntil":({contractID:e,messageHash:t,createdHeight:r,forceUpdate:n=!1})=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{await c("gi.actions/identity/kv/saveChatRoomUnreadMessages",{onconflict:({currentData:i={},etag:s}={})=>{if(n||i[e]?.readUntil.createdHeight<r){let{unreadMessages:a}=i[e];return[{...i,[e]:{readUntil:{messageHash:t,createdHeight:r},unreadMessages:a.filter(u=>u.createdHeight>r)}},s]}return null}})}),"gi.actions/identity/kv/markAsUnread":({contractID:e,messageHash:t,createdHeight:r,unreadMessages:n})=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{await c("gi.actions/identity/kv/saveChatRoomUnreadMessages",{onconflict:({currentData:i={},etag:s}={})=>{let a=i[e]?.readUntil;return a&&a.isManuallyMarked&&a?.messageHash===t?null:[{...i,[e]:{readUntil:{messageHash:t,createdHeight:r,isManuallyMarked:!0},unreadMessages:n}},s]}})}),"gi.actions/identity/kv/addChatRoomUnreadMessage":({contractID:e,messageHash:t,createdHeight:r})=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{await c("gi.actions/identity/kv/saveChatRoomUnreadMessages",{onconflict:({currentData:o={},etag:i}={})=>o[e]?.readUntil.createdHeight<r&&o[e].unreadMessages.findIndex(a=>a.messageHash===t)===-1?(o[e].unreadMessages.push({messageHash:t,createdHeight:r}),[o,i]):null})}),"gi.actions/identity/kv/removeChatRoomUnreadMessage":({contractID:e,messageHash:t})=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{await c("gi.actions/identity/kv/saveChatRoomUnreadMessages",{onconflict:({currentData:n={},etag:o}={})=>{let i=n[e]?.unreadMessages.findIndex(s=>s.messageHash===t);return Number.isInteger(i)&&i>=0?(n[e].unreadMessages.splice(i,1),[n,o]):null}})}),"gi.actions/identity/kv/deleteChatRoomUnreadMessages":({contractID:e})=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{await c("gi.actions/identity/kv/saveChatRoomUnreadMessages",{onconflict:({currentData:r={},etag:n}={})=>r[e]?(delete r[e],[r,n]):null})}),"gi.actions/identity/kv/fetchPreferences":async()=>{let e=c("state/vuex/state").loggedIn?.identityContractID;if(!e)throw new Error("Unable to fetch preferences without an active session");return(await c("chelonia/kv/get",e,ht.PREFERENCES))?.data||{}},"gi.actions/identity/kv/savePreferences":({data:e,onconflict:t})=>{let r=c("state/vuex/state").loggedIn?.identityContractID;if(!r)throw new Error("Unable to update preferences without an active session");return c("chelonia/kv/queuedSet",{contractID:r,key:ht.PREFERENCES,data:e,onconflict:t})},"gi.actions/identity/kv/loadPreferences":()=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{let e=await c("gi.actions/identity/kv/fetchPreferences");c("okTurtles.events/emit",Go,e)}),"gi.actions/identity/kv/updateDistributionBannerVisibility":({contractID:e,hidden:t})=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{let r=({etag:o,currentData:i={}}={})=>{let s={...i.hideDistributionBanner||{},[e]:t};return[{...i,hideDistributionBanner:s},o]},n=r()[0];await c("gi.actions/identity/kv/savePreferences",{data:n,onconflict:r})}),"gi.actions/identity/kv/fetchNotificationStatus":async()=>{let e=c("state/vuex/state").loggedIn?.identityContractID;if(!e)throw new Error("Unable to fetch notification status without an active session");return(await c("chelonia/kv/get",e,ht.NOTIFICATIONS))?.data||{}},"gi.actions/identity/kv/saveNotificationStatus":({data:e,onconflict:t})=>{let r=c("state/vuex/state").loggedIn?.identityContractID;if(!r)throw new Error("Unable to update notification status without an active session");let n=i=>Object.keys(i).reduce((s,a)=>(Ru(i[a])||(s[a]=i[a]),s),{}),o=async(...i)=>{let s=await t(...i);if(!s)return null;let[a,u]=s;return[n(a),u]};return c("chelonia/kv/queuedSet",{contractID:r,key:ht.NOTIFICATIONS,data:!!e&&n(e),onconflict:typeof t=="function"?o:null})},"gi.actions/identity/kv/loadNotificationStatus":()=>c("okTurtles.eventQueue/queueEvent",Tt,async()=>{let e=await c("gi.actions/identity/kv/fetchNotificationStatus");c("gi.notifications/setNotificationStatus",e)}),"gi.actions/identity/kv/addNotificationStatus":e=>{let{hash:t,timestamp:r}=e;return c("okTurtles.eventQueue/queueEvent",Tt,async()=>{let n=({currentData:i={},etag:s}={})=>i?.[t]?null:[{...i,[t]:$l({timestamp:r})},s],o=n()?.[0];await c("gi.actions/identity/kv/saveNotificationStatus",{data:o,onconflict:n})})},"gi.actions/identity/kv/markNotificationStatusRead":e=>(typeof e=="string"&&(e=[e]),c("okTurtles.eventQueue/queueEvent",Tt,async()=>{let t=c("chelonia/rootState").notifications.items;await c("gi.actions/identity/kv/saveNotificationStatus",{onconflict:({currentData:n={},etag:o}={})=>{let i=!1;for(let s of e){let a=t.find(d=>d.hash===s);n[s]||(n[s]=$l({timestamp:a.timestamp}));let u=n[s].read===!1,f=n[s].read!==a.read;(u||f)&&(n[s].read=!0,i=!0)}return i?[n,o]:null}})}))});c("sbp/selectors/register",{"gi.actions/out/shareVolatileKeys":async({contractID:e,contractName:t,subjectContractID:r,keyIds:n,returnInvocation:o})=>{if(e===r)return;let i=await c("chelonia/latestContractState",r);try{await c("chelonia/contract/retain",e,{ephemeral:!0});let s=await c("chelonia/latestContractState",e),a=ze(s,"cek"),u=gt(s,[v.OP_KEY_SHARE],["sig"]);if(!a||!s?._vm?.authorizedKeys?.[a])throw new Error("Missing CEK; unable to proceed sharing keys");let f=await c("chelonia/rootState").secretKeys,d=Array.isArray(n)?Po(f,n):n==="*"?Po(f,Object.entries(i._vm.authorizedKeys).filter(([,E])=>!!E.meta?.private?.content).map(([E])=>E)):null;if(!d)throw new TypeError("Invalid parameter: keyIds");let h={contractID:r,keys:Object.entries(d).map(([E,w])=>({id:E,meta:{private:{content:ke(e,a,w)}}}))},g=["chelonia/out/keyShare",{contractID:e,contractName:t,data:ke(e,a,h),signingKeyId:u}];if(o)return g;await c(...g)}finally{await c("chelonia/contract/release",e,{ephemeral:!0})}},"gi.actions/out/rotateKeys":async(e,t,r,n)=>{let o=c("chelonia/contract/state",e);if(!o)throw new Error(`[gi.actions/out/rotateKeys] Cannot rotate keys for ${e}: No state exists`);let i=Number.MAX_SAFE_INTEGER,s=Object.fromEntries(Object.entries(o._vm.authorizedKeys).filter(([h,g])=>!!g.meta?.private?.content&&g._notAfterHeight==null&&(Array.isArray(r)?r.includes(g.name):r==="*"?!0:o._volatile?.pendingKeyRevocations&&q(o._volatile.pendingKeyRevocations,h))).map(([h,g])=>{let E=el(g.data);return[g.name,[h,E,de(E),qo(g.meta.private.content)]]}));if(!Object.keys(s).length){console.debug("rotateKeys: No keys to rotate",{contractID:e});return}let a=Object.values(s).map(([h,g,E,w])=>{let I=o._vm.authorizedKeys[w].name,C=q(s,I),G=C?s[I][1]:o._vm.authorizedKeys[w].data;return o._vm.authorizedKeys[h].ringLevel<i&&(i=o._vm.authorizedKeys[h].ringLevel),{name:o._vm.authorizedKeys[h].name,id:E,oldKeyId:h,data:se(g,!1),meta:{private:{content:C?nt(G,se(g,!0)):ke(e,de(G),se(g,!0)),shareable:o._vm.authorizedKeys[h].meta.private.shareable}}}}),u=gt(o,[v.OP_ATOMIC,v.OP_KEY_SHARE,v.OP_KEY_UPDATE],["sig"],i);if(!u)throw new Error("No suitable signing key found");let f=n?await c(n,e,s):void 0,d=(h,g)=>a.filter(w=>g._vm.authorizedKeys[w.oldKeyId]._notAfterHeight==null).length!==0;Array.isArray(f)&&f.length>0?await c("chelonia/out/atomic",{contractID:e,contractName:t,data:[...f[0]??[],["chelonia/out/keyUpdate",{data:a}],...f[1]??[]],signingKeyId:u,hooks:{preSendCheck:d}}):await c("chelonia/out/keyUpdate",{contractID:e,contractName:t,data:a,signingKeyId:u,hooks:{preSendCheck:d}})}});var th={currentChatRoomId(e,t,r){return e.currentChatRoomIDs[r.currentGroupId]||null},currentChatRoomState(e,t,r){return r[t.currentChatRoomId]||{}},chatNotificationSettings(e){return Object.assign({publicDefault:{messageNotification:kr.DIRECT_MESSAGES,messageSound:kr.DIRECT_MESSAGES},privateDefault:{messageNotification:kr.ALL_MESSAGES,messageSound:kr.ALL_MESSAGES}},e.chatNotificationSettings||{})},ourUnreadMessages(e){return e.unreadMessages||{}},directMessagesByGroup(e,t,r){return n=>{let o={};if(!n)return o;for(let i of Object.keys(t.ourDirectMessages)){let s=r[i],a=t.ourDirectMessages[i],u=t.ourIdentityContractId;if(!s||!s.members?.[u])continue;let f=Object.keys(s.members),d=f.length===1&&f[0]===u,h=f.filter(E=>E!==u).sort((E,w)=>{let I=new Date(s.members[E].joinedDate).getTime(),C=new Date(s.members[w].joinedDate).getTime();return I-C}),g=h.some(E=>Object.keys(t.profilesByGroup(n)).includes(E));if(a.visible&&(d||g)){let E=d?u:h[h.length-1],w=s.messages?.length>0?new Date(s.messages[s.messages.length-1].datetime).getTime():0;o[i]={...a,members:f,partners:h.map(I=>({contractID:I,username:t.usernameFromID(I),displayName:t.userDisplayNameFromID(I)})),lastJoinedPartner:E,title:d?t.userDisplayNameFromID(u):h.map(I=>t.userDisplayNameFromID(I)).join(", "),lastMsgTimeStamp:w,picture:t.ourContactProfilesById[E]?.picture,isDMToMyself:d}}}return o}},ourGroupDirectMessages(e,t,r){return t.directMessagesByGroup(r.currentGroupId)},ourGroupDirectMessageFromUserIds(e,t,r){return n=>{typeof n=="string"&&(n=[n]);let o=n.length===1&&n[0]===r.loggedIn.identityContractID,i=t.ourGroupDirectMessages;return Object.keys(i).find(s=>{let a=i[s];if(o)return a.isDMToMyself;{let u=a.partners.map(f=>f.contractID);return u.length===n.length&&vu(u,n).length===n.length}})}},isGroupDirectMessage(e,t){return r=>!!t.ourGroupDirectMessages[r||t.currentChatRoomId]},isDirectMessage(e,t){return r=>!!t.ourDirectMessages[r||t.currentChatRoomId]},isGroupDirectMessageToMyself(e,t){return r=>{let n=t.ourGroupDirectMessages[r||t.currentChatRoomId];return!!n&&n?.isDMToMyself}},isJoinedChatRoom(e,t,r){return(n,o)=>!!r[n]?.members?.[o||t.ourIdentityContractId]},currentChatVm(e,t,r){return r?.[t.currentChatRoomId]?._vm||null},currentChatRoomScrollPosition(e,t){return e.chatRoomScrollPosition?.[t.currentChatRoomId]},currentChatRoomReadUntil(e,t){return t.ourUnreadMessages[t.currentChatRoomId]?.readUntil},chatRoomUnreadMessages(e,t){return r=>t.ourUnreadMessages[r]?.unreadMessages||[]},isChatRoomManuallyMarkedUnread(e,t){return r=>!!t.ourUnreadMessages[r||t.currentChatRoomId]?.readUntil?.isManuallyMarked},groupUnreadMessages(e,t,r){return n=>{let o=s=>Object.keys(t.directMessagesByGroup(n)).includes(s),i=s=>Object.keys(r[n]?.chatRooms||{}).includes(s);return Object.keys(t.ourUnreadMessages).filter(s=>o(s)||i(s)).map(s=>t.ourUnreadMessages[s].unreadMessages.length).reduce((s,a)=>s+a,0)}},groupIdFromChatRoomId(e,t,r){return n=>Object.keys(r.contracts).find(o=>r.contracts[o].type==="gi.contracts/group"&&Object.keys(r[o].chatRooms).includes(n))},chatRoomsInDetail(e,t,r){let n=Gt({},t.groupChatRooms),o=r.loggedIn.identityContractID;for(let i in n){let s=r[i];if(s&&s.attributes&&s.members[o])n[i]={...s.attributes,id:i,unreadMessagesCount:t.chatRoomUnreadMessages(i).length,joined:!0};else{let{name:a,privacyLevel:u}=n[i];n[i]={id:i,name:a,privacyLevel:u,joined:!1}}}return n},mentionableChatroomsInDetails(e,t){return Object.values(t.chatRoomsInDetail).filter(r=>[hr.GROUP,hr.PUBLIC].includes(r.privacyLevel)||r.privacyLevel===hr.PRIVATE&&r.joined)},getChatroomNameById(e,t){return r=>{let n=Object.values(t.chatRoomsInDetail).find(o=>o.id===r);return n?n.name:null}},chatRoomMembersInSort(e,t){return t.groupMembersSorted.map(r=>({contractID:r.contractID,username:r.username,displayName:r.displayName})).filter(r=>!!t.chatRoomMembers[r.contractID])||[]}},Gl=th;function rh(e){return typeof e=="string"?e.replace(/,/,"."):e.toString()}function nh(e){return!isNaN(e-parseFloat(e))}function oh(e,t){let r=e.split(".")[1];return!r||r.length<=t}function ih(e,t){let r=rh(e);return nh(r)&&oh(r,t)}function jl(e,t){return e.toFixed(t).replace(/\.0+$/,"")}function Da(e){return parseFloat(e.toFixed(8))}function Na(e){let{symbol:t,symbolWithCode:r,decimalsMax:n,formatCurrency:o}=e;return{symbol:t,symbolWithCode:r,decimalsMax:n,displayWithCurrency:i=>o(jl(i,n)),displayWithoutCurrency:i=>jl(i,n),validate:i=>ih(i,n)}}var sh={USD:Na({symbol:"$",symbolWithCode:"$ USD",decimalsMax:2,formatCurrency:e=>"$"+e}),EUR:Na({symbol:"\u20AC",symbolWithCode:"\u20AC EUR",decimalsMax:2,formatCurrency:e=>"\u20AC"+e}),BTC:Na({symbol:"\u0243",symbolWithCode:"\u0243 BTC",decimalsMax:8,formatCurrency:e=>e+"\u0243"})},Hl=sh;function Ra(e){let t=0,r=0,n=[],o=[];for(let a of e)a.haveNeed>0?(n.push(a),t+=a.haveNeed):a.haveNeed<0&&(o.push(a),r+=Math.abs(a.haveNeed));let i=Math.min(1,r/t),s=[];for(let a of n){let u=i*a.haveNeed;for(let f of o){let d=Math.abs(f.haveNeed)/r;s.push({amount:u*d,fromMemberID:a.memberID,toMemberID:f.memberID})}}return s}function ka(e){let t={},r={},n=[],o=[],i=[];for(let s of e)t[s.toMemberID]=(t[s.toMemberID]||0)+s.amount,r[s.fromMemberID]=(r[s.fromMemberID]||0)+s.amount;for(let s in r)n.push({memberID:s,amount:r[s]});for(let s in t)o.push({memberID:s,amount:t[s]});for(n.sort((s,a)=>a.amount-s.amount),o.sort((s,a)=>a.amount-s.amount);n.length>0&&o.length>0;){let s=n.pop(),a=o.pop(),u=s.amount-a.amount;u<0?(i.push({amount:s.amount,fromMemberID:s.memberID,toMemberID:a.memberID}),a.amount-=s.amount,o.push(a)):u>0?(i.push({amount:a.amount,fromMemberID:s.memberID,toMemberID:a.memberID}),s.amount-=a.amount,n.push(s)):i.push({amount:a.amount,fromMemberID:s.memberID,toMemberID:a.memberID})}return i}var ch=1/Math.pow(10,8);function Pa({haveNeeds:e=[],minimize:t=!0}){let r=Ra(e);return t?ka(r):r}function zl({distribution:e,payments:t,dueOn:r}){e=pt(e);for(let n of e)n.total=n.amount;e=fh(e,t).filter(n=>n.amount>=ch);for(let n of e)n.amount=Da(n.amount),n.total=Da(n.total),n.partial=n.total!==n.amount,n.isLate=!1,n.dueOn=r;return e}function uh(e){e=pt(e);for(let t=0;t<e.length;t++){let r=e[t];for(let n=t+1;n<e.length;n++){let o=e[n];(r.fromMemberID===o.fromMemberID&&r.toMemberID===o.toMemberID||r.toMemberID===o.fromMemberID&&r.fromMemberID===o.toMemberID)&&(r.amount+=(r.fromMemberID===o.fromMemberID?1:-1)*o.amount,r.total+=(r.fromMemberID===o.fromMemberID?1:-1)*o.total,e.splice(n,1),n--)}}return e}function lh(e,t){return uh([...e,...t])}function fh(e,t){t=pt(t);for(let r of t)r.amount*=-1,r.total*=-1;return lh(e,t)}var dh="pending",ph="cancelled",hh="error",Ka="not-received",Ma="completed",Pw=pn(...[dh,ph,hh,Ka,Ma].map(e=>dn(e))),gh="manual",yh="bitcoin",mh="paypal",Kw=pn(...[gh,yh,mh].map(e=>dn(e)));var Yl={chatRoomSettings(e,t){return t.currentChatRoomState.settings||{}},chatRoomAttributes(e,t){return t.currentChatRoomState.attributes||{}},chatRoomMembers(e,t){return t.currentChatRoomState.members||{}},chatRoomRecentMessages(e,t){return t.currentChatRoomState.messages||[]},chatRoomPinnedMessages(e,t){return(t.currentChatRoomState.pinnedMessages||[]).sort((r,n)=>r.height<n.height?1:-1)}};var Vl={currentGroupOwnerID(e,t){return t.currentGroupState.groupOwnerID},groupSettingsForGroup(e,t){return r=>r.settings||{}},groupSettings(e,t){return t.groupSettingsForGroup(t.currentGroupState)},profileActive(e,t){return r=>t.currentGroupState.profiles?.[r]?.status===Ot.ACTIVE},pendingAccept(e,t){return r=>t.currentGroupState.profiles?.[r]?.status===Ot.PENDING},groupProfileForGroup(e,t){return(r,n)=>{let o=r.profiles;return o&&o[n]&&{...o[n],get lastLoggedIn(){return t.currentGroupLastLoggedIn[n]||this.joinedDate}}}},groupProfile(e,t){return r=>t.groupProfileForGroup(t.currentGroupState,r)},groupProfilesForGroup(e,t){return r=>{let n={};for(let o in r.profiles||{}){let i=t.groupProfileForGroup(r,o);i.status===Ot.ACTIVE&&(n[o]=i)}return n}},groupProfiles(e,t){return t.groupProfilesForGroup(t.currentGroupState)},groupCreatedDate(e,t){return t.groupProfile(t.currentGroupOwnerID).joinedDate},groupMincomeAmountForGroup(e,t){return r=>t.groupSettingsForGroup(r).mincomeAmount},groupMincomeAmount(e,t){return t.groupMincomeAmountForGroup(t.currentGroupState)},groupMincomeCurrency(e,t){return t.groupSettings.mincomeCurrency},groupSortedPeriodKeysForGroup(e,t){return r=>{let{distributionDate:n,distributionPeriodLength:o}=t.groupSettingsForGroup(r);if(!n)return[];let i=Object.keys(t.groupPeriodPaymentsForGroup(r)).sort();return!i.length&&ec>0&&i.push(xr(Mr(n,-o))),i[i.length-1]!==n&&i.push(n),i}},groupSortedPeriodKeys(e,t){return t.groupSortedPeriodKeysForGroup(t.currentGroupState)},periodStampGivenDateForGroup(e,t){return(r,n,o)=>Si(n,{knownSortedStamps:o||t.groupSortedPeriodKeysForGroup(r),periodLength:t.groupSettingsForGroup(r).distributionPeriodLength}).current},periodStampGivenDate(e,t){return(r,n)=>t.periodStampGivenDateForGroup(t.currentGroupState,r,n)},periodBeforePeriodForGroup(e,t){return(r,n,o)=>Si(n,{knownSortedStamps:o||t.groupSortedPeriodKeysForGroup(r),periodLength:t.groupSettingsForGroup(r).distributionPeriodLength}).previous},periodBeforePeriod(e,t){return(r,n)=>t.periodBeforePeriodForGroup(t.currentGroupState,r,n)},periodAfterPeriodForGroup(e,t){return(r,n,o)=>Si(n,{knownSortedStamps:o||t.groupSortedPeriodKeysForGroup(r),periodLength:t.groupSettingsForGroup(r).distributionPeriodLength}).next},periodAfterPeriod(e,t){return(r,n)=>t.periodAfterPeriodForGroup(t.currentGroupState,r,n)},dueDateForPeriodForGroup(e,t){return(r,n,o)=>t.periodAfterPeriodForGroup(r,n,o)},dueDateForPeriod(e,t){return(r,n)=>t.dueDateForPeriodForGroup(t.currentGroupState,r,n)},paymentHashesForPeriodForGroup(e,t){return(r,n)=>{let o=t.groupPeriodPaymentsForGroup(r)[n];if(o)return Il(o)}},paymentHashesForPeriod(e,t){return r=>t.paymentHashesForPeriodForGroup(t.currentGroupState,r)},groupMembersByContractID(e,t){return Object.keys(t.groupProfiles)},groupMembersCount(e,t){return t.groupMembersByContractID.length},groupMembersPending(e,t){let r=t.currentGroupState.invites,n=t.currentGroupState._vm.invites,o=Object.create(null);for(let i in r)n[i].status===en.VALID&&r[i].creatorID!==jn&&(o[i]={displayName:r[i].invitee,invitedBy:r[i].creatorID,expires:n[i].expires});return o},groupShouldPropose(e,t){return t.groupMembersCount>=3},groupDistributionStarted(e,t){return r=>r>=t.groupSettings?.distributionDate},groupProposalSettings(e,t){return(r=Yt)=>t.groupSettings.proposals?.[r]},groupCurrency(e,t){let r=t.groupMincomeCurrency;return r&&Hl[r]},groupMincomeFormatted(e,t){return t.withGroupCurrency?.(t.groupMincomeAmount)},groupMincomeSymbolWithCode(e,t){return t.groupCurrency?.symbolWithCode},groupPeriodPaymentsForGroup(e,t){return r=>r.paymentsByPeriod||{}},groupPeriodPayments(e,t){return t.groupPeriodPaymentsForGroup(t.currentGroupState)},groupThankYousFrom(e,t){return t.currentGroupState.thankYousFrom||{}},groupStreaks(e,t){return t.currentGroupState.streaks||{}},groupTotalPledgeAmount(e,t){return t.currentGroupState.totalPledgeAmount||0},withGroupCurrency(e,t){return t.groupCurrency?.displayWithCurrency},groupChatRooms(e,t){return t.currentGroupState.chatRooms},groupGeneralChatRoomId(e,t){return t.currentGroupState.generalChatRoomId},haveNeedsForThisPeriodForGroup(e,t){return(r,n)=>{let o=t.groupProfilesForGroup(r),i=[];for(let s in o){let{incomeDetailsType:a,joinedDate:u}=o[s];if(a){let f=o[s][a],d=a==="incomeAmount"?f-t.groupMincomeAmountForGroup(r):f,h=Vn(n).toISOString();yc({date:u,periodStart:n,periodLength:t.groupSettingsForGroup(r).distributionPeriodLength})&&(h=u),i.push({memberID:s,haveNeed:d,when:h})}}return i}},haveNeedsForThisPeriod(e,t){return r=>t.haveNeedsForThisPeriodForGroup(t.currentGroupState,r)},paymentsForPeriodForGroup(e,t){return(r,n)=>{let o=t.paymentHashesForPeriodForGroup(r,n),i=[];if(o&&o.length>0){let s=r.payments;for(let a of o){let u=s[a];u.data.status===Ma&&i.push(Sl(a,u))}}return i}},paymentsForPeriod(e,t){return r=>t.paymentsForPeriodForGroup(t.currentGroupState,r)}};var ql={loginState(e,t){return t.currentIdentityState.loginState},ourDirectMessages(e,t){return t.currentIdentityState.chatRooms||{}}};var Wl=(e,t,r)=>{if(t&&e.namespaceLookups?.[t]===r)return t},Eh=(e,t)=>Object.keys(e).find(r=>e[r].creatorID===jn&&t.currentGroupState._vm.invites[r].status===en.VALID&&!(t.currentGroupState._vm.invites[r].expires<Date.now())&&!(t.currentGroupState._vm.invites[r].quantity<=0)),bh={currentGroupState(e){return e[e.currentGroupId]||{}},currentIdentityState(e){return e.loggedIn&&e[e.loggedIn.identityContractID]||{}},ourUsername(e,t){return e.loggedIn&&t.usernameFromID(e.loggedIn.identityContractID)},ourPreferences(e){return e.preferences},ourProfileActive(e,t){return t.profileActive(t.ourIdentityContractId)},ourPendingAccept(e,t){return t.pendingAccept(t.ourIdentityContractId)},ourGroupProfileForGroup(e,t){return r=>t.groupProfileForGroup(r,t.ourIdentityContractId)},ourGroupProfile(e,t){return t.ourGroupProfileForGroup(t.currentGroupState)},ourUserDisplayName(e,t){return(t.currentIdentityState||{}).attributes?.displayName||t.ourUsername||t.ourIdentityContractId},ourIdentityContractId(e){return e.loggedIn&&e.loggedIn.identityContractID},ourGroups(e,t){let r=t.ourIdentityContractId;return r?Object.keys(e[r]?.groups||{}).filter(n=>!e[r].groups[n].hasLeft&&e[n]):[]},currentGroupLastLoggedIn(e){return e.lastLoggedIn[e.currentGroupId]||{}},ourContributionSummary(e,t){let r=t.groupProfiles,n=t.ourIdentityContractId,o=t.ourGroupProfile;if(!o||!o.incomeDetailsType)return{};let i=o.incomeDetailsType==="incomeAmount",s=t.groupIncomeDistribution,a=u=>r[u].nonMonetaryContributions||[];return{givingMonetary:(()=>{if(i)return null;let u=[],f=[],d=s.filter(h=>h.fromMemberID===n).reduce((h,g)=>(u.push(t.userDisplayNameFromID(g.toMemberID)),f.push(g.toMemberID),h+g.amount),0);return{who:u,whoIds:f,total:d,pledged:o.pledgeAmount}})(),receivingMonetary:(()=>{if(!i)return null;let u=t.groupSettings.mincomeAmount-o.incomeAmount,f=[],d=[],h=s.filter(g=>g.toMemberID===n).reduce((g,E)=>(f.push(t.userDisplayNameFromID(E.fromMemberID)),d.push(E.fromMemberID),g+E.amount),0);return{who:f,whoIds:d,total:h,needed:u}})(),receivingNonMonetary:(()=>{let u=Object.keys(r).filter(d=>d!==n&&a(d).length>0),f=u.reduce((d,h)=>{let g=t.userDisplayNameFromID(h);return a(h).forEach(w=>{let I=d.findIndex(C=>C.what===w);I>=0?(d[I].who.push(g),d[I].whoIds.push(h)):d.push({who:[g],whoIds:[h],what:w})}),d},[]);return u.length>0?{what:f,who:u}:null})(),givingNonMonetary:(()=>{let u=o.nonMonetaryContributions;return u.length>0?u:null})()}},usernameFromID(e,t){return r=>t.ourContactProfilesById[r]?.username||e.reverseNamespaceLookups[r]||r},userDisplayNameFromID(e,t){return r=>{if(r===t.ourIdentityContractId)return t.ourUserDisplayName;let n=t.ourContactProfilesById[r];return n?.displayName||n?.username||e.reverseNamespaceLookups[r]||r}},thisPeriodPaymentInfoForGroup(e,t){return r=>t.groupPeriodPaymentsForGroup(r)[t.currentPaymentPeriodForGroup(r)]},thisPeriodPaymentInfo(e,t){return t.thisPeriodPaymentInfoForGroup(t.currentGroupState)},latePayments(e,t){let r=t.groupPeriodPayments;if(Object.keys(r).length===0)return;let n=t.ourIdentityContractId,o=t.periodBeforePeriod(t.currentPaymentPeriod),i=r[o];if(i)return i.lastAdjustedDistribution.filter(s=>s.fromMemberID===n)},groupIncomeDistribution(e,t){return Pa({haveNeeds:t.haveNeedsForThisPeriod(t.currentPaymentPeriod),minimize:!1})},groupIncomeAdjustedDistributionForGroup(e,t){return r=>{let n=t.thisPeriodPaymentInfoForGroup(r);if(n&&n.lastAdjustedDistribution)return n.lastAdjustedDistribution;{let o=t.currentPaymentPeriodForGroup(r);return zl({distribution:Pa({haveNeeds:t.haveNeedsForThisPeriodForGroup(r,o),minimize:t.groupSettingsForGroup(r).minimizeDistribution}),payments:t.paymentsForPeriodForGroup(r,o),dueOn:t.dueDateForPeriodForGroup(r,o)})}}},groupIncomeAdjustedDistribution(e,t){return t.groupIncomeAdjustedDistributionForGroup(t.currentGroupState)},ourPaymentsSentInPeriodForGroup(e,t){return(r,n)=>{let o=t.groupPeriodPaymentsForGroup(r);if(Object.keys(o).length===0)return;let i=[],s=o[n],a=s&&s.paymentsFrom;if(a){let u=t.ourIdentityContractId,f=r.payments;for(let d in a[u])for(let h of a[u][d]){let{data:g,meta:E,height:w}=f[h];i.push({hash:h,height:w,data:g,meta:E,amount:g.amount,period:n})}}return i.sort((u,f)=>f.height-u.height)}},ourPaymentsSentInPeriod(e,t){return r=>t.ourPaymentsSentInPeriodForGroup(t.currentGroupState,r)},ourPaymentsReceivedInPeriodForGroup(e,t){return(r,n)=>{let o=t.groupPeriodPaymentsForGroup(r);if(Object.keys(o).length===0)return;let i=[],s=o[n],a=s&&s.paymentsFrom;if(a){let u=t.ourIdentityContractId,f=r.payments;for(let d in a)for(let h in a[d])if(h===u)for(let g of a[d][h]){let{data:E,meta:w,height:I}=f[g];i.push({hash:g,height:I,data:E,meta:w,amount:E.amount})}}return i.sort((u,f)=>f.height-u.height)}},ourPaymentsReceivedInPeriod(e,t){return r=>t.ourPaymentsReceivedInPeriodForGroup(t.currentGroupState,r)},ourPaymentsForGroup(e,t){return r=>{let n=t.groupPeriodPaymentsForGroup(r);if(Object.keys(n).length===0)return;let o=t.ourIdentityContractId,i=t.currentPaymentPeriodForGroup(r),s=t.periodBeforePeriodForGroup(r,i),a=t.ourPaymentsSentInPeriodForGroup(r,i),u=t.ourPaymentsSentInPeriodForGroup(r,s),f=t.ourPaymentsReceivedInPeriodForGroup(r,i),d=t.ourPaymentsReceivedInPeriodForGroup(r,s),h=()=>t.groupIncomeAdjustedDistributionForGroup(r).filter(g=>g.fromMemberID===o);return{sent:[...a,...u],received:[...f,...d],todo:h()}}},ourPayments(e,t){return t.ourPaymentsForGroup(t.currentGroupState)},ourPaymentsSummary(e,t){let r=t.ourGroupProfile.incomeDetailsType==="incomeAmount",n=t.ourIdentityContractId,o=A=>r?A.toMemberID===n:A.fromMemberID===n,i=(A,R)=>A+R.amount,s=t.currentPaymentPeriod,a=t.groupIncomeAdjustedDistribution.filter(o),u=r?t.ourPaymentsReceivedInPeriod(s):t.ourPaymentsSentInPeriod(s),f=u.filter(A=>A.data.status===Ka),d=f.reduce(i,0),h=a.length+u.length,g=a.filter(A=>!A.isLate),E=h-g.length-f.length,w=a.some(A=>A.partial),I=u.reduce(i,0)-d,C=a.reduce((A,R)=>A+R.amount,0)+d,G=I+C;return{paymentsDone:E,hasPartials:w,paymentsTotal:h,amountDone:I,amountTotal:G}},currentWelcomeInvite(e,t){let r=t.currentGroupState.invites,n=Eh(r,t),o=t.currentGroupState._vm.invites[n].expires;return{inviteId:n,expires:o}},groupsByName(e,t){let r=t.ourIdentityContractId,n=e[r]?.groups;return n?Object.entries(n).filter(([,{hasLeft:o}])=>!o).map(([o])=>({groupName:e[o]?.settings?.groupName||S("Pending"),contractID:o,active:e[o]?.profiles?.[r]?.status===Ot.ACTIVE})):[]},profilesByGroup(e,t){return r=>{let n={};if(e.contracts[r]?.type!=="gi.contracts/group")return n;let o=e[r].profiles||{};for(let i in o){let s=o[i];s.status===Ot.ACTIVE&&(n[i]=s)}return n}},groupMembersSorted(e,t){let r=t.currentGroupState.profiles;if(!r||!r[t.ourIdentityContractId])return[];let n=r[t.ourIdentityContractId].joinedHeight,o=s=>{if(s===t.ourIdentityContractId)return!1;let a=r[s];if(!a)return!1;let u=a.joinedHeight,f=new Date(a.joinedDate).getTime();return n<u&&Date.now()-f<6048e5},i=t.groupMembersPending;return[i,t.groupProfiles].flatMap(Object.keys).filter(s=>t.groupProfiles[s]||!(t.groupMembersPending[s].expires<Date.now())).map(s=>{let{contractID:a,displayName:u,username:f}=t.globalProfile(s)||i[s]||(t.groupProfiles[s]?{contractID:s}:{});return{id:s,contractID:a,username:f,displayName:u||f||s,invitedBy:t.groupMembersPending[s],isNew:o(s)}}).sort((s,a)=>{let u=s.displayName.normalize().toUpperCase(),f=a.displayName.normalize().toUpperCase();return s.invitedBy&&!a.invitedBy?-1:!s.invitedBy&&a.invitedBy?1:s.isNew&&!a.isNew?-1:!s.isNew&&a.isNew?1:u<f?-1:1})},groupProposals(e,t){return r=>e[r]?.proposals},globalProfile(e,t){return r=>t.ourContactProfilesById[r]},ourContactProfilesByUsername(e,t){let r={};return Object.keys(e.contracts).filter(n=>e.contracts[n]?.type==="gi.contracts/identity").forEach(n=>{let o=e[n].attributes;if(o){let i=Wl(e,o.username,n);if(!i)return;r[i]={...o,username:i,contractID:n}}}),r},ourContactProfilesById(e,t){let r={};return Object.keys(e.contracts).filter(n=>e.contracts[n]?.type==="gi.contracts/identity").forEach(n=>{let o=e[n]?.attributes;if(o){let i=Wl(e,o.username,n);r[n]={...o,username:i,contractID:n}}else r[n]={contractID:n}}),Object.keys(e.reverseNamespaceLookups).forEach(n=>{r[n]||e.contracts[n]===null||(r[n]={username:e.reverseNamespaceLookups[n],contractID:n})}),r},currentGroupContactProfilesById(e,t){let r=Object.keys(t.currentGroupState.profiles||{}),n={};for(let o in t.ourContactProfilesById)r.includes(o)&&(n[o]=t.ourContactProfilesById[o]);return n},ourContactsById(e,t){return Object.keys(t.ourContactProfilesById).sort((r,n)=>{let o=t.ourContactProfilesById[r].displayName||t.ourContactProfilesById[r].username||r,i=t.ourContactProfilesById[n].displayName||t.ourContactProfilesById[n].username||n;return o.normalize().toUpperCase()>i.normalize().toUpperCase()?1:-1})},ourContactsByUsername(e,t){return Object.keys(t.ourContactProfilesByUsername).sort((r,n)=>{let o=t.ourContactProfilesByUsername[r].displayName||r,i=t.ourContactProfilesByUsername[n].displayName||n;return o.normalize().toUpperCase()>i.normalize().toUpperCase()?1:-1})},seenWelcomeScreen(e,t){return t.currentIdentityState?.groups?.[e.currentGroupId]?.hasLeft||t.ourProfileActive&&t.currentIdentityState?.groups?.[e.currentGroupId]?.seenWelcomeScreen},...Yl,...Vl,...ql},Jl=bh;var wh={notifications(e,t,r){return e.items.map(n=>{let o={...n,...e.status[n.hash]};return Ko(o)>Oi?null:(!o.read&&Ko(o)>Ai&&(o.read=!0),o)}).filter(Boolean)},currentGroupNotifications(e,t,r){return t.notifications.filter(n=>n.groupID===r.currentGroupId)},notificationsByGroup(e,t){return r=>t.notifications.filter(n=>n.groupID===r)},currentGroupUnreadNotificationCount(e,t){return t.currentGroupUnreadNotifications.length},currentGroupUnreadNotifications(e,t,r){return t.currentGroupNotifications.filter(n=>!n.read)},currentNewNotifications(e,t){return t.currentNotifications.filter(la)},currentNotificationCount(e,t){return t.currentNotifications.length},currentNotifications(e,t,r){return t.notifications.filter(n=>!n.groupID||n.groupID===r.currentGroupId)},currentOlderNotifications(e,t){return t.currentNotifications.filter(ku)},currentUnreadNotificationCount(e,t){return t.currentNotifications.filter(r=>!r.read).length},currentUnreadNotifications(e,t){return t.currentNotifications.filter(r=>!r.read)},totalUnreadNotificationCount(e,t){return t.notifications.filter(r=>!r.read).length},unreadGroupNotificationCountFor(e,t){return r=>t.unreadGroupNotificationsFor(r).length},unreadGroupNotificationsFor(e,t,r){return n=>n===r.currentGroupId?t.currentGroupUnreadNotifications:t.notifications.filter(o=>!o.read&&o.groupID===n)}},Xl=wh;var Ql={CHELONIA_ERROR(e){let{activity:t,error:r,message:n,msgMeta:o}=e,i=n.contractID(),s=n.opType(),a=n.decryptedValue(),u;a&&([v.OP_ACTION_ENCRYPTED,v.OP_ACTION_UNENCRYPTED].includes(s)?u=a.action:o&&s===v.OP_ATOMIC&&Number.isFinite(o.index)&&[v.OP_ACTION_ENCRYPTED,v.OP_ACTION_UNENCRYPTED].includes(a[o.index][0])&&(u=a[o.index][1].action));let f=c("state/vuex/state"),d,h;if(n.innerSigningKeyId()){let I=gl(f[n.contractID()],n.innerSigningKeyId());I&&(d=`${Ct}${I}`,h=c("state/vuex/getters").userDisplayNameFromID(I))}let g={errName:r.name,activity:t,action:u??s,contract:f.contracts[i]?.type??i,errMsg:r.message},E={...g,...Vt("b"),who:d},w={...g,who:h};return{title:S("Internal error"),body:d?S("{errName} during {activity} for '{action}' from {b_}{who}{_b} to '{contract}': '{errMsg}'",E):S("{errName} during {activity} for '{action}' to '{contract}': '{errMsg}'",E),plaintextBody:d?S("{errName} during {activity} for '{action}' from {who} to '{contract}': '{errMsg}'",w):S("{errName} during {activity} for '{action}' to '{contract}': '{errMsg}'",w),icon:"exclamation-triangle",level:"danger",linkTo:`/app/dashboard?modal=UserSettingsModal&tab=application-logs&errorMsg=${encodeURIComponent(r.message)}`,scope:"app"}},GENERAL(e){return{title:S("Group Income"),body:e.message,plaintextBody:e.message,icon:"cog",level:"info",linkTo:"",scope:"app"}},WARNING(e){return{title:S("Warning"),body:e.message,plaintextBody:e.message,icon:"exclamation-triangle",level:"danger",linkTo:"",scope:"app"}},ERROR(e){return{title:S("Error"),body:e.message,plaintextBody:e.message,icon:"exclamation-triangle",level:"danger",linkTo:`/app/dashboard?modal=UserSettingsModal&tab=application-logs&errorMsg=${encodeURIComponent(e.message)}`,scope:"app"}},CONTRIBUTION_REMINDER(e){return{title:S("Contribution reminder"),body:S("Do not forget to send your pledge by {strong_}{date}{_strong}.",{date:e.date,...Vt("strong")}),plaintextBody:S("Do not forget to send your pledge by {strong_}{date}{_strong}.",{date:e.date}),icon:"coins",level:"info",linkTo:"/payments",scope:"user"}},INCOME_DETAILS_OLD(e){return{title:S("Update income details"),body:S("You haven't updated your income details in more than {months} months. Would you like to review them now?",{months:Math.floor(e.months)}),plaintextBody:S("You haven't updated your income details in more than {months} months. Would you like to review them now?",{months:Math.floor(e.months)}),icon:"coins",level:"info",linkTo:"/contributions?modal=IncomeDetails",scope:"user",data:{lastUpdatedDate:e.lastUpdatedDate}}},MEMBER_ADDED(e){let t=c("state/vuex/state"),r=c("state/vuex/getters").userDisplayNameFromID(e.memberID),n=r!==e.memberID;return{avatarUserID:e.memberID,title:t[e.groupID]?.settings?.groupName||S("Member added"),body:S("The group has a new member. Say hi to {strong_}{name}{_strong}!",{name:`${Ct}${e.memberID}`,...Vt("strong")}),plaintextBody:n?S("The group has a new member. Say hi to {strong_}{name}{_strong}!",{name:r}):S("The group has a new member. Say hi!"),icon:"user-plus",level:"info",linkTo:`/group-chat/${t[e.groupID]?.generalChatRoomId}`,scope:"group",groupID:e.groupID}},MEMBER_LEFT(e){let t=c("state/vuex/state"),r=c("state/vuex/getters").userDisplayNameFromID(e.memberID),n=r!==e.memberID;return{title:t[e.groupID]?.settings?.groupName||S("Member added"),avatarUserID:e.memberID,body:S("{strong_}{name}{_strong} has left your group. Contributions were updated accordingly.",{name:`${Ct}${e.memberID}`,...Vt("strong")}),plaintextBody:n?S("{strong_}{name}{_strong} has left your group. Contributions were updated accordingly.",{name:r}):S("A member left your group. Contributions were updated accordingly.",{name:r}),icon:"user-minus",level:"danger",linkTo:"/contributions",scope:"group",groupID:e.groupID}},MEMBER_REMOVED(e){let t=c("state/vuex/state"),r=c("state/vuex/getters").userDisplayNameFromID(e.memberID),n=r!==e.memberID;return{title:t[e.groupID]?.settings?.groupName||S("Member added"),avatarUserID:e.memberID,body:S("{strong_}{name}{_strong} was kicked out of the group. Contributions were updated accordingly.",{name:`${Ct}${e.memberID}`,...Vt("strong")}),plaintextBody:n?S("{strong_}{name}{_strong} was kicked out of the group. Contributions were updated accordingly.",{name:r}):S("A member was kicked out of the group. Contributions were updated accordingly."),icon:"user-minus",level:"danger",linkTo:"/contributions",scope:"group",groupID:e.groupID}},NEW_PROPOSAL(e){let t=c("state/vuex/state"),r=e.creatorID===c("state/vuex/getters").ourIdentityContractId,n={name:`${Ct}${e.creatorID}`,...Vt("strong")},o={name:c("state/vuex/getters").userDisplayNameFromID(e.creatorID)},i={ADD_MEMBER:r?S("You proposed to add a member to the group."):S("{strong_}{name}{_strong} proposed to add a member to the group. Vote now!",n),CHANGE_MINCOME:r?S("You proposed to change the group mincome."):S("{strong_}{name}{_strong} proposed to change the group mincome. Vote now!",n),CHANGE_DISTRIBUTION_DATE:r?S("You proposed to change the group distribution date."):S("{strong_}{name}{_strong} proposed to change the group distribution date. Vote now!",n),CHANGE_VOTING_RULE:r?S("You proposed to change the group voting system."):S("{strong_}{name}{_strong} proposed to change the group voting system. Vote now!",n),REMOVE_MEMBER:r?S("You proposed to remove a member from the group."):S("{strong_}{name}{_strong} proposed to remove a member from the group. Vote now!",n),GENERIC:r?S("You created a proposal."):S("{strong_}{name}{_strong} created a proposal. Vote now!",n)},s={ADD_MEMBER:r?S("You proposed to add a member to the group."):S("{strong_}{name}{_strong} proposed to add a member to the group. Vote now!",o),CHANGE_MINCOME:r?S("You proposed to change the group mincome."):S("{strong_}{name}{_strong} proposed to change the group mincome. Vote now!",o),CHANGE_DISTRIBUTION_DATE:r?S("You proposed to change the group distribution date."):S("{strong_}{name}{_strong} proposed to change the group distribution date. Vote now!",o),CHANGE_VOTING_RULE:r?S("You proposed to change the group voting system."):S("{strong_}{name}{_strong} proposed to change the group voting system. Vote now!",o),REMOVE_MEMBER:r?S("You proposed to remove a member from the group."):S("{strong_}{name}{_strong} proposed to remove a member from the group. Vote now!",o),GENERIC:r?S("You created a proposal."):S("{strong_}{name}{_strong} created a proposal. Vote now!",o)},a={ADD_MEMBER:"user-plus",CHANGE_MINCOME:"dollar-sign",CHANGE_DISTRIBUTION_DATE:"chart-pie",CHANGE_VOTING_RULE:"vote-yea",REMOVE_MEMBER:"user-minus",GENERIC:"envelope-open-text"};return{title:t[e.groupID]?.settings?.groupName||S("New proposal"),avatarUserID:e.creatorID,body:i[e.subtype],plaintextBody:s[e.subtype],creatorID:e.creatorID,icon:a[e.subtype],level:"info",subtype:e.subtype,scope:"group",sbpInvocation:["gi.app/group/checkAndSeeProposal",{contractID:e.groupID,data:{proposalHash:e.proposalHash}}]}},PROPOSAL_EXPIRING(e){let t=c("state/vuex/state"),{proposalData:r,proposalType:n}=e.proposal.data,o={[pr]:S("Member addition"),[St]:S("Member removal"),[Er]:{mincomeAmount:S("Mincome change"),distributionDate:S("Distribution date change")}[r.setting],[br]:S("Voting rule change"),[Yt]:r.name};return{title:t[e.groupID]?.settings?.groupName||S("Proposal expiring"),avatarUserID:"",body:S('Proposal about to expire: {i_}"{proposalTitle}"{_i}. Please vote!',{...Vt("i"),proposalTitle:o[n]}),plaintextBody:S('Proposal about to expire: {i_}"{proposalTitle}"{_i}. Please vote!',{proposalTitle:o[n]}),level:"info",icon:"exclamation-triangle",scope:"group",data:{proposalId:e.proposalId},sbpInvocation:["gi.app/group/checkAndSeeProposal",{contractID:e.groupID,data:{proposalHash:e.proposalId}}]}},PROPOSAL_CLOSED(e){let t=c("state/vuex/state"),{creatorID:r,status:n,type:o,options:i}=_l(e.proposal),s=r===c("state/vuex/getters").ourIdentityContractId,a={[Dr]:{icon:"check",level:"success",closedWith:S("accepted")},[Hn]:{icon:"times",level:"danger",closedWith:S("rejected")},[fi]:{icon:"times",level:"danger",closedWith:S("cancelled")},[li]:{icon:"times",level:"danger",closedWith:S("expired")}},u={...i,...Vt("strong"),closedWith:a[n].closedWith,name:s?"":`${Ct}${r}`},f={...i,closedWith:a[n].closedWith,name:s?"":c("state/vuex/getters").userDisplayNameFromID(r)};i.memberID&&(u.member=`${Ct}${i.memberID}`,f.member=c("state/vuex/getters").userDisplayNameFromID(i.memberID));let d={[pr]:s?S("Your proposal to add {member} to the group was {strong_}{closedWith}{_strong}.",u):S("{strong_}{name}'s{_strong} proposal to add {member} to the group was {strong_}{closedWith}{_strong}.",u),[St]:s?S("Your proposal to remove {member} from the group was {strong_}{closedWith}{_strong}.",u):S("{strong_}{name}'s{_strong} proposal to remove {member} from the group was {strong_}{closedWith}{_strong}.",u),[Er]:s?S("Your proposal to change group's {setting} to {value} was {strong_}{closedWith}{_strong}.",u):S("{strong_}{name}'s{_strong} proposal to change group's {setting} to {value} was {strong_}{closedWith}{_strong}.",u),[br]:s?S("Your proposal to change group's {setting} was {strong_}{closedWith}{_strong}.",u):S("{strong_}{name}'s{_strong} proposal to change group's {setting} was {strong_}{closedWith}{_strong}.",u),[Yt]:s?S('Your proposal "{title}" was {strong_}{closedWith}{_strong}.',u):S(`{strong_}{name}'s{_strong} proposal "{title}" was {strong_}{closedWith}{_strong}.`,u)},h={[pr]:s?S("Your proposal to add {member} to the group was {strong_}{closedWith}{_strong}.",f):S("{strong_}{name}'s{_strong} proposal to add {member} to the group was {strong_}{closedWith}{_strong}.",f),[St]:s?S("Your proposal to remove {member} from the group was {strong_}{closedWith}{_strong}.",f):S("{strong_}{name}'s{_strong} proposal to remove {member} from the group was {strong_}{closedWith}{_strong}.",f),[Er]:s?S("Your proposal to change group's {setting} to {value} was {strong_}{closedWith}{_strong}.",f):S("{strong_}{name}'s{_strong} proposal to change group's {setting} to {value} was {strong_}{closedWith}{_strong}.",f),[br]:s?S("Your proposal to change group's {setting} was {strong_}{closedWith}{_strong}.",f):S("{strong_}{name}'s{_strong} proposal to change group's {setting} was {strong_}{closedWith}{_strong}.",f),[Yt]:s?S('Your proposal "{title}" was {strong_}{closedWith}{_strong}.',f):S(`{strong_}{name}'s{_strong} proposal "{title}" was {strong_}{closedWith}{_strong}.`,f)};return{title:t[e.groupID]?.settings?.groupName||S("Proposal closed"),avatarUserID:r,body:d[o],plaintextBody:h[o],icon:a[n].icon,level:a[n].level,scope:"group",sbpInvocation:["gi.app/group/checkAndSeeProposal",{contractID:e.groupID,data:{proposalHash:e.proposalHash}}]}},PAYMENT_RECEIVED(e){return{title:c("state/vuex/state")[e.groupID]?.settings?.groupName||S("Payment received"),avatarUserID:e.creatorID,body:S("{strong_}{name}{_strong} sent you a {amount} mincome contribution. {strong_}Review and send a thank you note.{_strong}",{name:`${Ct}${e.creatorID}`,amount:e.amount,...Vt("strong")}),plaintextBody:S("{strong_}{name}{_strong} sent you a {amount} mincome contribution. {strong_}Review and send a thank you note.{_strong}",{name:c("state/vuex/getters").userDisplayNameFromID(e.creatorID),amount:e.amount}),creatorID:e.creatorID,icon:"",level:"info",linkTo:`/payments?modal=PaymentDetail&id=${e.paymentHash}`,scope:"group",groupID:e.groupID}},PAYMENT_THANKYOU_SENT(e){return{title:c("state/vuex/state")[e.groupID]?.settings?.groupName||S("Thank you note received"),avatarUserID:e.fromMemberID,body:S("{strong_}{name}{_strong} sent you a {strong_}thank you note{_strong} for your contribution.",{name:`${Ct}${e.fromMemberID}`,...Vt("strong")}),plaintextBody:S("{strong_}{name}{_strong} sent you a {strong_}thank you note{_strong} for your contribution.",{name:c("state/vuex/getters").userDisplayNameFromID(e.fromMemberID)}),creatorID:e.fromMemberID,icon:"",level:"info",linkTo:`/payments?modal=ThankYouNoteModal&from=${e.fromMemberID}&to=${e.toMemberID}`,scope:"group",groupID:e.groupID}},MINCOME_CHANGED(e){let t=c("state/vuex/state"),{withGroupCurrency:r}=c("state/vuex/getters");return{title:t[e.groupID]?.settings?.groupName||S("Mincome changes"),avatarUserID:e.creatorID,body:S("The mincome has changed to {amount}.",{amount:r(e.to)}),plaintextBody:S("The mincome has changed to {amount}.",{amount:r(e.to)}),creatorID:e.creatorID,icon:"dollar-sign",level:"info",scope:"group",sbpInvocation:["gi.app/group/displayMincomeChangedPrompt",{contractID:e.groupID,data:{amount:e.to,memberType:e.memberType,increased:e.increased}}]}},NEW_DISTRIBUTION_PERIOD(e){let t=c("state/vuex/state"),{period:r,creatorID:n,memberType:o}=e,i=vi(r,{month:"short",day:"numeric",year:"numeric"}),s={pledger:S("A new distribution period ({period}) has started. Please check Payment TODOs.",{period:i}),receiver:S("A new distribution period ({period}) has started. Please update your income details if they have changed.",{period:i})};return{title:t[e.groupID]?.settings?.groupName||S("New distribution period"),avatarUserID:n,body:s[o],plaintextBody:s[o],level:"info",icon:"coins",linkTo:o==="pledger"?"/payments":"/contributions?modal=IncomeDetails",scope:"group",data:{period:r},groupID:e.groupID}},NEAR_DISTRIBUTION_END(e){return{title:c("state/vuex/state")[e.groupID]?.settings?.groupName||S("Distribution period ends soon"),body:S("Less than 1 week left before the distribution period ends - don't forget to send payments!"),plaintextBody:S("Less than 1 week left before the distribution period ends - don't forget to send payments!"),level:"info",icon:"coins",linkTo:"/payments",scope:"group",data:e,groupID:e.groupID}},NONMONETARY_CONTRIBUTION_UPDATE(e){let t=c("state/vuex/state"),{prev:r,after:n}=e.updateData,o=n.filter(g=>!r.includes(g)),i=r.filter(g=>!n.includes(g)),s=o.length?i.length?"updated":"added":i.length?"removed":null;if(!s)throw new Error("Cannot emit a NONMONETARY_CONTRIBUTION_UPDATE notification for no updates.");let a=`${Ct}${e.creatorID}`,u=c("state/vuex/getters").userDisplayNameFromID(e.creatorID),f=g=>{let E=g[0],w=g.length;return g.length>1?S("{first} and {rest} more",{first:E,rest:w-1}):E},d={added:()=>S("{name} added non-monetary contribution: {strong_}{added}{_strong}",{name:a,added:f(o),...Vt("strong")}),removed:()=>S("{name} removed non-monetary contribution: {strong_}{removed}{_strong}",{name:a,removed:f(i),...Vt("strong")}),updated:()=>S("{name} updated non-monetary contribution: added {strong_}{added}{_strong} and removed {strong_}{removed}{_strong}",{name:a,added:f(o),removed:f(i),...Vt("strong")})},h={added:()=>S("{name} added non-monetary contribution: {strong_}{added}{_strong}",{name:u,added:f(o)}),removed:()=>S("{name} removed non-monetary contribution: {strong_}{removed}{_strong}",{name:u,removed:f(i)}),updated:()=>S("{name} updated non-monetary contribution: added {strong_}{added}{_strong} and removed {strong_}{removed}{_strong}",{name:u,added:f(o),removed:f(i)})};return{title:t[e.groupID]?.settings?.groupName||S("Non-monetary contribution updated"),body:d[s](),plaintextBody:h[s](),scope:"group",avatarUserID:e.creatorID,level:"info",icon:"chart-pie",linkTo:"/contributions",groupID:e.groupID}}};c("sbp/selectors/register",{"gi.notifications/emit"(e,t){let r=Ql[e](t);if(r.scope==="group"&&!t.groupID)throw new TypeError("Incomplete notification data: `data.groupID` is required.");let n={...r,hash:Pu({...t,type:e}),avatarUserID:r.avatarUserID||c("state/vuex/getters").ourIdentityContractId,...r.scope==="group"?{groupID:t.groupID}:{},timestamp:new Date(t.createdDate?t.createdDate:c("chelonia/time")).getTime(),type:e},o=c("chelonia/rootState");if(o.notifications.items.some(s=>s.hash===n.hash))return console.error("[gi.notifications/emit] This notification is already in the store.",n.hash);let i=o.notifications.items.findLastIndex(s=>s.timestamp<n.timestamp);o.notifications.items.splice(Math.max(0,i),0,n),c("okTurtles.events/emit",wn),c("gi.actions/identity/kv/addNotificationStatus",n),c("okTurtles.events/emit",Lo,n)},"gi.notifications/markAsRead"(e){c("gi.actions/identity/kv/markNotificationStatusRead",e.hash)},"gi.notifications/markAllAsRead"(e){let t=c("chelonia/rootState");if(!t.notifications)return;let r=t.notifications.items.filter(n=>!n.read&&(!e||!n.groupID||n.groupID===e)).map(n=>n.hash);c("gi.actions/identity/kv/markNotificationStatusRead",r)},"gi.notifications/remove"(e){Array.isArray(e)||(e=[e]);let t=c("chelonia/rootState");if(!t.notifications)return;let r=new Set(e);t.notifications.items.map((o,i)=>r.has(o.hash)?(r.delete(o.hash),i):!1).filter(o=>o!==!1).sort().map((o,i)=>o-i).forEach(o=>t.notifications.items.splice(o,1)),c("okTurtles.events/emit",Xi,e)},"gi.notifications/setNotificationStatus"(e){let t=c("chelonia/rootState");t.notifications.status=e,c("okTurtles.events/emit",wn),c("okTurtles.events/emit",Qi,e)}});var Ye=Object.freeze({ENTRY:"entry",DELETION:"deletion",KV:"kv",KV_FILTER:"kv_filter",PING:"ping",PONG:"pong",PUB:"pub",SUB:"sub",UNSUB:"unsub",VERSION_INFO:"version_info"}),ft=Object.freeze({PUB:"pub",SUB:"sub",UNSUB:"unsub",PUSH_ACTION:"push_action",KV_FILTER:"kv_filter"}),Zl=Object.freeze({ERROR:"error",OK:"ok"}),bo=Object.freeze({SEND_PUBLIC_KEY:"send-public-key",STORE_SUBSCRIPTION:"store-subscription",DELETE_SUBSCRIPTION:"delete-subscription",SEND_PUSH_NOTIFICATION:"send-push-notification"}),xh={logPingMessages:!1,pingTimeout:45e3,maxReconnectionDelay:6e4,maxRetries:10,minReconnectionDelay:500,reconnectOnDisconnection:!0,reconnectOnOnline:!0,reconnectOnTimeout:!1,reconnectionDelayGrowFactor:2,timeout:6e4},ri="pubsub-error",Ih="pubsub-reconnection-attempt",Sh="pubsub-reconnection-failed",_h="pubsub-reconnection-scheduled",La="pubsub-reconnection-succeeded",vh="pubsub-subscription-succeeded";function ef(e,t={}){let r={customEventHandlers:t.handlers||{},failedConnectionAttempts:0,isLocal:/\/\/(localhost|127\.0\.0\.1)([:?/]|$)/.test(e),isNew:!0,listeners:Object.create(null),messageHandlers:{...Ah,...t.messageHandlers},nextConnectionAttemptDelayID:void 0,options:{...xh,...t},pendingSubscriptionSet:new Set,pendingUnsubscriptionSet:new Set,pingTimeoutID:void 0,shouldReconnect:!0,socket:null,subscriptionSet:new Set,kvFilter:new Map,connectionTimeoutID:void 0,url:e.replace(/^http/,"ws"),...Nh};for(let n of Object.keys(Ua))r.listeners[n]=o=>{try{Ua[n].call(r,o),r.customEventHandlers[n]?.call(r,o)}catch(i){c("okTurtles.events/emit",ri,r,i?.message)}};if(typeof self=="object"&&self instanceof EventTarget)for(let n of Fa)Ba.set(n,r.listeners[n]);return r.options.manual||r.connect(),r}function ni(e,t,r){let n={...r,type:e,data:t},o,i=function(){return o||(o=JSON.stringify(this)),o};return Object.defineProperties(n,{[Symbol.toPrimitive]:{value:i}}),n}function Th(e,t){return JSON.stringify({type:Ye.PUB,channelID:e,data:t})}function hs(e,t){return JSON.stringify(Object.assign({type:e},t))}var Ua={close(e){let t=this;if(console.debug("[pubsub] Event: close",e.code,e.reason),t.failedConnectionAttempts++,t.socket)for(let r of gs)t.socket.removeEventListener(r,t.listeners[r]);t.socket=null,t.clearAllTimers(),t.shouldReconnect&&t.subscriptionSet.forEach(r=>{t.pendingUnsubscriptionSet.has(r)||t.pendingSubscriptionSet.add(r)}),t.subscriptionSet.clear(),t.pendingUnsubscriptionSet.clear(),t.shouldReconnect&&t.options.reconnectOnDisconnection&&(t.failedConnectionAttempts>t.options.maxRetries?c("okTurtles.events/emit",Sh,t):(!Oh()||t.isLocal)&&t.scheduleConnectionAttempt())},error(e){let t=this;console.warn("[pubsub] Event: error",e),clearTimeout(t.pingTimeoutID)},message(e){let t=this,{data:r}=e;if(typeof r!="string")return c("okTurtles.events/emit",ri,t,{message:`Wrong data type: ${typeof r}`}),t.destroy();let n={type:""};try{n=Ch(r)}catch(i){return c("okTurtles.events/emit",ri,t,{message:`Malformed message: ${i?.message}`}),t.destroy()}let o=t.messageHandlers[n.type];if(o)o.call(t,n);else throw new Error(`Unhandled message type: ${n.type}`)},offline(){console.info("[pubsub] Event: offline");let e=this;e.clearAllTimers(),e.failedConnectionAttempts=0,e.socket?.close()},online(){console.info("[pubsub] Event: online");let e=this;e.options.reconnectOnOnline&&e.shouldReconnect&&(e.socket||(e.failedConnectionAttempts=0,e.scheduleConnectionAttempt()))},open(){console.debug("[pubsub] Event: open");let e=this,{options:t}=this;e.connectionTimeUsed=void 0,e.clearAllTimers(),c("okTurtles.events/emit",La,e),e.failedConnectionAttempts=-1,e.isNew=!1,t.pingTimeout>0&&t.pingTimeout<1/0&&(e.pingTimeoutID=setTimeout(()=>{e.socket?.close()},t.pingTimeout)),e.pendingSubscriptionSet.forEach(r=>{let n=this.kvFilter.get(r);e.socket?.send(hs(ft.SUB,n?{channelID:r,kvFilter:n}:{channelID:r}))})},"reconnection-attempt"(){console.info("[pubsub] Trying to reconnect...")},"reconnection-succeeded"(){console.info("[pubsub] Connection re-established")},"reconnection-failed"(){console.warn("[pubsub] Reconnection failed"),this.destroy()},"reconnection-scheduled"(e){let{delay:t,nth:r}=e.detail;console.info(`[pubsub] Scheduled connection attempt ${r} in ~${t} ms`)},"subscription-succeeded"(e){let{channelID:t}=e.detail;console.debug(`[pubsub] Subscribed to channel ${t}`)}},Ah={[Ye.ENTRY](e){console.debug("[pubsub] Received ENTRY:",e)},[Ye.PING]({data:e}){let t=this;t.options.logPingMessages&&console.debug(`[pubsub] Ping received in ${Date.now()-Number(e)} ms`),t.socket?.send(ni(Ye.PONG,e)),clearTimeout(t.pingTimeoutID),t.pingTimeoutID=setTimeout(()=>{t.socket?.close()},t.options.pingTimeout)},[Ye.PUB]({channelID:e,data:t}){console.log(`[pubsub] Received data from channel ${e}:`,t)},[Ye.KV]({channelID:e,key:t,data:r}){console.log(`[pubsub] Received KV update from channel ${e} ${t}:`,r)},[Ye.SUB](e){console.debug(`[pubsub] Ignoring ${e.type} message:`,e.data)},[Ye.UNSUB](e){console.debug(`[pubsub] Ignoring ${e.type} message:`,e.data)},[Zl.ERROR]({data:e}){let{type:t,channelID:r,reason:n}=e;console.warn(`[pubsub] Received ERROR response for ${t} request to ${r}`);let o=this;switch(t){case ft.SUB:{console.warn(`[pubsub] Could not subscribe to ${r}: ${n}`),o.pendingSubscriptionSet.delete(r);break}case ft.UNSUB:{console.warn(`[pubsub] Could not unsubscribe from ${r}: ${n}`),o.pendingUnsubscriptionSet.delete(r);break}case ft.PUSH_ACTION:{let{actionType:i,message:s}=e;console.warn(`[pubsub] Received ERROR for PUSH_ACTION request with the action type '${i}' and the following message: ${s}`);break}default:console.error(`[pubsub] Malformed response: invalid request type ${t}`)}},[Zl.OK]({data:{type:e,channelID:t}}){let r=this;switch(e){case ft.SUB:{r.pendingSubscriptionSet.delete(t),r.subscriptionSet.add(t),c("okTurtles.events/emit",vh,r,{channelID:t});break}case ft.UNSUB:{console.debug(`[pubsub] Unsubscribed from ${t}`),r.pendingUnsubscriptionSet.delete(t),r.subscriptionSet.delete(t),r.kvFilter.delete(t);break}case ft.KV_FILTER:{console.debug(`[pubsub] Set KV filter for ${t}`);break}default:console.error(`[pubsub] Malformed response: invalid request type ${e}`)}}},Fa=["offline","online"],gs=["close","error","message","open"],Ba=new Map;if(typeof self=="object"&&self instanceof EventTarget)for(let e of Fa){let t=r=>Ba.get(e)?.(r);self.addEventListener(e,t,!1)}var Oh=()=>typeof navigator=="object"&&navigator.onLine===!1,Ch=e=>{let t=JSON.parse(e);if(typeof t!="object"||t===null)throw new TypeError("Message is null or not an object");let{type:r}=t;if(typeof r!="string"||r==="")throw new TypeError("Message type must be a non-empty string");return t},Nh={clearAllTimers(){let e=this;clearTimeout(e.connectionTimeoutID),clearTimeout(e.nextConnectionAttemptDelayID),clearTimeout(e.pingTimeoutID),e.connectionTimeoutID=void 0,e.nextConnectionAttemptDelayID=void 0,e.pingTimeoutID=void 0},connect(){let e=this;if(e.socket!==null)throw new Error("connect() can only be called if there is no current socket.");if(e.nextConnectionAttemptDelayID)throw new Error("connect() must not be called during a reconnection delay.");if(!e.shouldReconnect)throw new Error("connect() should no longer be called on this instance.");if(e.socket=new WebSocket(e.url),e.socket.send=function(t){let r=WebSocket.prototype.send.bind(this);return typeof t=="object"&&typeof t[Symbol.toPrimitive]=="function"?r(t[Symbol.toPrimitive]()):r(t)},e.options.timeout){let t=performance.now();e.connectionTimeoutID=setTimeout(()=>{e.connectionTimeoutID=void 0,e.options.reconnectOnTimeout&&(e.connectionTimeUsed=performance.now()-t),e.socket?.close(4e3,"timeout")},e.options.timeout)}for(let t of gs)e.socket.addEventListener(t,e.listeners[t])},destroy(){let e=this;if(e.clearAllTimers(),e.pendingSubscriptionSet.clear(),e.pendingUnsubscriptionSet.clear(),e.subscriptionSet.clear(),typeof self=="object"&&self instanceof EventTarget)for(let t of Fa)Ba.delete(t);if(e.socket){for(let t of gs)e.socket.removeEventListener(t,e.listeners[t]);e.socket.close()}e.listeners={},e.socket=null,e.shouldReconnect=!1},getNextRandomDelay(){let e=this,{maxReconnectionDelay:t,minReconnectionDelay:r,reconnectionDelayGrowFactor:n}=e.options,o=r*n**e.failedConnectionAttempts,i=o*n,s=e.connectionTimeUsed;return e.connectionTimeUsed=void 0,Math.min(Math.max(r,s?t-s:t),Math.round(o+(0,Math.random)()*(i-o)))},scheduleConnectionAttempt(){let e=this;if(!e.shouldReconnect)throw new Error("Cannot call `scheduleConnectionAttempt()` when `shouldReconnect` is false.");if(e.nextConnectionAttemptDelayID)return console.warn("[pubsub] A reconnection attempt is already scheduled.");let t=e.getNextRandomDelay(),r=e.failedConnectionAttempts+1;e.nextConnectionAttemptDelayID=setTimeout(()=>{c("okTurtles.events/emit",Ih,e),e.nextConnectionAttemptDelayID=void 0,e.connect()},t),c("okTurtles.events/emit",_h,e,{delay:t,nth:r})},pub(e,t){this.socket?.readyState===WebSocket.OPEN&&this.socket.send(Th(e,t))},sub(e){let t=this,{socket:r}=this;if(!t.pendingSubscriptionSet.has(e)&&(t.pendingSubscriptionSet.add(e),t.pendingUnsubscriptionSet.delete(e),r?.readyState===WebSocket.OPEN)){let n=t.kvFilter.get(e);r.send(hs(ft.SUB,n?{channelID:e,kvFilter:n}:{channelID:e}))}},setKvFilter(e,t){let r=this,{socket:n}=this;t?r.kvFilter.set(e,t):r.kvFilter.delete(e),r.subscriptionSet.has(e)&&n?.readyState===WebSocket.OPEN&&n.send(hs(ft.KV_FILTER,t?{channelID:e,kvFilter:t}:{channelID:e}))},unsub(e){let t=this,{socket:r}=this;t.pendingUnsubscriptionSet.has(e)||(t.pendingSubscriptionSet.delete(e),t.pendingUnsubscriptionSet.add(e),r?.readyState===WebSocket.OPEN&&r.send(hs(ft.UNSUB,{channelID:e})))}};for(let e of Object.keys(Ua))(e==="error"||!gs.includes(e))&&c("okTurtles.events/on",`pubsub-${e}`,(t,r)=>{let n=new CustomEvent(e,{detail:r});t.listeners[e].call(t,n)});var wx=c("sbp/selectors/register",{"chelonia/kv/queuedSet":({contractID:e,key:t,data:r,onconflict:n,ifMatch:o,encryptionKeyName:i="cek",signingKeyName:s="csk"})=>c("chelonia/queueInvocation",e,()=>c("chelonia/kv/set",e,t,r,{ifMatch:o,encryptionKeyId:c("chelonia/contract/currentKeyIdByName",e,i),signingKeyId:c("chelonia/contract/currentKeyIdByName",e,s),onconflict:n}))});var Dh=/;\s*boundary=(?:"([0-9a-zA-Z'()+_,\-./:=? ]{0,69}[0-9a-zA-Z'()+_,\-./:=?])"|([0-9a-zA-Z'+_\-.]{0,69}[0-9a-zA-Z'+_\-.]))/,Rh=e=>new ReadableStream({pull(t){if(ArrayBuffer.isView(e))t.enqueue(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength));else if(e instanceof ArrayBuffer)t.enqueue(e);else throw new TypeError("Expected ArrayBuffer or an ArrayBuffer view.");t.close()}}),ys=Rh,$a=new TextEncoder,tf=/;\s*boundary=(?:"([^"]+)"|([^;",]+))/,rf="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+_-.",nf=()=>{let e=new Uint8Array(24);return globalThis.crypto.getRandomValues(e),Array.from(e).map(t=>rf[t%rf.length]).join("")},wo={preventClose:!0};async function*of(e,t,r){let n=$a.encode(`\r
--${e}`);if(Array.isArray(t)&&t.length<1){await r.abort(Error("At least one part is required"));return}let o=0;for await(let s of t){o++;let a,u;if(!s.body&&s.parts)if(u=s.headers.get("content-type"),!u)a=nf(),u=`multipart/mixed; boundary="${a}"`;else if(!u.startsWith("multipart/")||!tf.test(u)){await r.abort(Error("Invalid multipart content type: "+u));return}else{let f=u.match(Dh);(!f||!(a=f[1]||f[2]))&&(a=nf(),u=u.replace(tf,`; boundary="${a}"`))}await ys(n).pipeTo(r,wo),yield;{let f=[""];if(u){let h=!1;s.headers.forEach((g,E)=>{E!=="content-type"?f.push(`${E}: ${g}`):(h=!0,f.push(`${E}: ${u}`))}),h||f.push(`content-type: ${u}`)}else s.headers.forEach((h,g)=>{f.push(`${g}: ${h}`)});s.parts||!s.body?f.push(""):f.push("","");let d=$a.encode(f.join(`\r
`));f.length=0,await ys(d).pipeTo(r,wo),yield}if(s.body){if(s.body instanceof ArrayBuffer||ArrayBuffer.isView(s.body))await ys(s.body).pipeTo(r,wo);else if(s.body instanceof Blob)await s.body.stream().pipeTo(r,wo);else if(s.body instanceof ReadableStream)await s.body.pipeTo(r,wo);else{await r.abort(Error("Invalid body type"));return}yield}else if(s.parts){if(!a){await r.abort(Error("Runtime exception: undefined part boundary"));return}yield*of(a,s.parts,r),yield}}if(!o){await r.abort(Error("At least one part is required"));return}let i=$a.encode(`\r
--${e}--`);await ys(i).pipeTo(r,wo)}var kh=(e,t)=>{let r=new TransformStream,n=of(e,t,r.writable),o=!1,i=r.readable.getReader();return new ReadableStream({start(s){(async()=>{for(;;)try{let a=await i.read();if(a.done){let u=new Uint8Array([13,10]);s.enqueue(u.buffer.slice(u.byteOffset,u.byteOffset+u.byteLength)),s.close();return}s.enqueue(a.value)}catch(a){console.error("Read error:",a),s.error(a);return}})().catch(()=>{})},async pull(){o||(await n.next()).done&&(o=!0,await r.writable.close())}})},sf=kh;var Ph=async(e,t,r,n)=>{let o=await globalThis.crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveKey","deriveBits"]),i=await globalThis.crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",info:e.cek_info,salt:r},o,e.params,!1,n),s=await globalThis.crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",info:e.nonce_info,salt:r},o,e.nonce_length<<3);return[i,function*(){let a=new ArrayBuffer(e.nonce_length),u=new DataView(a),f=new Uint8Array(a),d=new Uint8Array(s),h=4294967295,g=(e.nonce_length>>2)-1,E=new Array(g).fill(0);for(;;){for(let w=0;w<=h;w++){u.setUint32(u.byteLength-4,w,!1);let I=new Uint8Array(e.nonce_length);for(let C=0;C<I.length;C++)I[C]=d[C]^f[C];yield I}for(let w=0;w<g;w++){if(w===g-1&&E[w]===h)throw new RangeError("Maximum number of segments exceeded");if(E[w]=(E[w]+1)%(h+1),u.setUint32(u.byteLength-4*(w+2),E[w],!1),E[w]!==0)break}}}()]},Kh=Ph,Mh=e=>ArrayBuffer.isView(e)?new Uint8Array(e.buffer).subarray(e.byteOffset,e.byteOffset+e.byteLength):new Uint8Array(e),Ga=Mh,lr={salt:{},recordSize:{},keyIdLen:{},keyId:{},payload:{},done:{}},Uh=(e,t,r,n)=>{let o=new Uint8Array(16),i,s,a,u=0,f=0,d=new Uint8Array(256),h=lr.salt,g=new TransformStream({start:()=>{},transform:async(E,w)=>{let I=Ga(E),C=0;for(;C<E.byteLength;)switch(h){case lr.salt:{let G=I.subarray(C,C+o.byteLength-f);if(o.set(G,f),f+=G.byteLength,C+=G.byteLength,f===o.byteLength){f=0,h=lr.recordSize;continue}break}case lr.recordSize:{let G=I.subarray(C,C+4-f),A=new ArrayBuffer(4),R=new Uint8Array(A),O=new DataView(A);if(R.set(G,f),u|=O.getUint32(0,!1),f+=G.byteLength,C+=G.byteLength,f===4){if(u<=e.tag_length+1||u>(n==null?4294967295:Math.min(4294967295,n)))throw new RangeError("Invalid record size: "+u);f=0,h=lr.keyIdLen;continue}break}case lr.keyIdLen:{d[0]=I[C++],h=lr.keyId;continue}case lr.keyId:{let G=I.subarray(C,C+d[0]-f);if(d.set(G,1+f),f+=G.byteLength,C+=G.byteLength,f===d[0]){let A=await r(d.subarray(1,1+d[0]));r=void 0;let R=await Kh(e,A,o,["decrypt"]);s=R[0],a=R[1],i=new Uint8Array(u),f=0,h=lr.payload;continue}break}case lr.payload:{let G=I.subarray(C,C+u-f);if(i.set(G,f),f+=G.byteLength,C+=G.byteLength,f===u){let A=a.next().value,R=Ga(await globalThis.crypto.subtle.decrypt({name:e.params.name,iv:A,tagLength:e.tag_length<<3},s,i.subarray(0,f))),O=R.byteLength-1;for(;O>0&&R[O]===0;O--);if(R[O]===2){if(C!==E.byteLength)throw new Error("Unexpected terminal padding delimiter");h=lr.done}else if(R[O]!==1)throw new Error("Invalid padding delimiter");w.enqueue(R.buffer.slice(0,O)),R.fill(0),f=0;continue}break}default:throw new Error("Invalid state")}},flush:async E=>{switch(h){case lr.done:return;case lr.payload:{if(f<1+e.tag_length)throw new Error("Unexpected end of data");let w=a.next().value,I=Ga(await globalThis.crypto.subtle.decrypt({name:e.params.name,iv:w,tagLength:e.tag_length<<3},s,i.subarray(0,f))),C=I.byteLength-1;for(;C>0&&I[C]===0;C--);if(I[C]!==2)throw new Error("Unexpected non-terminal padding delimiter");E.enqueue(I.buffer.slice(0,C)),I.fill(0);return}default:throw new Error("Invalid state")}}});return t.pipeThrough(g),g.readable},af=Uh;var ja={params:{name:"AES-GCM",length:256},get cek_info(){return new Uint8Array([67,111,110,116,101,110,116,45,69,110,99,111,100,105,110,103,58,32,97,101,115,50,53,54,103,99,109,0])},get nonce_info(){return new Uint8Array([67,111,110,116,101,110,116,45,69,110,99,111,100,105,110,103,58,32,110,111,110,99,101,0])},block_size:16,tag_length:16,nonce_length:12};var Lh=async(e,t,r,n)=>{let o=await globalThis.crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveKey","deriveBits"]),i=await globalThis.crypto.subtle.deriveKey({name:"HKDF",hash:"SHA-256",info:e.cek_info,salt:r},o,e.params,!1,n),s=await globalThis.crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",info:e.nonce_info,salt:r},o,e.nonce_length<<3);return[i,function*(){let a=new ArrayBuffer(e.nonce_length),u=new DataView(a),f=new Uint8Array(a),d=new Uint8Array(s),h=4294967295,g=(e.nonce_length>>2)-1,E=new Array(g).fill(0);for(;;){for(let w=0;w<=h;w++){u.setUint32(u.byteLength-4,w,!1);let I=new Uint8Array(e.nonce_length);for(let C=0;C<I.length;C++)I[C]=d[C]^f[C];yield I}for(let w=0;w<g;w++){if(w===g-1&&E[w]===h)throw new RangeError("Maximum number of segments exceeded");if(E[w]=(E[w]+1)%(h+1),u.setUint32(u.byteLength-4*(w+2),E[w],!1),E[w]!==0)break}}}()]},Fh=Lh,Bh=e=>ArrayBuffer.isView(e)?new Uint8Array(e.buffer).subarray(e.byteOffset,e.byteOffset+e.byteLength):new Uint8Array(e),Ha=Bh,$h=()=>{let e=new Uint8Array(16);return globalThis.crypto.getRandomValues(e),e},Gh=async(e,t,r,n,o,i)=>{if(r<=e.tag_length+1||r>4294967295)throw new RangeError("Invalid record size: "+r);if(n.byteLength>255)throw new RangeError("Key ID too long");if(i&&i.byteLength!==16)throw new RangeError("Invald salt length: "+i.byteLength);let s=r-e.tag_length-1,a=i?Ha(i):$h(),[u,f]=await Fh(e,o,a,["encrypt"]);o=void 0;let d=new Uint8Array(s),h=0,g=new TransformStream({start:E=>{let w=a.byteLength+4+1+n.byteLength,I=new ArrayBuffer(w);new Uint8Array(I,0,a.byteLength).set(a);let C=new DataView(I,a.byteLength,5);C.setUint32(0,r,!1),C.setUint8(4,n.byteLength);let G=new Uint8Array(I,a.byteLength+4+1,n.byteLength),A=Ha(n);G.set(A),E.enqueue(I)},transform:async(E,w)=>{let I=Ha(E),C=0;for(;C<E.byteLength;){let G=I.subarray(C,C+s-h);if(d.set(G,h),h+=G.byteLength,C+=G.byteLength,h===s){let A=f.next().value,R=new Uint8Array(s+1);R.set(d.subarray(0,h)),R[h]=1;let O=await globalThis.crypto.subtle.encrypt({name:e.params.name,iv:A,tagLength:e.tag_length<<3},u,R);w.enqueue(O),h=0}}},flush:async E=>{let w=f.next().value,I=new Uint8Array(h+1);I.set(d.subarray(0,h)),I[h]=2;let C=await globalThis.crypto.subtle.encrypt({name:e.params.name,iv:w,tagLength:e.tag_length<<3},u,I);E.enqueue(C),d.fill(0),I.fill(0)}});return t.pipeThrough(g),g.readable},cf=Gh;var ms=typeof window!="object"||(()=>{let e=!1,t=new Request("",{body:new ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("content-type");return e&&!t})(),za=async e=>{let t=e.getReader(),r=[],n=0;for(;;){let i=await t.read();if(i.done)break;r.push(J(i.value)),n+=i.value.byteLength}let o=new Uint8Array(n);return r.reduce((i,s)=>(o.set(s,i),i+s.byteLength),0),o},jh=async function(e,t){return ms===!0&&await this.config.fetch(`${e}/streams-test`,{method:"POST",body:new ReadableStream({start(r){r.enqueue(Buffer.from("ok")),r.close()}}),duplex:"half"}).then(r=>{if(!r.ok)throw new Error("Unexpected response");ms=2}).catch(()=>{console.info("files: Disabling streams support because the streams test failed"),ms=!1}),ms?t.pipeThrough(new TransformStream({transform(r,n){n.enqueue(J(r))}})):await za(t)},Hh=e=>{let t=0,[r,n]=e.tee(),o=new Promise((s,a)=>{r.pipeTo(new WritableStream({write(u){t+=u.byteLength},close(){s(t)},abort(u){a(u)}}))}),i=Cu(n,qt.SHELTER_FILE_CHUNK);return Promise.all([o,i])},lf=(e,t)=>{let n=async function*(){let o=0;for(let i of t.chunks){if(!Array.isArray(i)||typeof i[0]!="number"||typeof i[1]!="string")throw new Error("Invalid chunk descriptor");let s=await e.config.fetch(`${e.config.connectionURL}/file/${i[1]}`,{method:"GET",signal:e.abortController.signal});if(!s.ok)throw new Error("Unable to retrieve manifest");let a=await s.arrayBuffer();if(a.byteLength!==i[0])throw new Error("mismatched chunk size");if(o+=a.byteLength,o>t.size)throw new Error("read size exceeds declared size");if(Fr(J(a),qt.SHELTER_FILE_CHUNK)!==i[1])throw new Error("mismatched chunk hash");yield a}if(o!==t.size)throw new Error("mismatched size")}();return new ReadableStream({async pull(o){try{let i=await n.next();if(i.done){o.close();return}o.enqueue(i.value)}catch(i){o.error(i)}}})},zh={upload:(e,t)=>{let r=t["cipher-params"],n=r?.IKM,o=r?.rs??65536;n||(n=new Uint8Array(33),self.crypto.getRandomValues(n));let i=Rt("aes256gcm-keyId"+Rt(n)).slice(-8),s=Buffer.from(i);return{cipherParams:{keyId:i},streamHandler:async a=>await cf(ja,a,o,s,n),downloadParams:{IKM:Buffer.from(n).toString("base64"),rs:o}}},download:(e,t,r)=>{let n=t.IKM;if(!n)throw new Error("Missing IKM in downloadParams");let o=Buffer.from(n,"base64"),i=Rt("aes256gcm-keyId"+Rt(o)).slice(-8);if(!r["cipher-params"]||!r["cipher-params"].keyId)throw new Error("Missing cipher-params");if(i!==r["cipher-params"].keyId)throw new Error("Key ID mismatch");let s=t.rs??1<<27;return{payloadHandler:async()=>{let a=await za(af(ja,lf(e,r),u=>{if(Buffer.from(u).toString()!==i)throw new Error("Invalid key ID");return o},s));return new Blob([a],{type:r.type||"application/octet-stream"})}}}},Yh={upload:()=>({cipherParams:void 0,streamHandler:e=>e,downloadParams:void 0}),download:(e,t,r)=>({payloadHandler:async()=>{let n=await za(lf(e,r));return new Blob([n],{type:r.type||"application/octet-stream"})}})},uf={aes256gcm:zh,none:Yh},Mx=c("sbp/selectors/register",{"chelonia/fileUpload":async function(e,t,{billableContractID:r}={}){Array.isArray(e)||(e=[e]);let n=[],o=await uf[t.cipher]?.upload?.(this,t);if(!o)throw new Error("Unsupported cipher");let i=o.cipherParams,s=await Promise.all(e.map(async(g,E)=>{let w=g.stream(),I=await o.streamHandler(w),[C,G]=I.tee();return n.push(Hh(G)),{headers:new Headers([["content-disposition",`form-data; name="${E}"; filename="${E}"`],["content-type","application/octet-stream"]]),body:C}}));s.push({headers:new Headers([["content-disposition",'form-data; name="manifest"; filename="manifest.json"'],["content-type","application/vnd.shelter.filemanifest"]]),body:new ReadableStream({async start(g){let E=await Promise.all(n),w={version:"1.0.0",type:t.type??void 0,meta:t.meta??void 0,cipher:t.cipher,"cipher-params":i,size:E.reduce((I,[C])=>I+C,0),chunks:E,"name-map":t["name-map"]??void 0,alternatives:t.alternatives??void 0};g.enqueue(Buffer.from(JSON.stringify(w))),g.close()}})});let a=typeof self.crypto?.randomUUID=="function"?self.crypto.randomUUID():new Array(36).fill("").map(()=>"abcdefghijklmnopqrstuvwxyz"[(0,Math.random)()*26|0]).join(""),u=sf(a,s),f="deletionToken"+lo(),d=Rt(f),h=await this.config.fetch(`${this.config.connectionURL}/file`,{method:"POST",signal:this.abortController.signal,body:await jh.call(this,this.config.connectionURL,u),headers:new Headers([...r?[["authorization",mr.call(this,r)]]:[],["content-type",`multipart/form-data; boundary=${a}`],["shelter-deletion-token-digest",d]]),duplex:"half"});if(!h.ok)throw new Error("Error uploading file");return{download:{manifestCid:await h.text(),downloadParams:o.downloadParams},delete:f}},"chelonia/fileDownload":async function(e,t){let{manifestCid:r,downloadParams:n}=e.valueOf(),o=await this.config.fetch(`${this.config.connectionURL}/file/${r}`,{method:"GET",signal:this.abortController.signal});if(!o.ok)throw new Error("Unable to retrieve manifest");let i=await o.arrayBuffer();if(Fr(J(i),qt.SHELTER_FILE_MANIFEST)!==r)throw new Error("mismatched manifest hash");let s=JSON.parse(Buffer.from(i).toString());if(typeof s!="object")throw new Error("manifest format is invalid");if(s.version!=="1.0.0")throw new Error("unsupported manifest version");if(!Array.isArray(s.chunks))throw new Error("missing required field: chunks");if(t&&!await t?.(s))return!1;let a=await uf[s.cipher]?.download?.(this,n,s);if(!a)throw new Error("Unsupported cipher");return a.payloadHandler()},"chelonia/fileDelete":async function(e,t={}){if(!e)throw new TypeError("A manifest CID must be provided");return Array.isArray(e)||(e=[e]),await Promise.allSettled(e.map(async r=>{let n=q(t,r),o=q(t[r],"token")&&t[r].token,i=q(t[r],"billableContractID")&&t[r].billableContractID;if(!n||o===i)throw new TypeError(`Either a token or a billable contract ID must be provided for ${r}`);if(!(await this.config.fetch(`${this.config.connectionURL}/deleteFile/${r}`,{method:"POST",signal:this.abortController.signal,headers:new Headers([["authorization",o?`bearer ${t[r].token.valueOf()}`:mr.call(this,t[r].billableContractID)]])})).ok)throw new Error(`Unable to delete file ${r}`)}))}});var Va="head=",Vh=e=>{if(e.startsWith(Va))return e.slice(Va.length)},Ya=e=>`${Va}${e}`;c("sbp/selectors/unsafe",["chelonia.db/get","chelonia.db/set","chelonia.db/delete"]);var qh={"chelonia.db/get":function(e){let t=Vh(e);if(!t)return Promise.resolve();let r=c("chelonia/rootState").contracts[t],n=r?.HEAD?JSON.stringify({HEAD:r.HEAD,height:r.height,previousKeyOp:r.previousKeyOp}):void 0;return Promise.resolve(n)},"chelonia.db/set":function(){return Promise.resolve()},"chelonia.db/delete":function(){return Promise.resolve(!0)}},jx=c("sbp/selectors/register",{...qh,"chelonia/db/getEntryMeta":async(e,t)=>{let r=await c("chelonia.db/get",`_private_hidx=${e}#${t}`);if(r)return JSON.parse(r)},"chelonia/db/setEntryMeta":async(e,t,r)=>{let n=JSON.stringify(r);await c("chelonia.db/set",`_private_hidx=${e}#${t}`,n)},"chelonia/db/latestHEADinfo":async e=>{let t=await c("chelonia.db/get",Ya(e));return t&&JSON.parse(t)},"chelonia/db/deleteLatestHEADinfo":e=>c("chelonia.db/set",Ya(e),""),"chelonia/db/getEntry":async function(e){try{let t=await c("chelonia.db/get",e);if(!t)throw new Error(`no entry for ${e}!`);return v.deserialize(t,this.transientSecretKeys,void 0,this.config.unwrapMaybeEncryptedData)}catch(t){throw new bi(`${t.name} during getEntry: ${t.message}`)}},"chelonia/db/addEntry":function(e){return c("okTurtles.eventQueue/queueEvent",`chelonia/db/${e.contractID()}`,["chelonia/private/db/addEntry",e])},"chelonia/private/db/addEntry":async function(e){try{let{previousHEAD:t,previousKeyOp:r,height:n}=e.head(),o=e.contractID();if(await c("chelonia.db/get",e.hash()))return console.warn(`[chelonia.db] entry exists: ${e.hash()}`),e.hash();let i=await c("chelonia/db/latestHEADinfo",o);if(e.isFirstMessage()){if(i)throw console.error(`[chelonia.db] bad previousHEAD: ${t}! Expected: <null> for contractID: ${o}`),new Pr(`bad previousHEAD: ${t}. Expected <null> for contractID: ${o}`);if(n!==0)throw console.error(`[chelonia.db] bad height: ${n}! Expected: 0 for contractID: ${o}`),new Pr(`[chelonia.db] bad height: ${n}! Expected: 0 for contractID: ${o}`)}else{if(!i)throw new Error(`No latest HEAD for ${o} when attempting to process entry with previous HEAD ${t} at height ${n}`);let{HEAD:s,previousKeyOp:a,height:u}=i;if(t!==s)throw console.warn(`[chelonia.db] bad previousHEAD: ${t}! Expected: ${s} for contractID: ${o}`),new Pr(`bad previousHEAD: ${t}. Expected ${s} for contractID: ${o}`);if(r!==a)throw console.error(`[chelonia.db] bad previousKeyOp: ${r}! Expected: ${a} for contractID: ${o}`),new Pr(`bad previousKeyOp: ${r}. Expected ${a} for contractID: ${o}`);if(!Number.isSafeInteger(n)||n!==u+1)throw console.error(`[chelonia.db] bad height: ${n}! Expected: ${u+1} for contractID: ${o}`),new Pr(`[chelonia.db] bad height: ${n}! Expected: ${u+1} for contractID: ${o}`)}return await c("chelonia.db/set",e.hash(),e.serialize()),await c("chelonia.db/set",Ya(o),JSON.stringify({HEAD:e.hash(),previousKeyOp:e.isKeyOp()?e.hash():e.previousKeyOp(),height:e.height()})),console.debug(`[chelonia.db] HEAD for ${o} updated to:`,e.hash()),await c("chelonia/db/setEntryMeta",o,n,{hash:e.hash(),date:new Date().toISOString(),...e.isKeyOp()&&{isKeyOp:!0}}),e.hash()}catch(t){throw t.name.includes("ErrorDB")?t:new bi(`${t.name} during addEntry: ${t.message}`)}},"chelonia/db/lastEntry":async function(e){try{let t=await c("chelonia/db/latestHEADinfo",e);if(!t)throw new Error(`contract ${e} has no latest hash!`);return c("chelonia/db/getEntry",t.HEAD)}catch(t){throw new bi(`${t.name} during lastEntry: ${t.message}`)}}});var Fn=new WeakMap,ff=function(e,t,r,n){let o=e.signingKeyId(),i=null,s=this.config,a={signingKeyId:o,get signingContractID(){return $r(t,o,r)},get innerSigningKeyId(){if(i===null){let u=e.message(),f=s.unwrapMaybeEncryptedData(u);return f?.data&&Sr(f.data)?i=f.data.signingKeyId:i=void 0,i}},get innerSigningContractID(){return $r(t,a.innerSigningKeyId,r)},index:n};return a},qa=function(e,t,r){let n=e.map(i=>{let s=this.config.unwrapMaybeEncryptedData(i);if(s)return s.encryptionKeyId&&(s.data._private=s.encryptionKeyId),s.data}).filter(Boolean),o=pt(n);return Object.fromEntries(o.map(i=>{if(i._notBeforeHeight=t,r?.[i.id]){if(r[i.id]._notAfterHeight==null)throw new uc(`Cannot set existing unrevoked key: ${i.id}`);i._notBeforeHeight=Math.min(t,r[i.id]._notBeforeHeight??0)}else i._notBeforeHeight=t;return delete i._notAfterHeight,[i.id,i]}))},df=(e,t,r,n,o,i,s,a)=>{if(!a||!Array.isArray(t._volatile?.watch))return;let u=c(r.stateSelector),f=Object.create(null);t._volatile.watch.forEach(([d,h])=>{if(!(!n[d]||f[h]===null)){if(!f[h]){if(!u.contracts[h]?.type||!gt(u[h],[v.OP_KEY_UPDATE],["sig"])){f[h]=null;return}f[h]=[]}f[h].push(d)}}),Object.entries(f).forEach(([d,h])=>{if(!Array.isArray(h)||!h.length)return;let[g,E]=h.map(I=>{let C=u[d]?._vm?.authorizedKeys?.[n[I].oldKeyId];if(!C)return;let G=gt(u[d],o,["sig"],C.ringLevel);if(G)return[[I,C.name],G,u[d]._vm.authorizedKeys[G].ringLevel]}).filter(Boolean).reduce((I,[C,G,A])=>(I[0].push(C),A<I[2]?[I[0],G,A]:I),[[],void 0,Number.POSITIVE_INFINITY]);if(!E)return;let w=u.contracts[d]?.type;a?.push(()=>{c(i,{contractID:d,contractName:w,data:g.map(s).map(I=>I),signingKeyId:E}).catch(I=>{console.warn(`Error mirroring key operation (${i}) from ${e} to ${d}: ${I?.message||I}`)})})})},iI=c("sbp/selectors/register",{"chelonia/private/state":function(){return this.state},"chelonia/private/invoke":function(e,t){if(this._instance!==e){console.info("['chelonia/private/invoke] Not proceeding with invocation as Chelonia was restarted",{invocation:t});return}if(Array.isArray(t))return c(...t);if(typeof t=="function")return t();throw new TypeError(`[chelonia/private/invoke] Expected invocation to be an array or a function. Saw ${typeof t} instead.`)},"chelonia/private/queueEvent":function(e,t){return c("okTurtles.eventQueue/queueEvent",e,["chelonia/private/invoke",this._instance,t])},"chelonia/private/verifyManifestSignature":function(e,t,r){if(!q(r,"signature")||typeof r.signature.keyId!="string"||typeof r.signature.value!="string")throw new Error(`Invalid or missing signature field for manifest ${t} (named ${e})`);let n=c(this.config.stateSelector);q(n,"contractSigningKeys")||this.config.reactiveSet(n,"contractSigningKeys",Object.create(null));let o=`name:${e}`,i=!1;if(q(n.contractSigningKeys,o)){if(console.info(`[chelonia] verifying signature for ${t} with an existing key`),!q(n.contractSigningKeys[o],r.signature.keyId))throw console.error(`The manifest with ${t} (named ${e}) claims to be signed with a key with ID ${r.signature.keyId}, which is not trusted. The trusted key IDs for this name are:`,Object.keys(n.contractSigningKeys[o])),new Error(`Invalid or missing signature in manifest ${t} (named ${e}). It claims to be signed with a key with ID ${r.signature.keyId}, which has not been authorized for this contract before.`);let a=n.contractSigningKeys[o][r.signature.keyId];fo(a,r.body+r.head,r.signature.value),console.info(`[chelonia] successful signature verification for ${t} (named ${e}) using the already-trusted key ${r.signature.keyId}.`),i=!0}let s=JSON.parse(r.body);if(!i){if(console.info(`[chelonia] verifying signature for ${t} (named ${e}) for the first time`),!q(s,"signingKeys")||!Array.isArray(s.signingKeys))throw new Error(`Invalid manifest file ${t} (named ${e}). Its body doesn't contain a 'signingKeys' list'`);let a;try{a=Object.fromEntries(s.signingKeys.map(u=>[de(u),u]))}catch(u){throw console.error(`[chelonia] Error parsing the public keys list for ${t} (named ${e})`,u),u}if(!q(a,r.signature.keyId))throw new Error(`Invalid or missing signature in manifest ${t} (named ${e}). It claims to be signed with a key with ID ${r.signature.keyId}, which is not listed in its 'signingKeys' field.`);fo(a[r.signature.keyId],r.body+r.head,r.signature.value),console.info(`[chelonia] successful signature verification for ${t} (named ${e}) using ${r.signature.keyId}. The following key IDs will now be trusted for this contract name`,Object.keys(a)),i=!0,n.contractSigningKeys[o]=a}return s},"chelonia/private/loadManifest":async function(e,t){if(!e||typeof e!="string")throw new Error("Invalid or missing contract name");if(this.manifestToContract[t]){console.warn("[chelonia]: already loaded manifest",t);return}let r=await c("chelonia/out/fetchResource",t,{code:qt.SHELTER_CONTRACT_MANIFEST}),n=JSON.parse(r),o=c("chelonia/private/verifyManifestSignature",e,t,n);if(o.name!==e)throw new Error(`Mismatched contract name. Expected ${e} but got ${o.name}`);let i=this.config.contracts.defaults.preferSlim&&o.contractSlim||o.contract;console.info(`[chelonia] loading contract '${i.file}'@'${o.version}' from manifest: ${t}`);let s=await c("chelonia/out/fetchResource",i.hash,{code:qt.SHELTER_CONTRACT_TEXT}),a=(g,E)=>(g[E]=!0,g),u=["okTurtles.events/on","chelonia/defineContract","chelonia/out/keyRequest"].concat(this.config.contracts.defaults.allowedSelectors).reduce(a,{}),f=this.config.contracts.defaults.allowedDomains.reduce(a,{}),d=(g,...E)=>{let w=_o(g);if(g.startsWith(e+"/")&&(g=`${t}/${g}`),u[g]||f[w])return c(g,...E);throw console.error("[chelonia] selector not on allowlist",{selector:g,allowedSels:u,allowedDoms:f}),new Error(`[chelonia] selector not on allowlist: '${g}'`)},h=new Function(`
      return function (globals) {
        // almost a real sandbox
        // stops (() => this)().fetch
        // needs additional step of locking down Function constructor to stop:
        // new (()=>{}).constructor("console.log(typeof this.fetch)")()
        globals.self = globals
        globals.globalThis = globals
        with (new Proxy(globals, {
          get (o, p) { return o[p] },
          has (o, p) { /* console.log('has', p); */ return true }
        })) {
          (function () {
            'use strict'
            ${s}
          })()
        }
      }
    `)();if(this.defContractSBP=d,this.defContractManifest=t,h({crypto:{getRandomValues:g=>globalThis.crypto.getRandomValues(g)},...typeof window=="object"&&window&&{alert:window.alert.bind(window),confirm:window.confirm.bind(window),prompt:window.prompt.bind(window)},isNaN,console,Object,Error,TypeError,RangeError,Math,Symbol,Date,Array,BigInt,Boolean,Buffer,String,Number,Int8Array,Int16Array,Int32Array,Uint8Array,Uint16Array,Uint32Array,Float32Array,Float64Array,ArrayBuffer,JSON,RegExp,parseFloat,parseInt,Promise,Function,Map,WeakMap,...this.config.contracts.defaults.exposedGlobals,require:g=>g==="@sbp/sbp"?d:this.config.contracts.defaults.modules[g],sbp:d,fetchServerTime:async(g=!0)=>{try{let E=await this.config.fetch(`${this.config.connectionURL}/time`,{signal:this.abortController.signal});return rn("text")(E)}catch(E){if(console.warn("[fetchServerTime] Error",E),g)return new Date(c("chelonia/time")).toISOString();throw new dc("Can not fetch server time. Please check your internet connection.")}}}),e!==this.defContract.name)throw new Error(`Invalid contract name for manifest ${t}. Expected ${e} but got ${this.defContract.name}`);this.defContractSelectors.forEach(g=>{u[g]=!0}),this.manifestToContract[t]={slim:i===o.contractSlim,info:i,contract:this.defContract}},"chelonia/private/removeImmediately":function(e,t){let r=c(this.config.stateSelector),n=r.contracts[e]?.type;if(!n){console.error("[chelonia/private/removeImmediately] Missing contract name for contract",{contractID:e});return}let o=this.config.contracts.manifests[n];if(o){let i=`${o}/${n}/_cleanup`;if(c("sbp/selectors/fn",i))try{c(i,{contractID:e,resync:!!t?.resync,state:r[e]})}catch(s){console.error(`[chelonia/private/removeImmediately] Error at destructor for ${e}`,s)}}t?.resync?(Object.keys(r.contracts[e]).filter(i=>i!=="references").forEach(i=>this.config.reactiveDel(r.contracts[e],i)),Object.keys(r[e]).filter(i=>i!=="_volatile").forEach(i=>this.config.reactiveDel(r[e],i)),r[e]._volatile&&Object.keys(r[e]._volatile).filter(i=>i!=="watch").forEach(i=>this.config.reactiveDel(r[e]._volatile,i))):(delete this.ephemeralReferenceCount[e],t?.permanent?this.config.reactiveSet(r.contracts,e,null):this.config.reactiveDel(r.contracts,e),this.config.reactiveDel(r,e)),this.subscriptionSet.delete(e),c("okTurtles.events/emit",Tr,Array.from(this.subscriptionSet),{added:[],removed:[e],permanent:t?.permanent,resync:t?.resync})},"chelonia/private/noop":function(){},"chelonia/private/out/sync":function(e,t){let r=typeof e=="string"?[e]:e,n=!!t?.force;return Promise.all(r.map(o=>!n&&this.subscriptionSet.has(o)&&!c(this.config.stateSelector)[o]?._volatile?.dirty?c("chelonia/private/queueEvent",o,["chelonia/private/noop"]):c("chelonia/private/queueEvent",o,["chelonia/private/in/syncContract",o,t]).catch(i=>{throw console.error(`[chelonia] failed to sync ${o}:`,i),i})))},"chelonia/private/out/publishEvent":function(e,{maxAttempts:t=5,headers:r,billableContractID:n,bearer:o}={},i){let s=e.contractID(),a=e;return c("chelonia/private/queueEvent",`publish:${s}`,async()=>{let u=1,f;await i?.prepublish?.(e);let d=(h,g)=>{e.hash()===g.hash()&&(c("okTurtles.events/off",rr,d),i.onprocessed(e))};for(typeof i?.onprocessed=="function"&&c("okTurtles.events/on",rr,d);;){f=e.height();let h=await c("chelonia/private/queueEvent",s,async()=>{let E=c(this.config.stateSelector),w=E[s],I=e.isFirstMessage();if(!w&&!I){console.info(`[chelonia] Not sending message as contract state has been removed: ${e.description()}`);return}if(i?.preSendCheck&&!await i.preSendCheck(e,w)){console.info(`[chelonia] Not sending message as preSendCheck hook returned non-truish value: ${e.description()}`);return}return await c("chelonia/private/in/processMessage",e,pt(w||{})),I?e:El(e,w,E.contracts[s])});if(!h)return;await i?.beforeRequest?.(h,e),e=h;let g=await this.config.fetch(`${this.config.connectionURL}/event`,{method:"POST",body:e.serialize(),headers:{...r,...o&&{Authorization:`Bearer ${o}`},...n&&{Authorization:mr.call(this,n)},"Content-Type":"text/plain"},signal:this.abortController.signal});if(g.ok)return await i?.postpublish?.(e),e;try{if(g.status===409){if(u+1>t)throw console.error(`[chelonia] failed to publish ${e.description()} after ${u} attempts`,e),new Error(`publishEvent: ${g.status} - ${g.statusText}. attempt ${u}`);let E=Pn(0,1500);console.warn(`[chelonia] publish attempt ${u} of ${t} failed. Waiting ${E} msec before resending ${e.description()}`),u+=1,await Bi(E),!e.isFirstMessage()&&e.height()===f&&await c("chelonia/private/out/sync",s,{force:!0})}else{let E=(await g.json())?.message;throw console.error(`[chelonia] ERROR: failed to publish ${e.description()}: ${g.status} - ${g.statusText}: ${E}`,e),new Error(`publishEvent: ${g.status} - ${g.statusText}: ${E}`)}}catch(E){throw c("okTurtles.events/off",rr,d),E}}}).then(u=>(c("okTurtles.events/emit",ul,{contractID:s,message:u,originalMessage:a}),u)).catch(u=>{throw c("okTurtles.events/emit",ll,{contractID:s,message:e,originalMessage:a,error:u}),u})},"chelonia/private/out/latestHEADinfo":function(e){return this.config.fetch(`${this.config.connectionURL}/latestHEADinfo/${e}`,{cache:"no-store",signal:this.abortController.signal}).then(rn("json"))},"chelonia/private/postKeyShare":function(e,t,r){let o=c(this.config.stateSelector)[e];o&&(t&&q(t,"watch")&&(o._volatile||this.config.reactiveSet(o,"_volatile",Object.create(null)),o._volatile.watch?o._volatile.watch!==t.watch&&t.watch.forEach(i=>{o._volatile.watch.some(s=>s[0]===i[0]&&s[1]===i[1])||o._volatile.watch.push(i)}):this.config.reactiveSet(o._volatile,"watch",t.watch)),Array.isArray(o._volatile?.pendingKeyRequests)&&this.config.reactiveSet(o._volatile,"pendingKeyRequests",o._volatile.pendingKeyRequests.filter(i=>i?.name!==r.name)))},"chelonia/private/in/processMessage":async function(e,t,r,n){let[o,i]=e.op(),s=e.hash(),a=e.height(),u=e.contractID(),f=e.manifest(),d=e.signingKeyId(),h=e.direction(),g=this.config,E=this,w=Object.entries(v).find(([,A])=>A===o)?.[0];if(console.debug("PROCESSING OPCODE:",w,"to",u),t?._volatile?.dirty){console.debug("IGNORING OPCODE BECAUSE CONTRACT STATE IS MARKED AS DIRTY.","OPCODE:",w,"CONTRACT:",u);return}t._vm||(t._vm=Object.create(null));let I={async[v.OP_ATOMIC](A){for(let R=0;R<A.length;R++){let O=A[R];try{if(O[0]===v.OP_ATOMIC)throw new Error("Cannot nest OP_ATOMIC");if(!Ia(e,g,t,d,O[0],O[1]))throw new Error("Inside OP_ATOMIC: no matching signing key was defined");await I[O[0]](O[1])}catch(F){let P=F;if(P&&typeof P=="object"){if(P.name==="ChelErrorDecryptionKeyNotFound"){if(console.warn(`[chelonia] [OP_ATOMIC] WARN '${P.name}' in processMessage for ${e.description()}: ${P.message}`,P,e.serialize()),P.cause){let W=Fn.get(e);W?W.add(P.cause):Fn.set(e,new Set([P.cause]))}continue}else yr(e,`[chelonia] [OP_ATOMIC] ERROR '${P.name}' in processMessage for ${e.description()}: ${P.message||P}`,P,e.serialize());if(console.warn(`[chelonia] [OP_ATOMIC] Error processing ${e.description()}: ${e.serialize()}. Any side effects will be skipped!`),g.strictProcessing)throw P;if(g.hooks.processError?.(P,e,ff.call(E,e,u,t)),P.name==="ChelErrorWarning")continue}else yr(e,"Inside OP_ATOMIC: Non-object or null error thrown",u,e,R,P);throw P}}},[v.OP_CONTRACT](A){t._vm.type=A.type;let R=qa.call(E,A.keys,a);t._vm.authorizedKeys=R,ss.call(E,e,s,A.keys,t,u,G,r)},[v.OP_ACTION_ENCRYPTED](A){if(g.skipActionProcessing){g.skipDecryptionAttempts||console.log("OP_ACTION_ENCRYPTED: skipped action processing");return}return I[v.OP_ACTION_UNENCRYPTED](A.valueOf())},async[v.OP_ACTION_UNENCRYPTED](A){if(!g.skipActionProcessing){let R;Sr(A)&&(R=A.signingKeyId,A=A.valueOf());let{data:O,meta:F,action:P}=A;if(!g.whitelisted(P))throw new Error(`chelonia: action not whitelisted: '${P}'`);await c(`${f}/${P}/process`,{data:O,meta:F,hash:s,height:a,contractID:u,direction:e.direction(),signingKeyId:d,get signingContractID(){return $r(u,d,t)},innerSigningKeyId:R,get innerSigningContractID(){return $r(u,R,t)}},t)}},[v.OP_KEY_SHARE](A){let R=g.unwrapMaybeEncryptedData(A);if(!R)return;let O=R.data;for(let F of O.keys)F.id&&F.meta?.private?.content&&(q(t._vm,"sharedKeyIds")||(t._vm.sharedKeyIds=[]),t._vm.sharedKeyIds.some(P=>P.id===F.id)||t._vm.sharedKeyIds.push({id:F.id,contractID:O.contractID,height:a,keyRequestHash:O.keyRequestHash,keyRequestHeight:O.keyRequestHeight}));q(O,"keyRequestHash")&&t._vm.authorizedKeys[d].meta?.keyRequest&&(t._vm.authorizedKeys[d].meta.keyRequest.responded=s),r?.push(async()=>{delete E.postSyncOperations[u]?.["pending-keys-for-"+O.contractID];let F=c(E.config.stateSelector),P=F[O.contractID],W=F.contracts[O.contractID]?.missingDecryptionKeyIds,ce=Number.POSITIVE_INFINITY;for(let we of O.keys)if(we.id&&we.meta?.private?.content){let he=h==="outgoing"||we.meta.private.transient;if(!c("chelonia/haveSecretKey",we.id,!he))try{let $e=we.meta.private.content.valueOf();c("chelonia/storeSecretKeys",new Ze([{key:He($e),transient:he}])),W?.includes(we.id)?ce=Number.NEGATIVE_INFINITY:P?._vm?.authorizedKeys?.[we.id]?._notBeforeHeight!=null&&Array.isArray(P._vm.authorizedKeys[we.id].purpose)&&P._vm.authorizedKeys[we.id].purpose.includes("enc")&&(ce=Math.min(ce,P._vm.authorizedKeys[we.id]._notBeforeHeight))}catch($e){let Pe=$e;Pe?.name==="ChelErrorDecryptionKeyNotFound"?console.warn(`OP_KEY_SHARE (${s} of ${u}) missing secret key: ${Pe.message}`,Pe):console.error(`OP_KEY_SHARE (${s} of ${u}) error '${Pe.message||Pe}':`,Pe)}}let Oe=ce<F.contracts[O.contractID]?.height;if(Oe){if(q(P,"_volatile")||g.reactiveSet(P,"_volatile",Object.create(null)),g.reactiveSet(P._volatile,"dirty",!0),!Object.keys(P).some($e=>$e!=="_volatile"))return;let we=Object.create(null);P._volatile?.watch?.forEach(([$e,Pe])=>{if(!we[$e]){we[$e]=[Pe];return}we[$e].push(Pe)});let he=Array.from(new Set(Object.entries(we).flatMap(([$e,Pe])=>{let et=ze(P,$e);return et&&P._vm.authorizedKeys[et].purpose.includes("enc")&&P._vm.authorizedKeys[et]._notBeforeHeight>=ce?Pe:[]})));if(he.forEach($e=>{let Pe=F[$e];Pe&&(q(Pe,"_volatile")||g.reactiveSet(Pe,"_volatile",Object.create(null)),g.reactiveSet(Pe._volatile,"dirty",!0))}),E.subscriptionSet.has(O.contractID)){let $e=c("chelonia/private/queueEvent",O.contractID,["chelonia/private/in/syncContract",O.contractID]).then(()=>{c("chelonia/private/out/sync",he.filter(Pe=>E.subscriptionSet.has(Pe)),{force:!0,resync:!0}).catch(Pe=>{console.error("[chelonia] Error resyncing contracts with foreign key references after key rotation",Pe)})}).catch(Pe=>{if(console.error(`[chelonia] Error during sync for ${O.contractID} during OP_KEY_SHARE for ${u}`),O.contractID===u)throw Pe});O.contractID!==u&&await $e}}let xe=P?._volatile;c("chelonia/private/queueEvent",O.contractID,["chelonia/private/postKeyShare",O.contractID,Oe?xe:null,G]).then(()=>{c("chelonia/private/queueEvent",u,()=>{c("okTurtles.events/emit",is,{contractID:O.contractID,sharedWithContractID:u,signingKeyId:d,get signingKeyName(){return t._vm?.authorizedKeys?.[d]?.name}})}).catch(we=>{console.error(`[chelonia] Error while emitting the CONTRACT_HAS_RECEIVED_KEYS event for ${u}`,we)})})})},[v.OP_KEY_REQUEST](A){let R=g.unwrapMaybeEncryptedData(A),O=R?.data||{contractID:"(private)",replyWith:{context:void 0},request:"*"},F=O.contractID;if(t._vm?.invites?.[d]?.quantity!=null)if(t._vm.invites[d].quantity>0)--t._vm.invites[d].quantity<=0&&(t._vm.invites[d].status=en.USED);else{yr(e,"Ignoring OP_KEY_REQUEST because it exceeds allowed quantity: "+F);return}if(t._vm?.invites?.[d]?.expires!=null&&t._vm.invites[d].expires<Date.now()){yr(e,"Ignoring OP_KEY_REQUEST because it expired at "+t._vm.invites[d].expires+": "+F);return}if(g.skipActionProcessing||h==="outgoing")return;if(!q(O.replyWith,"context")){yr(e,"Ignoring OP_KEY_REQUEST because it is missing the context attribute");return}let P=O.replyWith.context;if(R&&(!Array.isArray(P)||P[0]!==F)){yr(e,"Ignoring OP_KEY_REQUEST because it is signed by the wrong contract");return}if(O.request!=="*"){yr(e,"Ignoring OP_KEY_REQUEST because it has an unsupported request attribute",O.request);return}t._vm.pendingKeyshares||(t._vm.pendingKeyshares=Object.create(null)),t._vm.pendingKeyshares[e.hash()]=P?[!!R?.encryptionKeyId,e.height(),d,P]:[!!R?.encryptionKeyId,e.height(),d],R&&r?.push(()=>{E.setPostSyncOp(u,"respondToAllKeyRequests-"+e.contractID(),["chelonia/private/respondToAllKeyRequests",u])})},[v.OP_KEY_REQUEST_SEEN](A){if(g.skipActionProcessing)return;let R=g.unwrapMaybeEncryptedData(A);if(!R)return;let O=R.data;if(t._vm.pendingKeyshares&&O.keyRequestHash in t._vm.pendingKeyshares){let F=O.keyRequestHash,P=t._vm.pendingKeyshares[F];if(delete t._vm.pendingKeyshares[F],P.length!==4)return;let W=P[2],ce=P[3][0];Array.isArray(t._vm?.invites?.[W]?.responses)&&t._vm?.invites?.[W]?.responses.push(ce),q(t._vm,"keyshares")||(t._vm.keyshares=Object.create(null));let Oe=O.success;t._vm.keyshares[F]={contractID:ce,height:a,success:Oe,...Oe&&{hash:O.keyShareHash}}}},[v.OP_PROP_DEL]:pf,[v.OP_PROP_SET](A){t._vm.props||(t._vm.props={}),t._vm.props[A.key]=A.value},[v.OP_KEY_ADD](A){let R=qa.call(E,A,a,t._vm.authorizedKeys);Object.values(A).forEach(F=>{if(q(t._vm.authorizedKeys,F.id)&&t._vm.authorizedKeys[F.id]._notAfterHeight==null)throw new Ei("Cannot use OP_KEY_ADD on existing keys. Key ID: "+F.id)}),Sa.call(E,u,G,t,A),t._vm.authorizedKeys={...t._vm.authorizedKeys,...R},ss.call(E,e,s,A,t,u,G,r)},[v.OP_KEY_DEL](A){t._vm.authorizedKeys||(t._vm.authorizedKeys=Object.create(null)),t._volatile||(t._volatile=Object.create(null)),t._volatile.pendingKeyRevocations||(t._volatile.pendingKeyRevocations=Object.create(null)),yl.call(E,u,G,t,A);let R=A.map(O=>{let F=g.unwrapMaybeEncryptedData(O);if(F)return F.data}).filter(O=>!O||typeof O!="string"?!1:!q(t._vm.authorizedKeys,O)||t._vm.authorizedKeys[O]._notAfterHeight!=null?(console.warn("Attempted to delete non-existent key from contract",{contractID:u,keyId:O}),!1):!0);if(R.forEach(O=>{let F=t._vm.authorizedKeys[O];if(t._vm.authorizedKeys[O]._notAfterHeight=a,q(t._volatile.pendingKeyRevocations,O)&&delete t._volatile.pendingKeyRevocations[O],F.foreignKey){let P=new URL(F.foreignKey),W=P.pathname,ce=P.searchParams.get("keyName");if(!W||!ce)throw new Error("Invalid foreign key: missing contract or key name");r?.push(()=>{c("chelonia/private/queueEvent",W,()=>{let xe=c(g.stateSelector);if(Array.isArray(xe[W]?._volatile?.watch)){let we=xe[W]._volatile.watch;xe[W]._volatile.watch=we.filter(([he,$e])=>he!==ce||$e!==u),we.length!==xe[W]._volatile.watch.length&&c("chelonia/contract/release",W,{try:!0}).catch(he=>{console.error(`[chelonia] Error at OP_KEY_DEL internalSideEffectStack while attempting to release foreign contract ${W}`,he)})}}).catch(xe=>{console.error("Error stopping watching events after removing key",{contractID:u,foreignContract:W,foreignKeyName:ce,fkUrl:P},xe)})});let Oe=t._vm.pendingWatch?.[W];Oe&&(t._vm.pendingWatch[W]=Oe.filter(([,xe])=>xe!==O))}F.name.startsWith("#inviteKey-")&&t._vm.invites[F.id]&&(t._vm.invites[F.id].status=en.REVOKED)}),Array.isArray(t._volatile?.watch)){let O=Object.create(null);R.forEach(F=>{O[t._vm.authorizedKeys[F].name]={name:t._vm.authorizedKeys[F].name,oldKeyId:F}}),df(u,t,g,O,[v.OP_KEY_DEL],"chelonia/out/keyDel",F=>O[F[0]].oldKeyId,r)}},[v.OP_KEY_UPDATE](A){t._volatile||(t._volatile=Object.create(null)),t._volatile.pendingKeyRevocations||(t._volatile.pendingKeyRevocations=Object.create(null));let[R,O]=ml.call(E,u,G,t,A),F=Object.values(O);for(let P of F)q(t._volatile.pendingKeyRevocations,P)&&delete t._volatile.pendingKeyRevocations[P],t._vm.authorizedKeys[P]._notAfterHeight=a;for(let P of R)q(t._vm.authorizedKeys,P.id)||(P._notBeforeHeight=a,t._vm.authorizedKeys[P.id]=pt(P));if(ss.call(E,e,s,R,t,u,G,r),Array.isArray(t._volatile?.watch)){let P=Object.create(null);R.forEach(W=>{W.data&&(P[W.name]=pt(W),P[W.name].oldKeyId=O[W.id])}),df(u,t,g,P,[v.OP_KEY_UPDATE],"chelonia/out/keyUpdate",W=>({name:W[1],oldKeyId:P[W[0]].oldKeyId,id:P[W[0]].id,data:P[W[0]].data}),r)}},[v.OP_PROTOCOL_UPGRADE]:pf};if(!this.config.skipActionProcessing&&!this.manifestToContract[f]){let A=c(this.config.stateSelector);if(n||(n=q(A.contracts,u)&&A.contracts[u]&&q(A.contracts[u],"type")?A.contracts[u].type:o===v.OP_CONTRACT?i.type:""),!n)throw new Error(`Unable to determine the name for a contract and refusing to load it (contract ID was ${u} and its manifest hash was ${f})`);await c("chelonia/private/loadManifest",n,f)}let C=!0;g.preOp&&(C=g.preOp(e,t)!==!1&&C);let G;{let A=o===v.OP_CONTRACT&&!t?._vm?.authorizedKeys?{_vm:{authorizedKeys:qa.call(this,i.keys,a)}}:t;if(!Ia(e,g,A,d,o,i))throw new Error("No matching signing key was defined");G=A._vm.authorizedKeys[d]}g[`preOp_${o}`]&&(C=g[`preOp_${o}`](e,t)!==!1&&C),C&&(await I[o](i),g.postOp?.(e,t),g[`postOp_${o}`]?.(e,t))},"chelonia/private/in/enqueueHandleEvent":function(e,t){return c("chelonia/private/queueEvent",e,async()=>{await c("chelonia/private/in/handleEvent",e,t),c("chelonia/private/enqueuePostSyncOps",e)})},"chelonia/private/in/syncContract":async function(e,t){let r=c(this.config.stateSelector);if(r.contracts[e]===null)throw new Vr("Cannot sync permanently deleted contract "+e);try{this.currentSyncs[e]={firstSync:!r.contracts[e]?.type},c("okTurtles.events/emit",Wo,e,!0);let n=r[e]?._volatile||Object.create(null);(n?.dirty||t?.resync)&&(delete n.dirty,n.resyncing=!0,c("chelonia/private/removeImmediately",e,{resync:!0}),this.config.reactiveSet(r,e,Object.create(null)),this.config.reactiveSet(r[e],"_volatile",n));let{HEAD:o}=await c("chelonia/out/latestHEADInfo",e);console.debug(`[chelonia] syncContract: ${e} latestHash is: ${o}`);let{HEAD:i,height:s}=r.contracts[e]||{},a=this.subscriptionSet.has(e);if(a||this.pending.find(f=>f?.contractID===e)||this.pending.push({contractID:e}),this.postSyncOperations[e]=this.postSyncOperations[e]??Object.create(null),o!==i){console.debug(`[chelonia] Synchronizing Contract ${e}: our recent was ${i||"undefined"} but the latest is ${o}`);let u=c("chelonia/out/eventsAfter",e,s??0,void 0,i??e),f=!1,d=u.getReader();for(let h=q(r.contracts,e)&&q(r.contracts[e],"HEAD");;h=!1){let{done:g,value:E}=await d.read();if(g){if(!f)throw new xi(`expected hash ${o} in list of events for contract ${e}`);break}f||(f=v.deserializeHEAD(E).hash===o),!h&&await c("chelonia/private/in/handleEvent",e,E)}}else if(a)console.debug(`[chelonia] contract ${e} was already synchronized`);else{this.subscriptionSet.add(e),c("okTurtles.events/emit",Tr,Array.from(this.subscriptionSet),{added:[e],removed:[]});let u=this.pending.findIndex(f=>f?.contractID===e);u!==-1&&this.pending.splice(u,1),console.debug(`[chelonia] added already synchronized ${e} to subscription set`)}c("chelonia/private/enqueuePostSyncOps",e)}catch(n){throw console.error(`[chelonia] syncContract error: ${n.message||n}`,n),this.config.hooks.syncContractError?.(n,e),n}finally{r[e]?._volatile?.resyncing&&this.config.reactiveDel(r[e]._volatile,"resyncing"),delete this.currentSyncs[e],c("okTurtles.events/emit",Wo,e,!1)}},"chelonia/private/enqueuePostSyncOps":function(e){q(this.postSyncOperations,e)&&Object.entries(this.postSyncOperations[e]).forEach(([t,r])=>{delete this.postSyncOperations[e][t],c("chelonia/private/queueEvent",e,r).catch(n=>{console.error(`Post-sync operation for ${e} failed`,{contractID:e,op:r,error:n})})})},"chelonia/private/watchForeignKeys":function(e){let r=c(this.config.stateSelector)[e],n=r?._vm?.pendingWatch;if(!n||!Object.keys(n).length)return;if(!!!gt(r,[v.OP_KEY_DEL],["sig"])){console.info("[chelonia/private/watchForeignKeys]: Returning as operations cannot be mirrored",{externalContractID:e});return}Object.entries(n).forEach(([s,a])=>{if(!Array.isArray(a)||!a.reduce((u,[,f])=>u||q(r._vm.authorizedKeys,f),!1)){console.info("[chelonia/private/watchForeignKeys]: Skipping as none of the keys to watch exist",{externalContractID:e,contractID:s});return}c("chelonia/private/queueEvent",s,["chelonia/private/in/syncContractAndWatchKeys",s,e]).catch(u=>{console.error(`Error at syncContractAndWatchKeys for contractID ${s} and externalContractID ${e}`,u)})})},"chelonia/private/in/syncContractAndWatchKeys":async function(e,t){let r=c(this.config.stateSelector),n=r[t],o=n?._vm?.pendingWatch?.[e]?.splice(0);if(!Array.isArray(o)||!o.reduce((u,[,f])=>u||q(n._vm.authorizedKeys,f)&&ze(n,n._vm.authorizedKeys[f].name)!=null,!1)){console.info("[chelonia/private/syncContractAndWatchKeys]: Skipping as none of the keys to watch exist",{externalContractID:t,contractID:e});return}this.subscriptionSet.has(e)||await c("chelonia/private/in/syncContract",e);let i=r[e],s=[],a=[];o.forEach(([u,f])=>{let d=ze(i,u);if(d)d!==f&&a.push(f);else{s.push(f);return}i._volatile?(i._volatile.watch||this.config.reactiveSet(i._volatile,"watch",[[u,t]]),Array.isArray(i._volatile.watch)&&!i._volatile.watch.find(h=>h[0]===u&&h[1]===t)&&i._volatile.watch.push([u,t])):this.config.reactiveSet(i,"_volatile",Object.create(null,{watch:{value:[[u,t]],configurable:!0,enumerable:!0,writable:!0}}))}),(s.length||a.length)&&(n._volatile||this.config.reactiveSet(n,"_volatile",Object.create(null)),n._volatile.pendingKeyRevocations||this.config.reactiveSet(n._volatile,"pendingKeyRevocations",Object.create(null)),s.forEach(u=>this.config.reactiveSet(n._volatile.pendingKeyRevocations,u,"del")),a.forEach(u=>this.config.reactiveSet(n._volatile.pendingKeyRevocations,u,!0)),c("chelonia/private/queueEvent",t,["chelonia/private/deleteOrRotateRevokedKeys",t]).catch(u=>{console.error(`Error at deleteOrRotateRevokedKeys for contractID ${e} and externalContractID ${t}`,u)}))},"chelonia/private/deleteOrRotateRevokedKeys":function(e){let t=c(this.config.stateSelector),r=t[e],n=r?._volatile?.pendingKeyRevocations;if(!n||Object.keys(n).length===0)return;let o=Object.entries(n).filter(([,d])=>d===!0).map(([d])=>d),[,i,s]=o.reduce((d,h)=>{let g=r._vm?.authorizedKeys?.[h];if(!g||!g.foreignKey)return d;let E=String(g.foreignKey),w=new URL(E),I=w.pathname,C=w.searchParams.get("keyName");if(!C)throw new Error("Missing foreign key name");let G=t[I];if(!G)return d;let A=ze(G,C);if(!A)return n[h]===!0&&this.config.reactiveSet(n,h,"del"),d;let[R,O,F]=d,P=Math.min(R,g.ringLevel??Number.POSITIVE_INFINITY);if(P>=R)return F.push({name:g.name,oldKeyId:h,id:A,data:G._vm.authorizedKeys[A].data}),[R,O,F];if(Number.isFinite(P)){let W=gt(r,[v.OP_KEY_UPDATE],["sig"],P);if(W)return F.push({name:g.name,oldKeyId:h,id:A,data:G._vm.authorizedKeys[A].data}),[P,W,F]}return d},[Number.POSITIVE_INFINITY,"",[]]);if(s.length!==0){let d=r._vm.type;c("chelonia/out/keyUpdate",{contractID:e,contractName:d,data:s,signingKeyId:i}).catch(h=>{console.error(`[chelonia/private/deleteOrRotateRevokedKeys] Error sending OP_KEY_UPDATE for ${e}`,h.message)})}let a=Object.entries(n).filter(([,d])=>d==="del").map(([d])=>d),[,u,f]=a.reduce((d,h)=>{let[g,E,w]=d,I=Math.min(g,r._vm?.authorizedKeys?.[h]?.ringLevel??Number.POSITIVE_INFINITY);if(I>=g)return w.push(h),[g,E,w];if(Number.isFinite(I)){let C=gt(r,[v.OP_KEY_DEL],["sig"],I);if(C)return w.push(h),[I,C,w]}return d},[Number.POSITIVE_INFINITY,"",[]]);if(f.length!==0){let d=r._vm.type;c("chelonia/out/keyDel",{contractID:e,contractName:d,data:f,signingKeyId:u}).catch(h=>{console.error(`[chelonia/private/deleteRevokedKeys] Error sending OP_KEY_DEL for ${e}`,h.message)})}},"chelonia/private/respondToAllKeyRequests":function(e){let r=c(this.config.stateSelector)[e]??{},n=r?._vm?.pendingKeyshares;if(!n)return;let o=gt(r,[v.OP_ATOMIC,v.OP_KEY_REQUEST_SEEN,v.OP_KEY_SHARE],["sig"]);if(!o){console.log("Unable to respond to key request because there is no suitable secret key with OP_KEY_REQUEST_SEEN permission");return}Object.entries(n).map(([i,s])=>{if(!Array.isArray(s)||s.length!==4)return;let[,,,[a]]=s;return c("chelonia/private/queueEvent",a,["chelonia/private/respondToKeyRequest",e,o,i]).catch(u=>{console.error(`respondToAllKeyRequests: Error responding to key request ${i} from ${a} to ${e}`,u)})})},"chelonia/private/respondToKeyRequest":async function(e,t,r){let n=c(this.config.stateSelector),o=n[e],i=o?._vm?.pendingKeyshares?.[r],s=this._instance;if(!Array.isArray(i)||i.length!==4)return;let[a,u,,[f,d,h,g]]=i;i.pop();let E=!!o._vm.authorizedKeys?.[t]?._private;if(await c("chelonia/private/in/syncContract",f),s!==this._instance)return;let w=n[f],I=n.contracts[e].type,C=w._vm.type,G=_r(f,w,d,h,g).valueOf(),{encryptionKeyId:A}=G,R=Br(e,o,G.responseKey,u,this.transientSecretKeys,g).valueOf(),O=He(R),F=de(O);Promise.resolve().then(()=>{if(s!==this._instance)return;if(!q(w._vm.authorizedKeys,F)||w._vm.authorizedKeys[F]._notAfterHeight!=null)throw new Error(`Unable to respond to key request for ${f}. Key ${F} is not valid.`);c("chelonia/storeSecretKeys",new Ze([{key:O}]));let P=Po(n.secretKeys,Object.entries(o._vm.authorizedKeys).filter(([,ce])=>!!ce.meta?.private?.shareable).map(([ce])=>ce));if(!P||Object.keys(P).length===0){console.info("respondToAllKeyRequests: no keys to share",{contractID:e,originatingContractID:f});return}let W={contractID:e,keys:Object.entries(P).map(([ce,Oe])=>({id:ce,meta:{private:{content:ke(f,A,Oe),shareable:!0}}})),keyRequestHash:r,keyRequestHeight:u};if(o?._vm?.pendingKeyshares?.[r])return W}).then(P=>{if(!(s!==this._instance||!P))return c("chelonia/out/keyShare",{contractID:f,contractName:C,data:a?ke(f,go(w,[v.OP_KEY_SHARE],["enc"])?.[0]||"",P):P,signingKeyId:F}).then(W=>{if(s!==this._instance)return;let ce={keyRequestHash:r,keyShareHash:W.hash(),success:!0},Oe={contractID:f,keys:[{id:F,meta:{private:{content:ke(e,go(o,[v.OP_KEY_REQUEST_SEEN],["enc"])?.[0]||"",R),shareable:!0}}}]};c("chelonia/out/atomic",{contractID:e,contractName:I,signingKeyId:t,data:[["chelonia/out/keyRequestResponse",{data:E?ke(e,go(o,[v.OP_KEY_REQUEST_SEEN],["enc"])?.[0]||"",ce):ce}],["chelonia/out/keyShare",{data:a?ke(e,go(o,[v.OP_KEY_SHARE],["enc"])?.[0]||"",Oe):Oe}]]}).catch(xe=>{console.error("Error at respondToKeyRequest while sending keyRequestResponse",xe)})})}).catch(P=>{console.error("Error at respondToKeyRequest",P);let W={keyRequestHash:r,success:!1};o?._vm?.pendingKeyshares?.[r]&&c("chelonia/out/keyRequestResponse",{contractID:e,contractName:I,signingKeyId:t,data:E?ke(e,go(o,[v.OP_KEY_REQUEST_SEEN],["enc"])?.[0]||"",W):W}).catch(ce=>{console.error("Error at respondToKeyRequest while sending keyRequestResponse in error handler",ce)})})},"chelonia/private/in/handleEvent":async function(e,t){let r=c(this.config.stateSelector),{preHandleEvent:n,postHandleEvent:o,handleEventError:i}=this.config.hooks,s=!1,a;try{if(!this.config.acceptAllMessages&&!this.pending.some(h=>h?.contractID===e)&&!this.subscriptionSet.has(e)){console.warn(`[chelonia] WARN: ignoring unexpected event for ${e}:`,t);return}let u=r[e]?pt(r[e]):Object.create(null);if(a=v.deserialize(t,this.transientSecretKeys,u,this.config.unwrapMaybeEncryptedData),a.contractID()!==e)throw new Error(`[chelonia] Wrong contract ID. Expected ${e} but got ${a.contractID()}`);if(!a.isFirstMessage()&&(!q(r.contracts,e)||!q(r,e)))throw new zn("The event is not for a first message but the contract state is missing");if(n?.(a),Es.checkMessageOrdering.call(this,a)===!1)return;if(r[e]?._volatile?.dirty){console.info(`[chelonia] Ignoring message ${a.description()} as the contract is marked as dirty`);return}let d=this.config.skipSideEffects?void 0:[];Fn.delete(a);try{await Es.processMutation.call(this,a,u,d)}catch(h){let g=h;if(g?.name==="ChelErrorDecryptionKeyNotFound"){if(console.warn(`[chelonia] WARN '${g.name}' in processMutation for ${a.description()}: ${g.message}`,g,a.serialize()),g.cause){let E=Fn.get(a);E?E.add(g.cause):Fn.set(a,new Set([g.cause]))}}else console.error(`[chelonia] ERROR '${g.name}' in processMutation for ${a.description()}: ${g.message||g}`,g,a.serialize());if(console.warn(`[chelonia] Error processing ${a.description()}: ${a.serialize()}. Any side effects will be skipped!`),this.config.strictProcessing||(s=g?.name!=="ChelErrorWarning",this.config.hooks.processError?.(g,a,ff.call(this,a,e,u)),g.name==="ChelErrorUnrecoverable"||g.name==="ChelErrorForkedChain"||a.isFirstMessage()))throw g}s||(Array.isArray(d)&&d.length>0&&await Promise.all(d.map(h=>Promise.resolve(h({state:u,message:a})).catch(g=>{let E=g;console.error(`[chelonia] ERROR '${E.name}' in internal side effect for ${a.description()}: ${E.message}`,E,{message:a.serialize()})}))),!this.config.skipActionProcessing&&!this.config.skipSideEffects&&await Es.processSideEffects.call(this,a,u)?.catch(h=>{let g=h;console.error(`[chelonia] ERROR '${g.name}' in sideEffect for ${a.description()}: ${g.message}`,g,{message:a.serialize()}),this.config.hooks.sideEffectError?.(g,a)}));try{let h=c(this.config.stateSelector);await Es.applyProcessResult.call(this,{message:a,state:h,contractState:u,processingErrored:s,postHandleEvent:o})}catch(h){let g=h;console.error(`[chelonia] ERROR '${g.name}' for ${a.description()} marking the event as processed: ${g.message}`,g,{message:a.serialize()})}}catch(u){let f=u;console.error(`[chelonia] ERROR in handleEvent: ${f.message||f}`,f);try{i?.(f,a)}catch(d){console.error("[chelonia] Ignoring user error in handleEventError hook:",d)}throw f}finally{a&&Fn.delete(a)}}}),oi=[],Wh=so(e=>c("chelonia/private/out/sync",e,{force:!0}).catch(t=>{console.error(`[chelonia] Error at reprocessDebounced for ${e}`,t)}),1e3),Es={checkMessageOrdering(e){let t=e.contractID(),r=e.hash(),n=e.height(),i=c(this.config.stateSelector).contracts[t]?.height;if(!Number.isSafeInteger(n))throw new Pr(`Message ${r} in contract ${t} has an invalid height.`);if(e.isFirstMessage()?i!=null:!(i<n)){if(!this.config.strictOrdering)return!1;throw new cc(`Message ${r} with height ${n} in contract ${t} has already been processed. Current height: ${i}.`)}if(i+1<n){if(this.config.strictOrdering)throw new Pr(`Unexpected message ${r} with height ${n} in contract ${t}: height is too high. Current height: ${i}.`);if(oi.length>100)throw new zn("more than 100 different bad previousHEAD errors");if(oi.includes(r))throw console.error(`[chelonia] ERROR already attempted to reingest ${e.description()}, will not attempt again!`),new Pr(`Already attempted to reingest ${r}`);return console.warn(`[chelonia] WARN bad previousHEAD for ${e.description()}, will attempt to re-sync contract to reingest message`),oi.push(r),Wh(t),!1}let s=oi.indexOf(r);s!==-1&&(console.warn(`[chelonia] WARN: successfully reingested ${e.description()}`),oi.splice(s,1))},async processMutation(e,t,r){let n=e.contractID();if(e.isFirstMessage()&&Object.keys(t).some(o=>o!=="_volatile"))throw new zn(`state for ${n} is already set`);await c("chelonia/private/in/processMessage",e,t,r)},processSideEffects(e,t){let r=e.opType();if(![v.OP_ATOMIC,v.OP_ACTION_ENCRYPTED,v.OP_ACTION_UNENCRYPTED].includes(r))return;let n=e.contractID(),o=e.manifest(),i=e.hash(),s=e.height(),a=e.signingKeyId(),u=async g=>{let E=this.config.unwrapMaybeEncryptedData(g);if(!E)return;let w=E.data,I;Sr(w)&&(I=w.signingKeyId,w=w.valueOf());let{action:C,data:G,meta:A}=w,R={data:G,meta:A,hash:i,height:s,contractID:n,description:e.description(),direction:e.direction(),signingKeyId:a,get signingContractID(){return $r(n,a,t)},innerSigningKeyId:I,get innerSigningContractID(){return $r(n,I,t)}};return await c(`${o}/${C}/sideEffect`,R,t)},f=Object(e.message());if(r!==v.OP_ATOMIC)return u(f);let d=(g,[E,w])=>([v.OP_ACTION_ENCRYPTED,v.OP_ACTION_UNENCRYPTED].includes(E)&&g.push(Object(w)),g),h=f.reduce(d,[]);return Promise.allSettled(h.map(g=>u(g))).then(g=>{let E=g.filter(w=>w.status==="rejected").map(w=>w.reason);if(E.length>0)throw console.error("Side-effect errors",n,E),new AggregateError(E,`Error at side effects for ${n}`)})},async applyProcessResult({message:e,state:t,contractState:r,processingErrored:n,postHandleEvent:o}){let i=e.contractID(),s=e.hash(),a=e.height();if(await c("chelonia/db/addEntry",e),!n){this.config.reactiveSet(t,i,r);try{o?.(e)}catch(f){console.error(`[chelonia] ERROR '${f.name}' for ${e.description()} in event post-handling: ${f.message}`,f,{message:e.serialize()})}}if(e.isFirstMessage()){let{type:f}=e.opValue();q(t.contracts,i)||this.config.reactiveSet(t.contracts,i,Object.create(null)),this.config.reactiveSet(t.contracts[i],"type",f),console.debug(`contract ${f} registered for ${i}`)}e.isKeyOp()&&this.config.reactiveSet(t.contracts[i],"previousKeyOp",s),this.config.reactiveSet(t.contracts[i],"HEAD",s),this.config.reactiveSet(t.contracts[i],"height",a);let u=Fn.get(e);if(u){let f=t.contracts[i].missingDecryptionKeyIds;f||(f=[],this.config.reactiveSet(t.contracts[i],"missingDecryptionKeyIds",f)),u.forEach(d=>{f.includes(d)||f.push(d)})}if(!this.subscriptionSet.has(i)){let f=this.pending.find(d=>d?.contractID===i);if(f){let d=this.pending.indexOf(f);d!==-1&&this.pending.splice(d,1)}this.subscriptionSet.add(i),c("okTurtles.events/emit",Tr,Array.from(this.subscriptionSet),{added:[i],removed:[]})}n||(c("okTurtles.events/emit",s,i,e),c("okTurtles.events/emit",rr,i,e))}},pf=e=>{throw new Error(`chelonia: action not implemented to handle: ${JSON.stringify(e)}.`)};var hf=Date.now(),gf=performance.now(),Jt,bs,Jh=async function(){let e=performance.now(),t=await this.config.fetch(`${this.config.connectionURL}/time`,{signal:this.abortController.signal}),r=performance.now();if(r-e>8e3)throw new Error("Error fetching server time: request took too long");if(!t.ok)throw new Error("Error fetching server time");let n=new Date(await t.text()).valueOf();if(Number.isNaN(n))throw new Error("Unable to parse server time");let o=performance.now();hf=n+(r-e)/2+(o-r),gf=o},cI=c("sbp/selectors/register",{"chelonia/private/startClockSync":function(){if(Jt!==void 0)throw new Error("chelonia/private/startClockSync has already been called");let e=(n=3e5)=>{if(Jt!==null)return;let o=setTimeout(()=>{Jh.call(this).then(()=>{Jt===o&&(Jt=null),e()}).catch(i=>{Jt===o?(Jt=null,console.error("Error re-syncing server time; will re-attempt in 5s",i),setTimeout(()=>e(0),5e3)):console.error("Error re-syncing server time; another attempt is in progress",i)})},n);Jt=o},t=Date.now(),r=performance.now();bs=setInterval(()=>{let n=Date.now(),o=performance.now();Math.abs(Math.abs(n-t)-Math.abs(o-r))>10&&(Jt!=null&&clearTimeout(Jt),Jt=null,e(0)),t=n,r=o},1e4),Jt=null,e(0)},"chelonia/private/stopClockSync":()=>{Jt!==void 0&&(bs!=null&&clearInterval(bs),Jt!=null&&clearTimeout(Jt),bs=void 0,Jt=void 0)},"chelonia/time":function(){let e=performance.now(),t=hf-gf+e;return Math.round(t)}});var bf=/^((([\w.]+)\/([^/]+))(?:\/(?:([^/]+)\/)?)?)\w*/,CI=c("sbp/selectors/register",{"chelonia/_init":function(){this.config={get connectionURL(){throw new Error("Invalid use of connectionURL before initialization")},set connectionURL(r){Object.defineProperty(this,"connectionURL",{value:r,writable:!0})},stateSelector:"chelonia/private/state",contracts:{defaults:{modules:{},exposedGlobals:{},allowedDomains:[],allowedSelectors:[],preferSlim:!1},overrides:{},manifests:{}},whitelisted:r=>!!this.whitelistedActions[r],reactiveSet:(r,n,o)=>(r[n]=o,o),fetch:(...r)=>fetch(...r),reactiveDel:(r,n)=>{delete r[n]},acceptAllMessages:!1,skipActionProcessing:!1,skipDecryptionAttempts:!1,skipSideEffects:!1,strictProcessing:!1,strictOrdering:!1,connectionOptions:{maxRetries:1/0,reconnectOnTimeout:!0},hooks:{preHandleEvent:null,postHandleEvent:null,processError:null,sideEffectError:null,handleEventError:null,syncContractError:null,pubsubError:null},unwrapMaybeEncryptedData:ho},this._instance=Object.create(null),this.abortController=new AbortController,this.state={contracts:{},pending:[]},this.manifestToContract={},this.whitelistedActions={},this.currentSyncs=Object.create(null),this.postSyncOperations=Object.create(null),this.sideEffectStacks=Object.create(null),this.sideEffectStack=r=>{let n=this.sideEffectStacks[r];return n||(this.sideEffectStacks[r]=n=[]),n},this.setPostSyncOp=(r,n,o)=>{this.postSyncOperations[r]=this.postSyncOperations[r]||Object.create(null),this.postSyncOperations[r][n]=o};let e=(r,n)=>{if(q(r,n))return r[n];let o=c(this.config.stateSelector);if(o?.secretKeys&&q(o.secretKeys,n)){let i=He(o.secretKeys[n]);return r[n]=i,i}},t=r=>{let n=c(this.config.stateSelector),o=Object.keys(n?.secretKeys||{});return Array.from(new Set([...Object.keys(r),...o]))};this.transientSecretKeys=new Proxy(Object.create(null),{get:e,ownKeys:t}),this.ephemeralReferenceCount=Object.create(null),this.subscriptionSet=new Set,this.pending=[]},"chelonia/config":function(){return{...pt(this.config),fetch:this.config.fetch,reactiveSet:this.config.reactiveSet,reactiveDel:this.config.reactiveDel}},"chelonia/configure":async function(e){if(Gt(this.config,e),Object.assign(this.config.hooks,e.hooks||{}),e.contracts){Object.assign(this.config.contracts.defaults,e.contracts.defaults||{});let t=this.config.contracts.manifests;console.debug("[chelonia] preloading manifests:",Object.keys(t));for(let r in t)await c("chelonia/private/loadManifest",r,t[r])}q(e,"skipDecryptionAttempts")&&(e.skipDecryptionAttempts?this.config.unwrapMaybeEncryptedData=t=>{if(!Ln(t))return{encryptionKeyId:null,data:t}}:this.config.unwrapMaybeEncryptedData=ho)},"chelonia/reset":async function(e,t){typeof e=="function"&&typeof t>"u"&&(t=e,e=void 0),this.pubsub&&c("chelonia/private/stopClockSync"),Object.keys(this.postSyncOperations).forEach(i=>{c("chelonia/private/enqueuePostSyncOps",i)}),await c("chelonia/contract/waitPublish"),await c("chelonia/contract/wait"),Object.keys(this.postSyncOperations).forEach(i=>{c("chelonia/private/enqueuePostSyncOps",i)}),await c("chelonia/contract/waitPublish"),await c("chelonia/contract/wait");let r=await t?.(),n=c(this.config.stateSelector);this._instance=Object.create(null),this.abortController.abort(),this.abortController=new AbortController,wl(n,this.config.reactiveDel),this.config.reactiveSet(n,"contracts",Object.create(null)),Xo(this.ephemeralReferenceCount),this.pending.splice(0),Xo(this.currentSyncs),Xo(this.postSyncOperations),Xo(this.sideEffectStacks);let o=Array.from(this.subscriptionSet);return this.subscriptionSet.clear(),c("chelonia/clearTransientSecretKeys"),c("okTurtles.events/emit",_n),c("okTurtles.events/emit",Tr,Array.from(this.subscriptionSet),{added:[],removed:o}),this.pubsub&&c("chelonia/private/startClockSync"),e&&Object.entries(e).forEach(([i,s])=>{this.config.reactiveSet(n,i,s)}),r},"chelonia/storeSecretKeys":function(e){let t=c(this.config.stateSelector);t.secretKeys||this.config.reactiveSet(t,"secretKeys",Object.create(null));let r=e.valueOf();r&&(Array.isArray(r)||(r=[r]),r.forEach(({key:n,transient:o})=>{if(!n)return;typeof n=="string"&&(n=He(n));let i=de(n);q(this.transientSecretKeys,i)||(this.transientSecretKeys[i]=n),!o&&(q(t.secretKeys,i)||this.config.reactiveSet(t.secretKeys,i,se(n,!0)))}))},"chelonia/clearTransientSecretKeys":function(e){Array.isArray(e)?e.forEach(t=>{delete this.transientSecretKeys[t]}):Object.keys(this.transientSecretKeys).forEach(t=>{delete this.transientSecretKeys[t]})},"chelonia/haveSecretKey":function(e,t){if(!t&&q(this.transientSecretKeys,e))return!0;let r=c(this.config.stateSelector);return!!r?.secretKeys&&q(r.secretKeys,e)},"chelonia/contract/isResyncing":function(e){return typeof e=="string"&&(e=c(this.config.stateSelector)[e]),!!e?._volatile?.dirty||!!e?._volatile?.resyncing},"chelonia/contract/hasKeyShareBeenRespondedBy":function(e,t,r){return typeof e=="string"&&(e=c(this.config.stateSelector)[e]),Object.values(e?._vm.authorizedKeys||{}).some(o=>o?.meta?.keyRequest?.responded&&o.meta.keyRequest.contractID===t&&(!r||o.meta.keyRequest.reference===r))},"chelonia/contract/waitingForKeyShareTo":function(e,t,r){typeof e=="string"&&(e=c(this.config.stateSelector)[e]);let n=e._volatile?.pendingKeyRequests?.filter(o=>o&&(!t||o.contractID===t)&&(!r||o.reference===r))?.map(({name:o})=>o);return n?.length?n:null},"chelonia/contract/successfulKeySharesByContractID":function(e,t){typeof e=="string"&&(e=c(this.config.stateSelector)[e]);let r=Object.values(e._vm.keyshares||{});if(!r?.length)return;let n=Object.create(null);return r.forEach(o=>{o.success&&(t&&o.contractID!==t||(n[o.contractID]||(n[o.contractID]=[]),n[o.contractID].push({height:o.height,hash:o.hash})))}),Object.keys(n).forEach(o=>{n[o].sort((i,s)=>s.height-i.height)}),n},"chelonia/contract/hasKeysToPerformOperation":function(e,t){return typeof e=="string"&&(e=c(this.config.stateSelector)[e]),!!gt(e,t!=="*"?[t]:t,["sig"])},"chelonia/contract/receivedKeysToPerformOperation":function(e,t,r){let n=c(this.config.stateSelector);typeof e=="string"&&(e=n[e]),typeof t=="string"&&(t=n[t]);let i=gt(t,r!=="*"?[r]:r,["sig"]);return e?._vm?.sharedKeyIds?.some(s=>s.id===i)},"chelonia/contract/currentKeyIdByName":function(e,t,r){typeof e=="string"&&(e=c(this.config.stateSelector)[e]);let n=ze(e,t);if(!(r&&!c("chelonia/haveSecretKey",n)))return n},"chelonia/contract/foreignKeysByContractID":function(e,t){return typeof e=="string"&&(e=c(this.config.stateSelector)[e]),pl(e,t)},"chelonia/contract/historicalKeyIdsByName":function(e,t){typeof e=="string"&&(e=c(this.config.stateSelector)[e]);let r=ze(e,t),n=hl(e,t);return r?[r,...n]:n},"chelonia/contract/suitableSigningKey":function(e,t,r,n,o){return typeof e=="string"&&(e=c(this.config.stateSelector)[e]),gt(e,t,r,n,o)},"chelonia/contract/setPendingKeyRevocation":function(e,t){let n=c(this.config.stateSelector)[e];n._volatile||this.config.reactiveSet(n,"_volatile",Object.create(null)),n._volatile.pendingKeyRevocations||this.config.reactiveSet(n._volatile,"pendingKeyRevocations",Object.create(null));for(let o of t){let i=ze(n,o);i?this.config.reactiveSet(n._volatile.pendingKeyRevocations,i,!0):console.warn("[setPendingKeyRevocation] Unable to find keyId for name",{contractID:e,name:o})}},"chelonia/shelterAuthorizationHeader"(e){return mr.call(this,e)},"chelonia/crypto/keyId":e=>de(e.valueOf()),"chelonia/connect":function(e={}){if(!this.config.connectionURL)throw new Error("config.connectionURL missing");if(!this.config.connectionOptions)throw new Error("config.connectionOptions missing");this.pubsub&&this.pubsub.destroy();let t=this.config.connectionURL;return this.pubsub&&c("chelonia/private/stopClockSync"),c("chelonia/private/startClockSync"),this.pubsub=ef(t,{...this.config.connectionOptions,handlers:{...e.handlers,"subscription-succeeded":function(r){let{channelID:n}=r.detail;this.subscriptionSet.has(n)&&c("chelonia/private/out/sync",n,{force:!0}).catch(o=>{console.warn(`[chelonia] Syncing contract ${n} failed: ${o.message}`)}),e.handlers?.["subscription-succeeded"]?.call(this,r)}},messageHandlers:{...Object.fromEntries(Object.entries(e.messageHandlers||{}).map(([r,n])=>{switch(r){case Ye.PUB:return[r,o=>{if(!o.channelID){console.info("[chelonia] Discarding pub event without channelID");return}if(!this.subscriptionSet.has(o.channelID)){console.info(`[chelonia] Discarding pub event for ${o.channelID} because it's not in the current subscriptionSet`);return}c("chelonia/queueInvocation",o.channelID,()=>{n.call(this.pubsub,ii(this,{contractID:o.channelID,serializedData:o.data}))}).catch(i=>{console.error(`[chelonia] Error processing pub event for ${o.channelID}`,i)})}];case Ye.KV:return[r,o=>{if(!o.channelID||!o.key){console.info("[chelonia] Discarding kv event without channelID or key");return}if(!this.subscriptionSet.has(o.channelID)){console.info(`[chelonia] Discarding kv event for ${o.channelID} because it's not in the current subscriptionSet`);return}c("chelonia/queueInvocation",o.channelID,()=>{n.call(this.pubsub,[o.key,ii(this,{contractID:o.channelID,meta:o.key,serializedData:JSON.parse(Buffer.from(o.data).toString())})])}).catch(i=>{console.error(`[chelonia] Error processing kv event for ${o.channelID} and key ${o.key}`,o,i)})}];case Ye.DELETION:return[r,o=>n.call(this.pubsub,o.data)];default:return[r,n]}})),[Ye.ENTRY](r){let{contractID:n}=v.deserializeHEAD(r.data);c("chelonia/private/in/enqueueHandleEvent",n,r.data)}}}),this.contractsModifiedListener||(this.contractsModifiedListener=()=>c("chelonia/pubsub/update"),c("okTurtles.events/on",Tr,this.contractsModifiedListener)),this.pubsub},"chelonia/handleEvent":async function(e){let{contractID:t}=v.deserializeHEAD(e);return await c("chelonia/private/in/enqueueHandleEvent",t,e)},"chelonia/defineContract":function(e){if(!bf.exec(e.name))throw new Error(`bad contract name: ${e.name}`);e.metadata||(e.metadata={validate(){},create:()=>({})}),e.getters||(e.getters={}),e.state=t=>c(this.config.stateSelector)[t],e.manifest=this.defContractManifest,e.sbp=this.defContractSBP,this.defContractSelectors=[],this.defContract=e,this.defContractSelectors.push(...c("sbp/selectors/register",{[`${e.manifest}/${e.name}/getters`]:()=>e.getters,[`${e.manifest}/${e.name}/pushSideEffect`]:(t,r)=>{let[n]=r;n.startsWith(e.name+"/")&&(r[0]=`${e.manifest}/${n}`),this.sideEffectStack(t).push(r)}}));for(let t in e.actions)wf(t),this.whitelistedActions[t]=!0,this.defContractSelectors.push(...c("sbp/selectors/register",{[`${e.manifest}/${t}/process`]:async(r,n)=>{let{meta:o,data:i,contractID:s}=r;n=n||e.state(s);let a=Ef(n,e.getters);await e.metadata.validate(o,{state:n,...a,contractID:s}),await e.actions[t].validate(i,{state:n,...a,meta:o,message:r,contractID:s}),this.sideEffectStacks[s]=[],await e.actions[t].process(r,{state:n,...a})},[`${e.manifest}/${t}/sideEffect`]:async(r,n)=>{if(e.actions[t].sideEffect){if(n=n||e.state(r.contractID),!n){console.warn(`[${e.manifest}/${t}/sideEffect]: Skipping side-effect since there is no contract state for contract ${r.contractID}`);return}let i=pt(n),s=Ef(i,e.getters);await e.actions[t].sideEffect(r,{state:i,...s})}let o=this.sideEffectStack(r.contractID);for(;o.length>0;){let i=o.shift();try{await e.sbp(...i)}catch(s){let a=s;throw console.error(`[chelonia] ERROR: '${a.name}' ${a.message}, for pushed sideEffect of ${r.description}:`,i),this.sideEffectStacks[r.contractID]=[],a}}}}));for(let t in e.methods)this.defContractSelectors.push(...c("sbp/selectors/register",{[`${e.manifest}/${t}`]:e.methods[t]}));c("okTurtles.events/emit",Jo,e)},"chelonia/queueInvocation":(e,t)=>c("chelonia/private/queueEvent",e,["chelonia/private/noop"]).then(()=>c("chelonia/private/queueEvent","public:"+e,t)),"chelonia/begin":async(...e)=>{for(let t of e)await c(...t)},"chelonia/pubsub/update":function(){let e=this.pubsub,t=[...e.subscriptionSet],r=Array.from(this.subscriptionSet),n=Tu(t,r),o=ua(t,n),i=ua(r,n);try{for(let s of o)e.unsub(s);for(let s of i)e.sub(s)}catch(s){console.error(`[chelonia] pubsub/update: error ${s.name}: ${s.message}`,{toUnsubscribe:o,toSubscribe:i},s),this.config.hooks.pubsubError?.(s,e)}},"chelonia/contract/wait":function(e){let t=e?typeof e=="string"?[e]:e:Object.keys(c(this.config.stateSelector).contracts);return Promise.all(t.flatMap(r=>c("chelonia/queueInvocation",r,["chelonia/private/noop"])))},"chelonia/contract/waitPublish":function(e){let t=e?typeof e=="string"?[e]:e:Object.keys(c(this.config.stateSelector).contracts);return Promise.all(t.flatMap(r=>c("chelonia/private/queueEvent",`publish:${r}`,["chelonia/private/noop"])))},"chelonia/contract/sync":async function(e,t){let r=typeof e=="string"?[e]:e;return r.forEach(n=>{if(_a.call(this,n))throw console.error("[chelonia] Missing reference count for contract "+n),new Error("Missing reference count for contract")}),c("chelonia/private/out/sync",r,{...t,force:!0})},"chelonia/contract/isSyncing":function(e,{firstSync:t=!1}={}){let r=!!this.currentSyncs[e];return t?r&&this.currentSyncs[e].firstSync:r},"chelonia/contract/currentSyncs":function(){return Object.keys(this.currentSyncs)},"chelonia/contract/remove":function(e,{confirmRemovalCallback:t,permanent:r}={}){let n=c(this.config.stateSelector),o=typeof e=="string"?[e]:e;return Promise.all(o.map(i=>{if(n?.contracts?.[i])return c("chelonia/private/queueEvent",i,()=>{if(t&&!t(i))return;let s=c(this.config.stateSelector),a=Array.from(new Set(Object.values(s[i]?._vm?.authorizedKeys??{}).filter(u=>!!u.foreignKey).map(u=>{try{return new URL(u.foreignKey).pathname}catch{return}}).filter(Boolean)));c("chelonia/private/removeImmediately",i,{permanent:r}),a.length&&c("chelonia/contract/release",a,{try:!0}).catch(u=>{console.error("[chelonia] Error attempting to release foreign key contracts",u)})})}))},"chelonia/contract/retain":async function(e,t){let r=typeof e=="string"?[e]:e,n=c(this.config.stateSelector);if(r.length===0)return Promise.resolve();let o=i=>{if(n.contracts[i]===null)throw console.error("[chelonia/contract/retain] Called /retain on permanently deleted contract.",i),new Vr("Unable to retain permanently deleted contract "+i)};return t?.ephemeral?r.forEach(i=>{o(i),q(this.ephemeralReferenceCount,i)?this.ephemeralReferenceCount[i]=this.ephemeralReferenceCount[i]+1:this.ephemeralReferenceCount[i]=1}):r.forEach(i=>{o(i),q(n.contracts,i)||this.config.reactiveSet(n.contracts,i,Object.create(null)),this.config.reactiveSet(n.contracts[i],"references",(n.contracts[i].references??0)+1)}),await c("chelonia/private/out/sync",r)},"chelonia/contract/release":async function(e,t){let r=typeof e=="string"?[e]:e,n=c(this.config.stateSelector);t?.try||(t?.ephemeral?r.forEach(s=>{if(n.contracts[s]===null){console.warn("[chelonia/contract/release] Called /release on permanently deleted contract. This has no effect.",s);return}if(q(this.ephemeralReferenceCount,s)){let a=this.ephemeralReferenceCount[s]??0;a<=1?delete this.ephemeralReferenceCount[s]:this.ephemeralReferenceCount[s]=a-1}else throw console.error("[chelonia/contract/release] Invalid negative ephemeral reference count for",s),new Error("Invalid negative ephemeral reference count")}):r.forEach(s=>{if(n.contracts[s]===null){console.warn("[chelonia/contract/release] Called /release on permanently deleted contract. This has no effect.",s);return}if(q(n.contracts,s)&&q(n.contracts[s],"references")){let a=n.contracts[s].references;if(a===0)throw console.error("[chelonia/contract/release] Invalid negative reference count for",s),new Error("Invalid negative reference count");a<=1?this.config.reactiveDel(n.contracts[s],"references"):this.config.reactiveSet(n.contracts[s],"references",a-1)}else throw console.error("[chelonia/contract/release] Invalid negative reference count for",s),new Error("Invalid negative reference count")}));let o=_a.bind(this),i=r.filter(o);return i.length?await c("chelonia/contract/remove",i,{confirmRemovalCallback:o}):void 0},"chelonia/contract/disconnect":async function(e,t){let n=c(this.config.stateSelector)[e],o=Object.values(n._vm.authorizedKeys).filter(i=>i._notAfterHeight==null&&i.meta?.keyRequest?.contractID===t).map(i=>i.id);if(o.length)return await c("chelonia/out/keyDel",{contractID:e,contractName:n._vm.type,data:o,signingKeyId:gt(n,[v.OP_KEY_DEL],["sig"])})},"chelonia/in/processMessage":function(e,t){let r=pt(t),n=typeof e=="string"?v.deserialize(e,this.transientSecretKeys,r,this.config.unwrapMaybeEncryptedData):e;return c("chelonia/private/in/processMessage",n,r).then(()=>r).catch(o=>(console.warn(`chelonia/in/processMessage: reverting mutation ${n.description()}: ${n.serialize()}`,o),t))},"chelonia/out/fetchResource":async function(e,{code:t}={}){let r=Ou(e);if(t!=null&&r.code!==t)throw new Error(`Invalid CID content type. Expected ${t}, got ${r.code}`);let n=await c("chelonia.db/get",e);if(n!=null)return n;let o=`${this.config.connectionURL}/file/${e}`,i=await this.config.fetch(o,{signal:this.abortController.signal}).then(rn("text")),s=Fr(i,r.code);if(s!==e)throw new Error(`expected hash ${e}. Got: ${s}`);return await c("chelonia.db/set",e,i),i},"chelonia/out/latestHEADInfo":function(e){return this.config.fetch(`${this.config.connectionURL}/latestHEADinfo/${e}`,{cache:"no-store",signal:this.abortController.signal}).then(rn("json"))},"chelonia/out/eventsAfter":bl,"chelonia/out/eventsBefore":function(e,t,r,n){r<=0&&console.error('[chelonia] invalid params error: "limit" needs to be positive integer');let o=Math.max(0,t-r+1),i=Math.min(t+1,r);return c("chelonia/out/eventsAfter",e,o,i,void 0,n)},"chelonia/out/eventsBetween":function(e,t,r,n=0,{stream:o}={stream:!0}){if(n<0){console.error('[chelonia] invalid params error: "offset" needs to be positive integer or zero');return}let i,s=new ReadableStream({start:async a=>{let u=await this.config.fetch(`${this.config.connectionURL}/file/${t}`,{signal:this.abortController.signal}).then(rn("text")),f=v.deserializeHEAD(u);if(f.contractID!==e){a.error(new Error("chelonia/out/eventsBetween: Mismatched contract ID"));return}let d=Math.max(0,f.head.height-n),h=r-d+1;if(h<1){a.close();return}i=c("chelonia/out/eventsAfter",e,d,h).getReader()},async pull(a){let{done:u,value:f}=await i.read();u?a.close():a.enqueue(f)}});return o?s:va(s)},"chelonia/rootState":function(){return c(this.config.stateSelector)},"chelonia/latestContractState":async function(e,t={forceSync:!1}){let r=c(this.config.stateSelector);if(r.contracts[e]===null)throw new Vr("Permanently deleted contract "+e);if(!t.forceSync&&r[e]&&Object.keys(r[e]).some(a=>a!=="_volatile"))return pt(r[e]);let n=Object.create(null),o=r.contracts[e]?.type,s=c("chelonia/out/eventsAfter",e,0,void 0,e).getReader();for(r[e]&&(n._volatile=r[e]._volatile);;){let{value:a,done:u}=await s.read();if(u)return n;let f=pt(n);try{await c("chelonia/private/in/processMessage",v.deserialize(a,this.transientSecretKeys,n,this.config.unwrapMaybeEncryptedData),n,void 0,o),!o&&n._vm&&(o=n._vm.type)}catch(d){if(console.warn(`[chelonia] latestContractState: '${d.name}': ${d.message} processing:`,a,d.stack),d instanceof zn)throw d;n=f}}},"chelonia/contract/state":function(e,t){let r=c(this.config.stateSelector)[e],n=r&&pt(r);return n?._vm&&t!=null&&Object.keys(n._vm.authorizedKeys).forEach(o=>{n._vm.authorizedKeys[o]._notBeforeHeight>t&&delete n._vm.authorizedKeys[o]}),n},"chelonia/contract/fullState":function(e){let t=c(this.config.stateSelector);return Array.isArray(e)?Object.fromEntries(e.map(r=>[r,{contractState:t[r],cheloniaState:t.contracts[r]}])):{contractState:t[e],cheloniaState:t.contracts[e]}},"chelonia/out/registerContract":async function(e){let{contractName:t,keys:r,hooks:n,publishOptions:o,signingKeyId:i,actionSigningKeyId:s,actionEncryptionKeyId:a}=e,u=this.config.contracts.manifests[t];if(!this.manifestToContract[u])throw new Error(`contract not defined: ${t}`);let d=this.transientSecretKeys[i];if(!d)throw new Error(`Signing key ${i} is not defined`);let h={type:t,keys:r},g=v.createV1_0({contractID:null,height:0,op:[v.OP_CONTRACT,po(d,h)],manifest:u}),E=g.hash();return await c("chelonia/private/out/publishEvent",g,e.namespaceRegistration?{...o,headers:{...o?.headers,"shelter-namespace-registration":e.namespaceRegistration}}:o,n&&{prepublish:n.prepublishContract,postpublish:n.postpublishContract}),await c("chelonia/private/out/sync",E),await c(a?"chelonia/out/actionEncrypted":"chelonia/out/actionUnencrypted",{action:t,contractID:E,data:e.data,signingKeyId:s??i,encryptionKeyId:a,hooks:n,publishOptions:o})},"chelonia/out/ownResources":async function(e){if(!e)throw new TypeError("A contract ID must be provided");let t=await this.config.fetch(`${this.config.connectionURL}/ownResources`,{method:"GET",signal:this.abortController.signal,headers:new Headers([["authorization",mr.call(this,e)]])});if(!t.ok)throw console.error("Unable to fetch own resources",e,t.status),new Error(`Unable to fetch own resources for ${e}: ${t.status}`);return t.json()},"chelonia/out/deleteContract":async function(e,t={}){if(!e)throw new TypeError("A contract ID must be provided");return Array.isArray(e)||(e=[e]),await Promise.allSettled(e.map(async r=>{let n=q(t,r),o=q(t[r],"token")&&t[r].token,i=q(t[r],"billableContractID")&&t[r].billableContractID;if(!n||o===i)throw new TypeError(`Either a token or a billable contract ID must be provided for ${r}`);let s=await this.config.fetch(`${this.config.connectionURL}/deleteContract/${r}`,{method:"POST",signal:this.abortController.signal,headers:new Headers([["authorization",o?`bearer ${t[r].token.valueOf()}`:mr.call(this,t[r].billableContractID)]])});if(!s.ok){if(s.status===404||s.status===410){console.warn("Contract appears to have been deleted already",r,s.status);return}throw console.error("Unable to delete contract",r,s.status),new Error(`Unable to delete contract ${r}: ${s.status}`)}}))},"chelonia/out/actionEncrypted":function(e){return mf.call(this,v.OP_ACTION_ENCRYPTED,e)},"chelonia/out/actionUnencrypted":function(e){return mf.call(this,v.OP_ACTION_UNENCRYPTED,e)},"chelonia/out/keyShare":async function(e){let{atomic:t,originatingContractName:r,originatingContractID:n,contractName:o,contractID:i,data:s,hooks:a,publishOptions:u}=e,f=this.config.contracts.manifests[r],d=this.config.contracts.manifests[o],h=n?this.manifestToContract[f]?.contract:void 0,g=this.manifestToContract[d]?.contract;if(n&&!h||!g)throw new Error("Contract name not found");let E=s;if(!e.signingKeyId&&!e.signingKey)throw new TypeError("Either signingKeyId or signingKey must be specified");let w=v.createV1_0({contractID:i,op:[v.OP_KEY_SHARE,e.signingKeyId?tr(i,e.signingKeyId,E,this.transientSecretKeys):po(e.signingKey,E)],manifest:d});return t||(w=await c("chelonia/private/out/publishEvent",w,u,a)),w},"chelonia/out/keyAdd":async function(e){let{atomic:t,contractID:r,contractName:n,data:o,hooks:i,publishOptions:s}=e,a=this.config.contracts.manifests[n],u=this.manifestToContract[a]?.contract;if(!u)throw new Error("Contract name not found");let f=u.state(r),d=o.filter(g=>{let E=Ln(g)?g.valueOf():g;return!(q(f._vm.authorizedKeys,E.id)&&f._vm.authorizedKeys[E.id]._notAfterHeight==null)});if(d.length===0)return;let h=v.createV1_0({contractID:r,op:[v.OP_KEY_ADD,tr(r,e.signingKeyId,d,this.transientSecretKeys)],manifest:a});return t||(h=await c("chelonia/private/out/publishEvent",h,s,i)),h},"chelonia/out/keyDel":async function(e){let{atomic:t,contractID:r,contractName:n,data:o,hooks:i,publishOptions:s}=e,a=this.config.contracts.manifests[n],u=this.manifestToContract[a]?.contract;if(!u)throw new Error("Contract name not found");let f=u.state(r),d=o.map(g=>{if(Ln(g))return g;if(!(!q(f._vm.authorizedKeys,g)||f._vm.authorizedKeys[g]._notAfterHeight!=null))return f._vm.authorizedKeys[g]._private?ke(r,f._vm.authorizedKeys[g]._private,g):g}).filter(Boolean),h=v.createV1_0({contractID:r,op:[v.OP_KEY_DEL,tr(r,e.signingKeyId,d,this.transientSecretKeys)],manifest:a});return t||(h=await c("chelonia/private/out/publishEvent",h,s,i)),h},"chelonia/out/keyUpdate":async function(e){let{atomic:t,contractID:r,contractName:n,data:o,hooks:i,publishOptions:s}=e,a=this.config.contracts.manifests[n],u=this.manifestToContract[a]?.contract;if(!u)throw new Error("Contract name not found");let f=u.state(r),d=o.map(g=>{if(Ln(g))return g;let{oldKeyId:E}=g;return f._vm.authorizedKeys[E]._private?ke(r,f._vm.authorizedKeys[E]._private,g):g}),h=v.createV1_0({contractID:r,op:[v.OP_KEY_UPDATE,tr(r,e.signingKeyId,d,this.transientSecretKeys)],manifest:a});return t||(h=await c("chelonia/private/out/publishEvent",h,s,i)),h},"chelonia/out/keyRequest":async function(e){let{originatingContractID:t,originatingContractName:r,contractID:n,contractName:o,hooks:i,publishOptions:s,innerSigningKeyId:a,encryptionKeyId:u,innerEncryptionKeyId:f,encryptKeyRequestMetadata:d,reference:h}=e,g=this.config.contracts.manifests[o],E=this.config.contracts.manifests[r],w=this.manifestToContract[g]?.contract,I=this.manifestToContract[E]?.contract;if(!w)throw new Error("Contract name not found");let C=c(this.config.stateSelector);try{await c("chelonia/contract/retain",n,{ephemeral:!0});let G=w.state(n),A=I.state(t);if(Object.values(A._vm.authorizedKeys).findIndex(he=>he._notAfterHeight==null&&he.meta?.keyRequest?.contractID===n&&G?._volatile?.pendingKeyRequests?.some($e=>$e.name===he.name))!==-1)return;let O=Qe(lt),F=de(O),P=se(O,!1),W=se(O,!0),ce=gt(A,[v.OP_KEY_ADD],["sig"]);if(!ce)throw wi(`Unable to send key request. Originating contract is missing a key with OP_KEY_ADD permission. contractID=${n} originatingContractID=${t}`);let Oe=()=>c("chelonia/out/keyAdd",{contractID:t,contractName:r,data:[{id:F,name:"#krrk-"+F,purpose:["sig"],ringLevel:Number.MAX_SAFE_INTEGER,permissions:e.permissions==="*"?"*":Array.isArray(e.permissions)?[...e.permissions,v.OP_KEY_SHARE]:[v.OP_KEY_SHARE],allowedActions:e.allowedActions,meta:{private:{content:ke(t,u,W),shareable:!1},keyRequest:{...h&&{reference:d?ke(t,u,h):h},contractID:d?ke(t,u,n):n}},data:P}],signingKeyId:ce}).catch(he=>{throw console.error(`[chelonia] Error sending OP_KEY_ADD for ${t} during key request to ${n}`,he),he}),xe={contractID:t,height:C.contracts[t].height,replyWith:tr(t,a,{encryptionKeyId:u,responseKey:ke(n,f,W)},this.transientSecretKeys),request:"*"},we=v.createV1_0({contractID:n,op:[v.OP_KEY_REQUEST,tr(n,e.signingKeyId,d?ke(n,f,xe):xe,this.transientSecretKeys)],manifest:g});return we=await c("chelonia/private/out/publishEvent",we,s,{...i,prepublish:(...he)=>Oe().then(()=>i?.prepublish?.(...he))}),we}finally{await c("chelonia/contract/release",n,{ephemeral:!0})}},"chelonia/out/keyRequestResponse":async function(e){let{atomic:t,contractID:r,contractName:n,data:o,hooks:i,publishOptions:s}=e,a=this.config.contracts.manifests[n];if(!this.manifestToContract[a]?.contract)throw new Error("Contract name not found");let f=o,d=v.createV1_0({contractID:r,op:[v.OP_KEY_REQUEST_SEEN,tr(r,e.signingKeyId,f,this.transientSecretKeys)],manifest:a});return t||(d=await c("chelonia/private/out/publishEvent",d,s,i)),d},"chelonia/out/atomic":async function(e){let{contractID:t,contractName:r,data:n,hooks:o,publishOptions:i}=e,s=this.config.contracts.manifests[r];if(!this.manifestToContract[s]?.contract)throw new Error("Contract name not found");let u=(await Promise.all(n.map(([d,h])=>{if(!["chelonia/out/actionEncrypted","chelonia/out/actionUnencrypted","chelonia/out/keyAdd","chelonia/out/keyDel","chelonia/out/keyUpdate","chelonia/out/keyRequestResponse","chelonia/out/keyShare"].includes(d))throw new Error("Selector not allowed in OP_ATOMIC: "+d);return c(d,{...h,...e,data:h.data,atomic:!0})}))).flat().filter(Boolean).map(d=>[d.opType(),d.opValue()]),f=v.createV1_0({contractID:t,op:[v.OP_ATOMIC,tr(t,e.signingKeyId,u,this.transientSecretKeys)],manifest:s});return f=await c("chelonia/private/out/publishEvent",f,i,o),f},"chelonia/out/protocolUpgrade":async function(){},"chelonia/out/propSet":async function(){},"chelonia/out/propDel":async function(){},"chelonia/out/encryptedOrUnencryptedPubMessage":function({contractID:e,innerSigningKeyId:t,encryptionKeyId:r,signingKeyId:n,data:o}){let i=yf.call(this,{contractID:e,innerSigningKeyId:t,encryptionKeyId:r,signingKeyId:n,data:o});this.pubsub.pub(e,i)},"chelonia/kv/set":async function(e,t,r,{ifMatch:n,innerSigningKeyId:o,encryptionKeyId:i,signingKeyId:s,maxAttempts:a,onconflict:u}){a=a??3;let f=`${this.config.connectionURL}/kv/${encodeURIComponent(e)}/${encodeURIComponent(t)}`,d=typeof u=="function",h,g=async()=>{let E;if(h.ok||h.status===409||h.status===412){let I=await h.text();E=I?ii(this,{contractID:e,serializedData:JSON.parse(I),meta:t}):void 0}else if(h.status!==404&&h.status!==410)throw new ln("[kv/set] Invalid response code: "+h.status);let w=await u({contractID:e,key:t,failedData:r,status:h.status,etag:h.headers.get("x-cid")||h.headers.get("etag"),get currentData(){return E?.data},currentValue:E});return w?(r=w[0],n=w[1],!0):!1};for(;;){if(r!==void 0){let E=yf.call(this,{contractID:e,innerSigningKeyId:o,encryptionKeyId:i,signingKeyId:s,data:r,meta:t});h=await this.config.fetch(f,{headers:new Headers([["authorization",mr.call(this,e)],["if-match",n||'""']]),method:"POST",body:JSON.stringify(E),signal:this.abortController.signal})}else{if(!d)throw TypeError("onconflict required with empty data");if(h=await this.config.fetch(f,{headers:new Headers([["authorization",mr.call(this,e)]]),signal:this.abortController.signal}),await g())continue;break}if(!h.ok){if(h.status===409||h.status===412){if(--a<=0)throw new Error("kv/set conflict setting KV value");if(await Bi(Pn(0,1500)),d){if(await g())continue;break}else throw new Error(`kv/set failed with status ${h.status} and no onconflict handler was provided`)}throw new ln("kv/set invalid response status: "+h.status)}break}},"chelonia/kv/get":async function(e,t){let r=await this.config.fetch(`${this.config.connectionURL}/kv/${encodeURIComponent(e)}/${encodeURIComponent(t)}`,{headers:new Headers([["authorization",mr.call(this,e)]]),signal:this.abortController.signal});if(r.status===404)return null;if(!r.ok)throw new Error("Invalid response status: "+r.status);let n=await r.json();return ii(this,{contractID:e,serializedData:n,meta:t})},"chelonia/kv/setFilter":function(e,t){this.pubsub.setKvFilter(e,t)},"chelonia/parseEncryptedOrUnencryptedDetachedMessage":function({contractID:e,serializedData:t,meta:r}){return ii(this,{contractID:e,serializedData:t,meta:r})}});function wf(e){let r=bf.exec(e)?.[2];if(!r)throw new Error(`Poorly named action '${e}': missing contract name.`);return r}function yf({contractID:e,innerSigningKeyId:t,encryptionKeyId:r,signingKeyId:n,data:o,meta:i}){let s=c(this.config.stateSelector)[e],a=t?s._vm.authorizedKeys[t]&&s._vm.authorizedKeys[t]?._notAfterHeight==null?tr(e,t,o,this.transientSecretKeys):po(this.transientSecretKeys[t],o):o,u=r?ke(e,r,a):a,f=tr(e,n,u,this.transientSecretKeys),d=c(this.config.stateSelector),h=String(d.contracts[e].height);return{...f.serialize((i??"")+h),height:h}}function ii(e,{contractID:t,serializedData:r,meta:n}){if(!r)throw new TypeError("[chelonia] parseEncryptedOrUnencryptedMessage: serializedData is required");let o=c(e.config.stateSelector)[t],i=parseInt(r.height),a=c(e.config.stateSelector).contracts[t].height;if(!(i>=0)||!(i<=a))throw new Error(`[chelonia] parseEncryptedOrUnencryptedMessage: Invalid height ${r.height}; it must be between 0 and ${a}`);let u=(n??"")+r.height,f=_r(t,o,r,i,u,w=>vr(t,o,w,i,e.transientSecretKeys,u,void 0)),d,h,g=(()=>{let w;return()=>{if(!w)try{let I;I=f.valueOf(),Ln(I)?(d=I.encryptionKeyId,I=I.valueOf(),Sr(I)?(h=I.signingKeyId,I=I.valueOf()):h=null):(d=null,h=null),w=[I]}catch(I){w=[void 0,I]}if(w.length===2)throw w[1];return w[0]}})(),E={get contractID(){return t},get innerSigningKeyId(){if(h===void 0)try{g()}catch{}return h},get encryptionKeyId(){if(d===void 0)try{g()}catch{}return d},get signingKeyId(){return f.signingKeyId},get data(){return g()},get signingContractID(){return $r(t,E.signingKeyId,o)},get innerSigningContractID(){return $r(t,E.innerSigningKeyId,o)}};return E}async function mf(e,t){let{atomic:r,action:n,contractID:o,data:i,hooks:s,publishOptions:a}=t,u=wf(n),f=this.config.contracts.manifests[u],{contract:d}=this.manifestToContract[f],h=d.state(o),g=await d.metadata.create(),E={action:n,data:i,meta:g},w=t.innerSigningKeyId?h._vm.authorizedKeys[t.innerSigningKeyId]&&h._vm.authorizedKeys[t.innerSigningKeyId]?._notAfterHeight==null?tr(o,t.innerSigningKeyId,E,this.transientSecretKeys):po(this.transientSecretKeys[t.innerSigningKeyId],E):E;if(e===v.OP_ACTION_ENCRYPTED&&!t.encryptionKeyId)throw new Error("OP_ACTION_ENCRYPTED requires an encryption key ID be given");if(t.encryptionKey&&t.encryptionKeyId!==de(t.encryptionKey))throw new Error("OP_ACTION_ENCRYPTED raw encryption key does not match encryptionKeyId");let I=e===v.OP_ACTION_UNENCRYPTED?w:t.encryptionKey?nt(t.encryptionKey,w):ke(o,t.encryptionKeyId,w),C=v.createV1_0({contractID:o,op:[e,tr(o,t.signingKeyId,I,this.transientSecretKeys)],manifest:f});return r||(C=await c("chelonia/private/out/publishEvent",C,a,s)),C}function Ef(e,t){let r=new Proxy({},{get(n,o){return t[o](e,r)}});return{getters:r}}c("sbp/domains/lock",["chelonia"]);var si="@instance/pubsub";var xf={manifests:{"gi.contracts/chatroom":"zL7mM9d4Xb4TUZovL5nbzHAwkuPuvJj2HLY778JUwMKXWZJdndRwNj7E","gi.contracts/group":"zL7mM9d4Xb4TUeDxkCdK3gtMEearhxVeWGDUmYRvKrjQkAaJ68xpAyCB","gi.contracts/identity":"zL7mM9d4Xb4THA1sugUsGkDKkfyPGjvDu5T3AUBY34rjfwfTdozC4VEo"}};var If=async e=>{let{cheloniaState:t,contractState:r}=c("chelonia/contract/fullState",e);if(!t)return;await c("chelonia/contract/remove",e,{permanent:!0});let n=t.type?.replace(/^gi\.contracts\//,"gi.actions/"),o=n&&c("sbp/selectors/fn",`${n}/_ondeleted`),i=c("state/vuex/getters").currentIdentityState;if(i.fileDeleteTokens){let s=Object.entries(i.fileDeleteTokens).filter(([,{billableContractID:a}])=>a===e).map(([a])=>a);await c("gi.actions/identity/removeFiles",{manifestCids:s,option:{shouldDeleteToken:!0}}).catch(a=>{console.error("[handleDeletedContract] Error deleting saved tokens for deleted contract",e,a)})}typeof o=="function"?await o(e,r).catch(s=>{console.error("[handleDeletedContract] Error handling deletion of contract",e,s)}):console.warn("[handleDeletedContract] Received contract deletion notification for contract without a declared deletion handler",e,t.type)},Qh=async()=>{await c("gi.db/settings/load",Tn).then(async o=>{if(!o)return;let i=await c("gi.db/settings/load",Eo);i&&(await c("chelonia/reset",o),typeof WorkerGlobalScope=="function"&&await c("swLogs/startCapture",i))});let e=(o,i,s,a)=>{c("gi.notifications/emit","CHELONIA_ERROR",{createdDate:new Date().toISOString(),activity:o,error:i,message:s,msgMeta:a}),c("appLogs/save").catch(u=>{console.error("Error saving logs during error notification",u)})},t=!1,r=()=>c("okTurtles.eventQueue/queueEvent",Tn,()=>{if(!t)return c("gi.db/settings/save",Tn,c("chelonia/rootState"))}),n=so(r,200);await c("chelonia/configure",{connectionURL:c("okTurtles.data/get","API_URL"),reactiveSet:(o,i,s)=>{o[i]!==s&&(o[i]=s,n())},reactiveDel:(o,i)=>{q(o,i)&&(delete o[i],n())},contracts:{...xf,defaults:{modules:{"@common/common.js":Ms},allowedSelectors:["namespace/lookup","namespace/lookupCached","state/vuex/state","state/vuex/settings","state/vuex/commit","state/vuex/getters","chelonia/rootState","chelonia/contract/state","chelonia/contract/sync","chelonia/contract/isSyncing","chelonia/contract/remove","chelonia/contract/retain","chelonia/contract/release","controller/router","chelonia/contract/suitableSigningKey","chelonia/contract/currentKeyIdByName","chelonia/contract/foreignKeysByContractID","chelonia/contract/setPendingKeyRevocation","chelonia/storeSecretKeys","chelonia/crypto/keyId","chelonia/queueInvocation","chelonia/contract/wait","chelonia/out/deleteContract","chelonia/contract/waitingForKeyShareTo","chelonia/contract/successfulKeySharesByContractID","gi.actions/group/removeOurselves","gi.actions/group/groupProfileUpdate","gi.actions/group/displayMincomeChangedPrompt","gi.actions/group/addChatRoom","gi.actions/group/join","gi.actions/group/joinChatRoom","gi.actions/identity/addJoinDirectMessageKey","gi.actions/identity/leaveGroup","gi.actions/chatroom/delete","gi.notifications/emit","gi.actions/out/rotateKeys","gi.actions/group/shareNewKeys","gi.actions/chatroom/shareNewKeys","gi.actions/identity/shareNewPEK","chelonia/out/keyDel","chelonia/contract/disconnect","gi.actions/identity/removeFiles","gi.actions/chatroom/join","gi.actions/chatroom/leave","chelonia/contract/hasKeysToPerformOperation","gi.actions/identity/kv/initChatRoomUnreadMessages","gi.actions/identity/kv/deleteChatRoomUnreadMessages","gi.actions/identity/kv/setChatRoomReadUntil","gi.actions/identity/kv/addChatRoomUnreadMessage","gi.actions/identity/kv/removeChatRoomUnreadMessage"],allowedDomains:["okTurtles.data","okTurtles.events","okTurtles.eventQueue","gi.db","gi.contracts"],preferSlim:!0,exposedGlobals:{Notification:self.Notification}}},hooks:{syncContractError:(o,i)=>{o&&(o.name==="ChelErrorResourceGone"&&(console.info("[syncContractError] Contract ID "+i+" has been deleted"),If(i).catch(s=>{console.error("[syncContractError] Error handling contract deletion",s)})),["ChelErrorUnrecoverable","ChelErrorForkedChain"].includes(o.name)&&c("okTurtles.events/emit",uo,o,{contractID:i}))},handleEventError:(o,i)=>{if(["ChelErrorUnrecoverable","ChelErrorForkedChain"].includes(o?.name)){let s=i.contractID();c("okTurtles.events/emit",uo,o,{contractID:s,message:i})}c("okTurtles.data/get","sideEffectError")!==i.hash()&&e("handleEvent",o,i)},processError:(o,i,s)=>{if(o.name==="GIErrorIgnoreAndBan"&&c("okTurtles.eventQueue/queueEvent",i.contractID(),["gi.actions/group/autobanUser",i,o,s]),o.name!=="ChelErrorDecryptionKeyNotFound"){if(i.direction()==="outgoing"){console.warn("Ignoring error on outgoing message",i,o);return}e("process",o,i,s)}},sideEffectError:(o,i)=>{let s=i.contractID();c("okTurtles.events/emit",uo,o,{contractID:s,message:i}),c("okTurtles.data/set","sideEffectError",i.hash()),e("sideEffect",o,i)}}}),c("okTurtles.events/on",Uu,()=>{if(!c("chelonia/rootState").loggedIn){console.warn("Received LOGIN_COMPLETE event but state.loggedIn is not an object");return}c("gi.actions/identity/kv/load").catch(i=>{console.error("Error from 'gi.actions/identity/kv/load' during login:",i)}),r().catch(i=>{console.error("LOGIN_COMPLETE handler: Error saving Chelonia state",i)})}),c("okTurtles.events/on",wn,()=>{r().catch(o=>{console.error("CHELONIA_STATE_MODIFIED handler: Error saving Chelonia state",o)})}),c("okTurtles.events/on",ao,()=>{t=!0}),c("okTurtles.events/on",bn,()=>{n.clear(),Promise.all([c("chelonia/reset"),c("gi.db/settings/delete",Tn)]).catch(o=>{console.error("Logout event: error deleting Chelonia state:",o)}).finally(()=>{t=!1})}),c("okTurtles.events/on",Tr,(o,{added:i})=>{if(!i.length)return;let s=c("chelonia/rootState");i.forEach(a=>{switch(s.contracts[a]?.type){case"gi.contracts/identity":if(a===s.loggedIn?.identityContractID){c("chelonia/kv/setFilter",a,[ht.UNREAD_MESSAGES,ht.PREFERENCES,ht.NOTIFICATIONS]);return}break;case"gi.contracts/group":c("chelonia/kv/setFilter",a,[ht.LAST_LOGGED_IN]);return}c("chelonia/kv/setFilter",a,[])})}),c("okTurtles.data/set",si,c("chelonia/connect",{messageHandlers:{[Ye.VERSION_INFO](o){let i="2.0.0",s=o.data.GI_VERSION,a="2.0.0",u=o.data.CONTRACTS_VERSION,f=a!==u,d=i!==s;console.info("VERSION_INFO received:",{ourVersion:i,theirVersion:s,ourContractsVersion:a,theirContractsVersion:u}),(f||d)&&c("okTurtles.events/emit",Ye.VERSION_INFO,o.data)},[ft.PUSH_ACTION](o){c("okTurtles.events/emit",ft.PUSH_ACTION,{data:o.data})},[Ye.PUB](o){let{contractID:i,innerSigningContractID:s,data:a}=o;switch(a[0]){case"gi.contracts/chatroom/user-typing-event":{c("okTurtles.events/emit",Wi,{contractID:i,innerSigningContractID:s});break}case"gi.contracts/chatroom/user-stop-typing-event":{c("okTurtles.events/emit",Ji,{contractID:i,innerSigningContractID:s});break}default:console.log(`[pubsub] Received data from channel ${i}:`,a)}},[Ye.KV]([o,i]){let{contractID:s,data:a}=i;a&&c("okTurtles.events/emit",Mo,{contractID:s,key:o,data:a})},[Ye.DELETION](o){console.info("[messageHandler] Contract ID "+o+" has been deleted"),If(o).catch(i=>{console.error("[messageHandler] Error handling contract deletion",i)})}},handlers:{offline(){c("okTurtles.events/emit",ji)},online(){c("okTurtles.events/emit",Jr),console.info("back online!")},"reconnection-attempt"(){c("okTurtles.events/emit",Hi)},"reconnection-failed"(){c("okTurtles.events/emit",zi)},"reconnection-succeeded"(){c("okTurtles.events/emit",Jr),console.info("reconnected to pubsub!")}}})),c("gi.db/settings/load",Eo).then(async o=>{let i=await c("chelonia/rootState");!i||!o||i.loggedIn?.identityContractID===o&&await c("chelonia/contract/sync",o).then(async()=>{let s=as(i.contracts);await cs(s)}).catch(s=>{console.error("[setupChelonia] Error syncing identity contract and groups",s)})})},ai=(()=>{let e=()=>(t||(t=Qh().catch(r=>{throw console.error("[setupChelonia] Error during chelonia setup",r),t=void 0,r})),t),t;return c("okTurtles.events/on",ri,()=>{t&&(t=void 0,setTimeout(()=>e().catch(r=>{console.error("[PUBSUB_ERROR handler] Error setting up Chelonia",r)}),100))}),e})();var Sf=e=>typeof e=="string"?(e=Buffer.from(e.replace(/_/g,"/").replace(/-/g,"+")+"=".repeat((4-e.length%4)%4),"base64"),e):new Uint8Array(e),Zh=(e,t)=>{if(e==null||t==null)return e==t;let r=Sf(e),n=Sf(t);if(r.byteLength!==n.byteLength)return!1;for(let o=r.byteLength-1;o>=0;o--)if(r[o]!==n[o])return!1;return!0},ZI=c("sbp/selectors/register",{"push/getSubscriptionOptions":(()=>{let e;return c("okTurtles.events/on",ft.PUSH_ACTION,({data:t})=>{if(t.type!==bo.SEND_PUBLIC_KEY)return;let r=e?.[1].applicationServerKey;e=[performance.now(),{userVisibleOnly:!0,applicationServerKey:t.data}],r!==t.data&&(async()=>{let n=await self.registration.pushManager.getSubscription();if(!n||Zh(n.options.applicationServerKey,t.data)||(console.warn("VAPID server key changed; removing existing subscription and setting up a new one",{oldApplicationServerPublicKey:n.options.applicationServerKey&&Buffer.from(n.options.applicationServerKey).toString("base64"),newApplicationServerPublicKey:t.data}),await n.unsubscribe(),!c("chelonia/rootState").loggedIn||c("sw/deviceSettings/get",pa.DISABLE_NOTIFICATIONS)))return;let o=await self.registration.pushManager.subscribe(e[1]);await c("push/reportExistingSubscription",o?.toJSON(),o?.options.applicationServerKey)})()}),()=>e&&performance.now()-e[0]<36e5?Promise.resolve(e[1]):new Promise((t,r)=>{let n=({data:a})=>{a.type===bo.SEND_PUBLIC_KEY&&(c("okTurtles.events/off",ft.PUSH_ACTION,n),clearTimeout(s),t(e[1]))},o=c("okTurtles.data/get",si);o||r(new Error("Missing pubsub instance")),o.socket?.readyState!==WebSocket.OPEN&&r(new Error("WebSocket connection is not open")),c("okTurtles.events/on",ft.PUSH_ACTION,n);let s=setTimeout(()=>{c("okTurtles.events/off",ft.PUSH_ACTION,n),r(new Error("Timed out requesting VAPID key"))},1e4);o.socket.send(ni(ft.PUSH_ACTION,{action:bo.SEND_PUBLIC_KEY}))})})(),"push/reportExistingSubscription":(()=>{let e=new WeakMap;async function t(r){try{return await Du(r)}catch(n){return`ERR: ${n.message}`}}return async(r,n)=>{let o=c("okTurtles.data/get",si);if(!o)throw new Error("Missing pubsub instance");if(o.socket?.readyState!==WebSocket.OPEN)throw new Error("WebSocket connection is not open");let s=o.socket,a=e.get(s);if(e.set(s,r),r?.endpoint){if(!a||r.endpoint!==a.endpoint){let u=await t(r),f=new URL(r.endpoint).host;console.info(`[reportExistingSubscription] reporting '${u}':`,f),o.socket.send(ni(ft.PUSH_ACTION,{action:bo.STORE_SUBSCRIPTION,payload:{applicationServerKey:n?Buffer.from(n).toString("base64"):null,settings:{heartbeatInterval:12*60*60*1e3},subscriptionInfo:r}}))}}else if(a){let u=await t(a),f=new URL(a.endpoint).host;console.info(`[reportExistingSubscription] removing subscription '${u}':`,f),o.socket.send(ni(ft.PUSH_ACTION,{action:bo.DELETE_SUBSCRIPTION,payload:null}))}}})()});self.registration?.pushManager&&(()=>{let e=!1;c("okTurtles.events/on",La,async()=>{if(e||!c("chelonia/rootState").loggedIn)return;e=!0;let t=c("sw/deviceSettings/get",pa.DISABLE_NOTIFICATIONS);if(console.info("pubsub reconnected. disableNotifications=",t),!t)try{let r=await self.registration.pushManager.getSubscription();await c("push/reportExistingSubscription",r?.toJSON(),r?.options.applicationServerKey)}catch(r){console.error("Error reporting subscription on reconnection",r)}e=!1})})();self.addEventListener("push",function(e){if(!e.data)return;let t;try{t=e.data.json()}catch(r){console.error("[push event] Invalid JSON:",r);return}t.type===Ye.ENTRY?e.waitUntil(ai().then(()=>t.data?c("chelonia/handleEvent",t.data):c("chelonia/contract/sync",t.contractID).catch(r=>{console.error("[push event] Error syncing",t.contractID,r)})).catch(r=>{if(console.error("Error processing push event",r),t.contractType==="gi.contracts/chatroom")return Kn({title:S("Chatroom activity"),body:S("New chatroom message. An iOS bug prevents us from saying what it is.")});if(t.contractType==="gi.contracts/group")return Kn({title:S("Group activity"),body:S("New group activity. An iOS bug prevents us from saying what it is.")})})):t.type==="recurring"&&e.waitUntil(c("gi.periodicNotifications/init"))},!1);self.addEventListener("pushsubscriptionchange",function(e){e.waitUntil((async()=>{try{let t=null;e.oldSubscription&&(t=await self.registration.pushManager.subscribe(e.oldSubscription.options)),await c("push/reportExistingSubscription",t?.toJSON(),t?.options.applicationServerKey)}catch(t){console.error("[pushsubscriptionchange] Error resubscribing:",t)}})())},!1);self.addEventListener("periodicsync",e=>{e.tag==="periodic-notifications"&&e.waitUntil(c("gi.periodicNotifications/init"))});c("sbp/selectors/register",{"namespace/lookupCached":e=>c("chelonia/rootState").namespaceLookups?.[e]??null,"namespace/lookupReverseCached":e=>c("chelonia/rootState").reverseNamespaceLookups?.[e]??null,"namespace/lookup":(e,{skipCache:t}={skipCache:!1})=>{if(!t){let r=c("namespace/lookupCached",e);if(r)return Promise.resolve(r)}return fetch(`${c("okTurtles.data/get","API_URL")}/name/${encodeURIComponent(e)}`).then(r=>{if(!r.ok){if(console.warn(`namespace/lookup: ${r.status} for ${e}`),r.status!==404)throw new Error(`${r.status}: ${r.statusText}`);return null}return r.text()}).then(r=>{if(r!==null){let n=c("chelonia/config").reactiveSet,o=c("chelonia/rootState");o.namespaceLookups||n(o,"namespaceLookups",Object.create(null)),o.reverseNamespaceLookups||n(o,"reverseNamespaceLookups",Object.create(null));let i=o.namespaceLookups,s=o.reverseNamespaceLookups;n(i,e,r),n(s,r,e),c("okTurtles.events/emit",Uo,{name:e,value:r})}else{let n=c("chelonia/rootState"),o=n.namespaceLookups,i=o?.[e];if(i){let s=c("chelonia/config").reactiveDel,a=n.reverseNamespaceLookups;s(o,e),a[i]===e&&s(o,i),c("okTurtles.events/emit",Uo,{name:e,deletedValue:i})}}return r})}});console.info("GI_VERSION:","2.0.0");console.info("GI_GIT_VERSION:","v2.0.0");console.info("CONTRACTS_VERSION:","2.0.0");console.info("LIGHTWEIGHT_CLIENT:","true");console.info("NODE_ENV:","production");Nr.register(v);Nr.register(Ze);var _f=(e,t)=>(e[t]=!0,e),eg=["sbp","okTurtles.data"].reduce(_f,{}),tg=["chelonia.db/get","chelonia.db/set","chelonia/rootState","chelonia/haveSecretKey","chelonia/private/enqueuePostSyncOps","chelonia/private/invoke","state/vuex/state","state/vuex/getters","state/vuex/settings","gi.db/settings/save","gi.db/logs/save"].reduce(_f,{});c("sbp/filters/global/add",(e,t,r)=>{eg[e]||tg[t]||console.debug(`[sbp] ${t}`,r)});var vf=()=>{let e=c("chelonia/rootState");e.chatroom||(e.chatroom=Object.create(null)),e.chatroom.chatNotificationSettings||(e.chatroom.chatNotificationSettings=Object.create(null)),e.chatroom.chatRoomScrollPosition||(e.chatroom.chatRoomScrollPosition=Object.create(null)),e.chatroom.unreadMessages||(e.chatroom.unreadMessages=Object.create(null)),e.lastLoggedIn||(e.lastLoggedIn=Object.create(null)),e.notifications||(e.notifications=Object.create(null)),e.notifications.items||(e.notifications.items=[]),e.notifications.status||(e.notifications.status=Object.create(null)),e.periodicNotificationAlreadyFiredMap||(e.periodicNotificationAlreadyFiredMap={alreadyFired:Object.create(null),lastRun:Object.create(null)}),e.namespaceLookups||(e.namespaceLookups=Object.create(null)),e.reverseNamespaceLookups||(e.reverseNamespaceLookups=Object.create(null)),e.deviceSettings||(e.deviceSettings=Object.create(null))};c("okTurtles.events/on",_n,vf);var ci=(...e)=>{self.clients.matchAll().then(t=>Promise.all(t.map(async r=>r.postMessage(...e))).catch(r=>{console.error("[broadcastMessage] Error",e,r)}))};[_n,Tr,Wo,Fu,Gu,rr,Gi,Mu,bn,ao,Yi,Ji,Wi,$u,Bu,qi,co,Vi,Mo,Ye.VERSION_INFO,pi,oc,Uo,Bo,Go,$o,Lo,Xi,Qi,ji,Jr,Hi,zi,Za,uo,Lu].forEach(e=>{c("okTurtles.events/on",e,(...t)=>{let{data:r,transferables:n}=Qt(t);ci({type:"event",subtype:e,data:r},n)})});c("okTurtles.events/on",Jo,e=>{let t={manifest:e.manifest,name:e.name},{data:r,transferables:n}=Qt([t]);ci({type:"event",subtype:Jo,data:r},n)});c("okTurtles.events/on",Fo,e=>{let t={...e,from:"sw"},{data:r,transferables:n}=Qt([t]);ci({type:"event",subtype:Fo,data:r},n)});c("okTurtles.events/on",Zi,e=>{let t={...e,from:"sw"},{data:r,transferables:n}=Qt([t]);ci({type:"event",subtype:Zi,data:r},n)});c("okTurtles.events/on",Xr,(...e)=>{let{data:t,transferables:r}=Qt(e);ci({type:Xr,data:t},r)});c("sbp/selectors/register",{"state/vuex/state":()=>c("chelonia/rootState"),"state/vuex/getters":(()=>{let e;return()=>(e||(e=Object.create(null),Object.defineProperties(e,Object.fromEntries(Object.entries(Jl).map(([t,r])=>[t,{get:function(){let n=c("chelonia/rootState");return r(n,this)}}]))),Object.defineProperties(e,Object.fromEntries(Object.entries(Gl).map(([t,r])=>[t,{get:function(){let n=c("chelonia/rootState");return r(n.chatroom||{},this,n)}}]))),Object.defineProperties(e,Object.fromEntries(Object.entries(Xl).map(([t,r])=>[t,{get:function(){let n=c("chelonia/rootState");return r(n.notifications||{},this,n)}}]))),Object.defineProperty(e,"currentPaymentPeriodForGroup",{get:function(){return t=>this.periodStampGivenDateForGroup(t,new Date)}})),e)})()});var rg=new URL(self.location);c("sbp/selectors/register",{"controller/router":()=>({options:{base:rg.searchParams.get("routerBase")}})});c("sbp/selectors/register",{"appLogs/save":()=>c("swLogs/save")});c("sbp/selectors/register",{"sw/version":()=>({GI_VERSION:"2.0.0",GI_GIT_VERSION:"v2.0.0",CONTRACTS_VERSION:"2.0.0",LIGHTWEIGHT_CLIENT:"true",NODE_ENV:"production"}),"sw/deviceSettings/set":(e,t)=>{let r=c("chelonia/config").reactiveSet,n=c("chelonia/rootState");r(n.deviceSettings,e,t)},"sw/deviceSettings/get":e=>c("chelonia/rootState").deviceSettings[e]});c("gi.periodicNotifications/importNotifications",Ku);c("okTurtles.events/on",_n,()=>{c("gi.periodicNotifications/clearStatesAndStopTimers"),c("gi.periodicNotifications/init")});var ws;c("okTurtles.events/on",Ye.VERSION_INFO,e=>{ws=e});c("okTurtles.data/set","API_URL",self.location.origin);vf();var ng=ai();self.addEventListener("install",function(e){console.debug("[sw] install"),e.waitUntil(ng.then(()=>self.skipWaiting()))});self.addEventListener("activate",function(e){console.debug("[sw] activate"),e.waitUntil(self.clients.claim())});self.addEventListener("fetch",function(e){console.debug(`[sw] fetch : ${e.request.method} - ${e.request.url}`)});self.addEventListener("message",function(e){if(console.debug(`[sw] message from ${e.source.id} of type ${e.data?.type}.`),typeof e.data=="object"&&e.data.type)switch(console.debug("[sw] event received:",e.data),e.data.type){case"sbp":{let t=e.data.port;(async()=>await c(...Nr(e.data.data)))().then(r=>{let{data:n,transferables:o}=Qt(r);t.postMessage([!0,n],o)}).catch(r=>{let{data:n,transferables:o}=Qt(r);t.postMessage([!1,n],o)}).finally(()=>{t.close()});break}case"ping":e.source.postMessage({type:"pong"});break;case"shutdown":self.registration.unregister().then(function(){return self.clients.matchAll()}).then(function(t){t.forEach(r=>r.navigate(r.url))});break;case"skip-waiting":self.skipWaiting();break;case"event":c("okTurtles.events/emit",e.data.subtype,...Nr(e.data.data));break;case"ready":{let t=e.data.port;Promise.race([ai(),new Promise((r,n)=>{setTimeout(()=>{n(new Error("Timed out setting up Chelonia"))},3e4)})]).then(()=>{t.postMessage({type:"ready",currentSyncs:c("chelonia/contract/currentSyncs"),GI_VERSION:"2.0.0"})},r=>{t.postMessage({type:"error",error:r})}).finally(()=>{t.close()}),ws&&e.source&&e.data.GI_VERSION!==ws.GI_VERSION&&e.source.postMessage({type:"event",subtype:Ye.VERSION_INFO,data:[ws]});break}default:console.error("[sw] unknown message type:",e.data);break}else console.error("[sw] unexpected data:",e.data)});self.addEventListener("notificationclick",e=>{console.debug("[sw] Notification clicked:",e.notification),e.notification.close(),e.waitUntil(self.clients.matchAll({type:"window"}).then(t=>{if(t.sort((n,o)=>{if(n.focused!==o.focused)return n.focused?-1:1;if(n.visibilityState!==o.visibilityState){if(n.visibilityState==="visible")return-1;if(o.visibilityState==="visible"||n.visibilityState==="hidden")return 1;if(o.visibilityState==="hidden")return-1}return 0}),!t.length)return self.clients.openWindow(`${c("controller/router").options.base}${e.notification.data.path??"/"}`).then(n=>{if(e.notification.data?.sbpInvocation){let{data:o}=Qt(e.notification.data.sbpInvocation);n.postMessage({type:"sbp",data:o})}else e.notification.data?.groupID&&n.postMessage({type:"sbp",data:["state/vuex/commit","setCurrentGroupId",{contractID:e.notification.data.groupID}]});return n});let r=t[0];if(e.notification.data?.sbpInvocation){let{data:n}=Qt(e.notification.data.sbpInvocation);r.postMessage({type:"sbp",data:n})}else e.notification.data?.path&&r.postMessage({type:"navigate",groupID:e.notification.data.groupID,path:e.notification.data.path});if(!r.focused)return r.focus()}))});c("okTurtles.events/on",Mo,({contractID:e,key:t,data:r})=>{let n=c("chelonia/rootState"),o=n.loggedIn?.identityContractID;if(e===o){switch(t){case ht.LAST_LOGGED_IN:{n.lastLoggedIn[e]=r;break}case ht.UNREAD_MESSAGES:{n.chatroom.unreadMessages=r;break}case ht.PREFERENCES:{n.preferences=r;break}case ht.NOTIFICATIONS:{n.notifications.status=r;break}default:return}c("okTurtles.events/emit",wn)}});c("okTurtles.events/on",Fo,({chatRoomID:e,messageHash:t})=>{let r=c("chelonia/rootState");t?r.chatroom.chatRoomScrollPosition[e]=t:delete r.chatroom.chatRoomScrollPosition[e],c("okTurtles.events/emit",wn)});c("okTurtles.events/on",Lo,e=>{let t=c("state/vuex/state"),r=c("state/vuex/getters"),n=e.avatarUserID&&r.ourContactProfilesById[e.avatarUserID]?.picture?r.ourContactProfilesById[e.avatarUserID].picture:e.groupID&&t[e.groupID]?r.groupSettingsForGroup(t[e.groupID]).groupPicture:void 0;Kn({icon:n||void 0,title:e.title,body:e.plaintextBody,groupID:e.groupID,path:e.linkTo,sbpInvocation:e.sbpInvocation}).catch(o=>{console.error("Error displaying native notification",o)})});c("okTurtles.events/on",Bo,([e,t])=>{let r=c("state/vuex/state");r.lastLoggedIn[e]=t});c("okTurtles.events/on",Go,e=>{let t=c("state/vuex/state");t.preferences=e});c("okTurtles.events/on",$o,e=>{let t=c("state/vuex/state");t.chatroom.unreadMessages=e});c("okTurtles.events/on",Zi,({chatRoomID:e,settings:t})=>{let r=c("chelonia/rootState");if(e){r.chatroom.chatNotificationSettings[e]||(r.chatroom.chatNotificationSettings[e]={});for(let n in t)r.chatroom.chatNotificationSettings[e][n]=t[n]}});
/*! Bundled license information:

ieee754/index.js:
  (*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> *)

buffer/index.js:
  (*!
   * The buffer module from node.js, for the browser.
   *
   * @author   Feross Aboukhadijeh <https://feross.org>
   * @license  MIT
   *)

scrypt-async/scrypt-async.js:
  (*!
   * Fast "async" scrypt implementation in JavaScript.
   * Copyright (c) 2013-2016 Dmitry Chestnykh | BSD License
   * https://github.com/dchest/scrypt-async-js
   *)
*/
//# sourceMappingURL=sw-primary.js.map
